<?xml version="1.0" encoding="UTF-8"?>
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Nokia. Portions Copyright 2003 Nokia.
All Rights Reserved.
-->

<project basedir="." default="netbeans" name="jnlpinstaller">

    <property name="nb_all" value="../.."/>
    <property name="jnlp-api.file.location" value="../external/jnlp.jar"/>
    <property name="jnlp-servlet.file.location" value="../external/jnlp-servlet.jar"/>

    <target name="compile">
        <ant dir="../external"/>
        <javac debug="${build.compiler.debug}" deprecation="${build.compiler.deprecation}" destdir="src" srcdir="src">
            <classpath refid="cp"/>
        </javac>
    </target>

    <target depends="compile, delete-release" name="jars">
        <mkdir dir="release"/>
        <jar compress="false" 
             jarfile="release/nbjnlpinstaller.jar">
             <fileset dir="src" excludesfile="${nb_all}/nbbuild/standard-jar-excludes.txt">
                <exclude name="**/IndexServlet*"/>
             </fileset>
        </jar>
    </target>

    <target depends="jnlp-expand1, create-war" name="netbeans">
    </target>

    <target depends="copy-to-release, create-jnlp-jars" name="create-config">
        <path id="nbmfiles">
            <fileset dir="release" includes="**/*.nbm"/>
        </path>
        <!-- config.txt contains the list of all nbm files -->
        <pathconvert dirsep="${file.separator}" pathsep="" property="nbm-files-list" refid="nbmfiles"/>
        <echo file="release/config.txt" message="${nbm-files-list}"/>
        <property location="${nb_all}/installer/jnlp/release/" name="dirname"/>
        <echo message="Replacing ${dirname}/"/>
        <replace file="release/config.txt" token="${dirname}${file.separator}">
            <replacevalue><![CDATA[@@@
###]]></replacevalue><!-- this tag has specified a value of new line -->
        </replace>
        <replace file="release/config.txt" token="@@@" value=""/>
        <replace file="release/config.txt" token="###" value="${jnlp.codebase}/"/>
        
        <!-- The rest of this target creates the end of nb-launch.jnlp file -->
        <path id="jarfiles">
            <fileset dir="release">
                <include name="*.jar"/>
                <exclude name="nbjnlpinstaller.jar"/>
            </fileset>
        </path>
        <!-- save directory name for replacing back -->
        <replace file="release/nb-launch.jnlp" token="${dirname}" value="D#I#R#_#N#A#M#E"/>
        <pathconvert dirsep="${file.separator}" pathsep="" property="jar-files-list" refid="jarfiles"/>
        <echo append="true" file="release/nb-launch.jnlp" message="@@@${jar-files-list}%%%"/>
        <echo message="Replacing ${dirname}"/>
        <replace file="release/nb-launch.jnlp" token="${dirname}${file.separator}" value="@@@###"/>
        <replace file="release/nb-launch.jnlp" token="@@@@@@" value=""/>
        <replace file="release/nb-launch.jnlp" token="@@@">
            <replacevalue><![CDATA["/>
]]></replacevalue>
        </replace>
        <replace file="release/nb-launch.jnlp" token="%%%">
            <replacevalue><![CDATA["/>
]]></replacevalue>
        </replace>
        <replace file="release/nb-launch.jnlp" token="###">
            <replacevalue><![CDATA[        <jar href="]]></replacevalue>
        </replace>
        <echo append="true" file="release/nb-launch.jnlp" message="${jnlp.extra.properties}"/>
        <echo append="true" file="release/nb-launch.jnlp">
<![CDATA[        
        <extension href="nb-install.jnlp" name="NetBeansInstall"/>
    </resources>
    <application-desc main-class="org.netbeans.jnlp.NetBeansLaunch"/>
</jnlp>
]]></echo>
        <!-- replace back accidentally replaced name of the directory -->
        <replace file="release/nb-launch.jnlp" token="D#I#R#_#N#A#M#E" value="${dirname}${file.separator}"/>
    </target>
    
    <target depends="jars" name="copy-to-release">
        <mkdir dir="release"/>
        <copy flatten="true" todir="release">
            <fileset dir="../..">
                <include name="**/*.nbm"/>
                <exclude name="installer/jnlp/**"/>
            </fileset>
        </copy>
        <copy flatten="true" todir="release">
            <fileset dir="">
                <include name="*.jnlp"/>
            </fileset>
        </copy>
    </target>
    
    <target name="jnlp-expand1" depends="create-config" if="jnlp.static">
        <replace file="release/nb-launch.jnlp" token="@CODEBASE@" value="${jnlp.codebase}"/>
        <replace file="release/nb-launch.jnlp" token="@NAME@" value="nb-launch.jnlp"/>
        <replace file="release/nb-install.jnlp" token="@CODEBASE@" value="${jnlp.codebase}"/>
        <replace file="release/nb-install.jnlp" token="@NAME@" value="nb-intstall.jnlp"/>
    </target>
    
    <target name="jnlp-expand2" depends="create-config" unless="jnlp.static">
        <replace file="release/nb-launch.jnlp" token="@CODEBASE@" value="$$$$codebase"/>
        <replace file="release/nb-launch.jnlp" token="@NAME@" value="$$$$name"/>
        <replace file="release/nb-install.jnlp" token="@CODEBASE@" value="$$$$codebase"/>
        <replace file="release/nb-install.jnlp" token="@NAME@" value="$$$$name"/>
<!--        <replace file="release/config.txt" token="${jnlp.codebase}/" value=" $$$$codebase/"/> -->
        <delete file="release/config.txt" />
    </target>

    <target name="create-war" depends="jnlp-expand2" unless="jnlp.static">
        <mkdir dir="release/WEB-INF/lib"/>
        <copy file="${jnlp-servlet.file.location}" todir="release/WEB-INF/lib"/>
        <mkdir dir="release/WEB-INF/classes"/>
        <copy todir="release/WEB-INF/classes" flatten="false">
            <fileset dir="src" excludesfile="${nb_all}/nbbuild/standard-jar-excludes.txt">
                <include name="**/IndexServlet*"/>
            </fileset>
        </copy>
        <war basedir="release" 
            compress="false"
            webxml="web.xml"
            warfile="${netbeans.dest}.war"/>
    </target>
        
    <target depends="jars" name="create-jnlp-jars">
        <mkdir dir="release"/>
        <copy flatten="true" todir="release">
            <fileset dir="../..">
                <include name="**/lib/ext/*.jar"/>
                <exclude name="installer/jnlp/**"/>
                
            </fileset>
            <fileset dir="../..">
                <include name="autoupdate/netbeans/lib/updater.jar"/>
                <include name="core/netbeans/lib/ext/boot.jar"/>
            </fileset>
        </copy>
        <!-- bacuase some of the file cannot be signed, repack them
            without their original manifests ;-( -->
        <mkdir dir="tmpdir"/>
        <unjar src="release/crimson-1.1.3.jar" dest="tmpdir"/>
        <delete file="tmpdir/META-INF/MANIFEST.MF"/>
        <jar jarfile="release/crimson-1.1.3.jar" basedir="tmpdir"/>
        <delete dir="tmpdir"/>
        <mkdir dir="tmpdir"/>
        <unjar src="release/xml-apis-1.0b2.jar" dest="tmpdir"/>
        <delete file="tmpdir/META-INF/MANIFEST.MF"/>
        <jar jarfile="release/xml-apis-1.0b2.jar" basedir="tmpdir"/>
        <delete dir="tmpdir"/>
        <!-- now they can be signed -->
        <signjar alias="${jnlp.signjar.alias}" storepass="${jnlp.signjar.password}">
            <fileset dir=".">
                <include name="release/*.jar"/>
            </fileset>
        </signjar>
    </target>
    
    <target name="delete-release">
        <delete dir="release"/>
    </target>
    
    <target name="nbm"/>
    
    <target description="Clean build products." name="clean">
        <delete>
            <fileset dir="src">
                <include name="**/*.class"/>
            </fileset>
        </delete>
	<!-- workaround for issue 20745 -->
        <delete dir="netbeans/lib"/>
        <delete>
	    <fileset dir=".">
		<include name="*.nbm"/>
	    </fileset>
	</delete>
        <delete dir="Info"/>
        <delete file="manifest-subst.mf"/>
        <delete dir="javadoc"/>
        <delete dir="release"/>
        <delete file="${netbeans.dest}.war"/>
    </target>

    <target depends="clean" name="real-clean">
        <delete dir="reload"/>
    </target>

    <path id="cp">
        <pathelement location="${nb_all}/core/netbeans/lib/ext/boot.jar"/>
        <pathelement location="${nb_all}/autoupdate/netbeans/lib/updater.jar"/>
        <pathelement location="${jnlp-api.file.location}"/>
        <pathelement location="${nb_all}/web/external/servlet-2.3.jar"/>
    </path>
    
</project>
