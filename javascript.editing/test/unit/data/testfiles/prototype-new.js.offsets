Missing position for node SCRIPT[0:0]:BLOCK[2235:0]:BLOCK[2235:29]:EXPR_RESULT[2236:10]:SETPROP[2236:10]:CALL[2236:29]:FUNCTION[2237:4]:BLOCK[2237:38]:SWITCH[2238:6]:CASE[2239:21]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:BLOCK[2235:0]:BLOCK[2235:29]:EXPR_RESULT[2236:10]:SETPROP[2236:10]:CALL[2236:29]:FUNCTION[2237:4]:BLOCK[2237:38]:SWITCH[2238:6]:CASE[2239:33]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:BLOCK[2235:0]:BLOCK[2235:29]:EXPR_RESULT[2236:10]:SETPROP[2236:10]:CALL[2236:29]:FUNCTION[2237:4]:BLOCK[2237:38]:SWITCH[2238:6]:CASE[2239:8]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:BLOCK[2235:0]:BLOCK[2235:29]:EXPR_RESULT[2236:10]:SETPROP[2236:10]:CALL[2236:29]:FUNCTION[2237:4]:BLOCK[2237:38]:SWITCH[2238:6]:CASE[2241:8]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:BLOCK[548:6]:LEAVEWITH[0:0]
Missing position for node SCRIPT[0:0]:EXPR_RESULT[107:0]:CALL[107:0]:OBJECTLIT[107:22]:FUNCTION[119:10]:BLOCK[119:27]:SWITCH[121:4]:CASE[122:6]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:EXPR_RESULT[107:0]:CALL[107:0]:OBJECTLIT[107:22]:FUNCTION[119:10]:BLOCK[119:27]:SWITCH[121:4]:CASE[123:6]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:EXPR_RESULT[3614:5]:SETPROP[3614:5]:OBJECTLIT[3614:27]:FUNCTION[3615:9]:BLOCK[3615:34]:SWITCH[3616:4]:CASE[3617:6]:BLOCK[0:0]
Missing position for node SCRIPT[0:0]:EXPR_RESULT[3710:0]:SETPROP[3710:0]:CALL[3710:25]:OBJECTLIT[3710:38]:FUNCTION[3734:20]:BLOCK[3734:38]:BLOCK[3735:4]:BLOCK[3735:22]:SWITCH[3736:6]:CASE[3737:8]:BLOCK[0:0]

<SCRIPT>/*  Prototype JavaScript framework, version 1.6.0.1
 *  (c) 2005-2007 Sam Stephenson
 *
 *  Prototype is freely distributable under the terms of an MIT-style license.
 *  For details, see the Prototype web site: http://www.prototypejs.org/
 *
 *--------------------------------------------------------------------------*/

<VAR>var <NAME>Prototype = <OBJECTLIT>{
  <OBJLITNAME>Version</OBJLITNAME>: <STRING>'1.6.0.1'</STRING>,

  <OBJLITNAME>Browser</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>IE</OBJLITNAME>:     !!(<NOT><NOT><AND><GETPROP><NAME>window</NAME>.<STRING>attachEvent</STRING></GETPROP> &amp;&amp; !<NOT><GETPROP><NAME>window</NAME>.<STRING>opera</STRING></GETPROP></NOT>)</AND></NOT></NOT>,
    <OBJLITNAME>Opera</OBJLITNAME>:  !!<NOT><NOT><GETPROP><NAME>window</NAME>.<STRING>opera</STRING></GETPROP></NOT></NOT>,
    <OBJLITNAME>WebKit</OBJLITNAME>: <GT><CALL><NAME>navigator</NAME>.<GETPROP><STRING>userAgent</STRING></GETPROP>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<STRING>'AppleWebKit/'</STRING>)</CALL> &gt; -<NUMBER>1</NUMBER></GT>,
    <OBJLITNAME>Gecko</OBJLITNAME>:  <AND><GT><CALL><NAME>navigator</NAME>.<GETPROP><STRING>userAgent</STRING></GETPROP>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<STRING>'Gecko'</STRING>)</CALL> &gt; -<NUMBER>1</NUMBER></GT> &amp;&amp; <EQ><CALL><NAME>navigator</NAME>.<GETPROP><STRING>userAgent</STRING></GETPROP>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<STRING>'KHTML'</STRING>)</CALL> == -<NUMBER>1</NUMBER></EQ></AND>,
    <OBJLITNAME>MobileSafari</OBJLITNAME>: !!<NOT><NOT><CALL><NAME>navigator</NAME>.<GETPROP><STRING>userAgent</STRING></GETPROP>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/Apple.*Mobile.*Safari/</REGEXP>)</CALL></NOT></NOT>
  }</OBJECTLIT>,

  <OBJLITNAME>BrowserFeatures</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>XPath</OBJLITNAME>: !!<NOT><NOT><GETPROP><NAME>document</NAME>.<STRING>evaluate</STRING></GETPROP></NOT></NOT>,
    <OBJLITNAME>ElementExtensions</OBJLITNAME>: !!<NOT><NOT><GETPROP><NAME>window</NAME>.<STRING>HTMLElement</STRING></GETPROP></NOT></NOT>,
    <OBJLITNAME>SpecificElementExtensions</OBJLITNAME>:
      <AND><GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF> &amp;&amp;
      <SHNE><GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF> !==
        <GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'form'</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF></SHNE></AND>
  }</OBJECTLIT>,

  <OBJLITNAME>ScriptFragment</OBJLITNAME>: <STRING>'&lt;script[^&gt;]*&gt;([\\S\\s]*?)&lt;\/script&gt;'</STRING>,
  <OBJLITNAME>JSONFilter</OBJLITNAME>: <REGEXP>/^\/\*-secure-([\s\S]*)\*\/\s*$/</REGEXP>,

  <OBJLITNAME>emptyFunction</OBJLITNAME>: <FUNCTION>function() <BLOCK>{ </BLOCK><RETURN/>}</FUNCTION>,
  <OBJLITNAME>K</OBJLITNAME>: <FUNCTION>function(<PARAMETER>x</PARAMETER>) <BLOCK>{ <RETURN>return <NAME>x</NAME></RETURN></BLOCK> }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>MobileSafari</STRING></GETPROP></IFNE>)
  <NAME>Prototype</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>SpecificElementExtensions</STRING> = <FALSE>false</FALSE></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>


/* Based on Alex Arnell's inheritance implementation. */
<VAR>var <NAME>Class = <OBJECTLIT>{
  <OBJLITNAME>create</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>parent = <NULL>null</NULL></NAME>, <NAME>properties = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>properties</NAME>[<NUMBER>0</NUMBER>]</GETELEM>)</CALL></IFNE>)
      <EXPR_VOID><SETNAME><BINDNAME>parent</BINDNAME> = <CALL><NAME>properties</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <FUNCTION>function <FUNCNAME>klass</FUNCNAME>() <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>initialize</STRING></GETPROP>.<GETPROP><STRING>apply</STRING></GETPROP>(<THIS>this</THIS>, <NAME>arguments</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>

    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>klass</NAME>, <GETPROP><NAME>Class</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>klass</NAME>.<STRING>superclass</STRING> = <NAME>parent</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>klass</NAME>.<STRING>subclasses</STRING> = <ARRAYLIT>[]</ARRAYLIT></SETPROP></EXPR_VOID>;

    <BLOCK>if (<IFNE><NAME>parent</NAME></IFNE>) <BLOCK>{
      <VAR>var <NAME>subclass = <FUNCTION>function() <BLOCK>{ </BLOCK><RETURN/>}</FUNCTION></NAME></VAR>;
      <EXPR_VOID><SETPROP><NAME>subclass</NAME>.<STRING>prototype</STRING> = <GETPROP><NAME>parent</NAME>.<STRING>prototype</STRING></GETPROP></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><NAME>klass</NAME>.<STRING>prototype</STRING> = <NEW>new <NAME>subclass</NAME></NEW></SETPROP></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>parent</NAME>.<GETPROP><STRING>subclasses</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>klass</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <GETPROP><NAME>properties</NAME>.<STRING>length</STRING></GETPROP></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <EXPR_VOID><CALL><NAME><TARGET/>klass</NAME>.<GETPROP><STRING>addMethods</STRING></GETPROP>(<GETELEM><NAME>properties</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;

    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>klass</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>initialize</STRING></GETPROP></NOT></IFNE>)
      <NAME>klass</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>initialize</STRING> = <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>

    <NAME>klass</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>constructor</STRING> = <NAME>klass</NAME></SETPROP></EXPR_VOID>;

    <RETURN>return <NAME>klass</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<EXPR_RESULT><SETPROP><NAME>Class</NAME>.<STRING>Methods</STRING> = <OBJECTLIT>{
  <OBJLITNAME>addMethods</OBJLITNAME>: <FUNCTION>function(<PARAMETER>source</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>ancestor   = <AND><GETPROP><THIS>this</THIS>.<STRING>superclass</STRING></GETPROP> &amp;&amp; <GETPROP><THIS>this</THIS>.<GETPROP><STRING>superclass</STRING></GETPROP>.<STRING>prototype</STRING></GETPROP></AND></NAME></VAR>;
    <VAR>var <NAME>properties = <CALL><NAME>Object</NAME>.<GETPROP><STRING>keys</STRING></GETPROP>(<NAME>source</NAME>)</CALL></NAME></VAR>;

    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Object</NAME>.<CALL><GETPROP><STRING>keys</STRING></GETPROP>(<OBJECTLIT>{ <OBJLITNAME>toString</OBJLITNAME>: <TRUE>true</TRUE> }</OBJECTLIT></CALL>).<STRING>length</STRING></GETPROP></NOT></IFNE>)
      <EXPR_VOID><CALL><NAME>properties</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<STRING>"toString"</STRING>, <STRING>"valueOf"</STRING>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>properties</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <VAR>var <NAME>property = <GETELEM><NAME>properties</NAME>[<NAME>i</NAME>]</GETELEM></NAME>, <NAME>value = <GETELEM><NAME>source</NAME>[<NAME>property</NAME>]</GETELEM></NAME></VAR>;
      <BLOCK>if (<IFNE><AND><NAME>ancestor</NAME> &amp;&amp; <AND><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>value</NAME>)</CALL> &amp;&amp;
          <EQ><CALL><NAME>value</NAME>.<CALL><GETPROP><STRING>argumentNames</STRING></GETPROP></CALL>().<GETPROP><STRING>first</STRING></GETPROP>()</CALL> == <STRING>"$super"</STRING></EQ></AND></AND></IFNE>) <BLOCK>{
        <VAR>var <NAME>method = <NAME>value</NAME></NAME>, <NAME>value = <CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>((<CALL><CALL><FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
          <RETURN>return <FUNCTION>function() <BLOCK>{ <RETURN>return <CALL><GETELEM><NAME>ancestor</NAME>[<NAME>m</NAME></GETELEM>].<GETPROP><STRING>apply</STRING></GETPROP>(<THIS>this</THIS>, <NAME>arguments</NAME>)</CALL></RETURN></BLOCK> }</FUNCTION></RETURN>;</BLOCK>
        }</FUNCTION>)(<NAME>property</NAME></CALL>).<GETPROP><STRING>wrap</STRING></GETPROP>(<NAME>method</NAME>)</CALL>, <OBJECTLIT>{
          <OBJLITNAME>valueOf</OBJLITNAME>:  <FUNCTION>function() <BLOCK>{ <RETURN>return <NAME>method</NAME></RETURN></BLOCK> }</FUNCTION>,
          <OBJLITNAME>toString</OBJLITNAME>: <FUNCTION>function() <BLOCK>{ <RETURN>return <CALL><NAME>method</NAME>.<GETPROP><STRING>toString</STRING></GETPROP>()</CALL></RETURN></BLOCK> }</FUNCTION>
        }</OBJECTLIT>)</CALL></NAME></VAR>;
      }</BLOCK></BLOCK><TARGET/>
      <THIS>this</THIS>.<EXPR_VOID><SETELEM><GETPROP><STRING>prototype</STRING></GETPROP>[<NAME>property</NAME>] = <NAME>value</NAME></SETELEM></EXPR_VOID>;
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>

    <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<VAR>var <NAME>Abstract = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;

<EXPR_RESULT><SETPROP><NAME>Object</NAME>.<STRING>extend</STRING> = <FUNCTION>function(<PARAMETER>destination</PARAMETER>, <PARAMETER>source</PARAMETER>) <BLOCK>{
  <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>source</NAME></ENUM_INIT_KEYS>)
    <BLOCK><EXPR_VOID><SETELEM><NAME><TARGET/>destination</NAME>[<NAME>property</NAME>] = <GETELEM><NAME>source</NAME>[<NAME>property</NAME>]</GETELEM></SETELEM></EXPR_VOID></BLOCK></LOOP><TARGET/><GOTO/><TARGET/>;</LOCAL_BLOCK>
  <RETURN>return <NAME>destination</NAME></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Object</NAME>, <OBJECTLIT>{
  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <TRY>try <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>object</NAME>)</CALL></IFNE>) <RETURN>return <STRING>'undefined'</STRING></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><SHEQ><NAME>object</NAME> === <NULL>null</NULL></SHEQ></IFNE>) <RETURN>return <STRING>'null'</STRING></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <HOOK><GETPROP><NAME>object</NAME>.<STRING>inspect</STRING></GETPROP> ? <CALL><NAME>object</NAME>.<GETPROP><STRING>inspect</STRING></GETPROP>()</CALL> : <CALL><NAME>object</NAME>.<GETPROP><STRING>toString</STRING></GETPROP>()</CALL></HOOK></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <BLOCK>if (<IFNE><INSTANCEOF><NAME>e</NAME> instanceof <NAME>RangeError</NAME></INSTANCEOF></IFNE>) <RETURN>return <STRING>'...'</STRING></RETURN>;</BLOCK><TARGET/>
      <THROW>throw <NAME>e</NAME></THROW>;
    }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>toJSON</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>type = typeof <TYPEOFNAME>object</TYPEOFNAME></NAME></VAR>;
    <SWITCH>switch (<NAME>type</NAME>) {
      <CASE>case <STRING>'undefined'</STRING></CASE>:
      <CASE>case <STRING>'function'</STRING></CASE>:
      <CASE>case <STRING>'unknown'</STRING>: <BLOCK><RETURN>return</RETURN></BLOCK></CASE>;
      <CASE>case <STRING>'boolean'</STRING>: <BLOCK><RETURN>return <CALL><NAME>object</NAME>.<GETPROP><STRING>toString</STRING></GETPROP>()</CALL></RETURN></BLOCK></CASE>;
    }</SWITCH><TARGET/>

    <BLOCK>if (<IFNE><SHEQ><NAME>object</NAME> === <NULL>null</NULL></SHEQ></IFNE>) <RETURN>return <STRING>'null'</STRING></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><NAME>object</NAME>.<STRING>toJSON</STRING></GETPROP></IFNE>) <RETURN>return <CALL><NAME>object</NAME>.<GETPROP><STRING>toJSON</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>object</NAME>)</CALL></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>object</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <VAR>var <NAME>value = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toJSON</STRING></GETPROP>(<GETELEM><NAME>object</NAME>[<NAME>property</NAME>]</GETELEM>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL></NOT></IFNE>)
        <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<ADD><ADD><CALL><NAME>property</NAME>.<GETPROP><STRING>toJSON</STRING></GETPROP>()</CALL> + <STRING>': '</STRING></ADD> + <NAME>value</NAME></ADD>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>

    <RETURN>return <ADD><ADD><STRING>'{'</STRING> + <CALL><NAME>results</NAME>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>', '</STRING>)</CALL></ADD> + <STRING>'}'</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toQueryString</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$H</NAME>(<NAME>object</NAME></CALL>).<GETPROP><STRING>toQueryString</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toHTML</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <HOOK><AND><NAME>object</NAME> &amp;&amp; <GETPROP><NAME>object</NAME>.<STRING>toHTML</STRING></GETPROP></AND> ? <CALL><NAME>object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>()</CALL> : <CALL><NAME>String</NAME>.<GETPROP><STRING>interpret</STRING></GETPROP>(<NAME>object</NAME>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>keys</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>keys = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>object</NAME></ENUM_INIT_KEYS>)
      <BLOCK><EXPR_VOID><CALL><NAME><TARGET/>keys</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>property</NAME>)</CALL></EXPR_VOID></BLOCK></LOOP><TARGET/><GOTO/><TARGET/>;</LOCAL_BLOCK>
    <RETURN>return <NAME>keys</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>values</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>values = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>object</NAME></ENUM_INIT_KEYS>)
      <BLOCK><EXPR_VOID><CALL><NAME><TARGET/>values</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETELEM><NAME>object</NAME>[<NAME>property</NAME>]</GETELEM>)</CALL></EXPR_VOID></BLOCK></LOOP><TARGET/><GOTO/><TARGET/>;</LOCAL_BLOCK>
    <RETURN>return <NAME>values</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>clone</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<OBJECTLIT>{ }</OBJECTLIT>, <NAME>object</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isElement</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <AND><NAME>object</NAME> &amp;&amp; <EQ><GETPROP><NAME>object</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isArray</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <AND><NAME>object</NAME> &amp;&amp; <SHEQ><GETPROP><NAME>object</NAME>.<STRING>constructor</STRING></GETPROP> === <NAME>Array</NAME></SHEQ></AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isHash</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return <INSTANCEOF><NAME>object</NAME> instanceof <NAME>Hash</NAME></INSTANCEOF></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isFunction</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return typeof <EQ><TYPEOFNAME>object</TYPEOFNAME> == <STRING>"function"</STRING></EQ></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isString</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return typeof <EQ><TYPEOFNAME>object</TYPEOFNAME> == <STRING>"string"</STRING></EQ></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isNumber</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return typeof <EQ><TYPEOFNAME>object</TYPEOFNAME> == <STRING>"number"</STRING></EQ></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isUndefined</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <RETURN>return typeof <EQ><TYPEOFNAME>object</TYPEOFNAME> == <STRING>"undefined"</STRING></EQ></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Function</NAME>.<STRING>prototype</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>argumentNames</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>names = <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>toString</STRING></GETPROP></CALL>().<GETELEM><CALL><GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^[\s\(]*function[^(]*\((.*?)\)/</REGEXP></CALL>)[<NUMBER>1</NUMBER></GETELEM>].<CALL><GETPROP><STRING>split</STRING></GETPROP>(<STRING>","</STRING></CALL>).<GETPROP><STRING>invoke</STRING></GETPROP>(<STRING>"strip"</STRING>)</CALL></NAME></VAR>;
    <RETURN>return <HOOK><AND><EQ><GETPROP><NAME>names</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; !<NOT><GETELEM><NAME>names</NAME>[<NUMBER>0</NUMBER>]</GETELEM></NOT></AND> ? <ARRAYLIT>[]</ARRAYLIT> : <NAME>names</NAME></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>bind</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><AND><LT><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> &lt; <NUMBER>2</NUMBER></LT> &amp;&amp; <CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<GETELEM><NAME>arguments</NAME>[<NUMBER>0</NUMBER>]</GETELEM>)</CALL></AND></IFNE>) <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME>, <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME>, <NAME>object = <CALL><NAME>args</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>__method</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<NAME>object</NAME>, <CALL><NAME>args</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></RETURN></BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>bindAsEventListener</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME>, <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME>, <NAME>object = <CALL><NAME>args</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>__method</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<NAME>object</NAME>, [<CALL><ARRAYLIT><OR><NAME>event</NAME> || <GETPROP><NAME>window</NAME>.<STRING>event</STRING></GETPROP></OR></ARRAYLIT>].<GETPROP><STRING>concat</STRING></GETPROP>(<NAME>args</NAME>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></RETURN></BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>curry</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP></NOT></IFNE>) <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME>, <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>__method</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<THIS>this</THIS>, <CALL><NAME>args</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></RETURN></BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>delay</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME>, <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME>, <NAME>timeout = <MUL><CALL><NAME>args</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL> * <NUMBER>1000</NUMBER></MUL></NAME></VAR>;
    <RETURN>return <CALL><NAME>window</NAME>.<GETPROP><STRING>setTimeout</STRING></GETPROP>(<FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>__method</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<NAME>__method</NAME>, <NAME>args</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>, <NAME>timeout</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>wrap</OBJLITNAME>: <FUNCTION>function(<PARAMETER>wrapper</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME></VAR>;
    <RETURN>return <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>wrapper</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<THIS>this</THIS>, [<CALL><ARRAYLIT><CALL><NAME>__method</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL></ARRAYLIT>].<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></RETURN></BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>methodize</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<STRING>_methodized</STRING></GETPROP></IFNE>) <RETURN>return <GETPROP><THIS>this</THIS>.<STRING>_methodized</STRING></GETPROP></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>__method = <THIS>this</THIS></NAME></VAR>;
    <RETURN>return <SETPROP><THIS>this</THIS>.<STRING>_methodized</STRING> = <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>__method</NAME>.<GETPROP><STRING>apply</STRING></GETPROP>(<NULL>null</NULL>, [<CALL><ARRAYLIT><THIS>this</THIS></ARRAYLIT>].<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></SETPROP></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<NAME>Function</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>defer</STRING> = <CALL><NAME>Function</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<GETPROP><STRING>delay</STRING></GETPROP>.<GETPROP><STRING>curry</STRING></GETPROP>(<NUMBER>0.01</NUMBER>)</CALL></SETPROP></EXPR_RESULT>;

<NAME>Date</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>toJSON</STRING> = <FUNCTION>function() <BLOCK>{
  <RETURN>return <ADD><ADD><ADD><ADD><ADD><ADD><ADD><ADD><ADD><ADD><ADD><ADD><STRING>'"'</STRING> + <CALL><THIS>this</THIS>.<GETPROP><STRING>getUTCFullYear</STRING></GETPROP>()</CALL></ADD> + <STRING>'-'</STRING></ADD> +
    (<CALL><ADD><CALL><THIS>this</THIS>.<GETPROP><STRING>getUTCMonth</STRING></GETPROP>()</CALL> + <NUMBER>1</NUMBER></ADD>).<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>)</CALL></ADD> + <STRING>'-'</STRING></ADD> +
    <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>getUTCDate</STRING></GETPROP></CALL>().<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>)</CALL></ADD> + <STRING>'T'</STRING></ADD> +
    <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>getUTCHours</STRING></GETPROP></CALL>().<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>)</CALL></ADD> + <STRING>':'</STRING></ADD> +
    <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>getUTCMinutes</STRING></GETPROP></CALL>().<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>)</CALL></ADD> + <STRING>':'</STRING></ADD> +
    <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>getUTCSeconds</STRING></GETPROP></CALL>().<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>)</CALL></ADD> + <STRING>'Z"'</STRING></ADD></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<VAR>var <NAME>Try = <OBJECTLIT>{
  <OBJLITNAME>these</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>returnValue</NAME></VAR>;

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <VAR>var <NAME>lambda = <GETELEM><NAME>arguments</NAME>[<NAME>i</NAME>]</GETELEM></NAME></VAR>;
      <TRY>try <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>returnValue</BINDNAME> = <CALL><NAME>lambda</NAME>()</CALL></SETNAME></EXPR_VOID>;
        <BREAK>break</BREAK>;
      }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ }</BLOCK></CATCH></TRY>
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>

    <RETURN>return <NAME>returnValue</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<NAME>RegExp</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>match</STRING> = <GETPROP><NAME>RegExp</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>test</STRING></GETPROP></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>RegExp</NAME>.<STRING>escape</STRING> = <FUNCTION>function(<PARAMETER>str</PARAMETER>) <BLOCK>{
  <RETURN>return <CALL><CALL><NAME>String</NAME>(<NAME>str</NAME></CALL>).<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/([.*+?^=!:${}()|[\]\/\\])/g</REGEXP>, <STRING>'\\$1'</STRING>)</CALL></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<VAR>var <NAME>PeriodicalExecuter = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>callback</PARAMETER>, <PARAMETER>frequency</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>callback</STRING> = <NAME>callback</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>frequency</STRING> = <NAME>frequency</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>currentlyExecuting</STRING> = <FALSE>false</FALSE></SETPROP></EXPR_VOID>;

    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>registerCallback</STRING></GETPROP>()</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>registerCallback</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>timer</STRING> = <CALL><NAME>setInterval</NAME>(<CALL><THIS>this</THIS>.<GETPROP><STRING>onTimerEvent</STRING></GETPROP>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL>, <MUL><GETPROP><THIS>this</THIS>.<STRING>frequency</STRING></GETPROP> * <NUMBER>1000</NUMBER></MUL>)</CALL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>execute</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>callback</STRING></GETPROP>(<THIS>this</THIS>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>stop</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<GETPROP><THIS>this</THIS>.<STRING>timer</STRING></GETPROP></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><NAME>clearInterval</NAME>(<GETPROP><THIS>this</THIS>.<STRING>timer</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>timer</STRING> = <NULL>null</NULL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>onTimerEvent</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<GETPROP><THIS>this</THIS>.<STRING>currentlyExecuting</STRING></GETPROP></NOT></IFNE>) <BLOCK>{
      <TRY>try <BLOCK>{
        <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>currentlyExecuting</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
        <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>execute</STRING></GETPROP>()</CALL></EXPR_VOID>;
      }</BLOCK> <FINALLY>finally <BLOCK>{
        <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>currentlyExecuting</STRING> = <FALSE>false</FALSE></SETPROP></EXPR_VOID>;
      }</BLOCK></FINALLY></TRY>
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></NAME></VAR>;
<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>String</NAME>, <OBJECTLIT>{
  <OBJLITNAME>interpret</OBJLITNAME>: <FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
    <RETURN>return <HOOK><EQ><NAME>value</NAME> == <NULL>null</NULL></EQ> ? <STRING>''</STRING> : <CALL><NAME>String</NAME>(<NAME>value</NAME>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,
  <OBJLITNAME>specialChar</OBJLITNAME>: <OBJECTLIT>{
    '<OBJLITNAME>\</OBJLITNAME>b': <STRING>'\\b'</STRING>,
    '<OBJLITNAME>\</OBJLITNAME>t': <STRING>'\\t'</STRING>,
    '<OBJLITNAME>\</OBJLITNAME>n': <STRING>'\\n'</STRING>,
    '<OBJLITNAME>\</OBJLITNAME>f': <STRING>'\\f'</STRING>,
    '<OBJLITNAME>\</OBJLITNAME>r': <STRING>'\\r'</STRING>,
    '<OBJLITNAME>\</OBJLITNAME>\': <STRING>'\\\\'</STRING>
  }</OBJECTLIT>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>String</NAME>.<STRING>prototype</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>gsub</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>, <PARAMETER>replacement</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>result = <STRING>''</STRING></NAME>, <NAME>source = <THIS>this</THIS></NAME>, <NAME>match</NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>replacement</BINDNAME> = <CALL><NAME>arguments</NAME>.<GETPROP><STRING>callee</STRING></GETPROP>.<GETPROP><STRING>prepareReplacement</STRING></GETPROP>(<NAME>replacement</NAME>)</CALL></SETNAME></EXPR_VOID>;

    <LOOP><EMPTY/>while (<IFEQ><GT><GETPROP><NAME><TARGET/>source</NAME>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>0</NUMBER></GT></IFEQ>) <BLOCK><TARGET/>{
      <BLOCK>if (<IFNE><SETNAME><BINDNAME>match</BINDNAME> = <CALL><NAME>source</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>pattern</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>result</NAME></BINDNAME> += <CALL><NAME>source</NAME>.<GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>0</NUMBER>, <GETPROP><NAME>match</NAME>.<STRING>index</STRING></GETPROP>)</CALL></ADD></SETNAME></EXPR_VOID>;
        <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>result</NAME></BINDNAME> += <CALL><NAME>String</NAME>.<GETPROP><STRING>interpret</STRING></GETPROP>(<CALL><NAME>replacement</NAME>(<NAME>match</NAME>)</CALL>)</CALL></ADD></SETNAME></EXPR_VOID>;
        <EXPR_VOID><SETNAME><BINDNAME>source</BINDNAME>  = <CALL><NAME>source</NAME>.<GETPROP><STRING>slice</STRING></GETPROP>(<ADD><GETPROP><NAME>match</NAME>.<STRING>index</STRING></GETPROP> + <GETPROP><GETELEM><NAME>match</NAME>[<NUMBER>0</NUMBER></GETELEM>].<STRING>length</STRING></GETPROP></ADD>)</CALL></SETNAME></EXPR_VOID>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <EXPR_VOID><COMMA><SETNAME><BINDNAME><ADD><NAME>result</NAME></BINDNAME> += <NAME>source</NAME></ADD></SETNAME>, <SETNAME><BINDNAME>source</BINDNAME> = <STRING>''</STRING></SETNAME></COMMA></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>sub</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>, <PARAMETER>replacement</PARAMETER>, <PARAMETER>count</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>replacement</BINDNAME> = <CALL><THIS>this</THIS>.<GETPROP><STRING>gsub</STRING></GETPROP>.<GETPROP><STRING>prepareReplacement</STRING></GETPROP>(<NAME>replacement</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>count</BINDNAME> = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>count</NAME>)</CALL> ? <NUMBER>1</NUMBER> : <NAME>count</NAME></HOOK></SETNAME></EXPR_VOID>;

    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>gsub</STRING></GETPROP>(<NAME>pattern</NAME>, <FUNCTION>function(<PARAMETER>match</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><LT>--<DEC><NAME>count</NAME></DEC> &lt; <NUMBER>0</NUMBER></LT></IFNE>) <RETURN>return <GETELEM><NAME>match</NAME>[<NUMBER>0</NUMBER>]</GETELEM></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NAME>replacement</NAME>(<NAME>match</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>scan</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>, <PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>gsub</STRING></GETPROP>(<NAME>pattern</NAME>, <NAME>iterator</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <CALL><NAME>String</NAME>(<THIS>this</THIS>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>truncate</OBJLITNAME>: <FUNCTION>function(<PARAMETER>length</PARAMETER>, <PARAMETER>truncation</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>length</BINDNAME> = <OR><NAME>length</NAME> || <NUMBER>30</NUMBER></OR></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>truncation</BINDNAME> = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>truncation</NAME>)</CALL> ? <STRING>'...'</STRING> : <NAME>truncation</NAME></HOOK></SETNAME></EXPR_VOID>;
    <RETURN>return <HOOK><GT><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> &gt; <NAME>length</NAME></GT> ?
      <ADD><CALL><THIS>this</THIS>.<GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>0</NUMBER>, <SUB><NAME>length</NAME> - <GETPROP><NAME>truncation</NAME>.<STRING>length</STRING></GETPROP></SUB>)</CALL> + <NAME>truncation</NAME></ADD> : <CALL><NAME>String</NAME>(<THIS>this</THIS>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>strip</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/^\s+/</REGEXP>, <STRING>''</STRING></CALL>).<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/\s+$/</REGEXP>, <STRING>''</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>stripTags</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&lt;\/?[^&gt;]+&gt;/gi</REGEXP>, <STRING>''</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>stripScripts</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>replace</STRING></GETPROP>(<NEW>new <NAME>RegExp</NAME>(<GETPROP><NAME>Prototype</NAME>.<STRING>ScriptFragment</STRING></GETPROP>, <STRING>'img'</STRING>)</NEW>, <STRING>''</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>extractScripts</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>matchAll = <NEW>new <NAME>RegExp</NAME>(<GETPROP><NAME>Prototype</NAME>.<STRING>ScriptFragment</STRING></GETPROP>, <STRING>'img'</STRING>)</NEW></NAME></VAR>;
    <VAR>var <NAME>matchOne = <NEW>new <NAME>RegExp</NAME>(<GETPROP><NAME>Prototype</NAME>.<STRING>ScriptFragment</STRING></GETPROP>, <STRING>'im'</STRING>)</NEW></NAME></VAR>;
    <RETURN>return (<CALL><OR><CALL><THIS>this</THIS>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>matchAll</NAME>)</CALL> || <ARRAYLIT>[]</ARRAYLIT></OR>).<GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>scriptTag</PARAMETER>) <BLOCK>{
      <RETURN>return (<GETELEM><OR><CALL><NAME>scriptTag</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>matchOne</NAME>)</CALL> || [<ARRAYLIT><STRING>''</STRING>, <STRING>''</STRING>]</ARRAYLIT></OR>)[<NUMBER>1</NUMBER>]</GETELEM></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>evalScripts</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>extractScripts</STRING></GETPROP></CALL>().<GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>script</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>eval</NAME>(<NAME>script</NAME>)</CALL></RETURN></BLOCK> }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>escapeHTML</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>self = <GETPROP><NAME>arguments</NAME>.<STRING>callee</STRING></GETPROP></NAME></VAR>;
    <NAME>self</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>text</STRING></GETPROP>.<STRING>data</STRING> = <THIS>this</THIS></SETPROP></EXPR_VOID>;
    <RETURN>return <GETPROP><NAME>self</NAME>.<GETPROP><STRING>div</STRING></GETPROP>.<STRING>innerHTML</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>unescapeHTML</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>div = <NEW>new <NAME>Element</NAME>(<STRING>'div'</STRING>)</NEW></NAME></VAR>;
    <EXPR_VOID><SETPROP><NAME>div</NAME>.<STRING>innerHTML</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>stripTags</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <RETURN>return <HOOK><GETELEM><NAME>div</NAME>.<GETPROP><STRING>childNodes</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM> ? (<HOOK><GT><GETPROP><NAME>div</NAME>.<GETPROP><STRING>childNodes</STRING></GETPROP>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>1</NUMBER></GT> ?
      <CALL><CALL><NAME>$A</NAME>(<GETPROP><NAME>div</NAME>.<STRING>childNodes</STRING></GETPROP></CALL>).<GETPROP><STRING>inject</STRING></GETPROP>(<STRING>''</STRING>, <FUNCTION>function(<PARAMETER>memo</PARAMETER>, <PARAMETER>node</PARAMETER>) <BLOCK>{ <RETURN>return <ADD><NAME>memo</NAME>+<GETPROP><NAME>node</NAME>.<STRING>nodeValue</STRING></GETPROP></ADD></RETURN></BLOCK> }</FUNCTION>)</CALL> :
      <GETPROP><NAME>div</NAME>.<GETELEM><GETPROP><STRING>childNodes</STRING></GETPROP>[<NUMBER>0</NUMBER></GETELEM>].<STRING>nodeValue</STRING></GETPROP>)</HOOK> : <STRING>''</STRING></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toQueryParams</OBJLITNAME>: <FUNCTION>function(<PARAMETER>separator</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>match = <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>strip</STRING></GETPROP></CALL>().<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/([^?#]*)(#.*)?$/</REGEXP>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><NOT>!<NAME>match</NAME></NOT></IFNE>) <RETURN>return <OBJECTLIT>{ }</OBJECTLIT></RETURN>;</BLOCK><TARGET/>

    <RETURN>return <CALL><GETELEM><NAME>match</NAME>[<NUMBER>1</NUMBER></GETELEM>].<CALL><GETPROP><STRING>split</STRING></GETPROP>(<OR><NAME>separator</NAME> || <STRING>'&amp;'</STRING></OR></CALL>).<GETPROP><STRING>inject</STRING></GETPROP>(<OBJECTLIT>{ }</OBJECTLIT>, <FUNCTION>function(<PARAMETER>hash</PARAMETER>, <PARAMETER>pair</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><GETELEM>(<SETNAME><BINDNAME>pair</BINDNAME> = <CALL><NAME>pair</NAME>.<GETPROP><STRING>split</STRING></GETPROP>(<STRING>'='</STRING>)</CALL></SETNAME>)[<NUMBER>0</NUMBER>]</GETELEM></IFNE>) <BLOCK>{
        <VAR>var <NAME>key = <CALL><NAME>decodeURIComponent</NAME>(<CALL><NAME>pair</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
        <VAR>var <NAME>value = <HOOK><GT><GETPROP><NAME>pair</NAME>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>1</NUMBER></GT> ? <CALL><NAME>pair</NAME>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>'='</STRING>)</CALL> : <GETELEM><NAME>pair</NAME>[<NUMBER>0</NUMBER>]</GETELEM></HOOK></NAME></VAR>;
        <BLOCK>if (<IFNE><NE><NAME>value</NAME> != <NAME>undefined</NAME></NE></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><NAME>decodeURIComponent</NAME>(<NAME>value</NAME>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

        <BLOCK>if (<IFNE><IN><NAME>key</NAME> in <NAME>hash</NAME></IN></IFNE>) <BLOCK>{
          <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<GETELEM><NAME>hash</NAME>[<NAME>key</NAME>]</GETELEM>)</CALL></NOT></IFNE>) <EXPR_VOID><SETELEM><NAME>hash</NAME>[<NAME>key</NAME>] = [<ARRAYLIT><GETELEM><NAME>hash</NAME>[<NAME>key</NAME>]</GETELEM>]</ARRAYLIT></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
          <EXPR_VOID><CALL><GETELEM><NAME>hash</NAME>[<NAME>key</NAME></GETELEM>].<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;
        }</BLOCK>
        else <EXPR_VOID><SETELEM><NAME><TARGET/>hash</NAME>[<NAME>key</NAME>] = <NAME>value</NAME></SETELEM></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
      }</BLOCK></BLOCK><TARGET/>
      <RETURN>return <NAME>hash</NAME></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toArray</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>split</STRING></GETPROP>(<STRING>''</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>succ</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><CALL><THIS>this</THIS>.<GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>0</NUMBER>, <SUB><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> - <NUMBER>1</NUMBER></SUB>)</CALL> +
      <CALL><NAME>String</NAME>.<GETPROP><STRING>fromCharCode</STRING></GETPROP>(<ADD><CALL><THIS>this</THIS>.<GETPROP><STRING>charCodeAt</STRING></GETPROP>(<SUB><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> - <NUMBER>1</NUMBER></SUB>)</CALL> + <NUMBER>1</NUMBER></ADD>)</CALL></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>times</OBJLITNAME>: <FUNCTION>function(<PARAMETER>count</PARAMETER>) <BLOCK>{
    <RETURN>return <HOOK><LT><NAME>count</NAME> &lt; <NUMBER>1</NUMBER></LT> ? <STRING>''</STRING> : <CALL><NEW>new <NAME>Array</NAME>(<ADD><NAME>count</NAME> + <NUMBER>1</NUMBER></ADD></NEW>).<GETPROP><STRING>join</STRING></GETPROP>(<THIS>this</THIS>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>camelize</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>parts = <CALL><THIS>this</THIS>.<GETPROP><STRING>split</STRING></GETPROP>(<STRING>'-'</STRING>)</CALL></NAME>, <NAME>len = <GETPROP><NAME>parts</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><EQ><NAME>len</NAME> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <GETELEM><NAME>parts</NAME>[<NUMBER>0</NUMBER>]</GETELEM></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>camelized = <HOOK><EQ><CALL><THIS>this</THIS>.<GETPROP><STRING>charAt</STRING></GETPROP>(<NUMBER>0</NUMBER>)</CALL> == <STRING>'-'</STRING></EQ>
      ? <ADD><CALL><GETELEM><NAME>parts</NAME>[<NUMBER>0</NUMBER></GETELEM>].<CALL><GETPROP><STRING>charAt</STRING></GETPROP>(<NUMBER>0</NUMBER></CALL>).<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL> + <CALL><GETELEM><NAME>parts</NAME>[<NUMBER>0</NUMBER></GETELEM>].<GETPROP><STRING>substring</STRING></GETPROP>(<NUMBER>1</NUMBER>)</CALL></ADD>
      : <GETELEM><NAME>parts</NAME>[<NUMBER>0</NUMBER>]</GETELEM></HOOK></NAME></VAR>;

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>1</NUMBER></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>len</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME><TARGET/>camelized</NAME></BINDNAME> += <ADD><CALL><GETELEM><NAME>parts</NAME>[<NAME>i</NAME></GETELEM>].<CALL><GETPROP><STRING>charAt</STRING></GETPROP>(<NUMBER>0</NUMBER></CALL>).<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL> + <CALL><GETELEM><NAME>parts</NAME>[<NAME>i</NAME></GETELEM>].<GETPROP><STRING>substring</STRING></GETPROP>(<NUMBER>1</NUMBER>)</CALL></ADD></ADD></SETNAME></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;

    <RETURN>return <NAME>camelized</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>capitalize</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>charAt</STRING></GETPROP>(<NUMBER>0</NUMBER></CALL>).<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL> + <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>substring</STRING></GETPROP>(<NUMBER>1</NUMBER></CALL>).<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>underscore</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/::/</REGEXP>, <STRING>'/'</STRING></CALL>).<CALL><GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/([A-Z]+)([A-Z][a-z])/</REGEXP>,<STRING>'#{1}_#{2}'</STRING></CALL>).<CALL><GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/([a-z\d])([A-Z])/</REGEXP>,<STRING>'#{1}_#{2}'</STRING></CALL>).<CALL><GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/-/</REGEXP>,<STRING>'_'</STRING></CALL>).<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>dasherize</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/_/</REGEXP>,<STRING>'-'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>useDoubleQuotes</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>escapedString = <CALL><THIS>this</THIS>.<GETPROP><STRING>gsub</STRING></GETPROP>(<REGEXP>/[\x00-\x1f\\]/</REGEXP>, <FUNCTION>function(<PARAMETER>match</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>character = <GETELEM><NAME>String</NAME>.<GETPROP><STRING>specialChar</STRING></GETPROP>[<GETELEM><NAME>match</NAME>[<NUMBER>0</NUMBER>]</GETELEM>]</GETELEM></NAME></VAR>;
      <RETURN>return <HOOK><NAME>character</NAME> ? <NAME>character</NAME> : <ADD><STRING>'\\u00'</STRING> + <CALL><GETELEM><NAME>match</NAME>[<NUMBER>0</NUMBER></GETELEM>].<CALL><GETPROP><STRING>charCodeAt</STRING></GETPROP></CALL>().<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>, <NUMBER>16</NUMBER>)</CALL></ADD></HOOK></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><NAME>useDoubleQuotes</NAME></IFNE>) <RETURN>return <ADD><ADD><STRING>'"'</STRING> + <CALL><NAME>escapedString</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/"/g</REGEXP>, <STRING>'\\"'</STRING>)</CALL></ADD> + <STRING>'"'</STRING></ADD></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <ADD><ADD><STRING>"'"</STRING> + <CALL><NAME>escapedString</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/'/g</REGEXP>, <STRING>'\\\''</STRING>)</CALL></ADD> + <STRING>"'"</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>inspect</STRING></GETPROP>(<TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>unfilterJSON</OBJLITNAME>: <FUNCTION>function(<PARAMETER>filter</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>sub</STRING></GETPROP>(<OR><NAME>filter</NAME> || <GETPROP><NAME>Prototype</NAME>.<STRING>JSONFilter</STRING></GETPROP></OR>, <STRING>'#{1}'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>isJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>str = <THIS>this</THIS></NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>str</NAME>.<GETPROP><STRING>blank</STRING></GETPROP>()</CALL></IFNE>) <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETNAME><BINDNAME>str</BINDNAME> = <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/\\./g</REGEXP>, <STRING>'@'</STRING></CALL>).<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/"[^"\\\n\r]*"/g</REGEXP>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
    <RETURN>return (<CALL><REGEXP>/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>str</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>evalJSON</OBJLITNAME>: <FUNCTION>function(<PARAMETER>sanitize</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>json = <CALL><THIS>this</THIS>.<GETPROP><STRING>unfilterJSON</STRING></GETPROP>()</CALL></NAME></VAR>;
    <TRY>try <BLOCK>{
      <BLOCK>if (<IFNE><OR>!<NOT><NAME>sanitize</NAME></NOT> || <CALL><NAME>json</NAME>.<GETPROP><STRING>isJSON</STRING></GETPROP>()</CALL></OR></IFNE>) <RETURN>return <CALL><NAME>eval</NAME>(<ADD><ADD><STRING>'('</STRING> + <NAME>json</NAME></ADD> + <STRING>')'</STRING></ADD>)</CALL></RETURN>;</BLOCK><TARGET/>
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ }</BLOCK></CATCH></TRY>
    <THROW>throw <NEW>new <NAME>SyntaxError</NAME>(<ADD><STRING>'Badly formed JSON string: '</STRING> + <CALL><THIS>this</THIS>.<GETPROP><STRING>inspect</STRING></GETPROP>()</CALL></ADD>)</NEW></THROW>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>include</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>) <BLOCK>{
    <RETURN>return <GT><CALL><THIS>this</THIS>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<NAME>pattern</NAME>)</CALL> &gt; -<NUMBER>1</NUMBER></GT></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>startsWith</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>) <BLOCK>{
    <RETURN>return <SHEQ><CALL><THIS>this</THIS>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<NAME>pattern</NAME>)</CALL> === <NUMBER>0</NUMBER></SHEQ></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>endsWith</OBJLITNAME>: <FUNCTION>function(<PARAMETER>pattern</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>d = <SUB><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> - <GETPROP><NAME>pattern</NAME>.<STRING>length</STRING></GETPROP></SUB></NAME></VAR>;
    <RETURN>return <AND><GE><NAME>d</NAME> &gt;= <NUMBER>0</NUMBER></GE> &amp;&amp; <SHEQ><CALL><THIS>this</THIS>.<GETPROP><STRING>lastIndexOf</STRING></GETPROP>(<NAME>pattern</NAME>)</CALL> === <NAME>d</NAME></SHEQ></AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>empty</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <EQ><THIS>this</THIS> == <STRING>''</STRING></EQ></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>blank</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><REGEXP>/^\s*$/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<THIS>this</THIS>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>interpolate</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>, <PARAMETER>pattern</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<THIS>this</THIS>, <NAME>pattern</NAME></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>object</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<BLOCK>if (<IFNE><OR><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP> || <GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></OR></IFNE>) <EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>String</NAME>.<STRING>prototype</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>escapeHTML</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&amp;/g</REGEXP>,<STRING>'&amp;amp;'</STRING></CALL>).<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&lt;/g</REGEXP>,<STRING>'&amp;lt;'</STRING></CALL>).<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&gt;/g</REGEXP>,<STRING>'&amp;gt;'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,
  <OBJLITNAME>unescapeHTML</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&amp;amp;/g</REGEXP>,<STRING>'&amp;'</STRING></CALL>).<CALL><GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&amp;lt;/g</REGEXP>,<STRING>'&lt;'</STRING></CALL>).<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/&amp;gt;/g</REGEXP>,<STRING>'&gt;'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;</BLOCK><TARGET/>

<NAME>String</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<EXPR_RESULT><SETPROP><GETPROP><STRING>gsub</STRING></GETPROP>.<STRING>prepareReplacement</STRING> = <FUNCTION>function(<PARAMETER>replacement</PARAMETER>) <BLOCK>{
  <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>replacement</NAME>)</CALL></IFNE>) <RETURN>return <NAME>replacement</NAME></RETURN>;</BLOCK><TARGET/>
  <VAR>var <NAME>template = <NEW>new <NAME>Template</NAME>(<NAME>replacement</NAME>)</NEW></NAME></VAR>;
  <RETURN>return <FUNCTION>function(<PARAMETER>match</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>template</NAME>.<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>match</NAME>)</CALL></RETURN></BLOCK> }</FUNCTION></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<NAME>String</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>parseQuery</STRING> = <GETPROP><NAME>String</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>toQueryParams</STRING></GETPROP></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>String</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>escapeHTML</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>div</OBJLITNAME>:  <CALL><NAME>document</NAME>.<GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING>)</CALL>,
  <OBJLITNAME>text</OBJLITNAME>: <CALL><NAME>document</NAME>.<GETPROP><STRING>createTextNode</STRING></GETPROP>(<STRING>''</STRING>)</CALL>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

with (<BLOCK><ENTERWITH><GETPROP><NAME>String</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>escapeHTML</STRING></GETPROP></ENTERWITH>) <WITH><EXPR_RESULT><CALL><NAME>div</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>text</NAME>)</CALL></EXPR_RESULT></WITH></BLOCK>;

<VAR>var <NAME>Template = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>template</PARAMETER>, <PARAMETER>pattern</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>template</STRING> = <CALL><NAME>template</NAME>.<GETPROP><STRING>toString</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>pattern</STRING> = <OR><NAME>pattern</NAME> || <GETPROP><NAME>Template</NAME>.<STRING>Pattern</STRING></GETPROP></OR></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>evaluate</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETPROP><NAME>object</NAME>.<STRING>toTemplateReplacements</STRING></GETPROP>)</CALL></IFNE>)
      <EXPR_VOID><SETNAME><BINDNAME>object</BINDNAME> = <CALL><NAME>object</NAME>.<GETPROP><STRING>toTemplateReplacements</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>template</STRING></GETPROP>.<GETPROP><STRING>gsub</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>pattern</STRING></GETPROP>, <CALL><FUNCTION>function(<PARAMETER>match</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><NAME>object</NAME> == <NULL>null</NULL></EQ></IFNE>) <RETURN>return <STRING>''</STRING></RETURN>;</BLOCK><TARGET/>

      <VAR>var <NAME>before = <OR><GETELEM><NAME>match</NAME>[<NUMBER>1</NUMBER>]</GETELEM> || <STRING>''</STRING></OR></NAME></VAR>;
      <BLOCK>if (<IFNE><EQ><NAME>before</NAME> == <STRING>'\\'</STRING></EQ></IFNE>) <RETURN>return <GETELEM><NAME>match</NAME>[<NUMBER>2</NUMBER>]</GETELEM></RETURN>;</BLOCK><TARGET/>

      <VAR>var <NAME>ctx = <NAME>object</NAME></NAME>, <NAME>expr = <GETELEM><NAME>match</NAME>[<NUMBER>3</NUMBER>]</GETELEM></NAME></VAR>;
      <VAR>var <NAME>pattern = <REGEXP>/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/</REGEXP></NAME></VAR>;
      <EXPR_VOID><SETNAME><BINDNAME>match</BINDNAME> = <CALL><NAME>pattern</NAME>.<GETPROP><STRING>exec</STRING></GETPROP>(<NAME>expr</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><EQ><NAME>match</NAME> == <NULL>null</NULL></EQ></IFNE>) <RETURN>return <NAME>before</NAME></RETURN>;</BLOCK><TARGET/>

      <LOOP><EMPTY/>while (<IFEQ><NE><NAME><TARGET/>match</NAME> != <NULL>null</NULL></NE></IFEQ>) <BLOCK><TARGET/>{
        <VAR>var <NAME>comp = <HOOK><CALL><GETELEM><NAME>match</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>startsWith</STRING></GETPROP>(<STRING>'['</STRING>)</CALL> ? <CALL><GETELEM><NAME>match</NAME>[<NUMBER>2</NUMBER></GETELEM>].<GETPROP><STRING>gsub</STRING></GETPROP>(<STRING>'\\\\]'</STRING>, <STRING>']'</STRING>)</CALL> : <GETELEM><NAME>match</NAME>[<NUMBER>1</NUMBER>]</GETELEM></HOOK></NAME></VAR>;
        <EXPR_VOID><SETNAME><BINDNAME>ctx</BINDNAME> = <GETELEM><NAME>ctx</NAME>[<NAME>comp</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><OR><EQ><NULL>null</NULL> == <NAME>ctx</NAME></EQ> || <EQ><STRING>''</STRING> == <GETELEM><NAME>match</NAME>[<NUMBER>3</NUMBER>]</GETELEM></EQ></OR></IFNE>) <BREAK>break</BREAK>;</BLOCK><TARGET/>
        <EXPR_VOID><SETNAME><BINDNAME>expr</BINDNAME> = <CALL><NAME>expr</NAME>.<GETPROP><STRING>substring</STRING></GETPROP>(<HOOK><EQ><STRING>'['</STRING> == <GETELEM><NAME>match</NAME>[<NUMBER>3</NUMBER>]</GETELEM></EQ> ? <GETPROP><GETELEM><NAME>match</NAME>[<NUMBER>1</NUMBER></GETELEM>].<STRING>length</STRING></GETPROP> : <GETPROP><GETELEM><NAME>match</NAME>[<NUMBER>0</NUMBER></GETELEM>].<STRING>length</STRING></GETPROP></HOOK>)</CALL></SETNAME></EXPR_VOID>;
        <EXPR_VOID><SETNAME><BINDNAME>match</BINDNAME> = <CALL><NAME>pattern</NAME>.<GETPROP><STRING>exec</STRING></GETPROP>(<NAME>expr</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>

      <RETURN>return <ADD><NAME>before</NAME> + <CALL><NAME>String</NAME>.<GETPROP><STRING>interpret</STRING></GETPROP>(<NAME>ctx</NAME>)</CALL></ADD></RETURN>;</BLOCK>
    }</FUNCTION>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></NAME></VAR>;
<EXPR_RESULT><SETPROP><NAME>Template</NAME>.<STRING>Pattern</STRING> = <REGEXP>/(^|.|\r|\n)(#\{(.*?)\})/</REGEXP></SETPROP></EXPR_RESULT>;

<VAR>var <NAME>$break = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;

<VAR>var <NAME>Enumerable = <OBJECTLIT>{
  <OBJLITNAME>each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>index = <NUMBER>0</NUMBER></NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <TRY>try <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>_each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <INC><NAME>index</NAME></INC>++)</CALL></EXPR_VOID>;
      </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <BLOCK>if (<IFNE><NE><NAME>e</NAME> != <NAME>$break</NAME></NE></IFNE>) <THROW>throw <NAME>e</NAME></THROW>;</BLOCK><TARGET/>
    }</BLOCK></CATCH></TRY>
    <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>eachSlice</OBJLITNAME>: <FUNCTION>function(<PARAMETER>number</PARAMETER>, <PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>index = -<NEG><NAME>number</NAME></NEG></NAME>, <NAME>slices = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>array = <CALL><THIS>this</THIS>.<GETPROP><STRING>toArray</STRING></GETPROP>()</CALL></NAME></VAR>;
    <LOOP><EMPTY/>while (<IFEQ><LT><TARGET/>(<SETNAME><BINDNAME><ADD><NAME>index</NAME></BINDNAME> += <NAME>number</NAME></ADD>)</SETNAME> &lt; <GETPROP><NAME>array</NAME>.<STRING>length</STRING></GETPROP></LT></IFEQ>)
      <EXPR_VOID><CALL><NAME><TARGET/>slices</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>array</NAME>.<GETPROP><STRING>slice</STRING></GETPROP>(<NAME>index</NAME>, <ADD><NAME>index</NAME>+<NAME>number</NAME></ADD>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
    <RETURN>return <CALL><NAME>slices</NAME>.<GETPROP><STRING>collect</STRING></GETPROP>(<NAME>iterator</NAME>, <NAME>context</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>all</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result = <TRUE>true</TRUE></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>result</BINDNAME> = <AND><NAME>result</NAME> &amp;&amp; !!<NOT><NOT><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></NOT></NOT></AND></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><NOT>!<NAME>result</NAME></NOT></IFNE>) <THROW>throw <NAME>$break</NAME></THROW>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>any</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result = <FALSE>false</FALSE></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><SETNAME><BINDNAME>result</BINDNAME> = !!<NOT><NOT><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></NOT></NOT></SETNAME></IFNE>)
        <THROW>throw <NAME>$break</NAME></THROW>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>collect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>detect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result</NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>result</BINDNAME> = <NAME>value</NAME></SETNAME></EXPR_VOID>;
        <THROW>throw <NAME>$break</NAME></THROW>;
      }</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>findAll</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></IFNE>)
        <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>grep</OBJLITNAME>: <FUNCTION>function(<PARAMETER>filter</PARAMETER>, <PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;

    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>filter</NAME>)</CALL></IFNE>)
      <EXPR_VOID><SETNAME><BINDNAME>filter</BINDNAME> = <NEW>new <NAME>RegExp</NAME>(<NAME>filter</NAME>)</NEW></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>filter</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>value</NAME>)</CALL></IFNE>)
        <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>include</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>indexOf</STRING></GETPROP>)</CALL></IFNE>)
      <BLOCK>if (<IFNE><NE><CALL><THIS>this</THIS>.<GETPROP><STRING>indexOf</STRING></GETPROP>(<NAME>object</NAME>)</CALL> != -<NUMBER>1</NUMBER></NE></IFNE>) <RETURN>return <TRUE>true</TRUE></RETURN>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>

    <VAR>var <NAME>found = <FALSE>false</FALSE></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><NAME>value</NAME> == <NAME>object</NAME></EQ></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>found</BINDNAME> = <TRUE>true</TRUE></SETNAME></EXPR_VOID>;
        <THROW>throw <NAME>$break</NAME></THROW>;
      }</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>found</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inGroupsOf</OBJLITNAME>: <FUNCTION>function(<PARAMETER>number</PARAMETER>, <PARAMETER>fillWith</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>fillWith</BINDNAME> = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>fillWith</NAME>)</CALL> ? <NULL>null</NULL> : <NAME>fillWith</NAME></HOOK></SETNAME></EXPR_VOID>;
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>eachSlice</STRING></GETPROP>(<NAME>number</NAME>, <FUNCTION>function(<PARAMETER>slice</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>while(<IFEQ><LT><GETPROP><NAME><TARGET/>slice</NAME>.<STRING>length</STRING></GETPROP> &lt; <NAME>number</NAME></LT></IFEQ>) <EXPR_VOID><CALL><NAME><TARGET/>slice</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>fillWith</NAME>)</CALL></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
      <RETURN>return <NAME>slice</NAME></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inject</OBJLITNAME>: <FUNCTION>function(<PARAMETER>memo</PARAMETER>, <PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>memo</BINDNAME> = <CALL><NAME>iterator</NAME>(<NAME>memo</NAME>, <NAME>value</NAME>, <NAME>index</NAME>)</CALL></SETNAME></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>memo</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>invoke</OBJLITNAME>: <FUNCTION>function(<PARAMETER>method</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>args = <CALL><CALL><NAME>$A</NAME>(<NAME>arguments</NAME></CALL>).<GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>1</NUMBER>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><GETELEM><NAME>value</NAME>[<NAME>method</NAME></GETELEM>].<GETPROP><STRING>apply</STRING></GETPROP>(<NAME>value</NAME>, <NAME>args</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>max</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result</NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><OR><EQ><NAME>result</NAME> == <NULL>null</NULL></EQ> || <GE><NAME>value</NAME> &gt;= <NAME>result</NAME></GE></OR></IFNE>)
        <EXPR_VOID><SETNAME><BINDNAME>result</BINDNAME> = <NAME>value</NAME></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>min</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result</NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><OR><EQ><NAME>result</NAME> == <NULL>null</NULL></EQ> || <LT><NAME>value</NAME> &lt; <NAME>result</NAME></LT></OR></IFNE>)
        <EXPR_VOID><SETNAME><BINDNAME>result</BINDNAME> = <NAME>value</NAME></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>partition</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <HOOK><NAME>iterator</NAME> ? <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL> : <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>trues = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>falses = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      (<EXPR_VOID><CALL><HOOK><CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL> ?
        <NAME>trues</NAME> : <NAME>falses</NAME></HOOK>).<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return [<ARRAYLIT><NAME>trues</NAME>, <NAME>falses</NAME>]</ARRAYLIT></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>pluck</OBJLITNAME>: <FUNCTION>function(<PARAMETER>property</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETELEM><NAME>value</NAME>[<NAME>property</NAME>]</GETELEM>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>reject</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><NOT>!<CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL></NOT></IFNE>)
        <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>sortBy</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>, <PARAMETER>context</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>iterator</NAME>.<GETPROP><STRING>bind</STRING></GETPROP>(<NAME>context</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <RETURN>return <OBJECTLIT>{<OBJLITNAME>value</OBJLITNAME>: <NAME>value</NAME>, <OBJLITNAME>criteria</OBJLITNAME>: <CALL><NAME>iterator</NAME>(<NAME>value</NAME>, <NAME>index</NAME>)</CALL>}</OBJECTLIT></RETURN>;</BLOCK>
    }</FUNCTION></CALL>).<CALL><GETPROP><STRING>sort</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>left</PARAMETER>, <PARAMETER>right</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>a = <GETPROP><NAME>left</NAME>.<STRING>criteria</STRING></GETPROP></NAME>, <NAME>b = <GETPROP><NAME>right</NAME>.<STRING>criteria</STRING></GETPROP></NAME></VAR>;
      <RETURN>return <HOOK><LT><NAME>a</NAME> &lt; <NAME>b</NAME></LT> ? -<NUMBER>1</NUMBER> : <HOOK><GT><NAME>a</NAME> &gt; <NAME>b</NAME></GT> ? <NUMBER>1</NUMBER> : <NUMBER>0</NUMBER></HOOK></HOOK></RETURN>;</BLOCK>
    }</FUNCTION></CALL>).<GETPROP><STRING>pluck</STRING></GETPROP>(<STRING>'value'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toArray</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>map</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>zip</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>iterator = <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></NAME>, <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<CALL><NAME>args</NAME>.<GETPROP><STRING>last</STRING></GETPROP>()</CALL>)</CALL></IFNE>)
      <EXPR_VOID><SETNAME><BINDNAME>iterator</BINDNAME> = <CALL><NAME>args</NAME>.<GETPROP><STRING>pop</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <VAR>var <NAME>collections = [<CALL><ARRAYLIT><THIS>this</THIS></ARRAYLIT>].<CALL><GETPROP><STRING>concat</STRING></GETPROP>(<NAME>args</NAME></CALL>).<GETPROP><STRING>map</STRING></GETPROP>(<NAME>$A</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>iterator</NAME>(<CALL><NAME>collections</NAME>.<GETPROP><STRING>pluck</STRING></GETPROP>(<NAME>index</NAME>)</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>size</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETPROP><THIS>this</THIS>.<CALL><GETPROP><STRING>toArray</STRING></GETPROP></CALL>().<STRING>length</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><ADD><STRING>'#&lt;Enumerable:'</STRING> + <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>toArray</STRING></GETPROP></CALL>().<GETPROP><STRING>inspect</STRING></GETPROP>()</CALL></ADD> + <STRING>'&gt;'</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Enumerable</NAME>, <OBJECTLIT>{
  <OBJLITNAME>map</OBJLITNAME>:     <GETPROP><NAME>Enumerable</NAME>.<STRING>collect</STRING></GETPROP>,
  <OBJLITNAME>find</OBJLITNAME>:    <GETPROP><NAME>Enumerable</NAME>.<STRING>detect</STRING></GETPROP>,
  <OBJLITNAME>select</OBJLITNAME>:  <GETPROP><NAME>Enumerable</NAME>.<STRING>findAll</STRING></GETPROP>,
  <OBJLITNAME>filter</OBJLITNAME>:  <GETPROP><NAME>Enumerable</NAME>.<STRING>findAll</STRING></GETPROP>,
  <OBJLITNAME>member</OBJLITNAME>:  <GETPROP><NAME>Enumerable</NAME>.<STRING>include</STRING></GETPROP>,
  <OBJLITNAME>entries</OBJLITNAME>: <GETPROP><NAME>Enumerable</NAME>.<STRING>toArray</STRING></GETPROP>,
  <OBJLITNAME>every</OBJLITNAME>:   <GETPROP><NAME>Enumerable</NAME>.<STRING>all</STRING></GETPROP>,
  <OBJLITNAME>some</OBJLITNAME>:    <GETPROP><NAME>Enumerable</NAME>.<STRING>any</STRING></GETPROP>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;
<FUNCTION>function <FUNCNAME>$A</FUNCNAME>(<PARAMETER>iterable</PARAMETER>) <BLOCK>{
  <BLOCK>if (<IFNE><NOT>!<NAME>iterable</NAME></NOT></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
  <BLOCK>if (<IFNE><GETPROP><NAME>iterable</NAME>.<STRING>toArray</STRING></GETPROP></IFNE>) <RETURN>return <CALL><NAME>iterable</NAME>.<GETPROP><STRING>toArray</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>
  <VAR>var <NAME>length = <GETPROP><NAME>iterable</NAME>.<STRING>length</STRING></GETPROP></NAME>, <NAME>results = <NEW>new <NAME>Array</NAME>(<NAME>length</NAME>)</NEW></NAME></VAR>;
  <LOOP><EMPTY/>while (<IFEQ><DEC><NAME><TARGET/>length</NAME>--</DEC></IFEQ>) <EXPR_VOID><SETELEM><NAME><TARGET/>results</NAME>[<NAME>length</NAME>] = <GETELEM><NAME>iterable</NAME>[<NAME>length</NAME>]</GETELEM></SETELEM></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
  <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
}</FUNCTION>

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP></IFNE>) <BLOCK>{
  <FUNCTION>function <FUNCNAME>$A</FUNCNAME>(<PARAMETER>iterable</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<NAME>iterable</NAME></NOT></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><AND>!(<NOT><AND><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>iterable</NAME>)</CALL> &amp;&amp; <EQ><NAME>iterable</NAME> == <STRING>'[object NodeList]'</STRING></EQ>)</AND></NOT> &amp;&amp;
        <GETPROP><NAME>iterable</NAME>.<STRING>toArray</STRING></GETPROP></AND></IFNE>) <RETURN>return <CALL><NAME>iterable</NAME>.<GETPROP><STRING>toArray</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>length = <GETPROP><NAME>iterable</NAME>.<STRING>length</STRING></GETPROP></NAME>, <NAME>results = <NEW>new <NAME>Array</NAME>(<NAME>length</NAME>)</NEW></NAME></VAR>;
    <LOOP><EMPTY/>while (<IFEQ><DEC><NAME><TARGET/>length</NAME>--</DEC></IFEQ>) <EXPR_VOID><SETELEM><NAME><TARGET/>results</NAME>[<NAME>length</NAME>] = <GETELEM><NAME>iterable</NAME>[<NAME>length</NAME>]</GETELEM></SETELEM></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</BLOCK></BLOCK><TARGET/>

<EXPR_RESULT><SETPROP><NAME>Array</NAME>.<STRING>from</STRING> = <NAME>$A</NAME></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Array</NAME>.<STRING>prototype</STRING></GETPROP>, <NAME>Enumerable</NAME>)</CALL></EXPR_RESULT>;

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>_reverse</STRING></GETPROP></NOT></IFNE>) <NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>_reverse</STRING> = <GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>reverse</STRING></GETPROP></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Array</NAME>.<STRING>prototype</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>_each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <EXPR_VOID><CALL><NAME><TARGET/>iterator</NAME>(<GETELEM><THIS>this</THIS>[<NAME>i</NAME>]</GETELEM>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>clear</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>length</STRING> = <NUMBER>0</NUMBER></SETPROP></EXPR_VOID>;
    <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>first</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETELEM><THIS>this</THIS>[<NUMBER>0</NUMBER>]</GETELEM></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>last</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETELEM><THIS>this</THIS>[<SUB><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> - <NUMBER>1</NUMBER></SUB>]</GETELEM></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>compact</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>select</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <RETURN>return <NE><NAME>value</NAME> != <NULL>null</NULL></NE></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>flatten</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>inject</STRING></GETPROP>(<ARRAYLIT>[]</ARRAYLIT>, <FUNCTION>function(<PARAMETER>array</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>array</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<NAME>value</NAME>)</CALL> ?
        <CALL><NAME>value</NAME>.<GETPROP><STRING>flatten</STRING></GETPROP>()</CALL> : [<ARRAYLIT><NAME>value</NAME>]</ARRAYLIT></HOOK>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>without</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>values = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>select</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <RETURN>return !<NOT><CALL><NAME>values</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>value</NAME>)</CALL></NOT></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>reverse</OBJLITNAME>: <FUNCTION>function(<PARAMETER>inline</PARAMETER>) <BLOCK>{
    <RETURN>return (<CALL><HOOK><SHNE><NAME>inline</NAME> !== <FALSE>false</FALSE></SHNE> ? <THIS>this</THIS> : <CALL><THIS>this</THIS>.<GETPROP><STRING>toArray</STRING></GETPROP>()</CALL></HOOK>).<GETPROP><STRING>_reverse</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>reduce</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <HOOK><GT><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>1</NUMBER></GT> ? <THIS>this</THIS> : <GETELEM><THIS>this</THIS>[<NUMBER>0</NUMBER>]</GETELEM></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>uniq</OBJLITNAME>: <FUNCTION>function(<PARAMETER>sorted</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>inject</STRING></GETPROP>(<ARRAYLIT>[]</ARRAYLIT>, <FUNCTION>function(<PARAMETER>array</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><OR><EQ><NUMBER>0</NUMBER> == <NAME>index</NAME></EQ> || (<HOOK><NAME>sorted</NAME> ? <NE><CALL><NAME>array</NAME>.<GETPROP><STRING>last</STRING></GETPROP>()</CALL> != <NAME>value</NAME></NE> : !<NOT><CALL><NAME>array</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>value</NAME>)</CALL></NOT>)</HOOK></OR></IFNE>)
        <EXPR_VOID><CALL><NAME>array</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <RETURN>return <NAME>array</NAME></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>intersect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>array</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>uniq</STRING></GETPROP></CALL>().<GETPROP><STRING>findAll</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>item</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>array</NAME>.<GETPROP><STRING>detect</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{ <RETURN>return <SHEQ><NAME>item</NAME> === <NAME>value</NAME></SHEQ></RETURN></BLOCK> }</FUNCTION>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>clone</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><ARRAYLIT>[]</ARRAYLIT>.<GETPROP><STRING>concat</STRING></GETPROP>(<THIS>this</THIS>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>size</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><ADD><STRING>'['</STRING> + <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<GETPROP><NAME>Object</NAME>.<STRING>inspect</STRING></GETPROP></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>', '</STRING>)</CALL></ADD> + <STRING>']'</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>value = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toJSON</STRING></GETPROP>(<NAME>object</NAME>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL></NOT></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <ADD><ADD><STRING>'['</STRING> + <CALL><NAME>results</NAME>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>', '</STRING>)</CALL></ADD> + <STRING>']'</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

// use native browser JS 1.6 implementation if available
<BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>forEach</STRING></GETPROP>)</CALL></IFNE>)
  <NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>_each</STRING> = <GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>forEach</STRING></GETPROP></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>indexOf</STRING></GETPROP></NOT></IFNE>) <NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>indexOf</STRING> = <FUNCTION>function(<PARAMETER>item</PARAMETER>, <PARAMETER>i</PARAMETER>) <BLOCK>{
  <EXPR_VOID><OR><NAME>i</NAME> || (<SETNAME><BINDNAME>i</BINDNAME> = <NUMBER>0</NUMBER>)</SETNAME></OR></EXPR_VOID>;
  <VAR>var <NAME>length = <GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP></NAME></VAR>;
  <BLOCK>if (<IFNE><LT><NAME>i</NAME> &lt; <NUMBER>0</NUMBER></LT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>i</BINDNAME> = <ADD><NAME>length</NAME> + <NAME>i</NAME></ADD></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
  <LOOP><EMPTY/>for (; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
    <BLOCK><TARGET/>if (<IFNE><SHEQ><GETELEM><THIS>this</THIS>[<NAME>i</NAME>]</GETELEM> === <NAME>item</NAME></SHEQ></IFNE>) <RETURN>return <NAME>i</NAME></RETURN><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
  <RETURN>return -<NUMBER>1</NUMBER></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>lastIndexOf</STRING></GETPROP></NOT></IFNE>) <NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>lastIndexOf</STRING> = <FUNCTION>function(<PARAMETER>item</PARAMETER>, <PARAMETER>i</PARAMETER>) <BLOCK>{
  <EXPR_VOID><SETNAME><BINDNAME>i</BINDNAME> = <HOOK><CALL><NAME>isNaN</NAME>(<NAME>i</NAME>)</CALL> ? <GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> : (<ADD><HOOK><LT><NAME>i</NAME> &lt; <NUMBER>0</NUMBER></LT> ? <ADD><GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP> + <NAME>i</NAME></ADD> : <NAME>i</NAME>)</HOOK> + <NUMBER>1</NUMBER></ADD></HOOK></SETNAME></EXPR_VOID>;
  <VAR>var <NAME>n = <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>0</NUMBER>, <NAME>i</NAME></CALL>).<CALL><GETPROP><STRING>reverse</STRING></GETPROP></CALL>().<GETPROP><STRING>indexOf</STRING></GETPROP>(<NAME>item</NAME>)</CALL></NAME></VAR>;
  <RETURN>return (<HOOK><LT><NAME>n</NAME> &lt; <NUMBER>0</NUMBER>)</LT> ? <NAME>n</NAME> : <SUB><SUB><NAME>i</NAME> - <NAME>n</NAME></SUB> - <NUMBER>1</NUMBER></SUB></HOOK></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>

<NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>toArray</STRING> = <GETPROP><NAME>Array</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>clone</STRING></GETPROP></SETPROP></EXPR_RESULT>;

<FUNCTION>function <FUNCNAME>$w</FUNCNAME>(<PARAMETER>string</PARAMETER>) <BLOCK>{
  <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>string</NAME>)</CALL></NOT></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
  <EXPR_VOID><SETNAME><BINDNAME>string</BINDNAME> = <CALL><NAME>string</NAME>.<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
  <RETURN>return <HOOK><NAME>string</NAME> ? <CALL><NAME>string</NAME>.<GETPROP><STRING>split</STRING></GETPROP>(<REGEXP>/\s+/</REGEXP>)</CALL> : <ARRAYLIT>[]</ARRAYLIT></HOOK></RETURN>;</BLOCK>
}</FUNCTION>

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></IFNE>)<BLOCK>{
  <NAME>Array</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>concat</STRING> = <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>array = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><THIS>this</THIS>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <EXPR_VOID><CALL><NAME><TARGET/>array</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETELEM><THIS>this</THIS>[<NAME>i</NAME>]</GETELEM>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<GETELEM><NAME>arguments</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL></IFNE>) <BLOCK>{
        <LOOP><EMPTY/>for <VAR>(var <NAME>j = <NUMBER>0</NUMBER></NAME>, <NAME>arrayLength = <GETPROP><GETELEM><NAME>arguments</NAME>[<NAME>i</NAME></GETELEM>].<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>j</NAME> &lt; <NAME>arrayLength</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>j</NAME></INC></EXPR_VOID>++)
          <EXPR_VOID><CALL><NAME><TARGET/>array</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETELEM><GETELEM><NAME>arguments</NAME>[<NAME>i</NAME></GETELEM>][<NAME>j</NAME>]</GETELEM>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <EXPR_VOID><CALL><NAME>array</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETELEM><NAME>arguments</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return <NAME>array</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>
<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Number</NAME>.<STRING>prototype</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>toColorPart</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>toPaddedString</STRING></GETPROP>(<NUMBER>2</NUMBER>, <NUMBER>16</NUMBER>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>succ</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><THIS>this</THIS> + <NUMBER>1</NUMBER></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>times</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><CALL><NAME>$R</NAME>(<NUMBER>0</NUMBER>, <THIS>this</THIS>, <TRUE>true</TRUE></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<NAME>iterator</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <THIS>this</THIS></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toPaddedString</OBJLITNAME>: <FUNCTION>function(<PARAMETER>length</PARAMETER>, <PARAMETER>radix</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>string = <CALL><THIS>this</THIS>.<GETPROP><STRING>toString</STRING></GETPROP>(<OR><NAME>radix</NAME> || <NUMBER>10</NUMBER></OR>)</CALL></NAME></VAR>;
    <RETURN>return <ADD><CALL><STRING>'0'</STRING>.<GETPROP><STRING>times</STRING></GETPROP>(<SUB><NAME>length</NAME> - <GETPROP><NAME>string</NAME>.<STRING>length</STRING></GETPROP></SUB>)</CALL> + <NAME>string</NAME></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <HOOK><CALL><NAME>isFinite</NAME>(<THIS>this</THIS>)</CALL> ? <CALL><THIS>this</THIS>.<GETPROP><STRING>toString</STRING></GETPROP>()</CALL> : <STRING>'null'</STRING></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><CALL><NAME>$w</NAME>(<STRING>'abs round ceil floor'</STRING></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>method</PARAMETER>)<BLOCK>{
  <NAME>Number</NAME>.<EXPR_VOID><SETELEM><GETPROP><STRING>prototype</STRING></GETPROP>[<NAME>method</NAME>] = <CALL><GETELEM><NAME>Math</NAME>[<NAME>method</NAME></GETELEM>].<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;
</BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_RESULT>;
<FUNCTION>function <FUNCNAME>$H</FUNCNAME>(<PARAMETER>object</PARAMETER>) <BLOCK>{
  <RETURN>return <NEW>new <NAME>Hash</NAME>(<NAME>object</NAME>)</NEW></RETURN>;</BLOCK>
}</FUNCTION><EMPTY/>;

<VAR>var <NAME>Hash = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<NAME>Enumerable</NAME>, (<CALL><FUNCTION>function() <BLOCK>{

  <FUNCTION>function <FUNCNAME>toQueryPair</FUNCNAME>(<PARAMETER>key</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL></IFNE>) <RETURN>return <NAME>key</NAME></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <ADD><ADD><NAME>key</NAME> + <STRING>'='</STRING></ADD> + <CALL><NAME>encodeURIComponent</NAME>(<CALL><NAME>String</NAME>.<GETPROP><STRING>interpret</STRING></GETPROP>(<NAME>value</NAME>)</CALL>)</CALL></ADD></RETURN>;</BLOCK>
  }</FUNCTION>

  <RETURN>return <OBJECTLIT>{
    <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>_object</STRING> = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isHash</STRING></GETPROP>(<NAME>object</NAME>)</CALL> ? <CALL><NAME>object</NAME>.<GETPROP><STRING>toObject</STRING></GETPROP>()</CALL> : <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<NAME>object</NAME>)</CALL></HOOK></SETPROP></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>,

    <OBJLITNAME>_each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
      <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>key</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><GETPROP><THIS>this</THIS>.<STRING>_object</STRING></GETPROP></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
        <VAR>var <NAME>value = <GETELEM><THIS>this</THIS>.<GETPROP><STRING>_object</STRING></GETPROP>[<NAME>key</NAME>]</GETELEM></NAME>, <NAME>pair = [<ARRAYLIT><NAME>key</NAME>, <NAME>value</NAME>]</ARRAYLIT></NAME></VAR>;
        <EXPR_VOID><SETPROP><NAME>pair</NAME>.<STRING>key</STRING> = <NAME>key</NAME></SETPROP></EXPR_VOID>;
        <EXPR_VOID><SETPROP><NAME>pair</NAME>.<STRING>value</STRING> = <NAME>value</NAME></SETPROP></EXPR_VOID>;
        <EXPR_VOID><CALL><NAME>iterator</NAME>(<NAME>pair</NAME>)</CALL></EXPR_VOID>;
      <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    </BLOCK><RETURN/>}</FUNCTION>,

    <OBJLITNAME>set</OBJLITNAME>: <FUNCTION>function(<PARAMETER>key</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
      <RETURN>return <THIS>this</THIS>.<SETELEM><GETPROP><STRING>_object</STRING></GETPROP>[<NAME>key</NAME>] = <NAME>value</NAME></SETELEM></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>get</OBJLITNAME>: <FUNCTION>function(<PARAMETER>key</PARAMETER>) <BLOCK>{
      <RETURN>return <GETELEM><THIS>this</THIS>.<GETPROP><STRING>_object</STRING></GETPROP>[<NAME>key</NAME>]</GETELEM></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>unset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>key</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>value = <GETELEM><THIS>this</THIS>.<GETPROP><STRING>_object</STRING></GETPROP>[<NAME>key</NAME>]</GETELEM></NAME></VAR>;
      delete <THIS>this</THIS>.<EXPR_VOID><DELPROP><GETPROP><STRING>_object</STRING></GETPROP>[<NAME>key</NAME></DELPROP></EXPR_VOID>];
      <RETURN>return <NAME>value</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>toObject</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>_object</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>keys</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>pluck</STRING></GETPROP>(<STRING>'key'</STRING>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>values</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>pluck</STRING></GETPROP>(<STRING>'value'</STRING>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>index</OBJLITNAME>: <FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>match = <CALL><THIS>this</THIS>.<GETPROP><STRING>detect</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>pair</PARAMETER>) <BLOCK>{
        <RETURN>return <SHEQ><GETPROP><NAME>pair</NAME>.<STRING>value</STRING></GETPROP> === <NAME>value</NAME></SHEQ></RETURN>;</BLOCK>
      }</FUNCTION>)</CALL></NAME></VAR>;
      <RETURN>return <AND><NAME>match</NAME> &amp;&amp; <GETPROP><NAME>match</NAME>.<STRING>key</STRING></GETPROP></AND></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>merge</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>clone</STRING></GETPROP></CALL>().<GETPROP><STRING>update</STRING></GETPROP>(<NAME>object</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>update</OBJLITNAME>: <FUNCTION>function(<PARAMETER>object</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NEW>new <NAME>Hash</NAME>(<NAME>object</NAME></NEW>).<GETPROP><STRING>inject</STRING></GETPROP>(<THIS>this</THIS>, <FUNCTION>function(<PARAMETER>result</PARAMETER>, <PARAMETER>pair</PARAMETER>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>result</NAME>.<GETPROP><STRING>set</STRING></GETPROP>(<GETPROP><NAME>pair</NAME>.<STRING>key</STRING></GETPROP>, <GETPROP><NAME>pair</NAME>.<STRING>value</STRING></GETPROP>)</CALL></EXPR_VOID>;
        <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
      }</FUNCTION>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>toQueryString</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>pair</PARAMETER>) <BLOCK>{
        <VAR>var <NAME>key = <CALL><NAME>encodeURIComponent</NAME>(<GETPROP><NAME>pair</NAME>.<STRING>key</STRING></GETPROP>)</CALL></NAME>, <NAME>values = <GETPROP><NAME>pair</NAME>.<STRING>value</STRING></GETPROP></NAME></VAR>;

        <BLOCK>if (<IFNE><AND><NAME>values</NAME> &amp;&amp; typeof <EQ><TYPEOFNAME>values</TYPEOFNAME> == <STRING>'object'</STRING></EQ></AND></IFNE>) <BLOCK>{
          <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<NAME>values</NAME>)</CALL></IFNE>)
            <RETURN>return <CALL><NAME>values</NAME>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<CALL><NAME>toQueryPair</NAME>.<GETPROP><STRING>curry</STRING></GETPROP>(<NAME>key</NAME>)</CALL></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>'&amp;'</STRING>)</CALL></RETURN>;</BLOCK><TARGET/>
        }</BLOCK></BLOCK><TARGET/>
        <RETURN>return <CALL><NAME>toQueryPair</NAME>(<NAME>key</NAME>, <NAME>values</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>'&amp;'</STRING>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <ADD><ADD><STRING>'#&lt;Hash:{'</STRING> + <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>pair</PARAMETER>) <BLOCK>{
        <RETURN>return <CALL><NAME>pair</NAME>.<CALL><GETPROP><STRING>map</STRING></GETPROP>(<GETPROP><NAME>Object</NAME>.<STRING>inspect</STRING></GETPROP></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>': '</STRING>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>', '</STRING>)</CALL></ADD> + <STRING>'}&gt;'</STRING></ADD></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>toJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <CALL><NAME>Object</NAME>.<GETPROP><STRING>toJSON</STRING></GETPROP>(<CALL><THIS>this</THIS>.<GETPROP><STRING>toObject</STRING></GETPROP>()</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>clone</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      <RETURN>return <NEW>new <NAME>Hash</NAME>(<THIS>this</THIS>)</NEW></RETURN>;</BLOCK>
    }</FUNCTION>
  }</OBJECTLIT></RETURN></BLOCK>
}</FUNCTION>)()</CALL>)</CALL></NAME></VAR>;

<NAME>Hash</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>toTemplateReplacements</STRING> = <GETPROP><NAME>Hash</NAME>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>toObject</STRING></GETPROP></SETPROP></EXPR_RESULT>;
<EXPR_RESULT><SETPROP><NAME>Hash</NAME>.<STRING>from</STRING> = <NAME>$H</NAME></SETPROP></EXPR_RESULT>;
<VAR>var <NAME>ObjectRange = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<NAME>Enumerable</NAME>, <OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>start</PARAMETER>, <PARAMETER>end</PARAMETER>, <PARAMETER>exclusive</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>start</STRING> = <NAME>start</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>end</STRING> = <NAME>end</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>exclusive</STRING> = <NAME>exclusive</NAME></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>_each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>value = <GETPROP><THIS>this</THIS>.<STRING>start</STRING></GETPROP></NAME></VAR>;
    <LOOP><EMPTY/>while (<IFEQ><CALL><THIS><TARGET/>this</THIS>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>value</NAME>)</CALL></IFEQ>) <BLOCK><TARGET/>{
      <EXPR_VOID><CALL><NAME>iterator</NAME>(<NAME>value</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><NAME>value</NAME>.<GETPROP><STRING>succ</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>include</OBJLITNAME>: <FUNCTION>function(<PARAMETER>value</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><LT><NAME>value</NAME> &lt; <GETPROP><THIS>this</THIS>.<STRING>start</STRING></GETPROP></LT></IFNE>)
      <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<STRING>exclusive</STRING></GETPROP></IFNE>)
      <RETURN>return <LT><NAME>value</NAME> &lt; <GETPROP><THIS>this</THIS>.<STRING>end</STRING></GETPROP></LT></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <LE><NAME>value</NAME> &lt;= <GETPROP><THIS>this</THIS>.<STRING>end</STRING></GETPROP></LE></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></NAME></VAR>;

<VAR>var <NAME>$R = <FUNCTION>function(<PARAMETER>start</PARAMETER>, <PARAMETER>end</PARAMETER>, <PARAMETER>exclusive</PARAMETER>) <BLOCK>{
  <RETURN>return <NEW>new <NAME>ObjectRange</NAME>(<NAME>start</NAME>, <NAME>end</NAME>, <NAME>exclusive</NAME>)</NEW></RETURN>;</BLOCK>
}</FUNCTION></NAME></VAR>;

<VAR>var <NAME>Ajax = <OBJECTLIT>{
  <OBJLITNAME>getTransport</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <OR><CALL><NAME>Try</NAME>.<GETPROP><STRING>these</STRING></GETPROP>(
      <FUNCTION>function() <BLOCK>{<RETURN>return <NEW>new <NAME>XMLHttpRequest</NAME>()</NEW></RETURN></BLOCK>}</FUNCTION>,
      <FUNCTION>function() <BLOCK>{<RETURN>return <NEW>new <NAME>ActiveXObject</NAME>(<STRING>'Msxml2.XMLHTTP'</STRING>)</NEW></RETURN></BLOCK>}</FUNCTION>,
      <FUNCTION>function() <BLOCK>{<RETURN>return <NEW>new <NAME>ActiveXObject</NAME>(<STRING>'Microsoft.XMLHTTP'</STRING>)</NEW></RETURN></BLOCK>}</FUNCTION>
    )</CALL> || <FALSE>false</FALSE></OR></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>activeRequestCount</OBJLITNAME>: <NUMBER>0</NUMBER>
}</OBJECTLIT></NAME></VAR>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>Responders</STRING> = <OBJECTLIT>{
  <OBJLITNAME>responders</OBJLITNAME>: <ARRAYLIT>[]</ARRAYLIT>,

  <OBJLITNAME>_each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>responders</STRING></GETPROP>.<GETPROP><STRING>_each</STRING></GETPROP>(<NAME>iterator</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>register</OBJLITNAME>: <FUNCTION>function(<PARAMETER>responder</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<CALL><THIS>this</THIS>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>responder</NAME>)</CALL></NOT></IFNE>)
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>responders</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>responder</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>unregister</OBJLITNAME>: <FUNCTION>function(<PARAMETER>responder</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>responders</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>responders</STRING></GETPROP>.<GETPROP><STRING>without</STRING></GETPROP>(<NAME>responder</NAME>)</CALL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>dispatch</OBJLITNAME>: <FUNCTION>function(<PARAMETER>callback</PARAMETER>, <PARAMETER>request</PARAMETER>, <PARAMETER>transport</PARAMETER>, <PARAMETER>json</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>responder</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>responder</NAME>[<NAME>callback</NAME>]</GETELEM>)</CALL></IFNE>) <BLOCK>{
        <TRY>try <BLOCK>{
          <EXPR_VOID><CALL><GETELEM><NAME>responder</NAME>[<NAME>callback</NAME></GETELEM>].<GETPROP><STRING>apply</STRING></GETPROP>(<NAME>responder</NAME>, [<ARRAYLIT><NAME>request</NAME>, <NAME>transport</NAME>, <NAME>json</NAME>]</ARRAYLIT>)</CALL></EXPR_VOID>;
        }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ }</BLOCK></CATCH></TRY>
      }</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Ajax</NAME>.<STRING>Responders</STRING></GETPROP>, <NAME>Enumerable</NAME>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Ajax</NAME>.<GETPROP><STRING>Responders</STRING></GETPROP>.<GETPROP><STRING>register</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>onCreate</OBJLITNAME>:   <FUNCTION>function() <BLOCK>{ <EXPR_VOID><INC><GETPROP><NAME>Ajax</NAME>.<STRING>activeRequestCount</STRING></GETPROP></INC></EXPR_VOID>++ </BLOCK><RETURN/>}</FUNCTION>,
  <OBJLITNAME>onComplete</OBJLITNAME>: <FUNCTION>function() <BLOCK>{ <EXPR_VOID><DEC><GETPROP><NAME>Ajax</NAME>.<STRING>activeRequestCount</STRING></GETPROP></DEC></EXPR_VOID>-- </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>Base</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>options</STRING> = <OBJECTLIT>{
      <OBJLITNAME>method</OBJLITNAME>:       <STRING>'post'</STRING>,
      <OBJLITNAME>asynchronous</OBJLITNAME>: <TRUE>true</TRUE>,
      <OBJLITNAME>contentType</OBJLITNAME>:  <STRING>'application/x-www-form-urlencoded'</STRING>,
      <OBJLITNAME>encoding</OBJLITNAME>:     <STRING>'UTF-8'</STRING>,
      <OBJLITNAME>parameters</OBJLITNAME>:   <STRING>''</STRING>,
      <OBJLITNAME>evalJSON</OBJLITNAME>:     <TRUE>true</TRUE>,
      <OBJLITNAME>evalJS</OBJLITNAME>:       <TRUE>true</TRUE>
    }</OBJECTLIT></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>options</STRING></GETPROP>, <OR><NAME>options</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></EXPR_VOID>;

    <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>options</STRING></GETPROP>.<STRING>method</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<GETPROP><STRING>method</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;

    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>parameters</STRING></GETPROP>)</CALL></IFNE>)
      <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>options</STRING></GETPROP>.<STRING>parameters</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<GETPROP><STRING>parameters</STRING></GETPROP>.<GETPROP><STRING>toQueryParams</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    else <BLOCK><TARGET/>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isHash</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>parameters</STRING></GETPROP>)</CALL></IFNE>)
      <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>options</STRING></GETPROP>.<STRING>parameters</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<GETPROP><STRING>parameters</STRING></GETPROP>.<GETPROP><STRING>toObject</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>Request</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Ajax</NAME>.<STRING>Base</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>_complete</OBJLITNAME>: <FALSE>false</FALSE>,

  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>$super</PARAMETER>, <PARAMETER>url</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>$super</NAME>(<NAME>options</NAME>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>transport</STRING> = <CALL><NAME>Ajax</NAME>.<GETPROP><STRING>getTransport</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>request</STRING></GETPROP>(<NAME>url</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>request</OBJLITNAME>: <FUNCTION>function(<PARAMETER>url</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>url</STRING> = <NAME>url</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>method</STRING> = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>method</STRING></GETPROP></SETPROP></EXPR_VOID>;
    <VAR>var <NAME>params = <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>parameters</STRING></GETPROP>)</CALL></NAME></VAR>;

    <BLOCK>if (<IFNE><NOT>![<CALL><ARRAYLIT><STRING>'get'</STRING>, <STRING>'post'</STRING></ARRAYLIT>].<GETPROP><STRING>include</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>method</STRING></GETPROP>)</CALL></NOT></IFNE>) <BLOCK>{
      // simulate other verbs over post
      <EXPR_VOID><SETELEM><NAME>params</NAME>[<STRING>'_method'</STRING>] = <GETPROP><THIS>this</THIS>.<STRING>method</STRING></GETPROP></SETELEM></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>method</STRING> = <STRING>'post'</STRING></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>parameters</STRING> = <NAME>params</NAME></SETPROP></EXPR_VOID>;

    <BLOCK>if (<IFNE><SETNAME><BINDNAME>params</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toQueryString</STRING></GETPROP>(<NAME>params</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
      // when GET, append parameters to URL
      <BLOCK>if (<IFNE><EQ><GETPROP><THIS>this</THIS>.<STRING>method</STRING></GETPROP> == <STRING>'get'</STRING></EQ></IFNE>)
        <EXPR_VOID><SETPROP_OP><THIS><ADD><USE_STACK/>this</THIS>.<STRING>url</STRING> += (<ADD><HOOK><CALL><THIS>this</THIS>.<GETPROP><STRING>url</STRING></GETPROP>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>'?'</STRING>)</CALL> ? <STRING>'&amp;'</STRING> : <STRING>'?'</STRING>)</HOOK> + <NAME>params</NAME></ADD></ADD></SETPROP_OP></EXPR_VOID>;
      else <BLOCK><TARGET/>if (<IFNE><CALL><REGEXP>/Konqueror|Safari|KHTML/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<GETPROP><NAME>navigator</NAME>.<STRING>userAgent</STRING></GETPROP>)</CALL></IFNE>)
        <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>params</NAME></BINDNAME> += <STRING>'&amp;_='</STRING></ADD></SETNAME></EXPR_VOID><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    }</BLOCK></BLOCK><TARGET/>

    <TRY>try <BLOCK>{
      <VAR>var <NAME>response = <NEW>new <GETPROP><NAME>Ajax</NAME>.<STRING>Response</STRING></GETPROP>(<THIS>this</THIS>)</NEW></NAME></VAR>;
      <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>onCreate</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<GETPROP><STRING>onCreate</STRING></GETPROP>(<NAME>response</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <EXPR_VOID><CALL><NAME>Ajax</NAME>.<GETPROP><STRING>Responders</STRING></GETPROP>.<GETPROP><STRING>dispatch</STRING></GETPROP>(<STRING>'onCreate'</STRING>, <THIS>this</THIS>, <NAME>response</NAME>)</CALL></EXPR_VOID>;

      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>open</STRING></GETPROP>(<CALL><THIS>this</THIS>.<GETPROP><STRING>method</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL>, <GETPROP><THIS>this</THIS>.<STRING>url</STRING></GETPROP>,
        <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>asynchronous</STRING></GETPROP>)</CALL></EXPR_VOID>;

      <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>asynchronous</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>respondToReadyState</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>(<NUMBER>1</NUMBER>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>

      <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>transport</STRING></GETPROP>.<STRING>onreadystatechange</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>onStateChange</STRING></GETPROP>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL></SETPROP></EXPR_VOID>;
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>setRequestHeaders</STRING></GETPROP>()</CALL></EXPR_VOID>;

      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>body</STRING> = <HOOK><EQ><GETPROP><THIS>this</THIS>.<STRING>method</STRING></GETPROP> == <STRING>'post'</STRING></EQ> ? (<OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>postBody</STRING></GETPROP> || <NAME>params</NAME>)</OR> : <NULL>null</NULL></HOOK></SETPROP></EXPR_VOID>;
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>send</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>body</STRING></GETPROP>)</CALL></EXPR_VOID>;

      /* Force Firefox to handle ready state 4 for synchronous requests */
      <BLOCK>if (<IFNE><AND>!<NOT><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>asynchronous</STRING></GETPROP></NOT> &amp;&amp; <GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>overrideMimeType</STRING></GETPROP></AND></IFNE>)
        <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>onStateChange</STRING></GETPROP>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>

    }</BLOCK>
    <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>onStateChange</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>readyState = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>readyState</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><AND><GT><NAME>readyState</NAME> &gt; <NUMBER>1</NUMBER></GT> &amp;&amp; !((<NOT><AND><EQ><NAME>readyState</NAME> == <NUMBER>4</NUMBER>)</EQ> &amp;&amp; <GETPROP><THIS>this</THIS>.<STRING>_complete</STRING></GETPROP>)</AND></NOT></AND></IFNE>)
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>respondToReadyState</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>readyState</STRING></GETPROP>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>setRequestHeaders</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>headers = <OBJECTLIT>{
      '<OBJLITNAME>X-Requested-With</OBJLITNAME>': <STRING>'XMLHttpRequest'</STRING>,
      '<OBJLITNAME>X-Prototype-Version</OBJLITNAME>': <GETPROP><NAME>Prototype</NAME>.<STRING>Version</STRING></GETPROP>,
      '<OBJLITNAME>Accept</OBJLITNAME>': <STRING>'text/javascript, text/html, application/xml, text/xml, */*'</STRING>
    }</OBJECTLIT></NAME></VAR>;

    <BLOCK>if (<IFNE><EQ><GETPROP><THIS>this</THIS>.<STRING>method</STRING></GETPROP> == <STRING>'post'</STRING></EQ></IFNE>) <BLOCK>{
      <EXPR_VOID><SETELEM><NAME>headers</NAME>[<STRING>'Content-type'</STRING>] = <ADD><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>contentType</STRING></GETPROP> +
        (<HOOK><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>encoding</STRING></GETPROP> ? <ADD><STRING>'; charset='</STRING> + <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>encoding</STRING></GETPROP></ADD> : <STRING>''</STRING>)</HOOK></ADD></SETELEM></EXPR_VOID>;

      /* Force "Connection: close" for older Mozilla browsers to work
       * around a bug where XMLHttpRequest sends an incorrect
       * Content-length header. See Mozilla Bugzilla #246651.
       */
      <BLOCK>if (<IFNE><AND><GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>overrideMimeType</STRING></GETPROP> &amp;&amp;
          (<LT><GETELEM><OR><CALL><NAME>navigator</NAME>.<GETPROP><STRING>userAgent</STRING></GETPROP>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/Gecko\/(\d{4})/</REGEXP>)</CALL> || [<ARRAYLIT><NUMBER>0</NUMBER>,<NUMBER>2005</NUMBER>]</ARRAYLIT></OR>)[<NUMBER>1</NUMBER>]</GETELEM> &lt; <NUMBER>2005</NUMBER></LT></AND></IFNE>)
            <EXPR_VOID><SETELEM><NAME>headers</NAME>[<STRING>'Connection'</STRING>] = <STRING>'close'</STRING></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>

    // user-defined headers
    <BLOCK>if (<IFNE><EQ>typeof <TYPEOF><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>requestHeaders</STRING></GETPROP></TYPEOF> == <STRING>'object'</STRING></EQ></IFNE>) <BLOCK>{
      <VAR>var <NAME>extras = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>requestHeaders</STRING></GETPROP></NAME></VAR>;

      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETPROP><NAME>extras</NAME>.<STRING>push</STRING></GETPROP>)</CALL></IFNE>)
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>extras</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>i</NAME></BINDNAME> += <NUMBER>2</NUMBER></ADD></SETNAME></EXPR_VOID>)
          <EXPR_VOID><SETELEM><NAME><TARGET/>headers</NAME>[<GETELEM><NAME>extras</NAME>[<NAME>i</NAME>]</GETELEM>] = <GETELEM><NAME>extras</NAME>[<ADD><NAME>i</NAME>+<NUMBER>1</NUMBER></ADD>]</GETELEM></SETELEM></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      else
        <EXPR_VOID><CALL><CALL><NAME><TARGET/>$H</NAME>(<NAME>extras</NAME></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>pair</PARAMETER>) <BLOCK>{ <EXPR_VOID><SETELEM><NAME>headers</NAME>[<GETPROP><NAME>pair</NAME>.<STRING>key</STRING></GETPROP>] = <GETPROP><NAME>pair</NAME>.<STRING>value</STRING></GETPROP></SETELEM></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>

    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>name</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>headers</NAME></ENUM_INIT_KEYS>)
      <BLOCK><EXPR_VOID><CALL><THIS><TARGET/>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>setRequestHeader</STRING></GETPROP>(<NAME>name</NAME>, <GETELEM><NAME>headers</NAME>[<NAME>name</NAME>]</GETELEM>)</CALL></EXPR_VOID></BLOCK></LOOP><TARGET/><GOTO/><TARGET/>;</LOCAL_BLOCK>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>success</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>status = <CALL><THIS>this</THIS>.<GETPROP><STRING>getStatus</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return !<OR><NOT><NAME>status</NAME></NOT> || (<AND><GE><NAME>status</NAME> &gt;= <NUMBER>200</NUMBER></GE> &amp;&amp; <LT><NAME>status</NAME> &lt; <NUMBER>300</NUMBER></LT>)</AND></OR></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getStatus</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <TRY>try <BLOCK>{
      <RETURN>return <OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>status</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ <RETURN>return <NUMBER>0</NUMBER></RETURN> }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>respondToReadyState</OBJLITNAME>: <FUNCTION>function(<PARAMETER>readyState</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>state = <GETELEM><NAME>Ajax</NAME>.<GETPROP><STRING>Request</STRING></GETPROP>.<GETPROP><STRING>Events</STRING></GETPROP>[<NAME>readyState</NAME>]</GETELEM></NAME>, <NAME>response = <NEW>new <GETPROP><NAME>Ajax</NAME>.<STRING>Response</STRING></GETPROP>(<THIS>this</THIS>)</NEW></NAME></VAR>;

    <BLOCK>if (<IFNE><EQ><NAME>state</NAME> == <STRING>'Complete'</STRING></EQ></IFNE>) <BLOCK>{
      <TRY>try <BLOCK>{
        <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>_complete</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
        (<EXPR_VOID><CALL><OR><GETELEM><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>[<ADD><STRING>'on'</STRING> + <GETPROP><NAME>response</NAME>.<STRING>status</STRING></GETPROP></ADD>]</GETELEM>
         || <OR><GETELEM><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>[<ADD><STRING>'on'</STRING> + (<HOOK><CALL><THIS>this</THIS>.<GETPROP><STRING>success</STRING></GETPROP>()</CALL> ? <STRING>'Success'</STRING> : <STRING>'Failure'</STRING>)</HOOK></ADD>]</GETELEM>
         || <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></OR></OR>)(<NAME>response</NAME>, <GETPROP><NAME>response</NAME>.<STRING>headerJSON</STRING></GETPROP>)</CALL></EXPR_VOID>;
      }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
        <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
      }</BLOCK></CATCH></TRY>

      <VAR>var <NAME>contentType = <CALL><NAME>response</NAME>.<GETPROP><STRING>getHeader</STRING></GETPROP>(<STRING>'Content-type'</STRING>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><OR><EQ><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>evalJS</STRING></GETPROP> == <STRING>'force'</STRING></EQ>
          || (<AND><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>evalJS</STRING></GETPROP> &amp;&amp; <AND><NAME>contentType</NAME>
          &amp;&amp; <CALL><NAME>contentType</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i</REGEXP>)</CALL></AND>)</AND></OR></IFNE>)
        <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>evalResponse</STRING></GETPROP>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>

    <TRY>try <BLOCK>{
      (<EXPR_VOID><CALL><OR><GETELEM><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>[<ADD><STRING>'on'</STRING> + <NAME>state</NAME></ADD>]</GETELEM> || <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></OR>)(<NAME>response</NAME>, <GETPROP><NAME>response</NAME>.<STRING>headerJSON</STRING></GETPROP>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>Ajax</NAME>.<GETPROP><STRING>Responders</STRING></GETPROP>.<GETPROP><STRING>dispatch</STRING></GETPROP>(<ADD><STRING>'on'</STRING> + <NAME>state</NAME></ADD>, <THIS>this</THIS>, <NAME>response</NAME>, <GETPROP><NAME>response</NAME>.<STRING>headerJSON</STRING></GETPROP>)</CALL></EXPR_VOID>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></CATCH></TRY>

    <BLOCK>if (<IFNE><EQ><NAME>state</NAME> == <STRING>'Complete'</STRING></EQ></IFNE>) <BLOCK>{
      // avoid memory leak in MSIE: clean up
      <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>transport</STRING></GETPROP>.<STRING>onreadystatechange</STRING> = <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>getHeader</OBJLITNAME>: <FUNCTION>function(<PARAMETER>name</PARAMETER>) <BLOCK>{
    <TRY>try <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>getResponseHeader</STRING></GETPROP>(<NAME>name</NAME>)</CALL></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ <RETURN>return <NULL>null</NULL></RETURN> }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>evalResponse</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <TRY>try <BLOCK>{
      <RETURN>return <CALL><NAME>eval</NAME>((<CALL><OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>responseText</STRING></GETPROP> || <STRING>''</STRING></OR>).<GETPROP><STRING>unfilterJSON</STRING></GETPROP>()</CALL>)</CALL></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>dispatchException</OBJLITNAME>: <FUNCTION>function(<PARAMETER>exception</PARAMETER>) <BLOCK>{
    (<EXPR_VOID><CALL><OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>onException</STRING></GETPROP> || <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></OR>)(<THIS>this</THIS>, <NAME>exception</NAME>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Ajax</NAME>.<GETPROP><STRING>Responders</STRING></GETPROP>.<GETPROP><STRING>dispatch</STRING></GETPROP>(<STRING>'onException'</STRING>, <THIS>this</THIS>, <NAME>exception</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<NAME>Ajax</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Request</STRING></GETPROP>.<STRING>Events</STRING> =
  [<ARRAYLIT><STRING>'Uninitialized'</STRING>, <STRING>'Loading'</STRING>, <STRING>'Loaded'</STRING>, <STRING>'Interactive'</STRING>, <STRING>'Complete'</STRING>]</ARRAYLIT></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>Response</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>request</PARAMETER>)<BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>request</STRING> = <NAME>request</NAME></SETPROP></EXPR_VOID>;
    <VAR>var <NAME>transport  = <SETPROP><THIS>this</THIS>.<STRING>transport</STRING>  = <GETPROP><NAME>request</NAME>.<STRING>transport</STRING></GETPROP></SETPROP></NAME>,
        <NAME>readyState = <SETPROP><THIS>this</THIS>.<STRING>readyState</STRING> = <GETPROP><NAME>transport</NAME>.<STRING>readyState</STRING></GETPROP></SETPROP></NAME></VAR>;

    <BLOCK>if(<IFNE><OR>(<AND><GT><NAME>readyState</NAME> &gt; <NUMBER>2</NUMBER></GT> &amp;&amp; !<NOT><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></NOT>)</AND> || <EQ><NAME>readyState</NAME> == <NUMBER>4</NUMBER></EQ></OR></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>status</STRING>       = <CALL><THIS>this</THIS>.<GETPROP><STRING>getStatus</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>statusText</STRING>   = <CALL><THIS>this</THIS>.<GETPROP><STRING>getStatusText</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>responseText</STRING> = <CALL><NAME>String</NAME>.<GETPROP><STRING>interpret</STRING></GETPROP>(<GETPROP><NAME>transport</NAME>.<STRING>responseText</STRING></GETPROP>)</CALL></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>headerJSON</STRING>   = <CALL><THIS>this</THIS>.<GETPROP><STRING>_getHeaderJSON</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    <BLOCK>if(<IFNE><EQ><NAME>readyState</NAME> == <NUMBER>4</NUMBER></EQ></IFNE>) <BLOCK>{
      <VAR>var <NAME>xml = <GETPROP><NAME>transport</NAME>.<STRING>responseXML</STRING></GETPROP></NAME></VAR>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>responseXML</STRING>  = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>xml</NAME>)</CALL> ? <NULL>null</NULL> : <NAME>xml</NAME></HOOK></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>responseJSON</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>_getResponseJSON</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>status</OBJLITNAME>:      <NUMBER>0</NUMBER>,
  <OBJLITNAME>statusText</OBJLITNAME>: <STRING>''</STRING>,

  <OBJLITNAME>getStatus</OBJLITNAME>: <GETPROP><NAME>Ajax</NAME>.<GETPROP><STRING>Request</STRING></GETPROP>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>getStatus</STRING></GETPROP>,

  <OBJLITNAME>getStatusText</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <TRY>try <BLOCK>{
      <RETURN>return <OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<STRING>statusText</STRING></GETPROP> || <STRING>''</STRING></OR></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ <RETURN>return <STRING>''</STRING></RETURN> }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>getHeader</OBJLITNAME>: <GETPROP><NAME>Ajax</NAME>.<GETPROP><STRING>Request</STRING></GETPROP>.<GETPROP><STRING>prototype</STRING></GETPROP>.<STRING>getHeader</STRING></GETPROP>,

  <OBJLITNAME>getAllHeaders</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <TRY>try <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>getAllResponseHeaders</STRING></GETPROP>()</CALL></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ <RETURN>return <NULL>null</NULL></RETURN> }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>getResponseHeader</OBJLITNAME>: <FUNCTION>function(<PARAMETER>name</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>getResponseHeader</STRING></GETPROP>(<NAME>name</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getAllResponseHeaders</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>transport</STRING></GETPROP>.<GETPROP><STRING>getAllResponseHeaders</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>_getHeaderJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>json = <CALL><THIS>this</THIS>.<GETPROP><STRING>getHeader</STRING></GETPROP>(<STRING>'X-JSON'</STRING>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><NOT>!<NAME>json</NAME></NOT></IFNE>) <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETNAME><BINDNAME>json</BINDNAME> = <CALL><NAME>decodeURIComponent</NAME>(<CALL><NAME>escape</NAME>(<NAME>json</NAME>)</CALL>)</CALL></SETNAME></EXPR_VOID>;
    <TRY>try <BLOCK>{
      <RETURN>return <CALL><NAME>json</NAME>.<GETPROP><STRING>evalJSON</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<GETPROP><STRING>request</STRING></GETPROP>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>sanitizeJSON</STRING></GETPROP>)</CALL></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>request</STRING></GETPROP>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>_getResponseJSON</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>options = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>request</STRING></GETPROP>.<STRING>options</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><OR>!<NOT><GETPROP><NAME>options</NAME>.<STRING>evalJSON</STRING></GETPROP></NOT> || (<OR><AND><NE><GETPROP><NAME>options</NAME>.<STRING>evalJSON</STRING></GETPROP> != <STRING>'force'</STRING></NE> &amp;&amp;
      !(<NOT><CALL><OR><CALL><THIS>this</THIS>.<GETPROP><STRING>getHeader</STRING></GETPROP>(<STRING>'Content-type'</STRING>)</CALL> || <STRING>''</STRING></OR>).<GETPROP><STRING>include</STRING></GETPROP>(<STRING>'application/json'</STRING>)</CALL></NOT>)</AND> ||
        <CALL><THIS>this</THIS>.<GETPROP><STRING>responseText</STRING></GETPROP>.<GETPROP><STRING>blank</STRING></GETPROP>()</CALL></OR></OR></IFNE>)
          <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK><TARGET/>
    <TRY>try <BLOCK>{
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>responseText</STRING></GETPROP>.<GETPROP><STRING>evalJSON</STRING></GETPROP>(<GETPROP><NAME>options</NAME>.<STRING>sanitizeJSON</STRING></GETPROP>)</CALL></RETURN>;
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>request</STRING></GETPROP>.<GETPROP><STRING>dispatchException</STRING></GETPROP>(<NAME>e</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></CATCH></TRY>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>Updater</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Ajax</NAME>.<STRING>Request</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>$super</PARAMETER>, <PARAMETER>container</PARAMETER>, <PARAMETER>url</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>container</STRING> = <OBJECTLIT>{
      <OBJLITNAME>success</OBJLITNAME>: (<OR><GETPROP><NAME>container</NAME>.<STRING>success</STRING></GETPROP> || <NAME>container</NAME>)</OR>,
      <OBJLITNAME>failure</OBJLITNAME>: (<OR><GETPROP><NAME>container</NAME>.<STRING>failure</STRING></GETPROP> || (<HOOK><GETPROP><NAME>container</NAME>.<STRING>success</STRING></GETPROP> ? <NULL>null</NULL> : <NAME>container</NAME>)</HOOK>)</OR>
    }</OBJECTLIT></SETPROP></EXPR_VOID>;

    <EXPR_VOID><SETNAME><BINDNAME>options</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<NAME>options</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>onComplete = <GETPROP><NAME>options</NAME>.<STRING>onComplete</STRING></GETPROP></NAME></VAR>;
    <EXPR_VOID><SETPROP><NAME>options</NAME>.<STRING>onComplete</STRING> = (<CALL><FUNCTION>function(<PARAMETER>response</PARAMETER>, <PARAMETER>json</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>updateContent</STRING></GETPROP>(<GETPROP><NAME>response</NAME>.<STRING>responseText</STRING></GETPROP>)</CALL></EXPR_VOID>;
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>onComplete</NAME>)</CALL></IFNE>) <EXPR_VOID><CALL><NAME>onComplete</NAME>(<NAME>response</NAME>, <NAME>json</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>).<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL></SETPROP></EXPR_VOID>;

    <EXPR_VOID><CALL><NAME>$super</NAME>(<NAME>url</NAME>, <NAME>options</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>updateContent</OBJLITNAME>: <FUNCTION>function(<PARAMETER>responseText</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>receiver = <GETELEM><THIS>this</THIS>.<GETPROP><STRING>container</STRING></GETPROP>[<HOOK><CALL><THIS>this</THIS>.<GETPROP><STRING>success</STRING></GETPROP>()</CALL> ? <STRING>'success'</STRING> : <STRING>'failure'</STRING></HOOK>]</GETELEM></NAME>,
        <NAME>options = <GETPROP><THIS>this</THIS>.<STRING>options</STRING></GETPROP></NAME></VAR>;

    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>options</NAME>.<STRING>evalScripts</STRING></GETPROP></NOT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>responseText</BINDNAME> = <CALL><NAME>responseText</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <BLOCK>if (<IFNE><SETNAME><BINDNAME>receiver</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>receiver</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
      <BLOCK>if (<IFNE><GETPROP><NAME>options</NAME>.<STRING>insertion</STRING></GETPROP></IFNE>) <BLOCK>{
        <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<GETPROP><NAME>options</NAME>.<STRING>insertion</STRING></GETPROP>)</CALL></IFNE>) <BLOCK>{
          <VAR>var <NAME>insertion = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>; <EXPR_VOID><SETELEM><NAME>insertion</NAME>[<GETPROP><NAME>options</NAME>.<STRING>insertion</STRING></GETPROP>] = <NAME>responseText</NAME></SETELEM></EXPR_VOID>;
          <EXPR_VOID><CALL><NAME>receiver</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>insertion</NAME>)</CALL></EXPR_VOID>;
        }</BLOCK>
        else <EXPR_VOID><CALL><NAME><TARGET/>options</NAME>.<GETPROP><STRING>insertion</STRING></GETPROP>(<NAME>receiver</NAME>, <NAME>responseText</NAME>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
      }</BLOCK>
      else <EXPR_VOID><CALL><NAME><TARGET/>receiver</NAME>.<GETPROP><STRING>update</STRING></GETPROP>(<NAME>responseText</NAME>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Ajax</NAME>.<STRING>PeriodicalUpdater</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Ajax</NAME>.<STRING>Base</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>$super</PARAMETER>, <PARAMETER>container</PARAMETER>, <PARAMETER>url</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>$super</NAME>(<NAME>options</NAME>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>onComplete</STRING> = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>onComplete</STRING></GETPROP></SETPROP></EXPR_VOID>;

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>frequency</STRING> = (<OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>frequency</STRING></GETPROP> || <NUMBER>2</NUMBER>)</OR></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>decay</STRING> = (<OR><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>decay</STRING></GETPROP> || <NUMBER>1</NUMBER>)</OR></SETPROP></EXPR_VOID>;

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>updater</STRING> = <OBJECTLIT>{ }</OBJECTLIT></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>container</STRING> = <NAME>container</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>url</STRING> = <NAME>url</NAME></SETPROP></EXPR_VOID>;

    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>start</STRING></GETPROP>()</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>start</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>options</STRING></GETPROP>.<STRING>onComplete</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>updateComplete</STRING></GETPROP>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>onTimerEvent</STRING></GETPROP>()</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>stop</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <THIS>this</THIS>.<GETPROP><STRING>updater</STRING></GETPROP>.<EXPR_VOID><SETPROP><GETPROP><STRING>options</STRING></GETPROP>.<STRING>onComplete</STRING> = <NAME>undefined</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>clearTimeout</NAME>(<GETPROP><THIS>this</THIS>.<STRING>timer</STRING></GETPROP>)</CALL></EXPR_VOID>;
    (<EXPR_VOID><CALL><OR><GETPROP><THIS>this</THIS>.<STRING>onComplete</STRING></GETPROP> || <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></OR>).<GETPROP><STRING>apply</STRING></GETPROP>(<THIS>this</THIS>, <NAME>arguments</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>updateComplete</OBJLITNAME>: <FUNCTION>function(<PARAMETER>response</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>decay</STRING></GETPROP></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>decay</STRING> = (<HOOK><EQ><GETPROP><NAME>response</NAME>.<STRING>responseText</STRING></GETPROP> == <GETPROP><THIS>this</THIS>.<STRING>lastText</STRING></GETPROP></EQ> ?
        <MUL><GETPROP><THIS>this</THIS>.<STRING>decay</STRING></GETPROP> * <GETPROP><THIS>this</THIS>.<GETPROP><STRING>options</STRING></GETPROP>.<STRING>decay</STRING></GETPROP></MUL> : <NUMBER>1</NUMBER>)</HOOK></SETPROP></EXPR_VOID>;

      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>lastText</STRING> = <GETPROP><NAME>response</NAME>.<STRING>responseText</STRING></GETPROP></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>timer</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>onTimerEvent</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS></CALL>).<GETPROP><STRING>delay</STRING></GETPROP>(<MUL><GETPROP><THIS>this</THIS>.<STRING>decay</STRING></GETPROP> * <GETPROP><THIS>this</THIS>.<STRING>frequency</STRING></GETPROP></MUL>)</CALL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>onTimerEvent</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>updater</STRING> = <NEW>new <GETPROP><NAME>Ajax</NAME>.<STRING>Updater</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>container</STRING></GETPROP>, <GETPROP><THIS>this</THIS>.<STRING>url</STRING></GETPROP>, <GETPROP><THIS>this</THIS>.<STRING>options</STRING></GETPROP>)</NEW></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;
<FUNCTION>function <FUNCNAME>$</FUNCNAME>(<PARAMETER>element</PARAMETER>) <BLOCK>{
  <BLOCK>if (<IFNE><GT><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>1</NUMBER></GT></IFNE>) <BLOCK>{
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>elements = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>length = <GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <EXPR_VOID><CALL><NAME><TARGET/>elements</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>$</NAME>(<GETELEM><NAME>arguments</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
    <RETURN>return <NAME>elements</NAME></RETURN>;
  }</BLOCK></BLOCK><TARGET/>
  <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>element</NAME>)</CALL></IFNE>)
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>document</NAME>.<GETPROP><STRING>getElementById</STRING></GETPROP>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
  <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
}</FUNCTION>

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>XPath</STRING></GETPROP></IFNE>) <BLOCK>{
  <EXPR_RESULT><SETPROP><NAME>document</NAME>.<STRING>_getElementsByXPath</STRING> = <FUNCTION>function(<PARAMETER>expression</PARAMETER>, <PARAMETER>parentElement</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <VAR>var <NAME>query = <CALL><NAME>document</NAME>.<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>expression</NAME>, <OR><CALL><NAME>$</NAME>(<NAME>parentElement</NAME>)</CALL> || <NAME>document</NAME></OR>,
      <NULL>null</NULL>, <GETPROP><NAME>XPathResult</NAME>.<STRING>ORDERED_NODE_SNAPSHOT_TYPE</STRING></GETPROP>, <NULL>null</NULL>)</CALL></NAME></VAR>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>query</NAME>.<STRING>snapshotLength</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <EXPR_VOID><CALL><NAME><TARGET/>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<CALL><NAME>query</NAME>.<GETPROP><STRING>snapshotItem</STRING></GETPROP>(<NAME>i</NAME>)</CALL>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

/*--------------------------------------------------------------------------*/

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>window</NAME>.<STRING>Node</STRING></GETPROP></NOT></IFNE>) <VAR>var <NAME>Node = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;</BLOCK><TARGET/>

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Node</NAME>.<STRING>ELEMENT_NODE</STRING></GETPROP></NOT></IFNE>) <BLOCK>{
  // DOM level 2 ECMAScript Language Binding
  <EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Node</NAME>, <OBJECTLIT>{
    <OBJLITNAME>ELEMENT_NODE</OBJLITNAME>: <NUMBER>1</NUMBER>,
    <OBJLITNAME>ATTRIBUTE_NODE</OBJLITNAME>: <NUMBER>2</NUMBER>,
    <OBJLITNAME>TEXT_NODE</OBJLITNAME>: <NUMBER>3</NUMBER>,
    <OBJLITNAME>CDATA_SECTION_NODE</OBJLITNAME>: <NUMBER>4</NUMBER>,
    <OBJLITNAME>ENTITY_REFERENCE_NODE</OBJLITNAME>: <NUMBER>5</NUMBER>,
    <OBJLITNAME>ENTITY_NODE</OBJLITNAME>: <NUMBER>6</NUMBER>,
    <OBJLITNAME>PROCESSING_INSTRUCTION_NODE</OBJLITNAME>: <NUMBER>7</NUMBER>,
    <OBJLITNAME>COMMENT_NODE</OBJLITNAME>: <NUMBER>8</NUMBER>,
    <OBJLITNAME>DOCUMENT_NODE</OBJLITNAME>: <NUMBER>9</NUMBER>,
    <OBJLITNAME>DOCUMENT_TYPE_NODE</OBJLITNAME>: <NUMBER>10</NUMBER>,
    <OBJLITNAME>DOCUMENT_FRAGMENT_NODE</OBJLITNAME>: <NUMBER>11</NUMBER>,
    <OBJLITNAME>NOTATION_NODE</OBJLITNAME>: <NUMBER>12</NUMBER>
  }</OBJECTLIT>)</CALL></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

(<EXPR_RESULT><CALL><FUNCTION>function() <BLOCK>{
  <VAR>var <NAME>element = <GETPROP><THIS>this</THIS>.<STRING>Element</STRING></GETPROP></NAME></VAR>;
  <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>Element</STRING> = <FUNCTION>function(<PARAMETER>tagName</PARAMETER>, <PARAMETER>attributes</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>attributes</BINDNAME> = <OR><NAME>attributes</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>tagName</BINDNAME> = <CALL><NAME>tagName</NAME>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>cache = <GETPROP><NAME>Element</NAME>.<STRING>cache</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><AND><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP> &amp;&amp; <GETPROP><NAME>attributes</NAME>.<STRING>name</STRING></GETPROP></AND></IFNE>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>tagName</BINDNAME> = <ADD><ADD><ADD><ADD><STRING>'&lt;'</STRING> + <NAME>tagName</NAME></ADD> + <STRING>' name="'</STRING></ADD> + <GETPROP><NAME>attributes</NAME>.<STRING>name</STRING></GETPROP></ADD> + <STRING>'"&gt;'</STRING></ADD></SETNAME></EXPR_VOID>;
      delete <EXPR_VOID><DELPROP><NAME>attributes</NAME>.<STRING>name</STRING></DELPROP></EXPR_VOID>;
      <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>writeAttribute</STRING></GETPROP>(<CALL><NAME>document</NAME>.<GETPROP><STRING>createElement</STRING></GETPROP>(<NAME>tagName</NAME>)</CALL>, <NAME>attributes</NAME>)</CALL></RETURN>;
    }</BLOCK></BLOCK><TARGET/>
    <BLOCK>if (<IFNE><NOT>!<GETELEM><NAME>cache</NAME>[<NAME>tagName</NAME>]</GETELEM></NOT></IFNE>) <EXPR_VOID><SETELEM><NAME>cache</NAME>[<NAME>tagName</NAME>] = <CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<CALL><NAME>document</NAME>.<GETPROP><STRING>createElement</STRING></GETPROP>(<NAME>tagName</NAME>)</CALL>)</CALL></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>writeAttribute</STRING></GETPROP>(<CALL><GETELEM><NAME>cache</NAME>[<NAME>tagName</NAME></GETELEM>].<GETPROP><STRING>cloneNode</STRING></GETPROP>(<FALSE>false</FALSE>)</CALL>, <NAME>attributes</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_VOID>;
  <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>Element</STRING></GETPROP>, <OR><NAME>element</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></EXPR_VOID>;
</BLOCK><RETURN/>}</FUNCTION>).<GETPROP><STRING>call</STRING></GETPROP>(<NAME>window</NAME>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>cache</STRING> = <OBJECTLIT>{ }</OBJECTLIT></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>Methods</STRING> = <OBJECTLIT>{
  <OBJLITNAME>visible</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <NE><GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>style</STRING></GETPROP>.<STRING>display</STRING></GETPROP> != <STRING>'none'</STRING></NE></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toggle</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><GETELEM><NAME>Element</NAME>[<HOOK><CALL><NAME>Element</NAME>.<GETPROP><STRING>visible</STRING></GETPROP>(<NAME>element</NAME>)</CALL> ? <STRING>'hide'</STRING> : <STRING>'show'</STRING></HOOK></GETELEM>](<NAME>element</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>hide</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>display</STRING> = <STRING>'none'</STRING></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>show</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>display</STRING> = <STRING>''</STRING></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>remove</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>removeChild</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>update</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></IFNE>) <RETURN>return <CALL><NAME>element</NAME>.<CALL><GETPROP><STRING>update</STRING></GETPROP></CALL>().<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>content</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>innerHTML</STRING> = <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>replace</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    else <BLOCK><TARGET/>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></NOT></IFNE>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <VAR>var <NAME>range = <CALL><NAME>element</NAME>.<GETPROP><STRING>ownerDocument</STRING></GETPROP>.<GETPROP><STRING>createRange</STRING></GETPROP>()</CALL></NAME></VAR>;
      <EXPR_VOID><CALL><NAME>range</NAME>.<GETPROP><STRING>selectNode</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>range</NAME>.<GETPROP><STRING>createContextualFragment</STRING></GETPROP>(<CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL>)</CALL></SETNAME></EXPR_VOID>;
    <GOTO/>}</BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>replaceChild</STRING></GETPROP>(<NAME>content</NAME>, <NAME>element</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>compileMatcher</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><CALL><THIS>this</THIS>.<GETPROP><STRING>shouldUseXPath</STRING></GETPROP>()</CALL></IFNE>)
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>compileXPathMatcher</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>e = <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></NAME>, <NAME>ps = <GETPROP><NAME>Selector</NAME>.<STRING>patterns</STRING></GETPROP></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME>,
        <NAME>c = <GETPROP><NAME>Selector</NAME>.<STRING>criteria</STRING></GETPROP></NAME>, <NAME>le</NAME>, <NAME>p</NAME>, <NAME>m</NAME></VAR>;

    <BLOCK>if (<IFNE><GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>matcher</STRING> = <GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></SETPROP></EXPR_VOID>;
      <RETURN>return</RETURN>;
    }</BLOCK></BLOCK><TARGET/>

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>matcher</STRING> = [<ARRAYLIT><STRING>"this.matcher = function(root) {"</STRING>,
                    <STRING>"var r = root, h = Selector.handlers, c = false, n;"</STRING>]</ARRAYLIT></SETPROP></EXPR_VOID>;

    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>e</NAME> &amp;&amp; <AND><NE><NAME>le</NAME> != <NAME>e</NAME></NE> &amp;&amp; (<CALL><REGEXP>/\S/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>e</NAME>)</CALL></AND></AND></IFEQ>) <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>le</BINDNAME> = <NAME>e</NAME></SETNAME></EXPR_VOID>;
      <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>i</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>ps</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
        <EXPR_VOID><SETNAME><BINDNAME>p</BINDNAME> = <GETELEM><NAME>ps</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>p</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
          <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>c</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL> ? <CALL><GETELEM><NAME>c</NAME>[<NAME>i</NAME></GETELEM>](<NAME>m</NAME>)</CALL> :
    	      <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>c</NAME>[<NAME>i</NAME>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></HOOK>)</CALL></EXPR_VOID>;
          <EXPR_VOID><SETNAME><BINDNAME>e</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<GETELEM><NAME>m</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
          <BREAK>break</BREAK>;
        }</BLOCK></BLOCK><TARGET/>
      <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>

    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<STRING>"return h.unique(n);\n}"</STRING>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>eval</NAME>(<CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>'\n'</STRING>)</CALL>)</CALL></EXPR_VOID>;
    <NAME>Selector</NAME>.<EXPR_VOID><SETELEM><GETPROP><STRING>_cache</STRING></GETPROP>[<GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP>] = <GETPROP><THIS>this</THIS>.<STRING>matcher</STRING></GETPROP></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,
  <OBJLITNAME>removeClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</SETNAME></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>className</STRING> = <CALL><NAME>element</NAME>.<GETPROP><STRING>className</STRING></GETPROP>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(
      <NEW>new <NAME>RegExp</NAME>(<ADD><ADD><STRING>"(^|\\s+)"</STRING> + <NAME>className</NAME></ADD> + <STRING>"(\\s+|$)"</STRING></ADD>)</NEW>, <STRING>' '</STRING></CALL>).<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  
  <OBJLITNAME>insert</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>insertions</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;

    <BLOCK>if (<IFNE><OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> || <OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isNumber</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> ||
        <OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> || (<AND><NAME>insertions</NAME> &amp;&amp; (<OR><GETPROP><NAME>insertions</NAME>.<STRING>toElement</STRING></GETPROP> || <GETPROP><NAME>insertions</NAME>.<STRING>toHTML</STRING></GETPROP>)</OR>)</AND></OR></OR></OR></IFNE>)
          <EXPR_VOID><SETNAME><BINDNAME>insertions</BINDNAME> = <OBJECTLIT>{<OBJLITNAME>bottom</OBJLITNAME>:<NAME>insertions</NAME>}</OBJECTLIT></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <VAR>var <NAME>content</NAME>, <NAME>t</NAME>, <NAME>range</NAME></VAR>;

    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for (<EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>position</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID> in <ENUM_INIT_KEYS><NAME>insertions</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME>  = <GETELEM><NAME>insertions</NAME>[<NAME>position</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>position</BINDNAME> = <CALL><NAME>position</NAME>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>t</BINDNAME> = <GETELEM><NAME>Element</NAME>.<GETPROP><STRING>_insertionTranslations</STRING></GETPROP>[<NAME>position</NAME>]</GETELEM></SETNAME></EXPR_VOID>;

      <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>t</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <NAME>content</NAME>)</CALL></EXPR_VOID>;
        <CONTINUE>continue</CONTINUE>;
      }</BLOCK></BLOCK><TARGET/>

      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;

      <EXPR_VOID><SETNAME><BINDNAME>range</BINDNAME> = <CALL><NAME>element</NAME>.<GETPROP><STRING>ownerDocument</STRING></GETPROP>.<GETPROP><STRING>createRange</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>t</NAME>.<GETPROP><STRING>initializeRange</STRING></GETPROP>(<NAME>element</NAME>, <NAME>range</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>t</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <CALL><NAME>range</NAME>.<GETPROP><STRING>createContextualFragment</STRING></GETPROP>(<CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL>)</CALL>)</CALL></EXPR_VOID>;

      <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>

    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>wrap</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>wrapper</PARAMETER>, <PARAMETER>attributes</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>wrapper</NAME>)</CALL></IFNE>)
      <EXPR_VOID><CALL><CALL><NAME>$</NAME>(<NAME>wrapper</NAME></CALL>).<GETPROP><STRING>writeAttribute</STRING></GETPROP>(<OR><NAME>attributes</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></EXPR_VOID>;
    else <BLOCK><TARGET/>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>wrapper</NAME>)</CALL></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>wrapper</BINDNAME> = <NEW>new <NAME>Element</NAME>(<NAME>wrapper</NAME>, <NAME>attributes</NAME>)</NEW></SETNAME></EXPR_VOID>;
    else <EXPR_VOID><SETNAME><BINDNAME><TARGET/>wrapper</BINDNAME> = <NEW>new <NAME>Element</NAME>(<STRING>'div'</STRING>, <NAME>wrapper</NAME>)</NEW></SETNAME></EXPR_VOID><GOTO/><GOTO/><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP></IFNE>)
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>replaceChild</STRING></GETPROP>(<NAME>wrapper</NAME>, <NAME>element</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><NAME>wrapper</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>wrapper</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>result = <ADD><STRING>'&lt;'</STRING> + <CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></ADD></NAME></VAR>;
    <EXPR_VOID><CALL><CALL><NAME>$H</NAME>(<OBJECTLIT>{'<OBJLITNAME>id</OBJLITNAME>': <STRING>'id'</STRING>, '<OBJLITNAME>className</OBJLITNAME>': <STRING>'class'</STRING>}</OBJECTLIT></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>pair</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>property = <CALL><NAME>pair</NAME>.<GETPROP><STRING>first</STRING></GETPROP>()</CALL></NAME>, <NAME>attribute = <CALL><NAME>pair</NAME>.<GETPROP><STRING>last</STRING></GETPROP>()</CALL></NAME></VAR>;
      <VAR>var <NAME>value = (<CALL><OR><GETELEM><NAME>element</NAME>[<NAME>property</NAME>]</GETELEM> || <STRING>''</STRING></OR>).<GETPROP><STRING>toString</STRING></GETPROP>()</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NAME>value</NAME></IFNE>) <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>result</NAME></BINDNAME> += <ADD><ADD><ADD><STRING>' '</STRING> + <NAME>attribute</NAME></ADD> + <STRING>'='</STRING></ADD> + <CALL><NAME>value</NAME>.<GETPROP><STRING>inspect</STRING></GETPROP>(<TRUE>true</TRUE>)</CALL></ADD></ADD></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <ADD><NAME>result</NAME> + <STRING>'&gt;'</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>recursivelyCollect</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>property</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>elements = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
    <LOOP><EMPTY/>while (<IFEQ><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETELEM><NAME>element</NAME>[<NAME>property</NAME>]</GETELEM></SETNAME></IFEQ>)
      <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>element</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>)
        <EXPR_VOID><CALL><NAME>elements</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>element</NAME>)</CALL>)</CALL></EXPR_VOID><TARGET/><GOTO/><TARGET/>;</BLOCK></LOOP><TARGET/>
    <RETURN>return <NAME>elements</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>ancestors</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>recursivelyCollect</STRING></GETPROP>(<STRING>'parentNode'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>descendants</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getElementsBySelector</STRING></GETPROP>(<STRING>"*"</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>firstDescendant</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<STRING>firstChild</STRING></GETPROP></SETNAME></EXPR_VOID>;
    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>element</NAME> &amp;&amp; <NE><GETPROP><NAME>element</NAME>.<STRING>nodeType</STRING></GETPROP> != <NUMBER>1</NUMBER></NE></AND></IFEQ>) <EXPR_VOID><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>nextSibling</STRING></GETPROP></SETNAME></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
    <RETURN>return <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>immediateDescendants</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<STRING>firstChild</STRING></GETPROP>)</SETNAME></NOT></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>element</NAME> &amp;&amp; <NE><GETPROP><NAME>element</NAME>.<STRING>nodeType</STRING></GETPROP> != <NUMBER>1</NUMBER></NE></AND></IFEQ>) <EXPR_VOID><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>nextSibling</STRING></GETPROP></SETNAME></EXPR_VOID></LOOP><TARGET/><GOTO/><TARGET/>;
    <BLOCK>if (<IFNE><NAME>element</NAME></IFNE>) <RETURN>return [<CALL><ARRAYLIT><NAME>element</NAME></ARRAYLIT>].<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>nextSiblings</STRING></GETPROP>()</CALL>)</CALL></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>previousSiblings</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>recursivelyCollect</STRING></GETPROP>(<STRING>'previousSibling'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>nextSiblings</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>recursivelyCollect</STRING></GETPROP>(<STRING>'nextSibling'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>siblings</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <RETURN>return <CALL><NAME>element</NAME>.<CALL><GETPROP><STRING>previousSiblings</STRING></GETPROP></CALL>().<CALL><GETPROP><STRING>reverse</STRING></GETPROP></CALL>().<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>element</NAME>.<GETPROP><STRING>nextSiblings</STRING></GETPROP>()</CALL>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>match</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>selector</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>selector</NAME>)</CALL></IFNE>)
      <EXPR_VOID><SETNAME><BINDNAME>selector</BINDNAME> = <NEW>new <NAME>Selector</NAME>(<NAME>selector</NAME>)</NEW></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <RETURN>return <CALL><NAME>selector</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>up</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>expression</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <CALL><NAME>$</NAME>(<GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP>)</CALL></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>ancestors = <CALL><NAME>element</NAME>.<GETPROP><STRING>ancestors</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <HOOK><NAME>expression</NAME> ? <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findElement</STRING></GETPROP>(<NAME>ancestors</NAME>, <NAME>expression</NAME>, <NAME>index</NAME>)</CALL> :
      <GETELEM><NAME>ancestors</NAME>[<OR><NAME>index</NAME> || <NUMBER>0</NUMBER></OR>]</GETELEM></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>down</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>expression</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <CALL><NAME>element</NAME>.<GETPROP><STRING>firstDescendant</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>descendants = <CALL><NAME>element</NAME>.<GETPROP><STRING>descendants</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <HOOK><NAME>expression</NAME> ? <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findElement</STRING></GETPROP>(<NAME>descendants</NAME>, <NAME>expression</NAME>, <NAME>index</NAME>)</CALL> :
      <GETELEM><NAME>descendants</NAME>[<OR><NAME>index</NAME> || <NUMBER>0</NUMBER></OR>]</GETELEM></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>previous</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>expression</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <CALL><NAME>$</NAME>(<CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>previousElementSibling</STRING></GETPROP>(<NAME>element</NAME>)</CALL>)</CALL></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>previousSiblings = <CALL><NAME>element</NAME>.<GETPROP><STRING>previousSiblings</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <HOOK><NAME>expression</NAME> ? <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findElement</STRING></GETPROP>(<NAME>previousSiblings</NAME>, <NAME>expression</NAME>, <NAME>index</NAME>)</CALL> :
      <GETELEM><NAME>previousSiblings</NAME>[<OR><NAME>index</NAME> || <NUMBER>0</NUMBER></OR>]</GETELEM></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>next</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>expression</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <CALL><NAME>$</NAME>(<CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>nextElementSibling</STRING></GETPROP>(<NAME>element</NAME>)</CALL>)</CALL></RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>nextSiblings = <CALL><NAME>element</NAME>.<GETPROP><STRING>nextSiblings</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <HOOK><NAME>expression</NAME> ? <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findElement</STRING></GETPROP>(<NAME>nextSiblings</NAME>, <NAME>expression</NAME>, <NAME>index</NAME>)</CALL> :
      <GETELEM><NAME>nextSiblings</NAME>[<OR><NAME>index</NAME> || <NUMBER>0</NUMBER></OR>]</GETELEM></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>select</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME>, <NAME>element = <CALL><NAME>$</NAME>(<CALL><NAME>args</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findChildElements</STRING></GETPROP>(<NAME>element</NAME>, <NAME>args</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>adjacent</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>args = <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL></NAME>, <NAME>element = <CALL><NAME>$</NAME>(<CALL><NAME>args</NAME>.<GETPROP><STRING>shift</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><NAME>Selector</NAME>.<CALL><GETPROP><STRING>findChildElements</STRING></GETPROP>(<GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP>, <NAME>args</NAME></CALL>).<GETPROP><STRING>without</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>identify</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>id = <CALL><NAME>element</NAME>.<GETPROP><STRING>readAttribute</STRING></GETPROP>(<STRING>'id'</STRING>)</CALL></NAME>, <NAME>self = <GETPROP><NAME>arguments</NAME>.<STRING>callee</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><NAME>id</NAME></IFNE>) <RETURN>return <NAME>id</NAME></RETURN>;</BLOCK><TARGET/>
    <LOOP>do <BLOCK><TARGET/>{ <EXPR_VOID><SETNAME><BINDNAME>id</BINDNAME> = <ADD><STRING>'anonymous_element_'</STRING> + <INC><GETPROP><NAME>self</NAME>.<STRING>counter</STRING></GETPROP></INC></ADD></SETNAME></EXPR_VOID>++ }</BLOCK> while (<IFEQ><CALL><NAME><TARGET/>$</NAME>(<NAME>id</NAME>)</CALL></IFEQ></LOOP><TARGET/>);
    <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>writeAttribute</STRING></GETPROP>(<STRING>'id'</STRING>, <NAME>id</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>id</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>readAttribute</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>name</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></IFNE>) <BLOCK>{
      <VAR>var <NAME>t = <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<STRING>read</STRING></GETPROP></NAME></VAR>;
      <BLOCK>if (<IFNE><GETELEM><NAME>t</NAME>.<GETPROP><STRING>values</STRING></GETPROP>[<NAME>name</NAME>]</GETELEM></IFNE>) <RETURN>return <CALL><NAME>t</NAME>.<GETELEM><GETPROP><STRING>values</STRING></GETPROP>[<NAME>name</NAME></GETELEM>](<NAME>element</NAME>, <NAME>name</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><GETELEM><NAME>t</NAME>.<GETPROP><STRING>names</STRING></GETPROP>[<NAME>name</NAME>]</GETELEM></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>name</BINDNAME> = <GETELEM><NAME>t</NAME>.<GETPROP><STRING>names</STRING></GETPROP>[<NAME>name</NAME>]</GETELEM></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><CALL><NAME>name</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>':'</STRING>)</CALL></IFNE>) <BLOCK>{
        <RETURN>return (!<HOOK><OR><NOT><GETPROP><NAME>element</NAME>.<STRING>attributes</STRING></GETPROP></NOT> || !<NOT><GETELEM><NAME>element</NAME>.<GETPROP><STRING>attributes</STRING></GETPROP>[<NAME>name</NAME>]</GETELEM></NOT>)</OR> ? <NULL>null</NULL> :
         <GETPROP><NAME>element</NAME>.<GETELEM><GETPROP><STRING>attributes</STRING></GETPROP>[<NAME>name</NAME></GETELEM>].<STRING>value</STRING></GETPROP></HOOK></RETURN>;
      }</BLOCK></BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <CALL><NAME>element</NAME>.<GETPROP><STRING>getAttribute</STRING></GETPROP>(<NAME>name</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>writeAttribute</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>name</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>attributes = <OBJECTLIT>{ }</OBJECTLIT></NAME>, <NAME>t = <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<STRING>write</STRING></GETPROP></NAME></VAR>;

    <BLOCK>if (<IFNE><EQ>typeof <TYPEOFNAME>name</TYPEOFNAME> == <STRING>'object'</STRING></EQ></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>attributes</BINDNAME> = <NAME>name</NAME></SETNAME></EXPR_VOID>;
    else <EXPR_VOID><SETELEM><NAME><TARGET/>attributes</NAME>[<NAME>name</NAME>] = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL> ? <TRUE>true</TRUE> : <NAME>value</NAME></HOOK></SETELEM></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>

    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>attr</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>attributes</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>name</BINDNAME> = <OR><GETELEM><NAME>t</NAME>.<GETPROP><STRING>names</STRING></GETPROP>[<NAME>attr</NAME>]</GETELEM> || <NAME>attr</NAME></OR></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <GETELEM><NAME>attributes</NAME>[<NAME>attr</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><GETELEM><NAME>t</NAME>.<GETPROP><STRING>values</STRING></GETPROP>[<NAME>attr</NAME>]</GETELEM></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>name</BINDNAME> = <CALL><NAME>t</NAME>.<GETELEM><GETPROP><STRING>values</STRING></GETPROP>[<NAME>attr</NAME></GETELEM>](<NAME>element</NAME>, <NAME>value</NAME>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><OR><SHEQ><NAME>value</NAME> === <FALSE>false</FALSE></SHEQ> || <SHEQ><NAME>value</NAME> === <NULL>null</NULL></SHEQ></OR></IFNE>)
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>removeAttribute</STRING></GETPROP>(<NAME>name</NAME>)</CALL></EXPR_VOID>;
      else <BLOCK><TARGET/>if (<IFNE><SHEQ><NAME>value</NAME> === <TRUE>true</TRUE></SHEQ></IFNE>)
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>setAttribute</STRING></GETPROP>(<NAME>name</NAME>, <NAME>name</NAME>)</CALL></EXPR_VOID>;
      else <EXPR_VOID><CALL><NAME><TARGET/>element</NAME>.<GETPROP><STRING>setAttribute</STRING></GETPROP>(<NAME>name</NAME>, <NAME>value</NAME>)</CALL></EXPR_VOID><GOTO/><GOTO/><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getHeight</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<CALL><GETPROP><STRING>getDimensions</STRING></GETPROP></CALL>().<STRING>height</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getWidth</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<CALL><GETPROP><STRING>getDimensions</STRING></GETPROP></CALL>().<STRING>width</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>classNames</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <NEW>new <GETPROP><NAME>Element</NAME>.<STRING>ClassNames</STRING></GETPROP>(<NAME>element</NAME>)</NEW></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>hasClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</SETNAME></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <VAR>var <NAME>elementClassName = <GETPROP><NAME>element</NAME>.<STRING>className</STRING></GETPROP></NAME></VAR>;
    <RETURN>return (<AND><GT><GETPROP><NAME>elementClassName</NAME>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>0</NUMBER></GT> &amp;&amp; (<OR><EQ><NAME>elementClassName</NAME> == <NAME>className</NAME></EQ> ||
      <CALL><NEW>new <NAME>RegExp</NAME>(<ADD><ADD><STRING>"(^|\\s)"</STRING> + <NAME>className</NAME></ADD> + <STRING>"(\\s|$)"</STRING></ADD></NEW>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>elementClassName</NAME>)</CALL>)</OR>)</AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>addClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</SETNAME></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><NOT>!<CALL><NAME>element</NAME>.<GETPROP><STRING>hasClassName</STRING></GETPROP>(<NAME>className</NAME>)</CALL></NOT></IFNE>)
      <EXPR_VOID><SETPROP_OP><NAME><ADD><USE_STACK/>element</NAME>.<STRING>className</STRING> += (<ADD><HOOK><GETPROP><NAME>element</NAME>.<STRING>className</STRING></GETPROP> ? <STRING>' '</STRING> : <STRING>''</STRING>)</HOOK> + <NAME>className</NAME></ADD></ADD></SETPROP_OP></EXPR_VOID>;</BLOCK><TARGET/>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>removeClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</SETNAME></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>className</STRING> = <CALL><NAME>element</NAME>.<GETPROP><STRING>className</STRING></GETPROP>.<CALL><GETPROP><STRING>replace</STRING></GETPROP>(
      <NEW>new <NAME>RegExp</NAME>(<ADD><ADD><STRING>"(^|\\s+)"</STRING> + <NAME>className</NAME></ADD> + <STRING>"(\\s+|$)"</STRING></ADD>)</NEW>, <STRING>' '</STRING></CALL>).<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toggleClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!(<SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL>)</SETNAME></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <RETURN>return <CALL><GETELEM><NAME>element</NAME>[<HOOK><CALL><NAME>element</NAME>.<GETPROP><STRING>hasClassName</STRING></GETPROP>(<NAME>className</NAME>)</CALL> ?
      <STRING>'removeClassName'</STRING> : <STRING>'addClassName'</STRING></HOOK></GETELEM>](<NAME>className</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  // removes whitespace-only text node children
  <OBJLITNAME>cleanWhitespace</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>node = <GETPROP><NAME>element</NAME>.<STRING>firstChild</STRING></GETPROP></NAME></VAR>;
    <LOOP><EMPTY/>while (<IFEQ><NAME><TARGET/>node</NAME></IFEQ>) <BLOCK><TARGET/>{
      <VAR>var <NAME>nextNode = <GETPROP><NAME>node</NAME>.<STRING>nextSibling</STRING></GETPROP></NAME></VAR>;
      <BLOCK>if (<IFNE><AND><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>3</NUMBER></EQ> &amp;&amp; !<NOT><CALL><REGEXP>/\S/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<GETPROP><NAME>node</NAME>.<STRING>nodeValue</STRING></GETPROP>)</CALL></NOT></AND></IFNE>)
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>removeChild</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <EXPR_VOID><SETNAME><BINDNAME>node</BINDNAME> = <NAME>nextNode</NAME></SETNAME></EXPR_VOID>;
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>empty</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>innerHTML</STRING></GETPROP>.<GETPROP><STRING>blank</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>descendantOf</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>ancestor</PARAMETER>) <BLOCK>{
    <EXPR_VOID><COMMA><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME>, <SETNAME><BINDNAME>ancestor</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>ancestor</NAME>)</CALL></SETNAME></COMMA></EXPR_VOID>;
    <VAR>var <NAME>originalAncestor = <NAME>ancestor</NAME></NAME></VAR>;

    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>compareDocumentPosition</STRING></GETPROP></IFNE>)
      <RETURN>return (<SHEQ><BITAND><CALL><NAME>element</NAME>.<GETPROP><STRING>compareDocumentPosition</STRING></GETPROP>(<NAME>ancestor</NAME>)</CALL> &amp; <NUMBER>8</NUMBER>)</BITAND> === <NUMBER>8</NUMBER></SHEQ></RETURN>;</BLOCK><TARGET/>

    <BLOCK>if (<IFNE><AND><GETPROP><NAME>element</NAME>.<STRING>sourceIndex</STRING></GETPROP> &amp;&amp; !<NOT><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></NOT></AND></IFNE>) <BLOCK>{
      <VAR>var <NAME>e = <GETPROP><NAME>element</NAME>.<STRING>sourceIndex</STRING></GETPROP></NAME>, <NAME>a = <GETPROP><NAME>ancestor</NAME>.<STRING>sourceIndex</STRING></GETPROP></NAME>,
       <NAME>nextAncestor = <GETPROP><NAME>ancestor</NAME>.<STRING>nextSibling</STRING></GETPROP></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>nextAncestor</NAME></NOT></IFNE>) <BLOCK>{
        <LOOP>do <BLOCK><TARGET/>{ <EXPR_VOID><SETNAME><BINDNAME>ancestor</BINDNAME> = <GETPROP><NAME>ancestor</NAME>.<STRING>parentNode</STRING></GETPROP></SETNAME></EXPR_VOID>; }</BLOCK>
        while (<IFEQ><AND><TARGET/>!(<NOT><SETNAME><BINDNAME>nextAncestor</BINDNAME> = <GETPROP><NAME>ancestor</NAME>.<STRING>nextSibling</STRING></GETPROP>)</SETNAME></NOT> &amp;&amp; <GETPROP><NAME>ancestor</NAME>.<STRING>parentNode</STRING></GETPROP></AND></IFEQ></LOOP><TARGET/>);
      }</BLOCK></BLOCK><TARGET/>
      <BLOCK>if (<IFNE><NAME>nextAncestor</NAME></IFNE>) <RETURN>return (<AND><GT><NAME>e</NAME> &gt; <NAME>a</NAME></GT> &amp;&amp; <LT><NAME>e</NAME> &lt; <GETPROP><NAME>nextAncestor</NAME>.<STRING>sourceIndex</STRING></GETPROP></LT>)</AND></RETURN>;</BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>

    <LOOP><EMPTY/>while (<IFEQ><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP></SETNAME></IFEQ>)
      <BLOCK><TARGET/>if (<IFNE><EQ><NAME>element</NAME> == <NAME>originalAncestor</NAME></EQ></IFNE>) <RETURN>return <TRUE>true</TRUE></RETURN><TARGET/><GOTO/><TARGET/>;</BLOCK></LOOP><TARGET/>
    <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>scrollTo</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>pos = <CALL><NAME>element</NAME>.<GETPROP><STRING>cumulativeOffset</STRING></GETPROP>()</CALL></NAME></VAR>;
    <EXPR_VOID><CALL><NAME>window</NAME>.<GETPROP><STRING>scrollTo</STRING></GETPROP>(<GETELEM><NAME>pos</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <GETELEM><NAME>pos</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getStyle</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>style</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>style</BINDNAME> = <HOOK><EQ><NAME>style</NAME> == <STRING>'float'</STRING></EQ> ? <STRING>'cssFloat'</STRING> : <CALL><NAME>style</NAME>.<GETPROP><STRING>camelize</STRING></GETPROP>()</CALL></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>value = <GETELEM><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>[<NAME>style</NAME>]</GETELEM></NAME></VAR>;
    <BLOCK>if (<IFNE><NOT>!<NAME>value</NAME></NOT></IFNE>) <BLOCK>{
      <VAR>var <NAME>css = <CALL><NAME>document</NAME>.<GETPROP><STRING>defaultView</STRING></GETPROP>.<GETPROP><STRING>getComputedStyle</STRING></GETPROP>(<NAME>element</NAME>, <NULL>null</NULL>)</CALL></NAME></VAR>;
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <HOOK><NAME>css</NAME> ? <GETELEM><NAME>css</NAME>[<NAME>style</NAME>]</GETELEM> : <NULL>null</NULL></HOOK></SETNAME></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
    <BLOCK>if (<IFNE><EQ><NAME>style</NAME> == <STRING>'opacity'</STRING></EQ></IFNE>) <RETURN>return <HOOK><NAME>value</NAME> ? <CALL><NAME>parseFloat</NAME>(<NAME>value</NAME>)</CALL> : <NUMBER>1.0</NUMBER></HOOK></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <HOOK><EQ><NAME>value</NAME> == <STRING>'auto'</STRING></EQ> ? <NULL>null</NULL> : <NAME>value</NAME></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getOpacity</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'opacity'</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>setStyle</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>styles</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>elementStyle = <GETPROP><NAME>element</NAME>.<STRING>style</STRING></GETPROP></NAME>, <NAME>match</NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>styles</NAME>)</CALL></IFNE>) <BLOCK>{
      <NAME><ADD><USE_STACK/>element</NAME>.<EXPR_VOID><SETPROP_OP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>cssText</STRING> += <ADD><STRING>';'</STRING> + <NAME>styles</NAME></ADD></ADD></SETPROP_OP></EXPR_VOID>;
      <RETURN>return <HOOK><CALL><NAME>styles</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>'opacity'</STRING>)</CALL> ?
        <CALL><NAME>element</NAME>.<GETPROP><STRING>setOpacity</STRING></GETPROP>(<GETELEM><NAME>styles</NAME>.<CALL><GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/opacity:\s*(\d?\.?\d*)/</REGEXP></CALL>)[<NUMBER>1</NUMBER>]</GETELEM>)</CALL> : <NAME>element</NAME></HOOK></RETURN>;
    }</BLOCK></BLOCK><TARGET/>
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>styles</NAME></ENUM_INIT_KEYS>)
      <BLOCK><BLOCK><TARGET/>if (<IFNE><EQ><NAME>property</NAME> == <STRING>'opacity'</STRING></EQ></IFNE>) <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>setOpacity</STRING></GETPROP>(<GETELEM><NAME>styles</NAME>[<NAME>property</NAME>]</GETELEM>)</CALL></EXPR_VOID>;
      else
        <EXPR_VOID><SETELEM><NAME><TARGET/>elementStyle</NAME>[(<HOOK><OR><EQ><NAME>property</NAME> == <STRING>'float'</STRING></EQ> || <EQ><NAME>property</NAME> == <STRING>'cssFloat'</STRING></EQ>)</OR> ?
          (<HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<GETPROP><NAME>elementStyle</NAME>.<STRING>styleFloat</STRING></GETPROP>)</CALL> ? <STRING>'cssFloat'</STRING> : <STRING>'styleFloat'</STRING>)</HOOK> :
            <NAME>property</NAME></HOOK>] = <GETELEM><NAME>styles</NAME>[<NAME>property</NAME>]</GETELEM></SETELEM></EXPR_VOID><TARGET/><GOTO/><GOTO/><GOTO/><TARGET/>;</BLOCK></BLOCK></LOOP></LOCAL_BLOCK><TARGET/>

    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>setOpacity</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>opacity</STRING> = (<HOOK><OR><EQ><NAME>value</NAME> == <NUMBER>1</NUMBER></EQ> || <SHEQ><NAME>value</NAME> === <STRING>''</STRING></SHEQ>)</OR> ? <STRING>''</STRING> :
      (<HOOK><LT><NAME>value</NAME> &lt; <NUMBER>0.00001</NUMBER>)</LT> ? <NUMBER>0</NUMBER> : <NAME>value</NAME></HOOK></HOOK></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getDimensions</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>display = <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'display'</STRING>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><AND><NE><NAME>display</NAME> != <STRING>'none'</STRING></NE> &amp;&amp; <NE><NAME>display</NAME> != <NULL>null</NULL></NE></AND></IFNE>) // Safari bug
      <RETURN>return <OBJECTLIT>{<OBJLITNAME>width</OBJLITNAME>: <GETPROP><NAME>element</NAME>.<STRING>offsetWidth</STRING></GETPROP>, <OBJLITNAME>height</OBJLITNAME>: <GETPROP><NAME>element</NAME>.<STRING>offsetHeight</STRING></GETPROP>}</OBJECTLIT></RETURN>;</BLOCK><TARGET/>

    // All *Width and *Height properties give 0 on elements with display none,
    // so enable the element temporarily
    <VAR>var <NAME>els = <GETPROP><NAME>element</NAME>.<STRING>style</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>originalVisibility = <GETPROP><NAME>els</NAME>.<STRING>visibility</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>originalPosition = <GETPROP><NAME>els</NAME>.<STRING>position</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>originalDisplay = <GETPROP><NAME>els</NAME>.<STRING>display</STRING></GETPROP></NAME></VAR>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>visibility</STRING> = <STRING>'hidden'</STRING></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>position</STRING> = <STRING>'absolute'</STRING></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>display</STRING> = <STRING>'block'</STRING></SETPROP></EXPR_VOID>;
    <VAR>var <NAME>originalWidth = <GETPROP><NAME>element</NAME>.<STRING>clientWidth</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>originalHeight = <GETPROP><NAME>element</NAME>.<STRING>clientHeight</STRING></GETPROP></NAME></VAR>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>display</STRING> = <NAME>originalDisplay</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>position</STRING> = <NAME>originalPosition</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>els</NAME>.<STRING>visibility</STRING> = <NAME>originalVisibility</NAME></SETPROP></EXPR_VOID>;
    <RETURN>return <OBJECTLIT>{<OBJLITNAME>width</OBJLITNAME>: <NAME>originalWidth</NAME>, <OBJLITNAME>height</OBJLITNAME>: <NAME>originalHeight</NAME>}</OBJECTLIT></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>makePositioned</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>pos = <CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><OR><EQ><NAME>pos</NAME> == <STRING>'static'</STRING></EQ> || !<NOT><NAME>pos</NAME></NOT></OR></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_madePositioned</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
      <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>position</STRING> = <STRING>'relative'</STRING></SETPROP></EXPR_VOID>;
      // Opera returns the offset relative to the positioning context, when an
      // element is position relative but top and left have not been defined
      <BLOCK>if (<IFNE><GETPROP><NAME>window</NAME>.<STRING>opera</STRING></GETPROP></IFNE>) <BLOCK>{
        <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING> = <NUMBER>0</NUMBER></SETPROP></EXPR_VOID>;
        <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING> = <NUMBER>0</NUMBER></SETPROP></EXPR_VOID>;
      }</BLOCK></BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>undoPositioned</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>_madePositioned</STRING></GETPROP></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_madePositioned</STRING> = <NAME>undefined</NAME></SETPROP></EXPR_VOID>;
      <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>position</STRING> =
        <NAME>element</NAME>.<SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING> =
        <NAME>element</NAME>.<SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING> =
        <NAME>element</NAME>.<SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>bottom</STRING> =
        <NAME>element</NAME>.<SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>right</STRING> = <STRING>''</STRING></SETPROP></SETPROP></SETPROP></SETPROP></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>makeClipping</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>_overflow</STRING></GETPROP></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_overflow</STRING> = <OR><CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'overflow'</STRING>)</CALL> || <STRING>'auto'</STRING></OR></SETPROP></EXPR_VOID>;
    <BLOCK>if (<IFNE><SHNE><GETPROP><NAME>element</NAME>.<STRING>_overflow</STRING></GETPROP> !== <STRING>'hidden'</STRING></SHNE></IFNE>)
      <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>overflow</STRING> = <STRING>'hidden'</STRING></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>undoClipping</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>element</NAME>.<STRING>_overflow</STRING></GETPROP></NOT></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>overflow</STRING> = <HOOK><EQ><GETPROP><NAME>element</NAME>.<STRING>_overflow</STRING></GETPROP> == <STRING>'auto'</STRING></EQ> ? <STRING>''</STRING> : <GETPROP><NAME>element</NAME>.<STRING>_overflow</STRING></GETPROP></HOOK></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_overflow</STRING> = <NULL>null</NULL></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>cumulativeOffset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>valueT = <NUMBER>0</NUMBER></NAME>, <NAME>valueL = <NUMBER>0</NUMBER></NAME></VAR>;
    <LOOP>do <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueT</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueL</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP></SETNAME></EXPR_VOID>;
    }</BLOCK> while (<IFEQ><NAME><TARGET/>element</NAME></IFEQ></LOOP><TARGET/>);
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(<NAME>valueL</NAME>, <NAME>valueT</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>positionedOffset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>valueT = <NUMBER>0</NUMBER></NAME>, <NAME>valueL = <NUMBER>0</NUMBER></NAME></VAR>;
    <LOOP>do <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueT</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueL</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><NAME>element</NAME></IFNE>) <BLOCK>{
        <BLOCK>if (<IFNE><EQ><GETPROP><NAME>element</NAME>.<STRING>tagName</STRING></GETPROP> == <STRING>'BODY'</STRING></EQ></IFNE>) <BREAK>break</BREAK>;</BLOCK><TARGET/>
        <VAR>var <NAME>p = <CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL></NAME></VAR>;
        <BLOCK>if (<IFNE><OR><EQ><NAME>p</NAME> == <STRING>'relative'</STRING></EQ> || <EQ><NAME>p</NAME> == <STRING>'absolute'</STRING></EQ></OR></IFNE>) <BREAK>break</BREAK>;</BLOCK><TARGET/>
      }</BLOCK></BLOCK><TARGET/>
    }</BLOCK> while (<IFEQ><NAME><TARGET/>element</NAME></IFEQ></LOOP><TARGET/>);
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(<NAME>valueL</NAME>, <NAME>valueT</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>absolutize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'position'</STRING>)</CALL> == <STRING>'absolute'</STRING></EQ></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    // Position.prepare(); // To be done manually by Scripty when it needs it.

    <VAR>var <NAME>offsets = <CALL><NAME>element</NAME>.<GETPROP><STRING>positionedOffset</STRING></GETPROP>()</CALL></NAME></VAR>;
    <VAR>var <NAME>top     = <GETELEM><NAME>offsets</NAME>[<NUMBER>1</NUMBER>]</GETELEM></NAME></VAR>;
    <VAR>var <NAME>left    = <GETELEM><NAME>offsets</NAME>[<NUMBER>0</NUMBER>]</GETELEM></NAME></VAR>;
    <VAR>var <NAME>width   = <GETPROP><NAME>element</NAME>.<STRING>clientWidth</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>height  = <GETPROP><NAME>element</NAME>.<STRING>clientHeight</STRING></GETPROP></NAME></VAR>;

    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_originalLeft</STRING>   = <SUB><NAME>left</NAME> - <CALL><NAME>parseFloat</NAME>(<OR><GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR>)</CALL></SUB></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_originalTop</STRING>    = <SUB><NAME>top</NAME>  - <CALL><NAME>parseFloat</NAME>(<OR><GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING></GETPROP> || <NUMBER>0</NUMBER></OR>)</CALL></SUB></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_originalWidth</STRING>  = <GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>width</STRING></GETPROP></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_originalHeight</STRING> = <GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>height</STRING></GETPROP></SETPROP></EXPR_VOID>;

    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>position</STRING> = <STRING>'absolute'</STRING></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING>    = <ADD><NAME>top</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING>   = <ADD><NAME>left</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>width</STRING>  = <ADD><NAME>width</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>height</STRING> = <ADD><NAME>height</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>relativize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'position'</STRING>)</CALL> == <STRING>'relative'</STRING></EQ></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    // Position.prepare(); // To be done manually by Scripty when it needs it.

    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>position</STRING> = <STRING>'relative'</STRING></SETPROP></EXPR_VOID>;
    <VAR>var <NAME>top  = <SUB><CALL><NAME>parseFloat</NAME>(<OR><GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR>)</CALL> - (<OR><GETPROP><NAME>element</NAME>.<STRING>_originalTop</STRING></GETPROP> || <NUMBER>0</NUMBER>)</OR></SUB></NAME></VAR>;
    <VAR>var <NAME>left = <SUB><CALL><NAME>parseFloat</NAME>(<OR><GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING></GETPROP> || <NUMBER>0</NUMBER></OR>)</CALL> - (<OR><GETPROP><NAME>element</NAME>.<STRING>_originalLeft</STRING></GETPROP> || <NUMBER>0</NUMBER>)</OR></SUB></NAME></VAR>;

    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING>    = <ADD><NAME>top</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING>   = <ADD><NAME>left</NAME> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>height</STRING> = <GETPROP><NAME>element</NAME>.<STRING>_originalHeight</STRING></GETPROP></SETPROP></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>width</STRING>  = <GETPROP><NAME>element</NAME>.<STRING>_originalWidth</STRING></GETPROP></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>cumulativeScrollOffset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>valueT = <NUMBER>0</NUMBER></NAME>, <NAME>valueL = <NUMBER>0</NUMBER></NAME></VAR>;
    <LOOP>do <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueT</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>scrollTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueL</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>scrollLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP></SETNAME></EXPR_VOID>;
    }</BLOCK> while (<IFEQ><NAME><TARGET/>element</NAME></IFEQ></LOOP><TARGET/>);
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(<NAME>valueL</NAME>, <NAME>valueT</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getOffsetParent</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP></IFNE>) <RETURN>return <CALL><NAME>$</NAME>(<GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP>)</CALL></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><EQ><NAME>element</NAME> == <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></EQ></IFNE>) <RETURN>return <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>

    <LOOP><EMPTY/>while (<IFEQ><AND><TARGET/>(<SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP>)</SETNAME> &amp;&amp; <NE><NAME>element</NAME> != <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></NE></AND></IFEQ>)
      <BLOCK><TARGET/>if (<IFNE><NE><CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL> != <STRING>'static'</STRING></NE></IFNE>)
        <RETURN>return <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></RETURN><TARGET/><GOTO/><TARGET/>;</BLOCK></LOOP><TARGET/>

    <RETURN>return <CALL><NAME>$</NAME>(<GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>viewportOffset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>forElement</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>valueT = <NUMBER>0</NUMBER></NAME>, <NAME>valueL = <NUMBER>0</NUMBER></NAME></VAR>;

    <VAR>var <NAME>element = <NAME>forElement</NAME></NAME></VAR>;
    <LOOP>do <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueT</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueL</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;

      // Safari fix
      <BLOCK>if (<IFNE><AND><EQ><GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP> == <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></EQ> &amp;&amp;
        <EQ><CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL> == <STRING>'absolute'</STRING></EQ></AND></IFNE>) <BREAK>break</BREAK>;</BLOCK><TARGET/>

    }</BLOCK> while (<IFEQ><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP></SETNAME></IFEQ></LOOP><TARGET/>);

    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <NAME>forElement</NAME></SETNAME></EXPR_VOID>;
    <LOOP>do <BLOCK><TARGET/>{
      <BLOCK>if (<IFNE><OR>!<NOT><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></NOT> || <EQ><GETPROP><NAME>element</NAME>.<STRING>tagName</STRING></GETPROP> == <STRING>'BODY'</STRING></EQ></OR></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME><SUB><NAME>valueT</NAME></BINDNAME> -= <OR><GETPROP><NAME>element</NAME>.<STRING>scrollTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></SUB></SETNAME></EXPR_VOID>;
        <EXPR_VOID><SETNAME><BINDNAME><SUB><NAME>valueL</NAME></BINDNAME> -= <OR><GETPROP><NAME>element</NAME>.<STRING>scrollLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></SUB></SETNAME></EXPR_VOID>;
      }</BLOCK></BLOCK><TARGET/>
    }</BLOCK> while (<IFEQ><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP></SETNAME></IFEQ></LOOP><TARGET/>);

    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(<NAME>valueL</NAME>, <NAME>valueT</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>clonePosition</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>source</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>options = <CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<OBJECTLIT>{
      <OBJLITNAME>setLeft</OBJLITNAME>:    <TRUE>true</TRUE>,
      <OBJLITNAME>setTop</OBJLITNAME>:     <TRUE>true</TRUE>,
      <OBJLITNAME>setWidth</OBJLITNAME>:   <TRUE>true</TRUE>,
      <OBJLITNAME>setHeight</OBJLITNAME>:  <TRUE>true</TRUE>,
      <OBJLITNAME>offsetTop</OBJLITNAME>:  <NUMBER>0</NUMBER>,
      <OBJLITNAME>offsetLeft</OBJLITNAME>: <NUMBER>0</NUMBER>
    }</OBJECTLIT>, <OR><GETELEM><NAME>arguments</NAME>[<NUMBER>2</NUMBER>]</GETELEM> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></NAME></VAR>;

    // find page position of source
    <EXPR_VOID><SETNAME><BINDNAME>source</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>source</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>p = <CALL><NAME>source</NAME>.<GETPROP><STRING>viewportOffset</STRING></GETPROP>()</CALL></NAME></VAR>;

    // find coordinate system to use
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>delta = [<ARRAYLIT><NUMBER>0</NUMBER>, <NUMBER>0</NUMBER>]</ARRAYLIT></NAME></VAR>;
    <VAR>var <NAME>parent = <NULL>null</NULL></NAME></VAR>;
    // delta [0,0] will do fine with position: fixed elements,
    // position:absolute needs offsetParent deltas
    <BLOCK>if (<IFNE><EQ><CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL> == <STRING>'absolute'</STRING></EQ></IFNE>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>parent</BINDNAME> = <CALL><NAME>element</NAME>.<GETPROP><STRING>getOffsetParent</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>delta</BINDNAME> = <CALL><NAME>parent</NAME>.<GETPROP><STRING>viewportOffset</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    // correct by body offsets (fixes Safari)
    <BLOCK>if (<IFNE><EQ><NAME>parent</NAME> == <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></EQ></IFNE>) <BLOCK>{
      <EXPR_VOID><SETELEM_OP><NAME><SUB><USE_STACK/>delta</NAME>[<NUMBER>0</NUMBER>] -= <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>offsetLeft</STRING></GETPROP></SUB></SETELEM_OP></EXPR_VOID>;
      <EXPR_VOID><SETELEM_OP><NAME><SUB><USE_STACK/>delta</NAME>[<NUMBER>1</NUMBER>] -= <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>offsetTop</STRING></GETPROP></SUB></SETELEM_OP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    // set position
    <BLOCK>if (<IFNE><GETPROP><NAME>options</NAME>.<STRING>setLeft</STRING></GETPROP></IFNE>)   <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>left</STRING>  = (<ADD><ADD><SUB><GETELEM><NAME>p</NAME>[<NUMBER>0</NUMBER>]</GETELEM> - <GETELEM><NAME>delta</NAME>[<NUMBER>0</NUMBER>]</GETELEM></SUB> + <GETPROP><NAME>options</NAME>.<STRING>offsetLeft</STRING></GETPROP>)</ADD> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><NAME>options</NAME>.<STRING>setTop</STRING></GETPROP></IFNE>)    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>top</STRING>   = (<ADD><ADD><SUB><GETELEM><NAME>p</NAME>[<NUMBER>1</NUMBER>]</GETELEM> - <GETELEM><NAME>delta</NAME>[<NUMBER>1</NUMBER>]</GETELEM></SUB> + <GETPROP><NAME>options</NAME>.<STRING>offsetTop</STRING></GETPROP>)</ADD> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><NAME>options</NAME>.<STRING>setWidth</STRING></GETPROP></IFNE>)  <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>width</STRING> = <ADD><GETPROP><NAME>source</NAME>.<STRING>offsetWidth</STRING></GETPROP> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETPROP><NAME>options</NAME>.<STRING>setHeight</STRING></GETPROP></IFNE>) <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>height</STRING> = <ADD><GETPROP><NAME>source</NAME>.<STRING>offsetHeight</STRING></GETPROP> + <STRING>'px'</STRING></ADD></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<EXPR_RESULT><SETPROP><GETPROP><STRING>identify</STRING></GETPROP>.<STRING>counter</STRING> = <NUMBER>1</NUMBER></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>getElementsBySelector</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>select</STRING></GETPROP>,
  <OBJLITNAME>childElements</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>immediateDescendants</STRING></GETPROP>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>_attributeTranslations</STRING> = <OBJECTLIT>{
  <OBJLITNAME>write</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>names</OBJLITNAME>: <OBJECTLIT>{
      <OBJLITNAME>className</OBJLITNAME>: <STRING>'class'</STRING>,
      <OBJLITNAME>htmlFor</OBJLITNAME>:   <STRING>'for'</STRING>
    }</OBJECTLIT>,
    <OBJLITNAME>values</OBJLITNAME>: <OBJECTLIT>{ }</OBJECTLIT>
  }</OBJECTLIT>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;


<BLOCK>if (<IFNE><OR>!<NOT><GETPROP><NAME>document</NAME>.<STRING>createRange</STRING></GETPROP></NOT> || <GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></OR></IFNE>) <BLOCK>{
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>insert</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>insertions</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;

    <BLOCK>if (<IFNE><OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> || <OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isNumber</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> ||
        <OR><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>insertions</NAME>)</CALL> || (<AND><NAME>insertions</NAME> &amp;&amp; (<OR><GETPROP><NAME>insertions</NAME>.<STRING>toElement</STRING></GETPROP> || <GETPROP><NAME>insertions</NAME>.<STRING>toHTML</STRING></GETPROP>)</OR>)</AND></OR></OR></OR></IFNE>)
          <EXPR_VOID><SETNAME><BINDNAME>insertions</BINDNAME> = <OBJECTLIT>{ <OBJLITNAME>bottom</OBJLITNAME>: <NAME>insertions</NAME> }</OBJECTLIT></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <VAR>var <NAME>t = <GETPROP><NAME>Element</NAME>.<STRING>_insertionTranslations</STRING></GETPROP></NAME>, <NAME>content</NAME>, <NAME>position</NAME>, <NAME>pos</NAME>, <NAME>tagName</NAME></VAR>;

    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for (<EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>position</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID> in <ENUM_INIT_KEYS><NAME>insertions</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME>  = <GETELEM><NAME>insertions</NAME>[<NAME>position</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>position</BINDNAME> = <CALL><NAME>position</NAME>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>pos</BINDNAME>      = <GETELEM><NAME>t</NAME>[<NAME>position</NAME>]</GETELEM></SETNAME></EXPR_VOID>;

      <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>pos</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <NAME>content</NAME>)</CALL></EXPR_VOID>;
        <CONTINUE>continue</CONTINUE>;
      }</BLOCK></BLOCK><TARGET/>

      <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME>tagName</BINDNAME> = ((<CALL><HOOK><OR><EQ><NAME>position</NAME> == <STRING>'before'</STRING></EQ> || <EQ><NAME>position</NAME> == <STRING>'after'</STRING></EQ>)</OR>
        ? <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP> : <NAME>element</NAME></HOOK>).<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;

      <BLOCK>if (<IFNE><GETELEM><NAME>t</NAME>.<GETPROP><STRING>tags</STRING></GETPROP>[<NAME>tagName</NAME>]</GETELEM></IFNE>) <BLOCK>{
        <VAR>var <NAME>fragments = <CALL><NAME>Element</NAME>.<GETPROP><STRING>_getContentFromAnonymousElement</STRING></GETPROP>(<NAME>tagName</NAME>, <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
        <BLOCK>if (<IFNE><OR><EQ><NAME>position</NAME> == <STRING>'top'</STRING></EQ> || <EQ><NAME>position</NAME> == <STRING>'after'</STRING></EQ></OR></IFNE>) <EXPR_VOID><CALL><NAME>fragments</NAME>.<GETPROP><STRING>reverse</STRING></GETPROP>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>
        <EXPR_VOID><CALL><NAME>fragments</NAME>.<GETPROP><STRING>each</STRING></GETPROP>(<CALL><NAME>pos</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>.<GETPROP><STRING>curry</STRING></GETPROP>(<NAME>element</NAME>)</CALL>)</CALL></EXPR_VOID>;
      }</BLOCK>
      else <EXPR_VOID><CALL><NAME><TARGET/>element</NAME>.<GETPROP><STRING>insertAdjacentHTML</STRING></GETPROP>(<GETPROP><NAME>pos</NAME>.<STRING>adjacency</STRING></GETPROP>, <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>

      <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>

    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></IFNE>) <BLOCK>{
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>getStyle</STRING> = <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>getStyle</STRING></GETPROP>.<GETPROP><STRING>wrap</STRING></GETPROP>(
    <FUNCTION>function(<PARAMETER>proceed</PARAMETER>, <PARAMETER>element</PARAMETER>, <PARAMETER>style</PARAMETER>) <BLOCK>{
      <SWITCH>switch (<NAME>style</NAME>) {
        <CASE>case <STRING>'left'</STRING></CASE>: <CASE>case <STRING>'top'</STRING></CASE>: <CASE>case <STRING>'right'</STRING></CASE>: <CASE>case <STRING>'bottom'</STRING>:
          <BLOCK><BLOCK>if (<IFNE><SHEQ><CALL><NAME>proceed</NAME>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL> === <STRING>'static'</STRING></SHEQ></IFNE>) <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK></BLOCK></CASE><TARGET/>
        <CASE>case <STRING>'height'</STRING></CASE>: <CASE>case <STRING>'width'</STRING>:
          // returns '0px' for hidden elements; we want it to return null
          <BLOCK><BLOCK>if (<IFNE><NOT>!<CALL><NAME>Element</NAME>.<GETPROP><STRING>visible</STRING></GETPROP>(<NAME>element</NAME>)</CALL></NOT></IFNE>) <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK><TARGET/>

          // returns the border-box dimensions rather than the content-box
          // dimensions, so we subtract padding and borders from the value
          <VAR>var <NAME>dim = <CALL><NAME>parseInt</NAME>(<CALL><NAME>proceed</NAME>(<NAME>element</NAME>, <NAME>style</NAME>)</CALL>, <NUMBER>10</NUMBER>)</CALL></NAME></VAR>;

          <BLOCK>if (<IFNE><SHNE><NAME>dim</NAME> !== <GETELEM><NAME>element</NAME>[<ADD><STRING>'offset'</STRING> + <CALL><NAME>style</NAME>.<GETPROP><STRING>capitalize</STRING></GETPROP>()</CALL></ADD>]</GETELEM></SHNE></IFNE>)
            <RETURN>return <ADD><NAME>dim</NAME> + <STRING>'px'</STRING></ADD></RETURN>;</BLOCK><TARGET/>

          <VAR>var <NAME>properties</NAME></VAR>;
          <BLOCK>if (<IFNE><SHEQ><NAME>style</NAME> === <STRING>'height'</STRING></SHEQ></IFNE>) <BLOCK>{
            <EXPR_VOID><SETNAME><BINDNAME>properties</BINDNAME> = [<ARRAYLIT><STRING>'border-top-width'</STRING>, <STRING>'padding-top'</STRING>,
             <STRING>'padding-bottom'</STRING>, <STRING>'border-bottom-width'</STRING>]</ARRAYLIT></SETNAME></EXPR_VOID>;
          }</BLOCK>
          else <BLOCK><TARGET/>{
            <EXPR_VOID><SETNAME><BINDNAME>properties</BINDNAME> = [<ARRAYLIT><STRING>'border-left-width'</STRING>, <STRING>'padding-left'</STRING>,
             <STRING>'padding-right'</STRING>, <STRING>'border-right-width'</STRING>]</ARRAYLIT></SETNAME></EXPR_VOID>;
          <GOTO/>}</BLOCK></BLOCK><TARGET/>
          <RETURN>return <ADD><CALL><NAME>properties</NAME>.<GETPROP><STRING>inject</STRING></GETPROP>(<NAME>dim</NAME>, <FUNCTION>function(<PARAMETER>memo</PARAMETER>, <PARAMETER>property</PARAMETER>) <BLOCK>{
            <VAR>var <NAME>val = <CALL><NAME>proceed</NAME>(<NAME>element</NAME>, <NAME>property</NAME>)</CALL></NAME></VAR>;
            <RETURN>return <HOOK><SHEQ><NAME>val</NAME> === <NULL>null</NULL></SHEQ> ? <NAME>memo</NAME> : <SUB><NAME>memo</NAME> - <CALL><NAME>parseInt</NAME>(<NAME>val</NAME>, <NUMBER>10</NUMBER>)</CALL></SUB></HOOK></RETURN>;</BLOCK>
          }</FUNCTION>)</CALL> + <STRING>'px'</STRING></ADD></RETURN></BLOCK></CASE>;
        <DEFAULT>default: <BLOCK><RETURN>return <CALL><NAME>proceed</NAME>(<NAME>element</NAME>, <NAME>style</NAME>)</CALL></RETURN></BLOCK></DEFAULT>;
      }</SWITCH><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>
  )</CALL></SETPROP></EXPR_RESULT>;

  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>readAttribute</STRING> = <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>readAttribute</STRING></GETPROP>.<GETPROP><STRING>wrap</STRING></GETPROP>(
    <FUNCTION>function(<PARAMETER>proceed</PARAMETER>, <PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><SHEQ><NAME>attribute</NAME> === <STRING>'title'</STRING></SHEQ></IFNE>) <RETURN>return <GETPROP><NAME>element</NAME>.<STRING>title</STRING></GETPROP></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NAME>proceed</NAME>(<NAME>element</NAME>, <NAME>attribute</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>
  )</CALL></SETPROP></EXPR_RESULT>;
}</BLOCK>

else <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></IFNE>) <BLOCK>{
  <EXPR_RESULT><CALL><CALL><NAME>$w</NAME>(<STRING>'positionedOffset getOffsetParent viewportOffset'</STRING></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>method</PARAMETER>) <BLOCK>{
    <NAME>Element</NAME>.<EXPR_VOID><SETELEM><GETPROP><STRING>Methods</STRING></GETPROP>[<NAME>method</NAME>] = <CALL><NAME>Element</NAME>.<GETELEM><GETPROP><STRING>Methods</STRING></GETPROP>[<NAME>method</NAME></GETELEM>].<GETPROP><STRING>wrap</STRING></GETPROP>(
      <FUNCTION>function(<PARAMETER>proceed</PARAMETER>, <PARAMETER>element</PARAMETER>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
        <VAR>var <NAME>position = <CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'position'</STRING>)</CALL></NAME></VAR>;
        <BLOCK>if (<IFNE><NE><NAME>position</NAME> != <STRING>'static'</STRING></NE></IFNE>) <RETURN>return <CALL><NAME>proceed</NAME>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>setStyle</STRING></GETPROP>(<OBJECTLIT>{ <OBJLITNAME>position</OBJLITNAME>: <STRING>'relative'</STRING> }</OBJECTLIT>)</CALL></EXPR_VOID>;
        <VAR>var <NAME>value = <CALL><NAME>proceed</NAME>(<NAME>element</NAME>)</CALL></NAME></VAR>;
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>setStyle</STRING></GETPROP>(<OBJECTLIT>{ <OBJLITNAME>position</OBJLITNAME>: <NAME>position</NAME> }</OBJECTLIT>)</CALL></EXPR_VOID>;
        <RETURN>return <NAME>value</NAME></RETURN>;</BLOCK>
      }</FUNCTION>
    )</CALL></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_RESULT>;

  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>getStyle</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>style</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>style</BINDNAME> = (<HOOK><OR><EQ><NAME>style</NAME> == <STRING>'float'</STRING></EQ> || <EQ><NAME>style</NAME> == <STRING>'cssFloat'</STRING></EQ>)</OR> ? <STRING>'styleFloat'</STRING> : <CALL><NAME>style</NAME>.<GETPROP><STRING>camelize</STRING></GETPROP>()</CALL></HOOK></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>value = <GETELEM><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>[<NAME>style</NAME>]</GETELEM></NAME></VAR>;
    <BLOCK>if (<IFNE><AND>!<NOT><NAME>value</NAME></NOT> &amp;&amp; <GETPROP><NAME>element</NAME>.<STRING>currentStyle</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <GETELEM><NAME>element</NAME>.<GETPROP><STRING>currentStyle</STRING></GETPROP>[<NAME>style</NAME>]</GETELEM></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

    <BLOCK>if (<IFNE><EQ><NAME>style</NAME> == <STRING>'opacity'</STRING></EQ></IFNE>) <BLOCK>{
      <BLOCK>if (<IFNE><SETNAME><BINDNAME>value</BINDNAME> = (<CALL><OR><CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'filter'</STRING>)</CALL> || <STRING>''</STRING></OR>).<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/alpha\(opacity=(.*)\)/</REGEXP>)</CALL></SETNAME></IFNE>)
        <BLOCK>if (<IFNE><GETELEM><NAME>value</NAME>[<NUMBER>1</NUMBER>]</GETELEM></IFNE>) <RETURN>return <DIV><CALL><NAME>parseFloat</NAME>(<GETELEM><NAME>value</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL> / <NUMBER>100</NUMBER></DIV></RETURN>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
      <RETURN>return <NUMBER>1.0</NUMBER></RETURN>;
    }</BLOCK></BLOCK><TARGET/>

    <BLOCK>if (<IFNE><EQ><NAME>value</NAME> == <STRING>'auto'</STRING></EQ></IFNE>) <BLOCK>{
      <BLOCK>if (<IFNE><AND>(<OR><EQ><NAME>style</NAME> == <STRING>'width'</STRING></EQ> || <EQ><NAME>style</NAME> == <STRING>'height'</STRING></EQ>)</OR> &amp;&amp; (<NE><CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'display'</STRING>)</CALL> != <STRING>'none'</STRING>)</NE></AND></IFNE>)
        <RETURN>return <ADD><GETELEM><NAME>element</NAME>[<ADD><STRING>'offset'</STRING> + <CALL><NAME>style</NAME>.<GETPROP><STRING>capitalize</STRING></GETPROP>()</CALL></ADD>]</GETELEM> + <STRING>'px'</STRING></ADD></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <NULL>null</NULL></RETURN>;
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <NAME>value</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;

  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>setOpacity</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <FUNCTION>function <FUNCNAME>stripAlpha</FUNCNAME>(<PARAMETER>filter</PARAMETER>)<BLOCK>{
      <RETURN>return <CALL><NAME>filter</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/alpha\([^\)]*\)/gi</REGEXP>,<STRING>''</STRING>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>currentStyle = <GETPROP><NAME>element</NAME>.<STRING>currentStyle</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><OR>(<AND><NAME>currentStyle</NAME> &amp;&amp; !<NOT><GETPROP><NAME>currentStyle</NAME>.<STRING>hasLayout</STRING></GETPROP></NOT>)</AND> ||
      (!<AND><NOT><NAME>currentStyle</NAME></NOT> &amp;&amp; <EQ><GETPROP><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<STRING>zoom</STRING></GETPROP> == <STRING>'normal'</STRING></EQ>)</AND></OR></IFNE>)
        <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>zoom</STRING> = <NUMBER>1</NUMBER></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>

    <VAR>var <NAME>filter = <CALL><NAME>element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<STRING>'filter'</STRING>)</CALL></NAME>, <NAME>style = <GETPROP><NAME>element</NAME>.<STRING>style</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><OR><EQ><NAME>value</NAME> == <NUMBER>1</NUMBER></EQ> || <SHEQ><NAME>value</NAME> === <STRING>''</STRING></SHEQ></OR></IFNE>) <BLOCK>{
      (<EXPR_VOID><HOOK><SETNAME><BINDNAME>filter</BINDNAME> = <CALL><NAME>stripAlpha</NAME>(<NAME>filter</NAME>)</CALL>)</SETNAME> ?
        <SETPROP><NAME>style</NAME>.<STRING>filter</STRING> = <NAME>filter</NAME></SETPROP> : <CALL><NAME>style</NAME>.<GETPROP><STRING>removeAttribute</STRING></GETPROP>(<STRING>'filter'</STRING>)</CALL></HOOK></EXPR_VOID>;
      <RETURN>return <NAME>element</NAME></RETURN>;
    }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><LT><NAME>value</NAME> &lt; <NUMBER>0.00001</NUMBER></LT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <NUMBER>0</NUMBER></SETNAME></EXPR_VOID><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    <EXPR_VOID><SETPROP><NAME>style</NAME>.<STRING>filter</STRING> = <ADD><ADD><ADD><CALL><NAME>stripAlpha</NAME>(<NAME>filter</NAME>)</CALL> +
      <STRING>'alpha(opacity='</STRING></ADD> + (<MUL><NAME>value</NAME> * <NUMBER>100</NUMBER>)</MUL></ADD> + <STRING>')'</STRING></ADD></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;

  <EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>_attributeTranslations</STRING> = <OBJECTLIT>{
    <OBJLITNAME>read</OBJLITNAME>: <OBJECTLIT>{
      <OBJLITNAME>names</OBJLITNAME>: <OBJECTLIT>{
        '<OBJLITNAME>class</OBJLITNAME>': <STRING>'className'</STRING>,
        '<OBJLITNAME>for</OBJLITNAME>':   <STRING>'htmlFor'</STRING>
      }</OBJECTLIT>,
      <OBJLITNAME>values</OBJLITNAME>: <OBJECTLIT>{
        <OBJLITNAME>_getAttr</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
          <RETURN>return <CALL><NAME>element</NAME>.<GETPROP><STRING>getAttribute</STRING></GETPROP>(<NAME>attribute</NAME>, <NUMBER>2</NUMBER>)</CALL></RETURN>;</BLOCK>
        }</FUNCTION>,
        <OBJLITNAME>_getAttrNode</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
          <VAR>var <NAME>node = <CALL><NAME>element</NAME>.<GETPROP><STRING>getAttributeNode</STRING></GETPROP>(<NAME>attribute</NAME>)</CALL></NAME></VAR>;
          <RETURN>return <HOOK><NAME>node</NAME> ? <GETPROP><NAME>node</NAME>.<STRING>value</STRING></GETPROP> : <STRING>""</STRING></HOOK></RETURN>;</BLOCK>
        }</FUNCTION>,
        <OBJLITNAME>_getEv</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
          <EXPR_VOID><SETNAME><BINDNAME>attribute</BINDNAME> = <CALL><NAME>element</NAME>.<GETPROP><STRING>getAttribute</STRING></GETPROP>(<NAME>attribute</NAME>)</CALL></SETNAME></EXPR_VOID>;
          <RETURN>return <HOOK><NAME>attribute</NAME> ? <CALL><NAME>attribute</NAME>.<CALL><GETPROP><STRING>toString</STRING></GETPROP></CALL>().<GETPROP><STRING>slice</STRING></GETPROP>(<NUMBER>23</NUMBER>, -<NUMBER>2</NUMBER>)</CALL> : <NULL>null</NULL></HOOK></RETURN>;</BLOCK>
        }</FUNCTION>,
        <OBJLITNAME>_flag</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
          <RETURN>return <HOOK><CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<NAME>attribute</NAME>)</CALL> ? <NAME>attribute</NAME> : <NULL>null</NULL></HOOK></RETURN>;</BLOCK>
        }</FUNCTION>,
        <OBJLITNAME>style</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
          <RETURN>return <CALL><NAME>element</NAME>.<GETPROP><STRING>style</STRING></GETPROP>.<GETPROP><STRING>cssText</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></RETURN>;</BLOCK>
        }</FUNCTION>,
        <OBJLITNAME>title</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
          <RETURN>return <GETPROP><NAME>element</NAME>.<STRING>title</STRING></GETPROP></RETURN>;</BLOCK>
        }</FUNCTION>
      }</OBJECTLIT>
    }</OBJECTLIT>
  }</OBJECTLIT></SETPROP></EXPR_RESULT>;

  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<STRING>write</STRING> = <OBJECTLIT>{
    <OBJLITNAME>names</OBJLITNAME>: <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<GETPROP><STRING>read</STRING></GETPROP>.<STRING>names</STRING></GETPROP>)</CALL>,
    <OBJLITNAME>values</OBJLITNAME>: <OBJECTLIT>{
      <OBJLITNAME>checked</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
        <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>checked</STRING> = !!<NOT><NOT><NAME>value</NAME></NOT></NOT></SETPROP></EXPR_VOID>;
      </BLOCK><RETURN/>}</FUNCTION>,

      <OBJLITNAME>style</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
        <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>cssText</STRING> = <HOOK><NAME>value</NAME> ? <NAME>value</NAME> : <STRING>''</STRING></HOOK></SETPROP></EXPR_VOID>;
      </BLOCK><RETURN/>}</FUNCTION>
    }</OBJECTLIT>
  }</OBJECTLIT></SETPROP></EXPR_RESULT>;

  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<STRING>has</STRING> = <OBJECTLIT>{}</OBJECTLIT></SETPROP></EXPR_RESULT>;

  <EXPR_RESULT><CALL><CALL><NAME>$w</NAME>(<STRING>'colSpan rowSpan vAlign dateTime accessKey tabIndex '</STRING></CALL> +
      'encType maxLength readOnly longDesc').<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>attr</PARAMETER>) <BLOCK>{
    <NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<GETPROP><STRING>write</STRING></GETPROP>.<EXPR_VOID><SETELEM><GETPROP><STRING>names</STRING></GETPROP>[<CALL><NAME>attr</NAME>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>] = <NAME>attr</NAME></SETELEM></EXPR_VOID>;
    <NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<EXPR_VOID><SETELEM><GETPROP><STRING>has</STRING></GETPROP>[<CALL><NAME>attr</NAME>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>] = <NAME>attr</NAME></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_RESULT>;

  (<EXPR_RESULT><CALL><FUNCTION>function(<PARAMETER>v</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>v</NAME>, <OBJECTLIT>{
      <OBJLITNAME>href</OBJLITNAME>:        <GETPROP><NAME>v</NAME>.<STRING>_getAttr</STRING></GETPROP>,
      <OBJLITNAME>src</OBJLITNAME>:         <GETPROP><NAME>v</NAME>.<STRING>_getAttr</STRING></GETPROP>,
      <OBJLITNAME>type</OBJLITNAME>:        <GETPROP><NAME>v</NAME>.<STRING>_getAttr</STRING></GETPROP>,
      <OBJLITNAME>action</OBJLITNAME>:      <GETPROP><NAME>v</NAME>.<STRING>_getAttrNode</STRING></GETPROP>,
      <OBJLITNAME>disabled</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_flag</STRING></GETPROP>,
      <OBJLITNAME>checked</OBJLITNAME>:     <GETPROP><NAME>v</NAME>.<STRING>_flag</STRING></GETPROP>,
      <OBJLITNAME>readonly</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_flag</STRING></GETPROP>,
      <OBJLITNAME>multiple</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_flag</STRING></GETPROP>,
      <OBJLITNAME>onload</OBJLITNAME>:      <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onunload</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onclick</OBJLITNAME>:     <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>ondblclick</OBJLITNAME>:  <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onmousedown</OBJLITNAME>: <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onmouseup</OBJLITNAME>:   <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onmouseover</OBJLITNAME>: <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onmousemove</OBJLITNAME>: <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onmouseout</OBJLITNAME>:  <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onfocus</OBJLITNAME>:     <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onblur</OBJLITNAME>:      <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onkeypress</OBJLITNAME>:  <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onkeydown</OBJLITNAME>:   <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onkeyup</OBJLITNAME>:     <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onsubmit</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onreset</OBJLITNAME>:     <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onselect</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>,
      <OBJLITNAME>onchange</OBJLITNAME>:    <GETPROP><NAME>v</NAME>.<STRING>_getEv</STRING></GETPROP>
    }</OBJECTLIT>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>)(<GETPROP><NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<GETPROP><STRING>read</STRING></GETPROP>.<STRING>values</STRING></GETPROP>)</CALL></EXPR_RESULT>;
}</BLOCK>

else <BLOCK><TARGET/>if (<IFNE><AND><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Gecko</STRING></GETPROP> &amp;&amp; <CALL><REGEXP>/rv:1\.8\.0/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<GETPROP><NAME>navigator</NAME>.<STRING>userAgent</STRING></GETPROP>)</CALL></AND></IFNE>) <BLOCK>{
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>setOpacity</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>opacity</STRING> = (<HOOK><EQ><NAME>value</NAME> == <NUMBER>1</NUMBER>)</EQ> ? <NUMBER>0.999999</NUMBER> :
      (<HOOK><SHEQ><NAME>value</NAME> === <STRING>''</STRING>)</SHEQ> ? <STRING>''</STRING> : (<HOOK><LT><NAME>value</NAME> &lt; <NUMBER>0.00001</NUMBER>)</LT> ? <NUMBER>0</NUMBER> : <NAME>value</NAME></HOOK></HOOK></HOOK></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK>

else <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP></IFNE>) <BLOCK>{
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>setOpacity</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <NAME>element</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>style</STRING></GETPROP>.<STRING>opacity</STRING> = (<HOOK><OR><EQ><NAME>value</NAME> == <NUMBER>1</NUMBER></EQ> || <SHEQ><NAME>value</NAME> === <STRING>''</STRING></SHEQ>)</OR> ? <STRING>''</STRING> :
      (<HOOK><LT><NAME>value</NAME> &lt; <NUMBER>0.00001</NUMBER>)</LT> ? <NUMBER>0</NUMBER> : <NAME>value</NAME></HOOK></HOOK></SETPROP></EXPR_VOID>;

    <BLOCK>if (<IFNE><EQ><NAME>value</NAME> == <NUMBER>1</NUMBER></EQ></IFNE>)
      <BLOCK>if(<IFNE><AND><EQ><GETPROP><NAME>element</NAME>.<STRING>tagName</STRING></GETPROP> == <STRING>'IMG'</STRING></EQ> &amp;&amp; <GETPROP><NAME>element</NAME>.<STRING>width</STRING></GETPROP></AND></IFNE>) <BLOCK>{
        <EXPR_VOID><INC><GETPROP><NAME>element</NAME>.<STRING>width</STRING></GETPROP></INC></EXPR_VOID>++; <EXPR_VOID><DEC><GETPROP><NAME>element</NAME>.<STRING>width</STRING></GETPROP></DEC></EXPR_VOID>--;
      }</BLOCK> else <TRY><TARGET/>try <BLOCK>{
        <VAR>var <NAME>n = <CALL><NAME>document</NAME>.<GETPROP><STRING>createTextNode</STRING></GETPROP>(<STRING>' '</STRING>)</CALL></NAME></VAR>;
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>n</NAME>)</CALL></EXPR_VOID>;
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>removeChild</STRING></GETPROP>(<NAME>n</NAME>)</CALL></EXPR_VOID>;
      }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ <GOTO/>}</BLOCK></CATCH></TRY></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>

    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;

  // Safari returns margins on body which is incorrect if the child is absolutely
  // positioned.  For performance reasons, redefine Element#cumulativeOffset for
  // KHTML/WebKit only.
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>cumulativeOffset</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>valueT = <NUMBER>0</NUMBER></NAME>, <NAME>valueL = <NUMBER>0</NUMBER></NAME></VAR>;
    <LOOP>do <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueT</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetTop</STRING></GETPROP>  || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <EXPR_VOID><SETNAME><BINDNAME><ADD><NAME>valueL</NAME></BINDNAME> += <OR><GETPROP><NAME>element</NAME>.<STRING>offsetLeft</STRING></GETPROP> || <NUMBER>0</NUMBER></OR></ADD></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><EQ><GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP> == <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></EQ></IFNE>)
        <BLOCK>if (<IFNE><EQ><CALL><NAME>Element</NAME>.<GETPROP><STRING>getStyle</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'position'</STRING>)</CALL> == <STRING>'absolute'</STRING></EQ></IFNE>) <BREAK>break</BREAK>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>

      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>offsetParent</STRING></GETPROP></SETNAME></EXPR_VOID>;
    }</BLOCK> while (<IFEQ><NAME><TARGET/>element</NAME></IFEQ></LOOP><TARGET/>);

    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(<NAME>valueL</NAME>, <NAME>valueT</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
<GOTO/><GOTO/><GOTO/><GOTO/><GOTO/>}</BLOCK></BLOCK></BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/><TARGET/><TARGET/><TARGET/><TARGET/>

<BLOCK>if (<IFNE><OR><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP> || <GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>Opera</STRING></GETPROP></OR></IFNE>) <BLOCK>{
  // IE and Opera are missing .innerHTML support for TABLE-related and SELECT elements
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>update</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;

    <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></IFNE>) <RETURN>return <CALL><NAME>element</NAME>.<CALL><GETPROP><STRING>update</STRING></GETPROP></CALL>().<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>content</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>

    <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>tagName = <CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></NAME></VAR>;

    <BLOCK>if (<IFNE><IN><NAME>tagName</NAME> in <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>_insertionTranslations</STRING></GETPROP>.<STRING>tags</STRING></GETPROP></IN></IFNE>) <BLOCK>{
      <EXPR_VOID><CALL><CALL><NAME>$A</NAME>(<GETPROP><NAME>element</NAME>.<STRING>childNodes</STRING></GETPROP></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{ <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>removeChild</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>Element</NAME>.<CALL><GETPROP><STRING>_getContentFromAnonymousElement</STRING></GETPROP>(<NAME>tagName</NAME>, <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL></CALL>)
        .<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{ <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    }</BLOCK>
    else <EXPR_VOID><SETPROP><NAME><TARGET/>element</NAME>.<STRING>innerHTML</STRING> = <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>

    <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

<BLOCK>if (<IFNE><GETPROP><NAME>document</NAME>.<CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING></CALL>).<STRING>outerHTML</STRING></GETPROP></IFNE>) <BLOCK>{
  <NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>replace</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;

    <BLOCK>if (<IFNE><AND><NAME>content</NAME> &amp;&amp; <GETPROP><NAME>content</NAME>.<STRING>toElement</STRING></GETPROP></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>content</NAME>.<GETPROP><STRING>toElement</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isElement</STRING></GETPROP>(<NAME>content</NAME>)</CALL></IFNE>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>replaceChild</STRING></GETPROP>(<NAME>content</NAME>, <NAME>element</NAME>)</CALL></EXPR_VOID>;
      <RETURN>return <NAME>element</NAME></RETURN>;
    }</BLOCK></BLOCK><TARGET/>

    <EXPR_VOID><SETNAME><BINDNAME>content</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>toHTML</STRING></GETPROP>(<NAME>content</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>parent = <GETPROP><NAME>element</NAME>.<STRING>parentNode</STRING></GETPROP></NAME>, <NAME>tagName = <CALL><NAME>parent</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></NAME></VAR>;

    <BLOCK>if (<IFNE><GETELEM><NAME>Element</NAME>.<GETPROP><STRING>_insertionTranslations</STRING></GETPROP>.<GETPROP><STRING>tags</STRING></GETPROP>[<NAME>tagName</NAME>]</GETELEM></IFNE>) <BLOCK>{
      <VAR>var <NAME>nextSibling = <CALL><NAME>element</NAME>.<GETPROP><STRING>next</STRING></GETPROP>()</CALL></NAME></VAR>;
      <VAR>var <NAME>fragments = <CALL><NAME>Element</NAME>.<GETPROP><STRING>_getContentFromAnonymousElement</STRING></GETPROP>(<NAME>tagName</NAME>, <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
      <EXPR_VOID><CALL><NAME>parent</NAME>.<GETPROP><STRING>removeChild</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
      <BLOCK>if (<IFNE><NAME>nextSibling</NAME></IFNE>)
        <EXPR_VOID><CALL><NAME>fragments</NAME>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{ <EXPR_VOID><CALL><NAME>parent</NAME>.<GETPROP><STRING>insertBefore</STRING></GETPROP>(<NAME>node</NAME>, <NAME>nextSibling</NAME>)</CALL></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
      else
        <EXPR_VOID><CALL><NAME><TARGET/>fragments</NAME>.<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{ <EXPR_VOID><CALL><NAME>parent</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
    }</BLOCK>
    else <EXPR_VOID><SETPROP><NAME><TARGET/>element</NAME>.<STRING>outerHTML</STRING> = <CALL><NAME>content</NAME>.<GETPROP><STRING>stripScripts</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>

    <EXPR_VOID><CALL><NAME>content</NAME>.<GETPROP><STRING>evalScripts</STRING></GETPROP>.<CALL><GETPROP><STRING>bind</STRING></GETPROP>(<NAME>content</NAME></CALL>).<GETPROP><STRING>defer</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>_returnOffset</STRING> = <FUNCTION>function(<PARAMETER>l</PARAMETER>, <PARAMETER>t</PARAMETER>) <BLOCK>{
  <VAR>var <NAME>result = [<ARRAYLIT><NAME>l</NAME>, <NAME>t</NAME>]</ARRAYLIT></NAME></VAR>;
  <EXPR_VOID><SETPROP><NAME>result</NAME>.<STRING>left</STRING> = <NAME>l</NAME></SETPROP></EXPR_VOID>;
  <EXPR_VOID><SETPROP><NAME>result</NAME>.<STRING>top</STRING> = <NAME>t</NAME></SETPROP></EXPR_VOID>;
  <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>_getContentFromAnonymousElement</STRING> = <FUNCTION>function(<PARAMETER>tagName</PARAMETER>, <PARAMETER>html</PARAMETER>) <BLOCK>{
  <VAR>var <NAME>div = <NEW>new <NAME>Element</NAME>(<STRING>'div'</STRING>)</NEW></NAME>, <NAME>t = <GETELEM><NAME>Element</NAME>.<GETPROP><STRING>_insertionTranslations</STRING></GETPROP>.<GETPROP><STRING>tags</STRING></GETPROP>[<NAME>tagName</NAME>]</GETELEM></NAME></VAR>;
  <EXPR_VOID><SETPROP><NAME>div</NAME>.<STRING>innerHTML</STRING> = <ADD><ADD><GETELEM><NAME>t</NAME>[<NUMBER>0</NUMBER>]</GETELEM> + <NAME>html</NAME></ADD> + <GETELEM><NAME>t</NAME>[<NUMBER>1</NUMBER>]</GETELEM></ADD></SETPROP></EXPR_VOID>;
  <EXPR_VOID><CALL><GETELEM><NAME>t</NAME>[<NUMBER>2</NUMBER></GETELEM>].<GETPROP><STRING>times</STRING></GETPROP>(<FUNCTION>function() <BLOCK>{ <EXPR_VOID><SETNAME><BINDNAME>div</BINDNAME> = <GETPROP><NAME>div</NAME>.<STRING>firstChild</STRING></GETPROP></SETNAME></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
  <RETURN>return <CALL><NAME>$A</NAME>(<GETPROP><NAME>div</NAME>.<STRING>childNodes</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>_insertionTranslations</STRING> = <OBJECTLIT>{
  <OBJLITNAME>before</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>adjacency</OBJLITNAME>: <STRING>'beforeBegin'</STRING>,
    <OBJLITNAME>insert</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>node</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>insertBefore</STRING></GETPROP>(<NAME>node</NAME>, <NAME>element</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>,
    <OBJLITNAME>initializeRange</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>range</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>range</NAME>.<GETPROP><STRING>setStartBefore</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT>,
  <OBJLITNAME>top</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>adjacency</OBJLITNAME>: <STRING>'afterBegin'</STRING>,
    <OBJLITNAME>insert</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>node</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>insertBefore</STRING></GETPROP>(<NAME>node</NAME>, <GETPROP><NAME>element</NAME>.<STRING>firstChild</STRING></GETPROP>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>,
    <OBJLITNAME>initializeRange</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>range</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>range</NAME>.<GETPROP><STRING>selectNodeContents</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>range</NAME>.<GETPROP><STRING>collapse</STRING></GETPROP>(<TRUE>true</TRUE>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT>,
  <OBJLITNAME>bottom</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>adjacency</OBJLITNAME>: <STRING>'beforeEnd'</STRING>,
    <OBJLITNAME>insert</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>node</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>appendChild</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT>,
  <OBJLITNAME>after</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>adjacency</OBJLITNAME>: <STRING>'afterEnd'</STRING>,
    <OBJLITNAME>insert</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>node</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<GETPROP><STRING>insertBefore</STRING></GETPROP>(<NAME>node</NAME>, <GETPROP><NAME>element</NAME>.<STRING>nextSibling</STRING></GETPROP>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>,
    <OBJLITNAME>initializeRange</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>range</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>range</NAME>.<GETPROP><STRING>setStartAfter</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT>,
  <OBJLITNAME>tags</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>TABLE</OBJLITNAME>:  [<ARRAYLIT><STRING>'&lt;table&gt;'</STRING>,                <STRING>'&lt;/table&gt;'</STRING>,                   <NUMBER>1</NUMBER>]</ARRAYLIT>,
    <OBJLITNAME>TBODY</OBJLITNAME>:  [<ARRAYLIT><STRING>'&lt;table&gt;&lt;tbody&gt;'</STRING>,         <STRING>'&lt;/tbody&gt;&lt;/table&gt;'</STRING>,           <NUMBER>2</NUMBER>]</ARRAYLIT>,
    <OBJLITNAME>TR</OBJLITNAME>:     [<ARRAYLIT><STRING>'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;'</STRING>,     <STRING>'&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</STRING>,      <NUMBER>3</NUMBER>]</ARRAYLIT>,
    <OBJLITNAME>TD</OBJLITNAME>:     [<ARRAYLIT><STRING>'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;'</STRING>, <STRING>'&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</STRING>, <NUMBER>4</NUMBER>]</ARRAYLIT>,
    <OBJLITNAME>SELECT</OBJLITNAME>: [<ARRAYLIT><STRING>'&lt;select&gt;'</STRING>,               <STRING>'&lt;/select&gt;'</STRING>,                  <NUMBER>1</NUMBER>]</ARRAYLIT>
  }</OBJECTLIT>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

(<EXPR_RESULT><CALL><FUNCTION>function() <BLOCK>{
  <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>bottom</STRING></GETPROP>.<STRING>initializeRange</STRING> = <GETPROP><THIS>this</THIS>.<GETPROP><STRING>top</STRING></GETPROP>.<STRING>initializeRange</STRING></GETPROP></SETPROP></EXPR_VOID>;
  <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>tags</STRING></GETPROP>, <OBJECTLIT>{
    <OBJLITNAME>THEAD</OBJLITNAME>: <GETPROP><THIS>this</THIS>.<GETPROP><STRING>tags</STRING></GETPROP>.<STRING>TBODY</STRING></GETPROP>,
    <OBJLITNAME>TFOOT</OBJLITNAME>: <GETPROP><THIS>this</THIS>.<GETPROP><STRING>tags</STRING></GETPROP>.<STRING>TBODY</STRING></GETPROP>,
    <OBJLITNAME>TH</OBJLITNAME>:    <GETPROP><THIS>this</THIS>.<GETPROP><STRING>tags</STRING></GETPROP>.<STRING>TD</STRING></GETPROP>
  }</OBJECTLIT>)</CALL></EXPR_VOID>;
</BLOCK><RETURN/>}</FUNCTION>).<GETPROP><STRING>call</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<STRING>_insertionTranslations</STRING></GETPROP>)</CALL></EXPR_RESULT>;

<NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>Simulated</STRING> = <OBJECTLIT>{
  <OBJLITNAME>hasAttribute</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>attribute</BINDNAME> = <OR><GETELEM><NAME>Element</NAME>.<GETPROP><STRING>_attributeTranslations</STRING></GETPROP>.<GETPROP><STRING>has</STRING></GETPROP>[<NAME>attribute</NAME>]</GETELEM> || <NAME>attribute</NAME></OR></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>node = <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getAttributeNode</STRING></GETPROP>(<NAME>attribute</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <AND><NAME>node</NAME> &amp;&amp; <GETPROP><NAME>node</NAME>.<STRING>specified</STRING></GETPROP></AND></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>ByTag</STRING> = <OBJECTLIT>{ }</OBJECTLIT></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Element</NAME>, <GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_RESULT>;

<BLOCK>if (<IFNE><AND>!<NOT><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>ElementExtensions</STRING></GETPROP></NOT> &amp;&amp;
    <GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF></AND></IFNE>) <BLOCK>{
  <EXPR_RESULT><SETPROP><NAME>window</NAME>.<STRING>HTMLElement</STRING> = <OBJECTLIT>{ }</OBJECTLIT></SETPROP></EXPR_RESULT>;
  <NAME>window</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>HTMLElement</STRING></GETPROP>.<STRING>prototype</STRING> = <GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<STRING>'div'</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF></SETPROP></EXPR_RESULT>;
  <NAME>Prototype</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>ElementExtensions</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>extend</STRING> = (<CALL><FUNCTION>function() <BLOCK>{
  <BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>SpecificElementExtensions</STRING></GETPROP></IFNE>)
    <RETURN>return <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></RETURN>;</BLOCK><TARGET/>

  <VAR>var <NAME>Methods = <OBJECTLIT>{ }</OBJECTLIT></NAME>, <NAME>ByTag = <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>ByTag</STRING></GETPROP></NAME></VAR>;

  <VAR>var <NAME>extend = <CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><OR>!<NOT><NAME>element</NAME></NOT> || <OR><GETPROP><NAME>element</NAME>.<STRING>_extendedByPrototype</STRING></GETPROP> ||
        <OR><NE><GETPROP><NAME>element</NAME>.<STRING>nodeType</STRING></GETPROP> != <NUMBER>1</NUMBER></NE> || <EQ><NAME>element</NAME> == <NAME>window</NAME></EQ></OR></OR></OR></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>methods = <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<NAME>Methods</NAME>)</CALL></NAME>,
      <NAME>tagName = <GETPROP><NAME>element</NAME>.<STRING>tagName</STRING></GETPROP></NAME>, <NAME>property</NAME>, <NAME>value</NAME></VAR>;

    // extend methods for specific tags
    <BLOCK>if (<IFNE><GETELEM><NAME>ByTag</NAME>[<NAME>tagName</NAME>]</GETELEM></IFNE>) <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>methods</NAME>, <GETELEM><NAME>ByTag</NAME>[<NAME>tagName</NAME>]</GETELEM>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>

    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for (<EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID> in <ENUM_INIT_KEYS><NAME>methods</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <GETELEM><NAME>methods</NAME>[<NAME>property</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><AND><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>value</NAME>)</CALL> &amp;&amp; !(<NOT><IN><NAME>property</NAME> in <NAME>element</NAME>)</IN></NOT></AND></IFNE>)
        <EXPR_VOID><SETELEM><NAME>element</NAME>[<NAME>property</NAME>] = <CALL><NAME>value</NAME>.<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>

    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>_extendedByPrototype</STRING> = <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>

  }</FUNCTION>, <OBJECTLIT>{
    <OBJLITNAME>refresh</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
      // extend methods for all tags (Safari doesn't need this)
      <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>ElementExtensions</STRING></GETPROP></NOT></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Methods</NAME>, <GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_VOID>;
        <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Methods</NAME>, <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>Simulated</STRING></GETPROP>)</CALL></EXPR_VOID>;
      }</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT>)</CALL></NAME></VAR>;

  <EXPR_VOID><CALL><NAME>extend</NAME>.<GETPROP><STRING>refresh</STRING></GETPROP>()</CALL></EXPR_VOID>;
  <RETURN>return <NAME>extend</NAME></RETURN>;</BLOCK>
}</FUNCTION>)()</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>hasAttribute</STRING> = <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>attribute</PARAMETER>) <BLOCK>{
  <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>hasAttribute</STRING></GETPROP></IFNE>) <RETURN>return <CALL><NAME>element</NAME>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<NAME>attribute</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
  <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>Simulated</STRING></GETPROP>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<NAME>element</NAME>, <NAME>attribute</NAME>)</CALL></RETURN>;</BLOCK>
}</FUNCTION></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>addMethods</STRING> = <FUNCTION>function(<PARAMETER>methods</PARAMETER>) <BLOCK>{
  <VAR>var <NAME>F = <GETPROP><NAME>Prototype</NAME>.<STRING>BrowserFeatures</STRING></GETPROP></NAME>, <NAME>T = <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>ByTag</STRING></GETPROP></NAME></VAR>;

  <BLOCK>if (<IFNE><NOT>!<NAME>methods</NAME></NOT></IFNE>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Form</NAME>, <GETPROP><NAME>Form</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Form</NAME>.<STRING>Element</STRING></GETPROP>, <GETPROP><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>ByTag</STRING></GETPROP>, <OBJECTLIT>{
      "<OBJLITNAME>FORM</OBJLITNAME>":     <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><NAME>Form</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL>,
      "<OBJLITNAME>INPUT</OBJLITNAME>":    <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Methods</STRING></GETPROP>)</CALL>,
      "<OBJLITNAME>SELECT</OBJLITNAME>":   <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Methods</STRING></GETPROP>)</CALL>,
      "<OBJLITNAME>TEXTAREA</OBJLITNAME>": <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<GETPROP><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Methods</STRING></GETPROP>)</CALL>
    }</OBJECTLIT>)</CALL></EXPR_VOID>;
  }</BLOCK></BLOCK><TARGET/>

  <BLOCK>if (<IFNE><EQ><GETPROP><NAME>arguments</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>2</NUMBER></EQ></IFNE>) <BLOCK>{
    <VAR>var <NAME>tagName = <NAME>methods</NAME></NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>methods</BINDNAME> = <GETELEM><NAME>arguments</NAME>[<NUMBER>1</NUMBER>]</GETELEM></SETNAME></EXPR_VOID>;
  }</BLOCK></BLOCK><TARGET/>

  <BLOCK>if (<IFNE><NOT>!<NAME>tagName</NAME></NOT></IFNE>) <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>, <OR><NAME>methods</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></EXPR_VOID>;
  else <BLOCK><TARGET/>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<NAME>tagName</NAME>)</CALL></IFNE>) <EXPR_VOID><CALL><NAME>tagName</NAME>.<GETPROP><STRING>each</STRING></GETPROP>(<NAME>extend</NAME>)</CALL></EXPR_VOID>;
    else <EXPR_VOID><CALL><NAME><TARGET/>extend</NAME>(<NAME>tagName</NAME>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
  <GOTO/>}</BLOCK></BLOCK><TARGET/>

  <FUNCTION>function <FUNCNAME>extend</FUNCNAME>(<PARAMETER>tagName</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>tagName</BINDNAME> = <CALL><NAME>tagName</NAME>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><NOT>!<GETELEM><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>ByTag</STRING></GETPROP>[<NAME>tagName</NAME>]</GETELEM></NOT></IFNE>)
      <NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<EXPR_VOID><SETELEM><GETPROP><STRING>ByTag</STRING></GETPROP>[<NAME>tagName</NAME>] = <OBJECTLIT>{ }</OBJECTLIT></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETELEM><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>ByTag</STRING></GETPROP>[<NAME>tagName</NAME>]</GETELEM>, <NAME>methods</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>

  <FUNCTION>function <FUNCNAME>copy</FUNCNAME>(<PARAMETER>methods</PARAMETER>, <PARAMETER>destination</PARAMETER>, <PARAMETER>onlyIfAbsent</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>onlyIfAbsent</BINDNAME> = <OR><NAME>onlyIfAbsent</NAME> || <FALSE>false</FALSE></OR></SETNAME></EXPR_VOID>;
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>property</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>methods</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <VAR>var <NAME>value = <GETELEM><NAME>methods</NAME>[<NAME>property</NAME>]</GETELEM></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>value</NAME>)</CALL></NOT></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><OR>!<NOT><NAME>onlyIfAbsent</NAME></NOT> || !(<NOT><IN><NAME>property</NAME> in <NAME>destination</NAME>)</IN></NOT></OR></IFNE>)
        <EXPR_VOID><SETELEM><NAME>destination</NAME>[<NAME>property</NAME>] = <CALL><NAME>value</NAME>.<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
  </BLOCK><RETURN/>}</FUNCTION>

  <FUNCTION>function <FUNCNAME>findDOMClass</FUNCNAME>(<PARAMETER>tagName</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>klass</NAME></VAR>;
    <VAR>var <NAME>trans = <OBJECTLIT>{
      "<OBJLITNAME>OPTGROUP</OBJLITNAME>": <STRING>"OptGroup"</STRING>, "<OBJLITNAME>TEXTAREA</OBJLITNAME>": <STRING>"TextArea"</STRING>, "<OBJLITNAME>P</OBJLITNAME>": <STRING>"Paragraph"</STRING>,
      "<OBJLITNAME>FIELDSET</OBJLITNAME>": <STRING>"FieldSet"</STRING>, "<OBJLITNAME>UL</OBJLITNAME>": <STRING>"UList"</STRING>, "<OBJLITNAME>OL</OBJLITNAME>": <STRING>"OList"</STRING>, "<OBJLITNAME>DL</OBJLITNAME>": <STRING>"DList"</STRING>,
      "<OBJLITNAME>DIR</OBJLITNAME>": <STRING>"Directory"</STRING>, "<OBJLITNAME>H1</OBJLITNAME>": <STRING>"Heading"</STRING>, "<OBJLITNAME>H2</OBJLITNAME>": <STRING>"Heading"</STRING>, "<OBJLITNAME>H3</OBJLITNAME>": <STRING>"Heading"</STRING>,
      "<OBJLITNAME>H4</OBJLITNAME>": <STRING>"Heading"</STRING>, "<OBJLITNAME>H5</OBJLITNAME>": <STRING>"Heading"</STRING>, "<OBJLITNAME>H6</OBJLITNAME>": <STRING>"Heading"</STRING>, "<OBJLITNAME>Q</OBJLITNAME>": <STRING>"Quote"</STRING>,
      "<OBJLITNAME>INS</OBJLITNAME>": <STRING>"Mod"</STRING>, "<OBJLITNAME>DEL</OBJLITNAME>": <STRING>"Mod"</STRING>, "<OBJLITNAME>A</OBJLITNAME>": <STRING>"Anchor"</STRING>, "<OBJLITNAME>IMG</OBJLITNAME>": <STRING>"Image"</STRING>, "<OBJLITNAME>CAPTION</OBJLITNAME>":
      <STRING>"TableCaption"</STRING>, "<OBJLITNAME>COL</OBJLITNAME>": <STRING>"TableCol"</STRING>, "<OBJLITNAME>COLGROUP</OBJLITNAME>": <STRING>"TableCol"</STRING>, "<OBJLITNAME>THEAD</OBJLITNAME>":
      <STRING>"TableSection"</STRING>, "<OBJLITNAME>TFOOT</OBJLITNAME>": <STRING>"TableSection"</STRING>, "<OBJLITNAME>TBODY</OBJLITNAME>": <STRING>"TableSection"</STRING>, "<OBJLITNAME>TR</OBJLITNAME>":
      <STRING>"TableRow"</STRING>, "<OBJLITNAME>TH</OBJLITNAME>": <STRING>"TableCell"</STRING>, "<OBJLITNAME>TD</OBJLITNAME>": <STRING>"TableCell"</STRING>, "<OBJLITNAME>FRAMESET</OBJLITNAME>":
      <STRING>"FrameSet"</STRING>, "<OBJLITNAME>IFRAME</OBJLITNAME>": <STRING>"IFrame"</STRING>
    }</OBJECTLIT></NAME></VAR>;
    <BLOCK>if (<IFNE><GETELEM><NAME>trans</NAME>[<NAME>tagName</NAME>]</GETELEM></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>klass</BINDNAME> = <ADD><ADD><STRING>'HTML'</STRING> + <GETELEM><NAME>trans</NAME>[<NAME>tagName</NAME>]</GETELEM></ADD> + <STRING>'Element'</STRING></ADD></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></IFNE>) <RETURN>return <GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETNAME><BINDNAME>klass</BINDNAME> = <ADD><ADD><STRING>'HTML'</STRING> + <NAME>tagName</NAME></ADD> + <STRING>'Element'</STRING></ADD></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></IFNE>) <RETURN>return <GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETNAME><BINDNAME>klass</BINDNAME> = <ADD><ADD><STRING>'HTML'</STRING> + <CALL><NAME>tagName</NAME>.<GETPROP><STRING>capitalize</STRING></GETPROP>()</CALL></ADD> + <STRING>'Element'</STRING></ADD></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></IFNE>) <RETURN>return <GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></RETURN>;</BLOCK><TARGET/>

    <EXPR_VOID><SETELEM><NAME>window</NAME>[<NAME>klass</NAME>] = <OBJECTLIT>{ }</OBJECTLIT></SETELEM></EXPR_VOID>;
    <EXPR_VOID><SETPROP><GETELEM><NAME>window</NAME>[<NAME>klass</NAME></GETELEM>].<STRING>prototype</STRING> = <GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createElement</STRING></GETPROP>(<NAME>tagName</NAME></CALL></REF_SPECIAL>).__proto__</GET_REF></SETPROP></EXPR_VOID>;
    <RETURN>return <GETELEM><NAME>window</NAME>[<NAME>klass</NAME>]</GETELEM></RETURN>;</BLOCK>
  }</FUNCTION>

  <BLOCK>if (<IFNE><GETPROP><NAME>F</NAME>.<STRING>ElementExtensions</STRING></GETPROP></IFNE>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>copy</NAME>(<GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>, <GETPROP><NAME>HTMLElement</NAME>.<STRING>prototype</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>copy</NAME>(<GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>Simulated</STRING></GETPROP>, <GETPROP><NAME>HTMLElement</NAME>.<STRING>prototype</STRING></GETPROP>, <TRUE>true</TRUE>)</CALL></EXPR_VOID>;
  }</BLOCK></BLOCK><TARGET/>

  <BLOCK>if (<IFNE><GETPROP><NAME>F</NAME>.<STRING>SpecificElementExtensions</STRING></GETPROP></IFNE>) <BLOCK>{
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>tag</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>ByTag</STRING></GETPROP></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
      <VAR>var <NAME>klass = <CALL><NAME>findDOMClass</NAME>(<NAME>tag</NAME>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>klass</NAME>)</CALL></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
      <EXPR_VOID><CALL><NAME>copy</NAME>(<GETELEM><NAME>T</NAME>[<NAME>tag</NAME>]</GETELEM>, <GETPROP><NAME>klass</NAME>.<STRING>prototype</STRING></GETPROP>)</CALL></EXPR_VOID>;
    <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
  }</BLOCK></BLOCK><TARGET/>

  <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Element</NAME>, <GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_VOID>;
  delete <EXPR_VOID><DELPROP><NAME>Element</NAME>.<STRING>ByTag</STRING></DELPROP></EXPR_VOID>;

  <BLOCK>if (<IFNE><GETPROP><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>.<STRING>refresh</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>.<GETPROP><STRING>refresh</STRING></GETPROP>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>
  <EXPR_VOID><SETPROP><NAME>Element</NAME>.<STRING>cache</STRING> = <OBJECTLIT>{ }</OBJECTLIT></SETPROP></EXPR_VOID>;
</BLOCK><RETURN/>}</FUNCTION></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>document</NAME>.<STRING>viewport</STRING> = <OBJECTLIT>{
  <OBJLITNAME>getDimensions</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>dimensions = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;
    <VAR>var <NAME>B = <GETPROP><NAME>Prototype</NAME>.<STRING>Browser</STRING></GETPROP></NAME></VAR>;
    <EXPR_VOID><CALL><CALL><NAME>$w</NAME>(<STRING>'width height'</STRING></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>d</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>D = <CALL><NAME>d</NAME>.<GETPROP><STRING>capitalize</STRING></GETPROP>()</CALL></NAME></VAR>;
      <EXPR_VOID><SETELEM><NAME>dimensions</NAME>[<NAME>d</NAME>] = (<HOOK><AND><GETPROP><NAME>B</NAME>.<STRING>WebKit</STRING></GETPROP> &amp;&amp; !<NOT><GETPROP><NAME>document</NAME>.<STRING>evaluate</STRING></GETPROP></NOT>)</AND> ? <GETELEM><NAME>self</NAME>[<ADD><STRING>'inner'</STRING> + <NAME>D</NAME></ADD>]</GETELEM> :
        (<HOOK><GETPROP><NAME>B</NAME>.<STRING>Opera</STRING>)</GETPROP> ? <GETELEM><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>[<ADD><STRING>'client'</STRING> + <NAME>D</NAME></ADD>]</GETELEM> : <GETELEM><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>[<ADD><STRING>'client'</STRING> + <NAME>D</NAME></ADD>]</GETELEM></HOOK></HOOK></SETELEM></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>dimensions</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getWidth</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETPROP><THIS>this</THIS>.<CALL><GETPROP><STRING>getDimensions</STRING></GETPROP></CALL>().<STRING>width</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getHeight</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETPROP><THIS>this</THIS>.<CALL><GETPROP><STRING>getDimensions</STRING></GETPROP></CALL>().<STRING>height</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getScrollOffsets</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>_returnOffset</STRING></GETPROP>(
      <OR><GETPROP><NAME>window</NAME>.<STRING>pageXOffset</STRING></GETPROP> || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP> || <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP></OR></OR>,
      <OR><GETPROP><NAME>window</NAME>.<STRING>pageYOffset</STRING></GETPROP> || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP> || <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP></OR></OR>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;
/* Portions of the Selector class are derived from Jack Slocums DomQuery,
 * part of YUI-Ext version 0.40, distributed under the terms of an MIT-style
 * license.  Please see http://www.yui-ext.com/ for more information. */

<VAR>var <NAME>Selector = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>expression</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>expression</STRING> = <CALL><NAME>expression</NAME>.<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>compileMatcher</STRING></GETPROP>()</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>shouldUseXPath</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>XPath</STRING></GETPROP></NOT></IFNE>) <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>e = <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></NAME></VAR>;

    // Safari 3 chokes on :*-of-type and :empty
    <BLOCK>if (<IFNE><AND><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP> &amp;&amp;
     (<OR><CALL><NAME>e</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>"-of-type"</STRING>)</CALL> || <CALL><NAME>e</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>":empty"</STRING>)</CALL>)</OR></AND></IFNE>)
      <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>

    // XPath can't do namespaced attributes, nor can it read
    // the "checked" property from DOM nodes
    <BLOCK>if (<IFNE><CALL>(<REGEXP>/(\[[\w-]*?:|:checked)/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP>)</CALL></IFNE>)
      <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>

    <RETURN>return <TRUE>true</TRUE></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>compileMatcher</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <BLOCK>if (<IFNE><CALL><THIS>this</THIS>.<GETPROP><STRING>shouldUseXPath</STRING></GETPROP>()</CALL></IFNE>)
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>compileXPathMatcher</STRING></GETPROP>()</CALL></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>e = <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></NAME>, <NAME>ps = <GETPROP><NAME>Selector</NAME>.<STRING>patterns</STRING></GETPROP></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME>,
        <NAME>c = <GETPROP><NAME>Selector</NAME>.<STRING>criteria</STRING></GETPROP></NAME>, <NAME>le</NAME>, <NAME>p</NAME>, <NAME>m</NAME></VAR>;

    <BLOCK>if (<IFNE><GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>matcher</STRING> = <GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></SETPROP></EXPR_VOID>;
      <RETURN>return</RETURN>;
    }</BLOCK></BLOCK><TARGET/>

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>matcher</STRING> = [<ARRAYLIT><STRING>"this.matcher = function(root) {"</STRING>,
                    <STRING>"var r = root, h = Selector.handlers, c = false, n;"</STRING>]</ARRAYLIT></SETPROP></EXPR_VOID>;

    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>e</NAME> &amp;&amp; <AND><NE><NAME>le</NAME> != <NAME>e</NAME></NE> &amp;&amp; (<CALL><REGEXP>/\S/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>e</NAME>)</CALL></AND></AND></IFEQ>) <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>le</BINDNAME> = <NAME>e</NAME></SETNAME></EXPR_VOID>;
      <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>i</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>ps</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
        <EXPR_VOID><SETNAME><BINDNAME>p</BINDNAME> = <GETELEM><NAME>ps</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>p</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
          <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>c</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL> ? <CALL><GETELEM><NAME>c</NAME>[<NAME>i</NAME></GETELEM>](<NAME>m</NAME>)</CALL> :
    	      <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>c</NAME>[<NAME>i</NAME>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></HOOK>)</CALL></EXPR_VOID>;
          <EXPR_VOID><SETNAME><BINDNAME>e</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<GETELEM><NAME>m</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
          <BREAK>break</BREAK>;
        }</BLOCK></BLOCK><TARGET/>
      <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>

    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<STRING>"return h.unique(n);\n}"</STRING>)</CALL></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>eval</NAME>(<CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>'\n'</STRING>)</CALL>)</CALL></EXPR_VOID>;
    <NAME>Selector</NAME>.<EXPR_VOID><SETELEM><GETPROP><STRING>_cache</STRING></GETPROP>[<GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP>] = <GETPROP><THIS>this</THIS>.<STRING>matcher</STRING></GETPROP></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>compileXPathMatcher</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>e = <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></NAME>, <NAME>ps = <GETPROP><NAME>Selector</NAME>.<STRING>patterns</STRING></GETPROP></NAME>,
        <NAME>x = <GETPROP><NAME>Selector</NAME>.<STRING>xpath</STRING></GETPROP></NAME>, <NAME>le</NAME>, <NAME>m</NAME></VAR>;

    <BLOCK>if (<IFNE><GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></IFNE>) <BLOCK>{
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>xpath</STRING> = <GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>_cache</STRING></GETPROP>[<NAME>e</NAME>]</GETELEM></SETPROP></EXPR_VOID>; <RETURN>return</RETURN>;
    }</BLOCK></BLOCK><TARGET/>

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>matcher</STRING> = [<ARRAYLIT><STRING>'.//*'</STRING>]</ARRAYLIT></SETPROP></EXPR_VOID>;
    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>e</NAME> &amp;&amp; <AND><NE><NAME>le</NAME> != <NAME>e</NAME></NE> &amp;&amp; (<CALL><REGEXP>/\S/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>e</NAME>)</CALL></AND></AND></IFEQ>) <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>le</BINDNAME> = <NAME>e</NAME></SETNAME></EXPR_VOID>;
      <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>i</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>ps</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<GETELEM><NAME>ps</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL></SETNAME></IFNE>) <BLOCK>{
          <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>(<HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>x</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL> ? <CALL><GETELEM><NAME>x</NAME>[<NAME>i</NAME></GETELEM>](<NAME>m</NAME>)</CALL> :
            <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>x</NAME>[<NAME>i</NAME>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></HOOK>)</CALL></EXPR_VOID>;
          <EXPR_VOID><SETNAME><BINDNAME>e</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<GETELEM><NAME>m</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
          <BREAK>break</BREAK>;
        }</BLOCK></BLOCK><TARGET/>
      <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>xpath</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>''</STRING>)</CALL></SETPROP></EXPR_VOID>;
    <NAME>Selector</NAME>.<EXPR_VOID><SETELEM><GETPROP><STRING>_cache</STRING></GETPROP>[<GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP>] = <GETPROP><THIS>this</THIS>.<STRING>xpath</STRING></GETPROP></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>findElements</OBJLITNAME>: <FUNCTION>function(<PARAMETER>root</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>root</BINDNAME> = <OR><NAME>root</NAME> || <NAME>document</NAME></OR></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<STRING>xpath</STRING></GETPROP></IFNE>) <RETURN>return <CALL><NAME>document</NAME>.<GETPROP><STRING>_getElementsByXPath</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>xpath</STRING></GETPROP>, <NAME>root</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>matcher</STRING></GETPROP>(<NAME>root</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>match</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>tokens</STRING> = <ARRAYLIT>[]</ARRAYLIT></SETPROP></EXPR_VOID>;

    <VAR>var <NAME>e = <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></NAME>, <NAME>ps = <GETPROP><NAME>Selector</NAME>.<STRING>patterns</STRING></GETPROP></NAME>, <NAME>as = <GETPROP><NAME>Selector</NAME>.<STRING>assertions</STRING></GETPROP></NAME></VAR>;
    <VAR>var <NAME>le</NAME>, <NAME>p</NAME>, <NAME>m</NAME></VAR>;

    <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>e</NAME> &amp;&amp; <AND><SHNE><NAME>le</NAME> !== <NAME>e</NAME></SHNE> &amp;&amp; (<CALL><REGEXP>/\S/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>e</NAME>)</CALL></AND></AND></IFEQ>) <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>le</BINDNAME> = <NAME>e</NAME></SETNAME></EXPR_VOID>;
      <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>i</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>ps</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
        <EXPR_VOID><SETNAME><BINDNAME>p</BINDNAME> = <GETELEM><NAME>ps</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<NAME>p</NAME>)</CALL></SETNAME></IFNE>) <BLOCK>{
          // use the Selector.assertions methods unless the selector
          // is too complex.
          <BLOCK>if (<IFNE><GETELEM><NAME>as</NAME>[<NAME>i</NAME>]</GETELEM></IFNE>) <BLOCK>{
            <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>tokens</STRING></GETPROP>.<GETPROP><STRING>push</STRING></GETPROP>([<ARRAYLIT><NAME>i</NAME>, <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<NAME>m</NAME>)</CALL>]</ARRAYLIT>)</CALL></EXPR_VOID>;
            <EXPR_VOID><SETNAME><BINDNAME>e</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<GETELEM><NAME>m</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
          }</BLOCK> else <BLOCK><TARGET/>{
            // reluctantly do a document-wide search
            // and look for a match in the array
            <RETURN>return <CALL><THIS>this</THIS>.<CALL><GETPROP><STRING>findElements</STRING></GETPROP>(<NAME>document</NAME></CALL>).<GETPROP><STRING>include</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;
          <GOTO/>}</BLOCK></BLOCK><TARGET/>
        }</BLOCK></BLOCK><TARGET/>
      <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
    <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>

    <VAR>var <NAME>match = <TRUE>true</TRUE></NAME>, <NAME>name</NAME>, <NAME>matches</NAME></VAR>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>token</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>token</BINDNAME> = <GETELEM><THIS>this</THIS>.<GETPROP><STRING>tokens</STRING></GETPROP>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <EXPR_VOID><COMMA><SETNAME><BINDNAME>name</BINDNAME> = <GETELEM><NAME>token</NAME>[<NUMBER>0</NUMBER>]</GETELEM></SETNAME>, <SETNAME><BINDNAME>matches</BINDNAME> = <GETELEM><NAME>token</NAME>[<NUMBER>1</NUMBER>]</GETELEM></SETNAME></COMMA></EXPR_VOID>;
      <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Selector</NAME>.<GETELEM><GETPROP><STRING>assertions</STRING></GETPROP>[<NAME>name</NAME></GETELEM>](<NAME>element</NAME>, <NAME>matches</NAME>)</CALL></NOT></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>match</BINDNAME> = <FALSE>false</FALSE></SETNAME></EXPR_VOID>; <BREAK>break</BREAK>;
      }</BLOCK></BLOCK><TARGET/>
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>

    <RETURN>return <NAME>match</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>toString</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <GETPROP><THIS>this</THIS>.<STRING>expression</STRING></GETPROP></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <ADD><ADD><STRING>"#&lt;Selector:"</STRING> + <CALL><THIS>this</THIS>.<GETPROP><STRING>expression</STRING></GETPROP>.<GETPROP><STRING>inspect</STRING></GETPROP>()</CALL></ADD> + <STRING>"&gt;"</STRING></ADD></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></NAME></VAR>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Selector</NAME>, <OBJECTLIT>{
  <OBJLITNAME>_cache</OBJLITNAME>: <OBJECTLIT>{ }</OBJECTLIT>,

  <OBJLITNAME>xpath</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>descendant</OBJLITNAME>:   <STRING>"//*"</STRING>,
    <OBJLITNAME>child</OBJLITNAME>:        <STRING>"/*"</STRING>,
    <OBJLITNAME>adjacent</OBJLITNAME>:     <STRING>"/following-sibling::*[1]"</STRING>,
    <OBJLITNAME>laterSibling</OBJLITNAME>: <STRING>'/following-sibling::*'</STRING>,
    <OBJLITNAME>tagName</OBJLITNAME>:      <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM> == <STRING>'*'</STRING></EQ></IFNE>) <RETURN>return <STRING>''</STRING></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <ADD><ADD><ADD><ADD><STRING>"[local-name()='"</STRING> + <CALL><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></ADD> +
             <STRING>"' or local-name()='"</STRING></ADD> + <CALL><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></ADD> + <STRING>"']"</STRING></ADD></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>className</OBJLITNAME>:    <STRING>"[contains(concat(' ', @class, ' '), ' #{1} ')]"</STRING>,
    <OBJLITNAME>id</OBJLITNAME>:           <STRING>"[@id='#{1}']"</STRING>,
    <OBJLITNAME>attrPresence</OBJLITNAME>: <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>] = <CALL><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;
      <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<STRING>"[@#{1}]"</STRING></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>attr</OBJLITNAME>: <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>] = <CALL><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;
      <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>3</NUMBER>] = <OR><GETELEM><NAME>m</NAME>[<NUMBER>5</NUMBER>]</GETELEM> || <GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>]</GETELEM></OR></SETELEM></EXPR_VOID>;
      <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>operators</STRING></GETPROP>[<GETELEM><NAME>m</NAME>[<NUMBER>2</NUMBER>]</GETELEM>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>pseudo</OBJLITNAME>: <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>[<GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM>]</GETELEM></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>h</NAME></NOT></IFNE>) <RETURN>return <STRING>''</STRING></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<NAME>h</NAME>)</CALL></IFNE>) <RETURN>return <CALL><NAME>h</NAME>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>[<GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>operators</OBJLITNAME>: <OBJECTLIT>{
      '<OBJLITNAME>=</OBJLITNAME>':  <STRING>"[@#{1}='#{3}']"</STRING>,
      '<OBJLITNAME>!=</OBJLITNAME>': <STRING>"[@#{1}!='#{3}']"</STRING>,
      '<OBJLITNAME>^=</OBJLITNAME>': <STRING>"[starts-with(@#{1}, '#{3}')]"</STRING>,
      '<OBJLITNAME>$=</OBJLITNAME>': <STRING>"[substring(@#{1}, (string-length(@#{1}) - string-length('#{3}') + 1))='#{3}']"</STRING>,
      '<OBJLITNAME>*=</OBJLITNAME>': <STRING>"[contains(@#{1}, '#{3}')]"</STRING>,
      '<OBJLITNAME>~=</OBJLITNAME>': <STRING>"[contains(concat(' ', @#{1}, ' '), ' #{3} ')]"</STRING>,
      '<OBJLITNAME>|=</OBJLITNAME>': <STRING>"[contains(concat('-', @#{1}, '-'), '-#{3}-')]"</STRING>
    }</OBJECTLIT>,
    <OBJLITNAME>pseudos</OBJLITNAME>: <OBJECTLIT>{
      '<OBJLITNAME>first-child</OBJLITNAME>': <STRING>'[not(preceding-sibling::*)]'</STRING>,
      '<OBJLITNAME>last-child</OBJLITNAME>':  <STRING>'[not(following-sibling::*)]'</STRING>,
      '<OBJLITNAME>only-child</OBJLITNAME>':  <STRING>'[not(preceding-sibling::* or following-sibling::*)]'</STRING>,
      '<OBJLITNAME>empty</OBJLITNAME>':       <STRING>"[count(*) = 0 and (count(text()) = 0 or translate(text(), ' \t\r\n', '') = '')]"</STRING>,
      '<OBJLITNAME>checked</OBJLITNAME>':     <STRING>"[@checked]"</STRING>,
      '<OBJLITNAME>disabled</OBJLITNAME>':    <STRING>"[@disabled]"</STRING>,
      '<OBJLITNAME>enabled</OBJLITNAME>':     <STRING>"[not(@disabled)]"</STRING>,
      '<OBJLITNAME>not</OBJLITNAME>': <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <VAR>var <NAME>e = <GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>]</GETELEM></NAME>, <NAME>p = <GETPROP><NAME>Selector</NAME>.<STRING>patterns</STRING></GETPROP></NAME>,
            <NAME>x = <GETPROP><NAME>Selector</NAME>.<STRING>xpath</STRING></GETPROP></NAME>, <NAME>le</NAME>, <NAME>v</NAME></VAR>;

        <VAR>var <NAME>exclusion = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
        <LOOP><EMPTY/>while (<IFEQ><AND><NAME><TARGET/>e</NAME> &amp;&amp; <AND><NE><NAME>le</NAME> != <NAME>e</NAME></NE> &amp;&amp; (<CALL><REGEXP>/\S/</REGEXP>).<GETPROP><STRING>test</STRING></GETPROP>(<NAME>e</NAME>)</CALL></AND></AND></IFEQ>) <BLOCK><TARGET/>{
          <EXPR_VOID><SETNAME><BINDNAME>le</BINDNAME> = <NAME>e</NAME></SETNAME></EXPR_VOID>;
          <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>i</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>p</NAME></ENUM_INIT_KEYS>) <BLOCK><BLOCK><TARGET/>{
            <BLOCK>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<GETELEM><NAME>p</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL></SETNAME></IFNE>) <BLOCK>{
              <EXPR_VOID><SETNAME><BINDNAME>v</BINDNAME> = <HOOK><CALL><NAME>Object</NAME>.<GETPROP><STRING>isFunction</STRING></GETPROP>(<GETELEM><NAME>x</NAME>[<NAME>i</NAME>]</GETELEM>)</CALL> ? <CALL><GETELEM><NAME>x</NAME>[<NAME>i</NAME></GETELEM>](<NAME>m</NAME>)</CALL> : <CALL><NEW>new <NAME>Template</NAME>(<GETELEM><NAME>x</NAME>[<NAME>i</NAME>]</GETELEM></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></HOOK></SETNAME></EXPR_VOID>;
              <EXPR_VOID><CALL><NAME>exclusion</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<ADD><ADD><STRING>"("</STRING> + <CALL><NAME>v</NAME>.<GETPROP><STRING>substring</STRING></GETPROP>(<NUMBER>1</NUMBER>, <SUB><GETPROP><NAME>v</NAME>.<STRING>length</STRING></GETPROP> - <NUMBER>1</NUMBER></SUB>)</CALL></ADD> + <STRING>")"</STRING></ADD>)</CALL></EXPR_VOID>;
              <EXPR_VOID><SETNAME><BINDNAME>e</BINDNAME> = <CALL><NAME>e</NAME>.<GETPROP><STRING>replace</STRING></GETPROP>(<GETELEM><NAME>m</NAME>[<NUMBER>0</NUMBER>]</GETELEM>, <STRING>''</STRING>)</CALL></SETNAME></EXPR_VOID>;
              <BREAK>break</BREAK>;
            }</BLOCK></BLOCK><TARGET/>
          <TARGET/><GOTO/><TARGET/>}</BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
        <TARGET/><GOTO/><TARGET/>}</BLOCK></LOOP>
        <RETURN>return <ADD><ADD><STRING>"[not("</STRING> + <CALL><NAME>exclusion</NAME>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>" and "</STRING>)</CALL></ADD> + <STRING>")]"</STRING></ADD></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>nth-child</OBJLITNAME>':      <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<STRING>"(count(./preceding-sibling::*) + 1) "</STRING>, <NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>nth-last-child</OBJLITNAME>': <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<STRING>"(count(./following-sibling::*) + 1) "</STRING>, <NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>nth-of-type</OBJLITNAME>':    <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<STRING>"position() "</STRING>, <NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>nth-last-of-type</OBJLITNAME>': <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<STRING>"(last() + 1 - position()) "</STRING>, <NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>first-of-type</OBJLITNAME>':  <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>] = <STRING>"1"</STRING></SETELEM></EXPR_VOID>; <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETELEM><GETPROP><STRING>pseudos</STRING></GETPROP>[<STRING>'nth-of-type'</STRING></GETELEM>](<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>last-of-type</OBJLITNAME>':   <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>] = <STRING>"1"</STRING></SETELEM></EXPR_VOID>; <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<GETELEM><GETPROP><STRING>pseudos</STRING></GETPROP>[<STRING>'nth-last-of-type'</STRING></GETELEM>](<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
      }</FUNCTION>,
      '<OBJLITNAME>only-of-type</OBJLITNAME>':   <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
        <VAR>var <NAME>p = <GETPROP><NAME>Selector</NAME>.<GETPROP><STRING>xpath</STRING></GETPROP>.<STRING>pseudos</STRING></GETPROP></NAME></VAR>; <RETURN>return <ADD><CALL><GETELEM><NAME>p</NAME>[<STRING>'first-of-type'</STRING></GETELEM>](<NAME>m</NAME>)</CALL> + <CALL><GETELEM><NAME>p</NAME>[<STRING>'last-of-type'</STRING></GETELEM>](<NAME>m</NAME>)</CALL></ADD></RETURN>;</BLOCK>
      }</FUNCTION>,
      <OBJLITNAME>nth</OBJLITNAME>: <FUNCTION>function(<PARAMETER>fragment</PARAMETER>, <PARAMETER>m</PARAMETER>) <BLOCK>{
        <VAR>var <NAME>mm</NAME>, <NAME>formula = <GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>]</GETELEM></NAME>, <NAME>predicate</NAME></VAR>;
        <BLOCK>if (<IFNE><EQ><NAME>formula</NAME> == <STRING>'even'</STRING></EQ></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>formula</BINDNAME> = <STRING>'2n+0'</STRING></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
        <BLOCK>if (<IFNE><EQ><NAME>formula</NAME> == <STRING>'odd'</STRING></EQ></IFNE>)  <EXPR_VOID><SETNAME><BINDNAME>formula</BINDNAME> = <STRING>'2n+1'</STRING></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>mm</BINDNAME> = <CALL><NAME>formula</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^(\d+)$/</REGEXP>)</CALL></SETNAME></IFNE>) // digit only
          <RETURN>return <ADD><ADD><ADD><ADD><STRING>'['</STRING> + <NAME>fragment</NAME></ADD> + <STRING>"= "</STRING></ADD> + <GETELEM><NAME>mm</NAME>[<NUMBER>1</NUMBER>]</GETELEM></ADD> + <STRING>']'</STRING></ADD></RETURN>;</BLOCK><TARGET/>
        <BLOCK>if (<IFNE><SETNAME><BINDNAME>mm</BINDNAME> = <CALL><NAME>formula</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^(-?\d*)?n(([+-])(\d+))?/</REGEXP>)</CALL></SETNAME></IFNE>) <BLOCK>{ // an+b
          <BLOCK>if (<IFNE><EQ><GETELEM><NAME>mm</NAME>[<NUMBER>1</NUMBER>]</GETELEM> == <STRING>"-"</STRING></EQ></IFNE>) <EXPR_VOID><SETELEM><NAME>mm</NAME>[<NUMBER>1</NUMBER>] = -<NUMBER>1</NUMBER></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
          <VAR>var <NAME>a = <HOOK><GETELEM><NAME>mm</NAME>[<NUMBER>1</NUMBER>]</GETELEM> ? <CALL><NAME>Number</NAME>(<GETELEM><NAME>mm</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL> : <NUMBER>1</NUMBER></HOOK></NAME></VAR>;
          <VAR>var <NAME>b = <HOOK><GETELEM><NAME>mm</NAME>[<NUMBER>2</NUMBER>]</GETELEM> ? <CALL><NAME>Number</NAME>(<GETELEM><NAME>mm</NAME>[<NUMBER>2</NUMBER>]</GETELEM>)</CALL> : <NUMBER>0</NUMBER></HOOK></NAME></VAR>;
          <EXPR_VOID><SETNAME><BINDNAME>predicate</BINDNAME> = <STRING>"[((#{fragment} - #{b}) mod #{a} = 0) and "</STRING></SETNAME></EXPR_VOID> +
          "((#{fragment} - #{b}) div #{a} &gt;= 0)]";
          <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<NAME>predicate</NAME></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<OBJECTLIT>{
            <OBJLITNAME>fragment</OBJLITNAME>: <NAME>fragment</NAME>, <OBJLITNAME>a</OBJLITNAME>: <NAME>a</NAME>, <OBJLITNAME>b</OBJLITNAME>: <NAME>b</NAME> }</OBJECTLIT>)</CALL></RETURN>;
        }</BLOCK></BLOCK><TARGET/>
      </BLOCK><RETURN/>}</FUNCTION>
    }</OBJECTLIT>
  }</OBJECTLIT>,

  <OBJLITNAME>criteria</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>tagName</OBJLITNAME>:      <STRING>'n = h.tagName(n, r, "#{1}", c);   c = false;'</STRING>,
    <OBJLITNAME>className</OBJLITNAME>:    <STRING>'n = h.className(n, r, "#{1}", c); c = false;'</STRING>,
    <OBJLITNAME>id</OBJLITNAME>:           <STRING>'n = h.id(n, r, "#{1}", c);        c = false;'</STRING>,
    <OBJLITNAME>attrPresence</OBJLITNAME>: <STRING>'n = h.attrPresence(n, r, "#{1}"); c = false;'</STRING>,
    <OBJLITNAME>attr</OBJLITNAME>: <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>3</NUMBER>] = (<OR><GETELEM><NAME>m</NAME>[<NUMBER>5</NUMBER>]</GETELEM> || <GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>]</GETELEM>)</OR></SETELEM></EXPR_VOID>;
      <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<STRING>'n = h.attr(n, r, "#{1}", "#{3}", "#{2}"); c = false;'</STRING></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>pseudo</OBJLITNAME>: <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>]</GETELEM></IFNE>) <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER>] = <CALL><GETELEM><NAME>m</NAME>[<NUMBER>6</NUMBER></GETELEM>].<GETPROP><STRING>replace</STRING></GETPROP>(<REGEXP>/"/g</REGEXP>, <STRING>'\\"'</STRING>)</CALL></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NEW>new <NAME>Template</NAME>(<STRING>'n = h.pseudo(n, "#{1}", "#{6}", r, c); c = false;'</STRING></NEW>).<GETPROP><STRING>evaluate</STRING></GETPROP>(<NAME>m</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    <OBJLITNAME>descendant</OBJLITNAME>:   <STRING>'c = "descendant";'</STRING>,
    <OBJLITNAME>child</OBJLITNAME>:        <STRING>'c = "child";'</STRING>,
    <OBJLITNAME>adjacent</OBJLITNAME>:     <STRING>'c = "adjacent";'</STRING>,
    <OBJLITNAME>laterSibling</OBJLITNAME>: <STRING>'c = "laterSibling";'</STRING>
  }</OBJECTLIT>,

  <OBJLITNAME>patterns</OBJLITNAME>: <OBJECTLIT>{
    // combinators must be listed first
    // (and descendant needs to be last combinator)
    <OBJLITNAME>laterSibling</OBJLITNAME>: <REGEXP>/^\s*~\s*/</REGEXP>,
    <OBJLITNAME>child</OBJLITNAME>:        <REGEXP>/^\s*&gt;\s*/</REGEXP>,
    <OBJLITNAME>adjacent</OBJLITNAME>:     <REGEXP>/^\s*\+\s*/</REGEXP>,
    <OBJLITNAME>descendant</OBJLITNAME>:   <REGEXP>/^\s/</REGEXP>,

    // selectors follow
    <OBJLITNAME>tagName</OBJLITNAME>:      <REGEXP>/^\s*(\*|[\w\-]+)(\b|$)?/</REGEXP>,
    <OBJLITNAME>id</OBJLITNAME>:           <REGEXP>/^#([\w\-\*]+)(\b|$)/</REGEXP>,
    <OBJLITNAME>className</OBJLITNAME>:    <REGEXP>/^\.([\w\-\*]+)(\b|$)/</REGEXP>,
    <OBJLITNAME>pseudo</OBJLITNAME>:       <REGEXP>/^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|(?=\s)|(?=:))/</REGEXP>,
    <OBJLITNAME>attrPresence</OBJLITNAME>: <REGEXP>/^\[([\w]+)\]/</REGEXP>,
    <OBJLITNAME>attr</OBJLITNAME>:         <REGEXP>/\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['"])([^\4]*?)\4|([^'"][^\]]*?)))?\]/</REGEXP>
  }</OBJECTLIT>,

  // for Selector.match and Element#match
  <OBJLITNAME>assertions</OBJLITNAME>: <OBJECTLIT>{
    <OBJLITNAME>tagName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>matches</PARAMETER>) <BLOCK>{
      <RETURN>return <EQ><CALL><GETELEM><NAME>matches</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL> == <CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></EQ></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>className</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>matches</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>hasClassName</STRING></GETPROP>(<NAME>element</NAME>, <GETELEM><NAME>matches</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>id</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>matches</PARAMETER>) <BLOCK>{
      <RETURN>return <SHEQ><GETPROP><NAME>element</NAME>.<STRING>id</STRING></GETPROP> === <GETELEM><NAME>matches</NAME>[<NUMBER>1</NUMBER>]</GETELEM></SHEQ></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>attrPresence</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>matches</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<NAME>element</NAME>, <GETELEM><NAME>matches</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>attr</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>matches</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>nodeValue = <CALL><NAME>Element</NAME>.<GETPROP><STRING>readAttribute</STRING></GETPROP>(<NAME>element</NAME>, <GETELEM><NAME>matches</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL></NAME></VAR>;
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETELEM><GETPROP><STRING>operators</STRING></GETPROP>[<GETELEM><NAME>matches</NAME>[<NUMBER>2</NUMBER>]</GETELEM></GETELEM>](<NAME>nodeValue</NAME>, <GETELEM><NAME>matches</NAME>[<NUMBER>3</NUMBER>]</GETELEM>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>
  }</OBJECTLIT>,

  <OBJLITNAME>handlers</OBJLITNAME>: <OBJECTLIT>{
    // UTILITY FUNCTIONS
    // joins two collections
    <OBJLITNAME>concat</OBJLITNAME>: <FUNCTION>function(<PARAMETER>a</PARAMETER>, <PARAMETER>b</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>b</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <EXPR_VOID><CALL><NAME><TARGET/>a</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      <RETURN>return <NAME>a</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    // marks an array of nodes for counting
    <OBJLITNAME>mark</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <EXPR_VOID><SETPROP><NAME><TARGET/>node</NAME>.<STRING>_counted</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      <RETURN>return <NAME>nodes</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>unmark</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <EXPR_VOID><SETPROP><NAME><TARGET/>node</NAME>.<STRING>_counted</STRING> = <NAME>undefined</NAME></SETPROP></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      <RETURN>return <NAME>nodes</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    // mark each child node with its position (for nth calls)
    // "ofType" flag indicates whether we're indexing for nth-of-type
    // rather than nth-child
    <OBJLITNAME>index</OBJLITNAME>: <FUNCTION>function(<PARAMETER>parentNode</PARAMETER>, <PARAMETER>reverse</PARAMETER>, <PARAMETER>ofType</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETPROP><NAME>parentNode</NAME>.<STRING>_counted</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
      <BLOCK>if (<IFNE><NAME>reverse</NAME></IFNE>) <BLOCK>{
        <LOOP><EMPTY/>for <VAR>(var <NAME>nodes = <GETPROP><NAME>parentNode</NAME>.<STRING>childNodes</STRING></GETPROP></NAME>, <NAME>i = <SUB><GETPROP><NAME>nodes</NAME>.<STRING>length</STRING></GETPROP> - <NUMBER>1</NUMBER></SUB></NAME>, <NAME>j = <NUMBER>1</NUMBER></NAME></VAR>; <IFEQ><GE><NAME><TARGET/>i</NAME> &gt;= <NUMBER>0</NUMBER></GE></IFEQ>; <EXPR_VOID><DEC><NAME>i</NAME></DEC></EXPR_VOID>--) <BLOCK><TARGET/>{
          <VAR>var <NAME>node = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></NAME></VAR>;
          <BLOCK>if (<IFNE><AND><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; (!<OR><NOT><NAME>ofType</NAME></NOT> || <GETPROP><NAME>node</NAME>.<STRING>_counted</STRING></GETPROP>)</OR></AND></IFNE>) <EXPR_VOID><SETPROP><NAME>node</NAME>.<STRING>nodeIndex</STRING> = <INC><NAME>j</NAME></INC></SETPROP></EXPR_VOID>++;</BLOCK><TARGET/>
        <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      }</BLOCK> else <BLOCK><TARGET/>{
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>j = <NUMBER>1</NUMBER></NAME>, <NAME>nodes = <GETPROP><NAME>parentNode</NAME>.<STRING>childNodes</STRING></GETPROP></NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
          <BLOCK><TARGET/>if (<IFNE><AND><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; (!<OR><NOT><NAME>ofType</NAME></NOT> || <GETPROP><NAME>node</NAME>.<STRING>_counted</STRING></GETPROP>)</OR></AND></IFNE>) <EXPR_VOID><SETPROP><NAME>node</NAME>.<STRING>nodeIndex</STRING> = <INC><NAME>j</NAME></INC></SETPROP></EXPR_VOID>++<TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <GOTO/>}</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>,

    // filters out duplicates and extends all nodes
    <OBJLITNAME>unique</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><GETPROP><NAME>nodes</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>0</NUMBER></EQ></IFNE>) <RETURN>return <NAME>nodes</NAME></RETURN>;</BLOCK><TARGET/>
      <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>n</NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>l = <GETPROP><NAME>nodes</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>l</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><NOT>!(<GETPROP><SETNAME><BINDNAME>n</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME>).<STRING>_counted</STRING></GETPROP></NOT></IFNE>) <BLOCK>{
          <EXPR_VOID><SETPROP><NAME>n</NAME>.<STRING>_counted</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
          <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>n</NAME>)</CALL>)</CALL></EXPR_VOID>;
        <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></BLOCK></LOOP><TARGET/>
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>unmark</STRING></GETPROP>(<NAME>results</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    // COMBINATOR FUNCTIONS
    <OBJLITNAME>descendant</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <EXPR_VOID><CALL><NAME><TARGET/>h</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<NAME>results</NAME>, <CALL><NAME>node</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>'*'</STRING>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>child</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <LOOP><EMPTY/>for <VAR>(var <NAME>j = <NUMBER>0</NUMBER></NAME>, <NAME>child</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>child</BINDNAME> = <GETELEM><NAME>node</NAME>.<GETPROP><STRING>childNodes</STRING></GETPROP>[<NAME>j</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>j</NAME></INC></EXPR_VOID>++)
          <BLOCK><TARGET/>if (<IFNE><AND><EQ><GETPROP><NAME>child</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; <NE><GETPROP><NAME>child</NAME>.<STRING>tagName</STRING></GETPROP> != <STRING>'!'</STRING></NE></AND></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>child</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>adjacent</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <VAR>var <NAME>next = <CALL><THIS>this</THIS>.<GETPROP><STRING>nextElementSibling</STRING></GETPROP>(<NAME>node</NAME>)</CALL></NAME></VAR>;
        <BLOCK>if (<IFNE><NAME>next</NAME></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>next</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>laterSibling</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <EXPR_VOID><CALL><NAME><TARGET/>h</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<NAME>results</NAME>, <CALL><NAME>Element</NAME>.<GETPROP><STRING>nextSiblings</STRING></GETPROP>(<NAME>node</NAME>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>nextElementSibling</OBJLITNAME>: <FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>while (<IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETPROP><NAME>node</NAME>.<STRING>nextSibling</STRING></GETPROP></SETNAME></IFEQ>)
	      <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <NAME>node</NAME></RETURN><TARGET/><GOTO/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>previousElementSibling</OBJLITNAME>: <FUNCTION>function(<PARAMETER>node</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>while (<IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETPROP><NAME>node</NAME>.<STRING>previousSibling</STRING></GETPROP></SETNAME></IFEQ>)
        <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ></IFNE>) <RETURN>return <NAME>node</NAME></RETURN><TARGET/><GOTO/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK>
    }</FUNCTION>,

    // TOKEN FUNCTIONS
    <OBJLITNAME>tagName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>tagName</PARAMETER>, <PARAMETER>combinator</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>tagName</BINDNAME> = <CALL><NAME>tagName</NAME>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
      <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <BLOCK>if (<IFNE><NAME>nodes</NAME></IFNE>) <BLOCK>{
        <BLOCK>if (<IFNE><NAME>combinator</NAME></IFNE>) <BLOCK>{
          // fastlane for ordinary descendant combinators
          <BLOCK>if (<IFNE><EQ><NAME>combinator</NAME> == <STRING>"descendant"</STRING></EQ></IFNE>) <BLOCK>{
            <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
              <EXPR_VOID><CALL><NAME><TARGET/>h</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<NAME>results</NAME>, <CALL><NAME>node</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<NAME>tagName</NAME>)</CALL>)</CALL></EXPR_VOID></LOOP><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;
            <RETURN>return <NAME>results</NAME></RETURN>;
          }</BLOCK> else <EXPR_VOID><SETNAME><BINDNAME><TARGET/>nodes</BINDNAME> = <CALL><GETELEM><THIS>this</THIS>[<NAME>combinator</NAME></GETELEM>](<NAME>nodes</NAME>)</CALL></SETNAME></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
          <BLOCK>if (<IFNE><EQ><NAME>tagName</NAME> == <STRING>"*"</STRING></EQ></IFNE>) <RETURN>return <NAME>nodes</NAME></RETURN>;</BLOCK><TARGET/>
        }</BLOCK></BLOCK><TARGET/>
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
          <BLOCK><TARGET/>if (<IFNE><EQ><CALL><NAME>node</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL> == <NAME>tagName</NAME></EQ></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
        <RETURN>return <NAME>results</NAME></RETURN>;
      }</BLOCK> else <RETURN><TARGET/>return <CALL><NAME>root</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<NAME>tagName</NAME>)</CALL></RETURN><GOTO/>;</BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION>,

    <OBJLITNAME>id</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>id</PARAMETER>, <PARAMETER>combinator</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>targetNode = <CALL><NAME>$</NAME>(<NAME>id</NAME>)</CALL></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>targetNode</NAME></NOT></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><AND>!<NOT><NAME>nodes</NAME></NOT> &amp;&amp; <EQ><NAME>root</NAME> == <NAME>document</NAME></EQ></AND></IFNE>) <RETURN>return [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><NAME>nodes</NAME></IFNE>) <BLOCK>{
        <BLOCK>if (<IFNE><NAME>combinator</NAME></IFNE>) <BLOCK>{
          <BLOCK>if (<IFNE><EQ><NAME>combinator</NAME> == <STRING>'child'</STRING></EQ></IFNE>) <BLOCK>{
            <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
              <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>targetNode</NAME>.<STRING>parentNode</STRING></GETPROP> == <NAME>node</NAME></EQ></IFNE>) <RETURN>return [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT></RETURN><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
          }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><EQ><NAME>combinator</NAME> == <STRING>'descendant'</STRING></EQ></IFNE>) <BLOCK>{
            <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
              <BLOCK><TARGET/>if (<IFNE><CALL><NAME>Element</NAME>.<GETPROP><STRING>descendantOf</STRING></GETPROP>(<NAME>targetNode</NAME>, <NAME>node</NAME>)</CALL></IFNE>) <RETURN>return [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT></RETURN><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
          }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><EQ><NAME>combinator</NAME> == <STRING>'adjacent'</STRING></EQ></IFNE>) <BLOCK>{
            <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
              <BLOCK><TARGET/>if (<IFNE><EQ><CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>previousElementSibling</STRING></GETPROP>(<NAME>targetNode</NAME>)</CALL> == <NAME>node</NAME></EQ></IFNE>)
                <RETURN>return [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT></RETURN><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
          }</BLOCK> else <EXPR_VOID><SETNAME><BINDNAME><TARGET/>nodes</BINDNAME> = <CALL><GETELEM><NAME>h</NAME>[<NAME>combinator</NAME></GETELEM>](<NAME>nodes</NAME>)</CALL></SETNAME></EXPR_VOID><GOTO/><GOTO/><GOTO/><GOTO/><GOTO/>;</BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/><TARGET/><TARGET/>
        }</BLOCK></BLOCK><TARGET/>
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
          <BLOCK><TARGET/>if (<IFNE><EQ><NAME>node</NAME> == <NAME>targetNode</NAME></EQ></IFNE>) <RETURN>return [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT></RETURN><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
        <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;
      }</BLOCK></BLOCK><TARGET/>
      <RETURN>return (<HOOK><AND><NAME>targetNode</NAME> &amp;&amp; <CALL><NAME>Element</NAME>.<GETPROP><STRING>descendantOf</STRING></GETPROP>(<NAME>targetNode</NAME>, <NAME>root</NAME>)</CALL>)</AND> ? [<ARRAYLIT><NAME>targetNode</NAME>]</ARRAYLIT> : <ARRAYLIT>[]</ARRAYLIT></HOOK></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>className</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>className</PARAMETER>, <PARAMETER>combinator</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><AND><NAME>nodes</NAME> &amp;&amp; <NAME>combinator</NAME></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><GETELEM><THIS>this</THIS>[<NAME>combinator</NAME></GETELEM>](<NAME>nodes</NAME>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>byClassName</STRING></GETPROP>(<NAME>nodes</NAME>, <NAME>root</NAME>, <NAME>className</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>byClassName</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><NOT>!<NAME>nodes</NAME></NOT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>descendant</STRING></GETPROP>([<ARRAYLIT><NAME>root</NAME>]</ARRAYLIT>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <VAR>var <NAME>needle = <ADD><ADD><STRING>' '</STRING> + <NAME>className</NAME></ADD> + <STRING>' '</STRING></ADD></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME>, <NAME>nodeClassName</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <EXPR_VOID><SETNAME><BINDNAME>nodeClassName</BINDNAME> = <GETPROP><NAME>node</NAME>.<STRING>className</STRING></GETPROP></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><EQ><GETPROP><NAME>nodeClassName</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>0</NUMBER></EQ></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
        <BLOCK>if (<IFNE><OR><EQ><NAME>nodeClassName</NAME> == <NAME>className</NAME></EQ> || (<CALL><ADD><ADD><STRING>' '</STRING> + <NAME>nodeClassName</NAME></ADD> + <STRING>' '</STRING></ADD>).<GETPROP><STRING>include</STRING></GETPROP>(<NAME>needle</NAME>)</CALL></OR></IFNE>)
          <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>attrPresence</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>attr</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><NOT>!<NAME>nodes</NAME></NOT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><NAME>root</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>"*"</STRING>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><CALL><NAME>Element</NAME>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<NAME>node</NAME>, <NAME>attr</NAME>)</CALL></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>attr</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>attr</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>operator</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><NOT>!<NAME>nodes</NAME></NOT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><NAME>root</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>"*"</STRING>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <VAR>var <NAME>handler = <GETELEM><NAME>Selector</NAME>.<GETPROP><STRING>operators</STRING></GETPROP>[<NAME>operator</NAME>]</GETELEM></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <VAR>var <NAME>nodeValue = <CALL><NAME>Element</NAME>.<GETPROP><STRING>readAttribute</STRING></GETPROP>(<NAME>node</NAME>, <NAME>attr</NAME>)</CALL></NAME></VAR>;
        <BLOCK>if (<IFNE><SHEQ><NAME>nodeValue</NAME> === <NULL>null</NULL></SHEQ></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
        <BLOCK>if (<IFNE><CALL><NAME>handler</NAME>(<NAME>nodeValue</NAME>, <NAME>value</NAME>)</CALL></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>pseudo</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>name</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>combinator</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><AND><NAME>nodes</NAME> &amp;&amp; <NAME>combinator</NAME></AND></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><GETELEM><THIS>this</THIS>[<NAME>combinator</NAME></GETELEM>](<NAME>nodes</NAME>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><NOT>!<NAME>nodes</NAME></NOT></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>nodes</BINDNAME> = <CALL><NAME>root</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>"*"</STRING>)</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETELEM><GETPROP><STRING>pseudos</STRING></GETPROP>[<NAME>name</NAME></GETELEM>](<NAME>nodes</NAME>, <NAME>value</NAME>, <NAME>root</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>
  }</OBJECTLIT>,

  <OBJLITNAME>pseudos</OBJLITNAME>: <OBJECTLIT>{
    '<OBJLITNAME>first-child</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <BLOCK>if (<IFNE><CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>previousElementSibling</STRING></GETPROP>(<NAME>node</NAME>)</CALL></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
          <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>last-child</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <BLOCK>if (<IFNE><CALL><NAME>Selector</NAME>.<GETPROP><STRING>handlers</STRING></GETPROP>.<GETPROP><STRING>nextElementSibling</STRING></GETPROP>(<NAME>node</NAME>)</CALL></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
          <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>only-child</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><AND>!<NOT><CALL><NAME>h</NAME>.<GETPROP><STRING>previousElementSibling</STRING></GETPROP>(<NAME>node</NAME>)</CALL></NOT> &amp;&amp; !<NOT><CALL><NAME>h</NAME>.<GETPROP><STRING>nextElementSibling</STRING></GETPROP>(<NAME>node</NAME>)</CALL></NOT></AND></IFNE>)
          <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>nth-child</OBJLITNAME>':        <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <NAME>formula</NAME>, <NAME>root</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>nth-last-child</OBJLITNAME>':   <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <NAME>formula</NAME>, <NAME>root</NAME>, <TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>nth-of-type</OBJLITNAME>':      <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <NAME>formula</NAME>, <NAME>root</NAME>, <FALSE>false</FALSE>, <TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>nth-last-of-type</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <NAME>formula</NAME>, <NAME>root</NAME>, <TRUE>true</TRUE>, <TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>first-of-type</OBJLITNAME>':    <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <STRING>"1"</STRING>, <NAME>root</NAME>, <FALSE>false</FALSE>, <TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>last-of-type</OBJLITNAME>':     <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>nth</STRING></GETPROP>(<NAME>nodes</NAME>, <STRING>"1"</STRING>, <NAME>root</NAME>, <TRUE>true</TRUE>, <TRUE>true</TRUE>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,
    '<OBJLITNAME>only-of-type</OBJLITNAME>':     <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>p = <GETPROP><NAME>Selector</NAME>.<STRING>pseudos</STRING></GETPROP></NAME></VAR>;
      <RETURN>return <CALL><GETELEM><NAME>p</NAME>[<STRING>'last-of-type'</STRING></GETELEM>](<CALL><GETELEM><NAME>p</NAME>[<STRING>'first-of-type'</STRING></GETELEM>](<NAME>nodes</NAME>, <NAME>formula</NAME>, <NAME>root</NAME>)</CALL>, <NAME>formula</NAME>, <NAME>root</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    // handles the an+b logic
    <OBJLITNAME>getIndices</OBJLITNAME>: <FUNCTION>function(<PARAMETER>a</PARAMETER>, <PARAMETER>b</PARAMETER>, <PARAMETER>total</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><NAME>a</NAME> == <NUMBER>0</NUMBER></EQ></IFNE>) <RETURN>return <HOOK><GT><NAME>b</NAME> &gt; <NUMBER>0</NUMBER></GT> ? [<ARRAYLIT><NAME>b</NAME>]</ARRAYLIT> : <ARRAYLIT>[]</ARRAYLIT></HOOK></RETURN>;</BLOCK><TARGET/>
      <RETURN>return <CALL><CALL><NAME>$R</NAME>(<NUMBER>1</NUMBER>, <NAME>total</NAME></CALL>).<GETPROP><STRING>inject</STRING></GETPROP>(<ARRAYLIT>[]</ARRAYLIT>, <FUNCTION>function(<PARAMETER>memo</PARAMETER>, <PARAMETER>i</PARAMETER>) <BLOCK>{
        <BLOCK>if (<IFNE><AND><EQ><NUMBER>0</NUMBER> == (<MOD><SUB><NAME>i</NAME> - <NAME>b</NAME>)</SUB> % <NAME>a</NAME></MOD></EQ> &amp;&amp; (<GE><DIV><SUB><NAME>i</NAME> - <NAME>b</NAME>)</SUB> / <NAME>a</NAME></DIV> &gt;= <NUMBER>0</NUMBER></GE></AND></IFNE>) <EXPR_VOID><CALL><NAME>memo</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>i</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
        <RETURN>return <NAME>memo</NAME></RETURN>;</BLOCK>
      }</FUNCTION>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    // handles nth(-last)-child, nth(-last)-of-type, and (first|last)-of-type
    <OBJLITNAME>nth</OBJLITNAME>: <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>formula</PARAMETER>, <PARAMETER>root</PARAMETER>, <PARAMETER>reverse</PARAMETER>, <PARAMETER>ofType</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><EQ><GETPROP><NAME>nodes</NAME>.<STRING>length</STRING></GETPROP> == <NUMBER>0</NUMBER></EQ></IFNE>) <RETURN>return <ARRAYLIT>[]</ARRAYLIT></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><EQ><NAME>formula</NAME> == <STRING>'even'</STRING></EQ></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>formula</BINDNAME> = <STRING>'2n+0'</STRING></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><EQ><NAME>formula</NAME> == <STRING>'odd'</STRING></EQ></IFNE>)  <EXPR_VOID><SETNAME><BINDNAME>formula</BINDNAME> = <STRING>'2n+1'</STRING></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>indexed = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>m</NAME></VAR>;
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>mark</STRING></GETPROP>(<NAME>nodes</NAME>)</CALL></EXPR_VOID>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>node</NAME>.<GETPROP><STRING>parentNode</STRING></GETPROP>.<STRING>_counted</STRING></GETPROP></NOT></IFNE>) <BLOCK>{
          <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>index</STRING></GETPROP>(<GETPROP><NAME>node</NAME>.<STRING>parentNode</STRING></GETPROP>, <NAME>reverse</NAME>, <NAME>ofType</NAME>)</CALL></EXPR_VOID>;
          <EXPR_VOID><CALL><NAME>indexed</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<GETPROP><NAME>node</NAME>.<STRING>parentNode</STRING></GETPROP>)</CALL></EXPR_VOID>;
        }</BLOCK></BLOCK><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <BLOCK>if (<IFNE><CALL><NAME>formula</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^\d+$/</REGEXP>)</CALL></IFNE>) <BLOCK>{ // just a number
        <EXPR_VOID><SETNAME><BINDNAME>formula</BINDNAME> = <CALL><NAME>Number</NAME>(<NAME>formula</NAME>)</CALL></SETNAME></EXPR_VOID>;
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
          <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeIndex</STRING></GETPROP> == <NAME>formula</NAME></EQ></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><SETNAME><BINDNAME>m</BINDNAME> = <CALL><NAME>formula</NAME>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^(-?\d*)?n(([+-])(\d+))?/</REGEXP>)</CALL></SETNAME></IFNE>) <BLOCK>{ // an+b
        <BLOCK>if (<IFNE><EQ><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM> == <STRING>"-"</STRING></EQ></IFNE>) <EXPR_VOID><SETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>] = -<NUMBER>1</NUMBER></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
        <VAR>var <NAME>a = <HOOK><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM> ? <CALL><NAME>Number</NAME>(<GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER>]</GETELEM>)</CALL> : <NUMBER>1</NUMBER></HOOK></NAME></VAR>;
        <VAR>var <NAME>b = <HOOK><GETELEM><NAME>m</NAME>[<NUMBER>2</NUMBER>]</GETELEM> ? <CALL><NAME>Number</NAME>(<GETELEM><NAME>m</NAME>[<NUMBER>2</NUMBER>]</GETELEM>)</CALL> : <NUMBER>0</NUMBER></HOOK></NAME></VAR>;
        <VAR>var <NAME>indices = <CALL><NAME>Selector</NAME>.<GETPROP><STRING>pseudos</STRING></GETPROP>.<GETPROP><STRING>getIndices</STRING></GETPROP>(<NAME>a</NAME>, <NAME>b</NAME>, <GETPROP><NAME>nodes</NAME>.<STRING>length</STRING></GETPROP>)</CALL></NAME></VAR>;
        <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME>, <NAME>l = <GETPROP><NAME>indices</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
          <LOOP><EMPTY/>for <VAR>(var <NAME>j = <NUMBER>0</NUMBER></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>j</NAME> &lt; <NAME>l</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>j</NAME></INC></EXPR_VOID>++)
            <BLOCK><TARGET/>if (<IFNE><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeIndex</STRING></GETPROP> == <GETELEM><NAME>indices</NAME>[<NAME>j</NAME>]</GETELEM></EQ></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
        <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <GOTO/>}</BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>unmark</STRING></GETPROP>(<NAME>nodes</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>unmark</STRING></GETPROP>(<NAME>indexed</NAME>)</CALL></EXPR_VOID>;
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    '<OBJLITNAME>empty</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        // IE treats comments as element nodes
        <BLOCK>if (<IFNE><OR><EQ><GETPROP><NAME>node</NAME>.<STRING>tagName</STRING></GETPROP> == <STRING>'!'</STRING></EQ> || (<AND><GETPROP><NAME>node</NAME>.<STRING>firstChild</STRING></GETPROP> &amp;&amp; !<NOT><CALL><NAME>node</NAME>.<GETPROP><STRING>innerHTML</STRING></GETPROP>.<GETPROP><STRING>match</STRING></GETPROP>(<REGEXP>/^\s*$/</REGEXP>)</CALL></NOT>)</AND></OR></IFNE>) <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
        <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID>;
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    '<OBJLITNAME>not</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>selector</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME>, <NAME>selectorType</NAME>, <NAME>m</NAME></VAR>;
      <VAR>var <NAME>exclusions = <CALL><NEW>new <NAME>Selector</NAME>(<NAME>selector</NAME></NEW>).<GETPROP><STRING>findElements</STRING></GETPROP>(<NAME>root</NAME>)</CALL></NAME></VAR>;
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>mark</STRING></GETPROP>(<NAME>exclusions</NAME>)</CALL></EXPR_VOID>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><NOT>!<GETPROP><NAME>node</NAME>.<STRING>_counted</STRING></GETPROP></NOT></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>unmark</STRING></GETPROP>(<NAME>exclusions</NAME>)</CALL></EXPR_VOID>;
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    '<OBJLITNAME>enabled</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><NOT>!<GETPROP><NAME>node</NAME>.<STRING>disabled</STRING></GETPROP></NOT></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    '<OBJLITNAME>disabled</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>node</NAME>.<STRING>disabled</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    '<OBJLITNAME>checked</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nodes</PARAMETER>, <PARAMETER>value</PARAMETER>, <PARAMETER>root</PARAMETER>) <BLOCK>{
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
        <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>node</NAME>.<STRING>checked</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
      <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
    }</FUNCTION>
  }</OBJECTLIT>,

  <OBJLITNAME>operators</OBJLITNAME>: <OBJECTLIT>{
    '<OBJLITNAME>=</OBJLITNAME>':  <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return <EQ><NAME>nv</NAME> == <NAME>v</NAME></EQ></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>!=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return <NE><NAME>nv</NAME> != <NAME>v</NAME></NE></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>^=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>nv</NAME>.<GETPROP><STRING>startsWith</STRING></GETPROP>(<NAME>v</NAME>)</CALL></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>$=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>nv</NAME>.<GETPROP><STRING>endsWith</STRING></GETPROP>(<NAME>v</NAME>)</CALL></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>*=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>nv</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>v</NAME>)</CALL></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>~=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return (<CALL><ADD><ADD><STRING>' '</STRING> + <NAME>nv</NAME></ADD> + <STRING>' '</STRING></ADD>).<GETPROP><STRING>include</STRING></GETPROP>(<ADD><ADD><STRING>' '</STRING> + <NAME>v</NAME></ADD> + <STRING>' '</STRING></ADD>)</CALL></RETURN>;</BLOCK> }</FUNCTION>,
    '<OBJLITNAME>|=</OBJLITNAME>': <FUNCTION>function(<PARAMETER>nv</PARAMETER>, <PARAMETER>v</PARAMETER>) <BLOCK>{ <RETURN>return (<CALL><ADD><ADD><STRING>'-'</STRING> + <CALL><NAME>nv</NAME>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></ADD> + <STRING>'-'</STRING></ADD>).<GETPROP><STRING>include</STRING></GETPROP>(<ADD><ADD><STRING>'-'</STRING> + <CALL><NAME>v</NAME>.<GETPROP><STRING>toUpperCase</STRING></GETPROP>()</CALL></ADD> + <STRING>'-'</STRING></ADD>)</CALL></RETURN>;</BLOCK> }</FUNCTION>
  }</OBJECTLIT>,

  <OBJLITNAME>matchElements</OBJLITNAME>: <FUNCTION>function(<PARAMETER>elements</PARAMETER>, <PARAMETER>expression</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>matches = <CALL><NEW>new <NAME>Selector</NAME>(<NAME>expression</NAME></NEW>).<GETPROP><STRING>findElements</STRING></GETPROP>()</CALL></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
    <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>mark</STRING></GETPROP>(<NAME>matches</NAME>)</CALL></EXPR_VOID>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>element</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>element</BINDNAME> = <GETELEM><NAME>elements</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>_counted</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><NAME>results</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>element</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
    <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>unmark</STRING></GETPROP>(<NAME>matches</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>results</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>findElement</OBJLITNAME>: <FUNCTION>function(<PARAMETER>elements</PARAMETER>, <PARAMETER>expression</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isNumber</STRING></GETPROP>(<NAME>expression</NAME>)</CALL></IFNE>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>index</BINDNAME> = <NAME>expression</NAME></SETNAME></EXPR_VOID>; <EXPR_VOID><SETNAME><BINDNAME>expression</BINDNAME> = <FALSE>false</FALSE></SETNAME></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <GETELEM><NAME>Selector</NAME>.<CALL><GETPROP><STRING>matchElements</STRING></GETPROP>(<NAME>elements</NAME>, <OR><NAME>expression</NAME> || <STRING>'*'</STRING></OR></CALL>)[<OR><NAME>index</NAME> || <NUMBER>0</NUMBER></OR>]</GETELEM></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>findChildElements</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>expressions</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>exprs = <CALL><NAME>expressions</NAME>.<GETPROP><STRING>join</STRING></GETPROP>(<STRING>','</STRING>)</CALL></NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>expressions</BINDNAME> = <ARRAYLIT>[]</ARRAYLIT></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>exprs</NAME>.<GETPROP><STRING>scan</STRING></GETPROP>(<REGEXP>/(([\w#:.~&gt;+()\s-]+|\*|\[.*?\])+)\s*(,|$)/</REGEXP>, <FUNCTION>function(<PARAMETER>m</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>expressions</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><GETELEM><NAME>m</NAME>[<NUMBER>1</NUMBER></GETELEM>].<GETPROP><STRING>strip</STRING></GETPROP>()</CALL>)</CALL></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
    <VAR>var <NAME>results = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>h = <GETPROP><NAME>Selector</NAME>.<STRING>handlers</STRING></GETPROP></NAME></VAR>;
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>l = <GETPROP><NAME>expressions</NAME>.<STRING>length</STRING></GETPROP></NAME>, <NAME>selector</NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>l</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <EXPR_VOID><SETNAME><BINDNAME>selector</BINDNAME> = <NEW>new <NAME>Selector</NAME>(<CALL><GETELEM><NAME>expressions</NAME>[<NAME>i</NAME></GETELEM>].<GETPROP><STRING>strip</STRING></GETPROP>()</CALL>)</NEW></SETNAME></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>h</NAME>.<GETPROP><STRING>concat</STRING></GETPROP>(<NAME>results</NAME>, <CALL><NAME>selector</NAME>.<GETPROP><STRING>findElements</STRING></GETPROP>(<NAME>element</NAME>)</CALL>)</CALL></EXPR_VOID>;
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return (<HOOK><GT><NAME>l</NAME> &gt; <NUMBER>1</NUMBER>)</GT> ? <CALL><NAME>h</NAME>.<GETPROP><STRING>unique</STRING></GETPROP>(<NAME>results</NAME>)</CALL> : <NAME>results</NAME></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></IFNE>) <BLOCK>{
  // IE returns comment nodes on getElementsByTagName("*").
  // Filter them out.
  <NAME>Selector</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>handlers</STRING></GETPROP>.<STRING>concat</STRING> = <FUNCTION>function(<PARAMETER>a</PARAMETER>, <PARAMETER>b</PARAMETER>) <BLOCK>{
    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>node</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>node</BINDNAME> = <GETELEM><NAME>b</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++)
      <BLOCK><TARGET/>if (<IFNE><SHNE><GETPROP><NAME>node</NAME>.<STRING>tagName</STRING></GETPROP> !== <STRING>"!"</STRING></SHNE></IFNE>) <EXPR_VOID><CALL><NAME>a</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>node</NAME>)</CALL></EXPR_VOID><TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>;</BLOCK></LOOP><TARGET/>
    <RETURN>return <NAME>a</NAME></RETURN>;</BLOCK>
  }</FUNCTION></SETPROP></EXPR_RESULT>;
}</BLOCK></BLOCK><TARGET/>

<FUNCTION>function <FUNCNAME>$$</FUNCNAME>() <BLOCK>{
  <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findChildElements</STRING></GETPROP>(<NAME>document</NAME>, <CALL><NAME>$A</NAME>(<NAME>arguments</NAME>)</CALL>)</CALL></RETURN>;</BLOCK>
}</FUNCTION>
<VAR>var <NAME>Form = <OBJECTLIT>{
  <OBJLITNAME>reset</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><CALL><NAME>$</NAME>(<NAME>form</NAME></CALL>).<GETPROP><STRING>reset</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>form</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>serializeElements</OBJLITNAME>: <FUNCTION>function(<PARAMETER>elements</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NE>typeof <TYPEOFNAME>options</TYPEOFNAME> != <STRING>'object'</STRING></NE></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>options</BINDNAME> = <OBJECTLIT>{ <OBJLITNAME>hash</OBJLITNAME>: !!<NOT><NOT><NAME>options</NAME></NOT></NOT> }</OBJECTLIT></SETNAME></EXPR_VOID>;
    else <BLOCK><TARGET/>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<GETPROP><NAME>options</NAME>.<STRING>hash</STRING></GETPROP>)</CALL></IFNE>) <EXPR_VOID><SETPROP><NAME>options</NAME>.<STRING>hash</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID><GOTO/>;</BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>
    <VAR>var <NAME>key</NAME>, <NAME>value</NAME>, <NAME>submitted = <FALSE>false</FALSE></NAME>, <NAME>submit = <GETPROP><NAME>options</NAME>.<STRING>submit</STRING></GETPROP></NAME></VAR>;

    <VAR>var <NAME>data = <CALL><NAME>elements</NAME>.<GETPROP><STRING>inject</STRING></GETPROP>(<OBJECTLIT>{ }</OBJECTLIT>, <FUNCTION>function(<PARAMETER>result</PARAMETER>, <PARAMETER>element</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><AND>!<NOT><GETPROP><NAME>element</NAME>.<STRING>disabled</STRING></GETPROP></NOT> &amp;&amp; <GETPROP><NAME>element</NAME>.<STRING>name</STRING></GETPROP></AND></IFNE>) <BLOCK>{
        <EXPR_VOID><SETNAME><BINDNAME>key</BINDNAME> = <GETPROP><NAME>element</NAME>.<STRING>name</STRING></GETPROP></SETNAME></EXPR_VOID>; <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><AND><NE><NAME>value</NAME> != <NULL>null</NULL></NE> &amp;&amp; (<OR><NE><GETPROP><NAME>element</NAME>.<STRING>type</STRING></GETPROP> != <STRING>'submit'</STRING></NE> || (!<AND><NOT><NAME>submitted</NAME></NOT> &amp;&amp;
            <AND><SHNE><NAME>submit</NAME> !== <FALSE>false</FALSE></SHNE> &amp;&amp; (!<AND><OR><NOT><NAME>submit</NAME></NOT> || <EQ><NAME>key</NAME> == <NAME>submit</NAME></EQ>)</OR> &amp;&amp; (<SETNAME><BINDNAME>submitted</BINDNAME> = <TRUE>true</TRUE>)</SETNAME></AND></AND>)</AND>)</OR></AND></IFNE>) <BLOCK>{
          <BLOCK>if (<IFNE><IN><NAME>key</NAME> in <NAME>result</NAME></IN></IFNE>) <BLOCK>{
            // a key is already present; construct an array of values
            <BLOCK>if (<IFNE><NOT>!<CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<GETELEM><NAME>result</NAME>[<NAME>key</NAME>]</GETELEM>)</CALL></NOT></IFNE>) <EXPR_VOID><SETELEM><NAME>result</NAME>[<NAME>key</NAME>] = [<ARRAYLIT><GETELEM><NAME>result</NAME>[<NAME>key</NAME>]</GETELEM>]</ARRAYLIT></SETELEM></EXPR_VOID>;</BLOCK><TARGET/>
            <EXPR_VOID><CALL><GETELEM><NAME>result</NAME>[<NAME>key</NAME></GETELEM>].<GETPROP><STRING>push</STRING></GETPROP>(<NAME>value</NAME>)</CALL></EXPR_VOID>;
          }</BLOCK>
          else <EXPR_VOID><SETELEM><NAME><TARGET/>result</NAME>[<NAME>key</NAME>] = <NAME>value</NAME></SETELEM></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
        }</BLOCK></BLOCK><TARGET/>
      }</BLOCK></BLOCK><TARGET/>
      <RETURN>return <NAME>result</NAME></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></NAME></VAR>;

    <RETURN>return <HOOK><GETPROP><NAME>options</NAME>.<STRING>hash</STRING></GETPROP> ? <NAME>data</NAME> : <CALL><NAME>Object</NAME>.<GETPROP><STRING>toQueryString</STRING></GETPROP>(<NAME>data</NAME>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<EXPR_RESULT><SETPROP><NAME>Form</NAME>.<STRING>Methods</STRING> = <OBJECTLIT>{
  <OBJLITNAME>serialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>serializeElements</STRING></GETPROP>(<CALL><NAME>Form</NAME>.<GETPROP><STRING>getElements</STRING></GETPROP>(<NAME>form</NAME>)</CALL>, <NAME>options</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getElements</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$A</NAME>(<CALL><CALL><NAME>$</NAME>(<NAME>form</NAME></CALL>).<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>'*'</STRING>)</CALL></CALL>).<GETPROP><STRING>inject</STRING></GETPROP>(<ARRAYLIT>[]</ARRAYLIT>,
      <FUNCTION>function(<PARAMETER>elements</PARAMETER>, <PARAMETER>child</PARAMETER>) <BLOCK>{
        <BLOCK>if (<IFNE><GETELEM><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>Serializers</STRING></GETPROP>[<CALL><NAME>child</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>]</GETELEM></IFNE>)
          <EXPR_VOID><CALL><NAME>elements</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>child</NAME>)</CALL>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
        <RETURN>return <NAME>elements</NAME></RETURN>;</BLOCK>
      }</FUNCTION>
    )</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getInputs</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>, <PARAMETER>typeName</PARAMETER>, <PARAMETER>name</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>form</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>form</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>inputs = <CALL><NAME>form</NAME>.<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>'input'</STRING>)</CALL></NAME></VAR>;

    <BLOCK>if (<IFNE><AND>!<NOT><NAME>typeName</NAME></NOT> &amp;&amp; !<NOT><NAME>name</NAME></NOT></AND></IFNE>) <RETURN>return <CALL><CALL><NAME>$A</NAME>(<NAME>inputs</NAME></CALL>).<GETPROP><STRING>map</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<STRING>extend</STRING></GETPROP>)</CALL></RETURN>;</BLOCK><TARGET/>

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>matchingInputs = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>length = <GETPROP><NAME>inputs</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <VAR>var <NAME>input = <GETELEM><NAME>inputs</NAME>[<NAME>i</NAME>]</GETELEM></NAME></VAR>;
      <BLOCK>if (<IFNE><OR>(<AND><NAME>typeName</NAME> &amp;&amp; <NE><GETPROP><NAME>input</NAME>.<STRING>type</STRING></GETPROP> != <NAME>typeName</NAME></NE>)</AND> || (<AND><NAME>name</NAME> &amp;&amp; <NE><GETPROP><NAME>input</NAME>.<STRING>name</STRING></GETPROP> != <NAME>name</NAME></NE>)</AND></OR></IFNE>)
        <CONTINUE>continue</CONTINUE>;</BLOCK><TARGET/>
      <EXPR_VOID><CALL><NAME>matchingInputs</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>input</NAME>)</CALL>)</CALL></EXPR_VOID>;
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>

    <RETURN>return <NAME>matchingInputs</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>disable</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>form</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>form</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Form</NAME>.<CALL><GETPROP><STRING>getElements</STRING></GETPROP>(<NAME>form</NAME></CALL>).<GETPROP><STRING>invoke</STRING></GETPROP>(<STRING>'disable'</STRING>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>form</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>enable</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>form</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>form</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Form</NAME>.<CALL><GETPROP><STRING>getElements</STRING></GETPROP>(<NAME>form</NAME></CALL>).<GETPROP><STRING>invoke</STRING></GETPROP>(<STRING>'enable'</STRING>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>form</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>findFirstElement</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>elements = <CALL><CALL><NAME>$</NAME>(<NAME>form</NAME></CALL>).<CALL><GETPROP><STRING>getElements</STRING></GETPROP></CALL>().<GETPROP><STRING>findAll</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
      <RETURN>return <AND><NE><STRING>'hidden'</STRING> != <GETPROP><NAME>element</NAME>.<STRING>type</STRING></GETPROP></NE> &amp;&amp; !<NOT><GETPROP><NAME>element</NAME>.<STRING>disabled</STRING></GETPROP></NOT></AND></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></NAME></VAR>;
    <VAR>var <NAME>firstByIndex = <CALL><NAME>elements</NAME>.<CALL><GETPROP><STRING>findAll</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
      <RETURN>return <AND><CALL><NAME>element</NAME>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<STRING>'tabIndex'</STRING>)</CALL> &amp;&amp; <GE><GETPROP><NAME>element</NAME>.<STRING>tabIndex</STRING></GETPROP> &gt;= <NUMBER>0</NUMBER></GE></AND></RETURN>;</BLOCK>
    }</FUNCTION></CALL>).<CALL><GETPROP><STRING>sortBy</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{ <RETURN>return <GETPROP><NAME>element</NAME>.<STRING>tabIndex</STRING></GETPROP></RETURN></BLOCK> }</FUNCTION></CALL>).<GETPROP><STRING>first</STRING></GETPROP>()</CALL></NAME></VAR>;

    <RETURN>return <HOOK><NAME>firstByIndex</NAME> ? <NAME>firstByIndex</NAME> : <CALL><NAME>elements</NAME>.<GETPROP><STRING>find</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
      <RETURN>return [<CALL><ARRAYLIT><STRING>'input'</STRING>, <STRING>'select'</STRING>, <STRING>'textarea'</STRING></ARRAYLIT>].<GETPROP><STRING>include</STRING></GETPROP>(<CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>)</CALL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>focusFirstElement</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>form</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>form</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>form</NAME>.<CALL><GETPROP><STRING>findFirstElement</STRING></GETPROP></CALL>().<GETPROP><STRING>activate</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>form</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>request</OBJLITNAME>: <FUNCTION>function(<PARAMETER>form</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><COMMA><SETNAME><BINDNAME>form</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>form</NAME>)</CALL></SETNAME>, <SETNAME><BINDNAME>options</BINDNAME> = <CALL><NAME>Object</NAME>.<GETPROP><STRING>clone</STRING></GETPROP>(<OR><NAME>options</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR>)</CALL></SETNAME></COMMA></EXPR_VOID>;

    <VAR>var <NAME>params = <GETPROP><NAME>options</NAME>.<STRING>parameters</STRING></GETPROP></NAME>, <NAME>action = <OR><CALL><NAME>form</NAME>.<GETPROP><STRING>readAttribute</STRING></GETPROP>(<STRING>'action'</STRING>)</CALL> || <STRING>''</STRING></OR></NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>action</NAME>.<GETPROP><STRING>blank</STRING></GETPROP>()</CALL></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>action</BINDNAME> = <GETPROP><NAME>window</NAME>.<GETPROP><STRING>location</STRING></GETPROP>.<STRING>href</STRING></GETPROP></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><NAME>options</NAME>.<STRING>parameters</STRING> = <CALL><NAME>form</NAME>.<GETPROP><STRING>serialize</STRING></GETPROP>(<TRUE>true</TRUE>)</CALL></SETPROP></EXPR_VOID>;

    <BLOCK>if (<IFNE><NAME>params</NAME></IFNE>) <BLOCK>{
      <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>params</NAME>)</CALL></IFNE>) <EXPR_VOID><SETNAME><BINDNAME>params</BINDNAME> = <CALL><NAME>params</NAME>.<GETPROP><STRING>toQueryParams</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>
      <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>options</NAME>.<STRING>parameters</STRING></GETPROP>, <NAME>params</NAME>)</CALL></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>

    <BLOCK>if (<IFNE><AND><CALL><NAME>form</NAME>.<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<STRING>'method'</STRING>)</CALL> &amp;&amp; !<NOT><GETPROP><NAME>options</NAME>.<STRING>method</STRING></GETPROP></NOT></AND></IFNE>)
      <EXPR_VOID><SETPROP><NAME>options</NAME>.<STRING>method</STRING> = <GETPROP><NAME>form</NAME>.<STRING>method</STRING></GETPROP></SETPROP></EXPR_VOID>;</BLOCK><TARGET/>

    <RETURN>return <NEW>new <GETPROP><NAME>Ajax</NAME>.<STRING>Request</STRING></GETPROP>(<NAME>action</NAME>, <NAME>options</NAME>)</NEW></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<EXPR_RESULT><SETPROP><NAME>Form</NAME>.<STRING>Element</STRING> = <OBJECTLIT>{
  <OBJLITNAME>focus</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>focus</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>select</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>select</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<NAME>Form</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Methods</STRING> = <OBJECTLIT>{
  <OBJLITNAME>serialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <BLOCK>if (<IFNE><AND>!<NOT><GETPROP><NAME>element</NAME>.<STRING>disabled</STRING></GETPROP></NOT> &amp;&amp; <GETPROP><NAME>element</NAME>.<STRING>name</STRING></GETPROP></AND></IFNE>) <BLOCK>{
      <VAR>var <NAME>value = <CALL><NAME>element</NAME>.<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NE><NAME>value</NAME> != <NAME>undefined</NAME></NE></IFNE>) <BLOCK>{
        <VAR>var <NAME>pair = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;
        <EXPR_VOID><SETELEM><NAME>pair</NAME>[<GETPROP><NAME>element</NAME>.<STRING>name</STRING></GETPROP>] = <NAME>value</NAME></SETELEM></EXPR_VOID>;
        <RETURN>return <CALL><NAME>Object</NAME>.<GETPROP><STRING>toQueryString</STRING></GETPROP>(<NAME>pair</NAME>)</CALL></RETURN>;
      }</BLOCK></BLOCK><TARGET/>
    }</BLOCK></BLOCK><TARGET/>
    <RETURN>return <STRING>''</STRING></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>getValue</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>method = <CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></NAME></VAR>;
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETELEM><GETPROP><STRING>Serializers</STRING></GETPROP>[<NAME>method</NAME></GETELEM>](<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>setValue</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>method = <CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL></NAME></VAR>;
    <EXPR_VOID><CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETELEM><GETPROP><STRING>Serializers</STRING></GETPROP>[<NAME>method</NAME></GETELEM>](<NAME>element</NAME>, <NAME>value</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>clear</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<STRING>value</STRING> = <STRING>''</STRING></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>present</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <RETURN>return <NE><GETPROP><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<STRING>value</STRING></GETPROP> != <STRING>''</STRING></NE></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>activate</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <TRY>try <BLOCK>{
      <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>focus</STRING></GETPROP>()</CALL></EXPR_VOID>;
      <BLOCK>if (<IFNE><AND><GETPROP><NAME>element</NAME>.<STRING>select</STRING></GETPROP> &amp;&amp; (<OR><NE><CALL><NAME>element</NAME>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL> != <STRING>'input'</STRING></NE> ||
          ![<NOT><CALL><ARRAYLIT><STRING>'button'</STRING>, <STRING>'reset'</STRING>, <STRING>'submit'</STRING></ARRAYLIT>].<GETPROP><STRING>include</STRING></GETPROP>(<GETPROP><NAME>element</NAME>.<STRING>type</STRING></GETPROP>)</CALL></NOT>)</OR></AND></IFNE>)
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>select</STRING></GETPROP>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    }</BLOCK> <CATCH>catch (<NAME>e</NAME><EMPTY/>) <BLOCK>{ }</BLOCK></CATCH></TRY>
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>disable</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>blur</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>disabled</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>enable</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
    <EXPR_VOID><SETPROP><NAME>element</NAME>.<STRING>disabled</STRING> = <FALSE>false</FALSE></SETPROP></EXPR_VOID>;
    <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<VAR>var <NAME>Field = <GETPROP><NAME>Form</NAME>.<STRING>Element</STRING></GETPROP></NAME></VAR>;
<VAR>var <NAME>$F = <GETPROP><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>getValue</STRING></GETPROP></NAME></VAR>;

/*--------------------------------------------------------------------------*/

<NAME>Form</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Serializers</STRING> = <OBJECTLIT>{
  <OBJLITNAME>input</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <SWITCH>switch (<CALL><NAME>element</NAME>.<GETPROP><STRING>type</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>) {
      <CASE>case <STRING>'checkbox'</STRING></CASE>:
      <CASE>case <STRING>'radio'</STRING>:
        <BLOCK><RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>Serializers</STRING></GETPROP>.<GETPROP><STRING>inputSelector</STRING></GETPROP>(<NAME>element</NAME>, <NAME>value</NAME>)</CALL></RETURN></BLOCK></CASE>;
      <DEFAULT>default:
        <BLOCK><RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>Serializers</STRING></GETPROP>.<GETPROP><STRING>textarea</STRING></GETPROP>(<NAME>element</NAME>, <NAME>value</NAME>)</CALL></RETURN></BLOCK></DEFAULT>;
    }</SWITCH><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>inputSelector</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL></IFNE>) <RETURN>return <HOOK><GETPROP><NAME>element</NAME>.<STRING>checked</STRING></GETPROP> ? <GETPROP><NAME>element</NAME>.<STRING>value</STRING></GETPROP> : <NULL>null</NULL></HOOK></RETURN>;
    else <EXPR_VOID><SETPROP><NAME><TARGET/>element</NAME>.<STRING>checked</STRING> = !!<NOT><NOT><NAME>value</NAME></NOT></NOT></SETPROP></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>textarea</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>value</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>value</NAME>)</CALL></IFNE>) <RETURN>return <GETPROP><NAME>element</NAME>.<STRING>value</STRING></GETPROP></RETURN>;
    else <EXPR_VOID><SETPROP><NAME><TARGET/>element</NAME>.<STRING>value</STRING> = <NAME>value</NAME></SETPROP></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>select</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>index</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><NAME>Object</NAME>.<GETPROP><STRING>isUndefined</STRING></GETPROP>(<NAME>index</NAME>)</CALL></IFNE>)
      <RETURN>return <CALL><GETELEM><THIS>this</THIS>[<HOOK><EQ><GETPROP><NAME>element</NAME>.<STRING>type</STRING></GETPROP> == <STRING>'select-one'</STRING></EQ> ?
        <STRING>'selectOne'</STRING> : <STRING>'selectMany'</STRING></HOOK></GETELEM>](<NAME>element</NAME>)</CALL></RETURN>;
    else <BLOCK><TARGET/>{
      <VAR>var <NAME>opt</NAME>, <NAME>value</NAME>, <NAME>single = !<NOT><CALL><NAME>Object</NAME>.<GETPROP><STRING>isArray</STRING></GETPROP>(<NAME>index</NAME>)</CALL></NOT></NAME></VAR>;
      <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>length = <GETPROP><NAME>element</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
        <EXPR_VOID><SETNAME><BINDNAME>opt</BINDNAME> = <GETELEM><NAME>element</NAME>.<GETPROP><STRING>options</STRING></GETPROP>[<NAME>i</NAME>]</GETELEM></SETNAME></EXPR_VOID>;
        <EXPR_VOID><SETNAME><BINDNAME>value</BINDNAME> = <CALL><THIS>this</THIS>.<GETPROP><STRING>optionValue</STRING></GETPROP>(<NAME>opt</NAME>)</CALL></SETNAME></EXPR_VOID>;
        <BLOCK>if (<IFNE><NAME>single</NAME></IFNE>) <BLOCK>{
          <BLOCK>if (<IFNE><EQ><NAME>value</NAME> == <NAME>index</NAME></EQ></IFNE>) <BLOCK>{
            <EXPR_VOID><SETPROP><NAME>opt</NAME>.<STRING>selected</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
            <RETURN>return</RETURN>;
          }</BLOCK></BLOCK><TARGET/>
        }</BLOCK>
        else <EXPR_VOID><SETPROP><NAME><TARGET/>opt</NAME>.<STRING>selected</STRING> = <CALL><NAME>index</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>value</NAME>)</CALL></SETPROP></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
      <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
    <GOTO/>}</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>selectOne</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>index = <GETPROP><NAME>element</NAME>.<STRING>selectedIndex</STRING></GETPROP></NAME></VAR>;
    <RETURN>return <HOOK><GE><NAME>index</NAME> &gt;= <NUMBER>0</NUMBER></GE> ? <CALL><THIS>this</THIS>.<GETPROP><STRING>optionValue</STRING></GETPROP>(<GETELEM><NAME>element</NAME>.<GETPROP><STRING>options</STRING></GETPROP>[<NAME>index</NAME>]</GETELEM>)</CALL> : <NULL>null</NULL></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>selectMany</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>values</NAME>, <NAME>length = <GETPROP><NAME>element</NAME>.<STRING>length</STRING></GETPROP></NAME></VAR>;
    <BLOCK>if (<IFNE><NOT>!<NAME>length</NAME></NOT></IFNE>) <RETURN>return <NULL>null</NULL></RETURN>;</BLOCK><TARGET/>

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>values = <ARRAYLIT>[]</ARRAYLIT></NAME></VAR>; <IFEQ><LT><NAME><TARGET/>i</NAME> &lt; <NAME>length</NAME></LT></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <VAR>var <NAME>opt = <GETELEM><NAME>element</NAME>.<GETPROP><STRING>options</STRING></GETPROP>[<NAME>i</NAME>]</GETELEM></NAME></VAR>;
      <BLOCK>if (<IFNE><GETPROP><NAME>opt</NAME>.<STRING>selected</STRING></GETPROP></IFNE>) <EXPR_VOID><CALL><NAME>values</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><THIS>this</THIS>.<GETPROP><STRING>optionValue</STRING></GETPROP>(<NAME>opt</NAME>)</CALL>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return <NAME>values</NAME></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>optionValue</OBJLITNAME>: <FUNCTION>function(<PARAMETER>opt</PARAMETER>) <BLOCK>{
    // extend element because hasAttribute may not be native
    <RETURN>return <HOOK><CALL><NAME>Element</NAME>.<CALL><GETPROP><STRING>extend</STRING></GETPROP>(<NAME>opt</NAME></CALL>).<GETPROP><STRING>hasAttribute</STRING></GETPROP>(<STRING>'value'</STRING>)</CALL> ? <GETPROP><NAME>opt</NAME>.<STRING>value</STRING></GETPROP> : <GETPROP><NAME>opt</NAME>.<STRING>text</STRING></GETPROP></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<EXPR_RESULT><SETPROP><NAME>Abstract</NAME>.<STRING>TimedObserver</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<NAME>PeriodicalExecuter</NAME>, <OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>$super</PARAMETER>, <PARAMETER>element</PARAMETER>, <PARAMETER>frequency</PARAMETER>, <PARAMETER>callback</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>$super</NAME>(<NAME>callback</NAME>, <NAME>frequency</NAME>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>element</STRING>   = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>lastValue</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>execute</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>value = <CALL><THIS>this</THIS>.<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><HOOK><AND><CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>lastValue</STRING></GETPROP>)</CALL> &amp;&amp; <CALL><NAME>Object</NAME>.<GETPROP><STRING>isString</STRING></GETPROP>(<NAME>value</NAME>)</CALL></AND> ?
        <NE><GETPROP><THIS>this</THIS>.<STRING>lastValue</STRING></GETPROP> != <NAME>value</NAME></NE> : <NE><CALL><NAME>String</NAME>(<GETPROP><THIS>this</THIS>.<STRING>lastValue</STRING></GETPROP>)</CALL> != <CALL><NAME>String</NAME>(<NAME>value</NAME>)</CALL></NE></HOOK></IFNE>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>callback</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>, <NAME>value</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>lastValue</STRING> = <NAME>value</NAME></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<NAME>Form</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Element</STRING></GETPROP>.<STRING>Observer</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Abstract</NAME>.<STRING>TimedObserver</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>getValue</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>getValue</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Form</NAME>.<STRING>Observer</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Abstract</NAME>.<STRING>TimedObserver</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>getValue</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>serialize</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<EXPR_RESULT><SETPROP><NAME>Abstract</NAME>.<STRING>EventObserver</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>callback</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>element</STRING>  = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>callback</STRING> = <NAME>callback</NAME></SETPROP></EXPR_VOID>;

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>lastValue</STRING> = <CALL><THIS>this</THIS>.<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></SETPROP></EXPR_VOID>;
    <BLOCK>if (<IFNE><EQ><CALL><THIS>this</THIS>.<GETPROP><STRING>element</STRING></GETPROP>.<GETPROP><STRING>tagName</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL> == <STRING>'form'</STRING></EQ></IFNE>)
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>registerFormCallbacks</STRING></GETPROP>()</CALL></EXPR_VOID>;
    else
      <EXPR_VOID><CALL><THIS><TARGET/>this</THIS>.<GETPROP><STRING>registerCallback</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>)</CALL></EXPR_VOID><GOTO/>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>onElementEvent</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <VAR>var <NAME>value = <CALL><THIS>this</THIS>.<GETPROP><STRING>getValue</STRING></GETPROP>()</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><NE><GETPROP><THIS>this</THIS>.<STRING>lastValue</STRING></GETPROP> != <NAME>value</NAME></NE></IFNE>) <BLOCK>{
      <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>callback</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>, <NAME>value</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>lastValue</STRING> = <NAME>value</NAME></SETPROP></EXPR_VOID>;
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>registerFormCallbacks</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><CALL><NAME>Form</NAME>.<CALL><GETPROP><STRING>getElements</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>registerCallback</STRING></GETPROP>, <THIS>this</THIS>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>registerCallback</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>type</STRING></GETPROP></IFNE>) <BLOCK>{
      <SWITCH>switch (<CALL><NAME>element</NAME>.<GETPROP><STRING>type</STRING></GETPROP>.<GETPROP><STRING>toLowerCase</STRING></GETPROP>()</CALL>) {
        <CASE>case <STRING>'checkbox'</STRING></CASE>:
        <CASE>case <STRING>'radio'</STRING>:
          <BLOCK><EXPR_VOID><CALL><NAME>Event</NAME>.<GETPROP><STRING>observe</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'click'</STRING>, <CALL><THIS>this</THIS>.<GETPROP><STRING>onElementEvent</STRING></GETPROP>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL>)</CALL></EXPR_VOID>;
          <BREAK>break</BREAK></BLOCK></CASE>;
        <DEFAULT>default:
          <BLOCK><EXPR_VOID><CALL><NAME>Event</NAME>.<GETPROP><STRING>observe</STRING></GETPROP>(<NAME>element</NAME>, <STRING>'change'</STRING>, <CALL><THIS>this</THIS>.<GETPROP><STRING>onElementEvent</STRING></GETPROP>.<GETPROP><STRING>bind</STRING></GETPROP>(<THIS>this</THIS>)</CALL>)</CALL></EXPR_VOID>;
          <BREAK>break</BREAK></BLOCK></DEFAULT>;
      }</SWITCH><TARGET/>
    }</BLOCK></BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<NAME>Form</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Element</STRING></GETPROP>.<STRING>EventObserver</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Abstract</NAME>.<STRING>EventObserver</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>getValue</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>Element</STRING></GETPROP>.<GETPROP><STRING>getValue</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Form</NAME>.<STRING>EventObserver</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>(<GETPROP><NAME>Abstract</NAME>.<STRING>EventObserver</STRING></GETPROP>, <OBJECTLIT>{
  <OBJLITNAME>getValue</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><NAME>Form</NAME>.<GETPROP><STRING>serialize</STRING></GETPROP>(<GETPROP><THIS>this</THIS>.<STRING>element</STRING></GETPROP>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></SETPROP></EXPR_RESULT>;
<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>window</NAME>.<STRING>Event</STRING></GETPROP></NOT></IFNE>) <VAR>var <NAME>Event = <OBJECTLIT>{ }</OBJECTLIT></NAME></VAR>;</BLOCK><TARGET/>

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Event</NAME>, <OBJECTLIT>{
  <OBJLITNAME>KEY_BACKSPACE</OBJLITNAME>: <NUMBER>8</NUMBER>,
  <OBJLITNAME>KEY_TAB</OBJLITNAME>:       <NUMBER>9</NUMBER>,
  <OBJLITNAME>KEY_RETURN</OBJLITNAME>:   <NUMBER>13</NUMBER>,
  <OBJLITNAME>KEY_ESC</OBJLITNAME>:      <NUMBER>27</NUMBER>,
  <OBJLITNAME>KEY_LEFT</OBJLITNAME>:     <NUMBER>37</NUMBER>,
  <OBJLITNAME>KEY_UP</OBJLITNAME>:       <NUMBER>38</NUMBER>,
  <OBJLITNAME>KEY_RIGHT</OBJLITNAME>:    <NUMBER>39</NUMBER>,
  <OBJLITNAME>KEY_DOWN</OBJLITNAME>:     <NUMBER>40</NUMBER>,
  <OBJLITNAME>KEY_DELETE</OBJLITNAME>:   <NUMBER>46</NUMBER>,
  <OBJLITNAME>KEY_HOME</OBJLITNAME>:     <NUMBER>36</NUMBER>,
  <OBJLITNAME>KEY_END</OBJLITNAME>:      <NUMBER>35</NUMBER>,
  <OBJLITNAME>KEY_PAGEUP</OBJLITNAME>:   <NUMBER>33</NUMBER>,
  <OBJLITNAME>KEY_PAGEDOWN</OBJLITNAME>: <NUMBER>34</NUMBER>,
  <OBJLITNAME>KEY_INSERT</OBJLITNAME>:   <NUMBER>45</NUMBER>,

  <OBJLITNAME>cache</OBJLITNAME>: <OBJECTLIT>{ }</OBJECTLIT>,

  <OBJLITNAME>relatedTarget</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>element</NAME></VAR>;
    <SWITCH>switch(<GETPROP><NAME>event</NAME>.<STRING>type</STRING></GETPROP>) {
      <CASE>case <STRING>'mouseover'</STRING>: <BLOCK><EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>event</NAME>.<STRING>fromElement</STRING></GETPROP></SETNAME></EXPR_VOID>; <BREAK>break</BREAK></BLOCK></CASE>;
      <CASE>case <STRING>'mouseout'</STRING>:  <BLOCK><EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>event</NAME>.<STRING>toElement</STRING></GETPROP></SETNAME></EXPR_VOID>;   <BREAK>break</BREAK></BLOCK></CASE>;
      <DEFAULT>default: <BLOCK><RETURN>return <NULL>null</NULL></RETURN></BLOCK></DEFAULT>;
    }</SWITCH><TARGET/>
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Event</NAME>.<STRING>Methods</STRING> = (<CALL><FUNCTION>function() <BLOCK>{
  <VAR>var <NAME>isButton</NAME></VAR>;

  <BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></IFNE>) <BLOCK>{
    <VAR>var <NAME>buttonMap = <OBJECTLIT>{ <OBJLITNAME>0</OBJLITNAME>: <NUMBER>1</NUMBER>, <OBJLITNAME>1</OBJLITNAME>: <NUMBER>4</NUMBER>, <OBJLITNAME>2</OBJLITNAME>: <NUMBER>2</NUMBER> }</OBJECTLIT></NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>isButton</BINDNAME> = <FUNCTION>function(<PARAMETER>event</PARAMETER>, <PARAMETER>code</PARAMETER>) <BLOCK>{
      <RETURN>return <EQ><GETPROP><NAME>event</NAME>.<STRING>button</STRING></GETPROP> == <GETELEM><NAME>buttonMap</NAME>[<NAME>code</NAME>]</GETELEM></EQ></RETURN>;</BLOCK>
    }</FUNCTION></SETNAME></EXPR_VOID>;

  }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP></IFNE>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>isButton</BINDNAME> = <FUNCTION>function(<PARAMETER>event</PARAMETER>, <PARAMETER>code</PARAMETER>) <BLOCK>{
      <SWITCH>switch (<NAME>code</NAME>) {
        <CASE>case <NUMBER>0</NUMBER>: <BLOCK><RETURN>return <AND><EQ><GETPROP><NAME>event</NAME>.<STRING>which</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; !<NOT><GETPROP><NAME>event</NAME>.<STRING>metaKey</STRING></GETPROP></NOT></AND></RETURN></BLOCK></CASE>;
        <CASE>case <NUMBER>1</NUMBER>: <BLOCK><RETURN>return <AND><EQ><GETPROP><NAME>event</NAME>.<STRING>which</STRING></GETPROP> == <NUMBER>1</NUMBER></EQ> &amp;&amp; <GETPROP><NAME>event</NAME>.<STRING>metaKey</STRING></GETPROP></AND></RETURN></BLOCK></CASE>;
        <DEFAULT>default: <BLOCK><RETURN>return <FALSE>false</FALSE></RETURN></BLOCK></DEFAULT>;
      }</SWITCH><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION></SETNAME></EXPR_VOID>;

  }</BLOCK> else <BLOCK><TARGET/>{
    <EXPR_VOID><SETNAME><BINDNAME>isButton</BINDNAME> = <FUNCTION>function(<PARAMETER>event</PARAMETER>, <PARAMETER>code</PARAMETER>) <BLOCK>{
      <RETURN>return <HOOK><GETPROP><NAME>event</NAME>.<STRING>which</STRING></GETPROP> ? (<SHEQ><GETPROP><NAME>event</NAME>.<STRING>which</STRING></GETPROP> === <ADD><NAME>code</NAME> + <NUMBER>1</NUMBER></ADD>)</SHEQ> : (<SHEQ><GETPROP><NAME>event</NAME>.<STRING>button</STRING></GETPROP> === <NAME>code</NAME>)</SHEQ></HOOK></RETURN>;</BLOCK>
    }</FUNCTION></SETNAME></EXPR_VOID>;
  <GOTO/><GOTO/><GOTO/>}</BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>

  <RETURN>return <OBJECTLIT>{
    <OBJLITNAME>isLeftClick</OBJLITNAME>:   <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>isButton</NAME>(<NAME>event</NAME>, <NUMBER>0</NUMBER>)</CALL></RETURN></BLOCK> }</FUNCTION>,
    <OBJLITNAME>isMiddleClick</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>isButton</NAME>(<NAME>event</NAME>, <NUMBER>1</NUMBER>)</CALL></RETURN></BLOCK> }</FUNCTION>,
    <OBJLITNAME>isRightClick</OBJLITNAME>:  <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{ <RETURN>return <CALL><NAME>isButton</NAME>(<NAME>event</NAME>, <NUMBER>2</NUMBER>)</CALL></RETURN></BLOCK> }</FUNCTION>,

    <OBJLITNAME>element</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>node = <GETPROP><NAME>Event</NAME>.<CALL><GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME></CALL>).<STRING>target</STRING></GETPROP></NAME></VAR>;
      <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<HOOK><EQ><GETPROP><NAME>node</NAME>.<STRING>nodeType</STRING></GETPROP> == <GETPROP><NAME>Node</NAME>.<STRING>TEXT_NODE</STRING></GETPROP></EQ> ? <GETPROP><NAME>node</NAME>.<STRING>parentNode</STRING></GETPROP> : <NAME>node</NAME></HOOK>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>findElement</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>, <PARAMETER>expression</PARAMETER>) <BLOCK>{
      <VAR>var <NAME>element = <CALL><NAME>Event</NAME>.<GETPROP><STRING>element</STRING></GETPROP>(<NAME>event</NAME>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>expression</NAME></NOT></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>
      <VAR>var <NAME>elements = [<CALL><ARRAYLIT><NAME>element</NAME></ARRAYLIT>].<GETPROP><STRING>concat</STRING></GETPROP>(<CALL><NAME>element</NAME>.<GETPROP><STRING>ancestors</STRING></GETPROP>()</CALL>)</CALL></NAME></VAR>;
      <RETURN>return <CALL><NAME>Selector</NAME>.<GETPROP><STRING>findElement</STRING></GETPROP>(<NAME>elements</NAME>, <NAME>expression</NAME>, <NUMBER>0</NUMBER>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>pointer</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <RETURN>return <OBJECTLIT>{
        <OBJLITNAME>x</OBJLITNAME>: <OR><GETPROP><NAME>event</NAME>.<STRING>pageX</STRING></GETPROP> || (<ADD><GETPROP><NAME>event</NAME>.<STRING>clientX</STRING></GETPROP> +
          (<OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP> || <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP>)</OR>)</ADD></OR>,
        <OBJLITNAME>y</OBJLITNAME>: <OR><GETPROP><NAME>event</NAME>.<STRING>pageY</STRING></GETPROP> || (<ADD><GETPROP><NAME>event</NAME>.<STRING>clientY</STRING></GETPROP> +
          (<OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP> || <GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP>)</OR>)</ADD></OR>
      }</OBJECTLIT></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>pointerX</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{ <RETURN>return <GETPROP><NAME>Event</NAME>.<CALL><GETPROP><STRING>pointer</STRING></GETPROP>(<NAME>event</NAME></CALL>).<STRING>x</STRING></GETPROP></RETURN></BLOCK> }</FUNCTION>,
    <OBJLITNAME>pointerY</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{ <RETURN>return <GETPROP><NAME>Event</NAME>.<CALL><GETPROP><STRING>pointer</STRING></GETPROP>(<NAME>event</NAME></CALL>).<STRING>y</STRING></GETPROP></RETURN></BLOCK> }</FUNCTION>,

    <OBJLITNAME>stop</OBJLITNAME>: <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <EXPR_VOID><CALL><NAME>Event</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>event</NAME>.<GETPROP><STRING>preventDefault</STRING></GETPROP>()</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>event</NAME>.<GETPROP><STRING>stopPropagation</STRING></GETPROP>()</CALL></EXPR_VOID>;
      <EXPR_VOID><SETPROP><NAME>event</NAME>.<STRING>stopped</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID>;
    </BLOCK><RETURN/>}</FUNCTION>
  }</OBJECTLIT></RETURN>;</BLOCK>
}</FUNCTION>)()</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><SETPROP><NAME>Event</NAME>.<STRING>extend</STRING> = (<CALL><FUNCTION>function() <BLOCK>{
  <VAR>var <NAME>methods = <CALL><NAME>Object</NAME>.<CALL><GETPROP><STRING>keys</STRING></GETPROP>(<GETPROP><NAME>Event</NAME>.<STRING>Methods</STRING></GETPROP></CALL>).<GETPROP><STRING>inject</STRING></GETPROP>(<OBJECTLIT>{ }</OBJECTLIT>, <FUNCTION>function(<PARAMETER>m</PARAMETER>, <PARAMETER>name</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETELEM><NAME>m</NAME>[<NAME>name</NAME>] = <CALL><NAME>Event</NAME>.<GETELEM><GETPROP><STRING>Methods</STRING></GETPROP>[<NAME>name</NAME></GETELEM>].<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL></SETELEM></EXPR_VOID>;
    <RETURN>return <NAME>m</NAME></RETURN>;</BLOCK>
  }</FUNCTION>)</CALL></NAME></VAR>;

  <BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>IE</STRING></GETPROP></IFNE>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>methods</NAME>, <OBJECTLIT>{
      <OBJLITNAME>stopPropagation</OBJLITNAME>: <FUNCTION>function() <BLOCK>{ <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>cancelBubble</STRING> = <TRUE>true</TRUE></SETPROP></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>,
      <OBJLITNAME>preventDefault</OBJLITNAME>:  <FUNCTION>function() <BLOCK>{ <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>returnValue</STRING> = <FALSE>false</FALSE></SETPROP></EXPR_VOID> </BLOCK><RETURN/>}</FUNCTION>,
      <OBJLITNAME>inspect</OBJLITNAME>: <FUNCTION>function() <BLOCK>{ <RETURN>return <STRING>"[object Event]"</STRING></RETURN></BLOCK> }</FUNCTION>
    }</OBJECTLIT>)</CALL></EXPR_VOID>;

    <RETURN>return <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><NOT>!<NAME>event</NAME></NOT></IFNE>) <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>
      <BLOCK>if (<IFNE><GETPROP><NAME>event</NAME>.<STRING>_extendedByPrototype</STRING></GETPROP></IFNE>) <RETURN>return <NAME>event</NAME></RETURN>;</BLOCK><TARGET/>

      <EXPR_VOID><SETPROP><NAME>event</NAME>.<STRING>_extendedByPrototype</STRING> = <GETPROP><NAME>Prototype</NAME>.<STRING>emptyFunction</STRING></GETPROP></SETPROP></EXPR_VOID>;
      <VAR>var <NAME>pointer = <CALL><NAME>Event</NAME>.<GETPROP><STRING>pointer</STRING></GETPROP>(<NAME>event</NAME>)</CALL></NAME></VAR>;
      <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME>, <OBJECTLIT>{
        <OBJLITNAME>target</OBJLITNAME>: <GETPROP><NAME>event</NAME>.<STRING>srcElement</STRING></GETPROP>,
        <OBJLITNAME>relatedTarget</OBJLITNAME>: <CALL><NAME>Event</NAME>.<GETPROP><STRING>relatedTarget</STRING></GETPROP>(<NAME>event</NAME>)</CALL>,
        <OBJLITNAME>pageX</OBJLITNAME>:  <GETPROP><NAME>pointer</NAME>.<STRING>x</STRING></GETPROP>,
        <OBJLITNAME>pageY</OBJLITNAME>:  <GETPROP><NAME>pointer</NAME>.<STRING>y</STRING></GETPROP>
      }</OBJECTLIT>)</CALL></EXPR_VOID>;
      <RETURN>return <CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME>, <NAME>methods</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION></RETURN>;

  }</BLOCK> else <BLOCK><TARGET/>{
    <EXPR_VOID><SETPROP><NAME>Event</NAME>.<STRING>prototype</STRING> = <OR><GETPROP><NAME>Event</NAME>.<STRING>prototype</STRING></GETPROP> || <GET_REF><NAME>document</NAME>.<REF_SPECIAL><CALL><GETPROP><STRING>createEvent</STRING></GETPROP>(<STRING>"HTMLEvents"</STRING></CALL></REF_SPECIAL>).__proto__</GET_REF></OR></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Event</NAME>.<STRING>prototype</STRING></GETPROP>, <NAME>methods</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <GETPROP><NAME>Prototype</NAME>.<STRING>K</STRING></GETPROP></RETURN>;
  <GOTO/>}</BLOCK></BLOCK><TARGET/>
</BLOCK><RETURN/>}</FUNCTION>)()</CALL></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Event</NAME>, (<CALL><FUNCTION>function() <BLOCK>{
  <VAR>var <NAME>cache = <GETPROP><NAME>Event</NAME>.<STRING>cache</STRING></GETPROP></NAME></VAR>;

  <FUNCTION>function <FUNCNAME>getEventID</FUNCNAME>(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>_eventID</STRING></GETPROP></IFNE>) <RETURN>return <GETPROP><NAME>element</NAME>.<STRING>_eventID</STRING></GETPROP></RETURN>;</BLOCK><TARGET/>
    <NAME>arguments</NAME>.<EXPR_VOID><SETPROP><GETPROP><STRING>callee</STRING></GETPROP>.<STRING>id</STRING> = <OR><GETPROP><NAME>arguments</NAME>.<GETPROP><STRING>callee</STRING></GETPROP>.<STRING>id</STRING></GETPROP> || <NUMBER>1</NUMBER></OR></SETPROP></EXPR_VOID>;
    <RETURN>return <SETPROP><NAME>element</NAME>.<STRING>_eventID</STRING> = ++<INC><GETPROP><NAME>arguments</NAME>.<GETPROP><STRING>callee</STRING></GETPROP>.<STRING>id</STRING></GETPROP></INC></SETPROP></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>getDOMEventName</FUNCNAME>(<PARAMETER>eventName</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><AND><NAME>eventName</NAME> &amp;&amp; <CALL><NAME>eventName</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<STRING>':'</STRING>)</CALL></AND></IFNE>) <RETURN>return <STRING>"dataavailable"</STRING></RETURN>;</BLOCK><TARGET/>
    <RETURN>return <NAME>eventName</NAME></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>getCacheForID</FUNCNAME>(<PARAMETER>id</PARAMETER>) <BLOCK>{
    <RETURN>return <SETELEM><NAME>cache</NAME>[<NAME>id</NAME>] = <OR><GETELEM><NAME>cache</NAME>[<NAME>id</NAME>]</GETELEM> || <OBJECTLIT>{ }</OBJECTLIT></OR></SETELEM></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>getWrappersForEventName</FUNCNAME>(<PARAMETER>id</PARAMETER>, <PARAMETER>eventName</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>c = <CALL><NAME>getCacheForID</NAME>(<NAME>id</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <SETELEM><NAME>c</NAME>[<NAME>eventName</NAME>] = <OR><GETELEM><NAME>c</NAME>[<NAME>eventName</NAME>]</GETELEM> || <ARRAYLIT>[]</ARRAYLIT></OR></SETELEM></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>createWrapper</FUNCNAME>(<PARAMETER>element</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>handler</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>id = <CALL><NAME>getEventID</NAME>(<NAME>element</NAME>)</CALL></NAME></VAR>;
    <VAR>var <NAME>c = <CALL><NAME>getWrappersForEventName</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><CALL><NAME>c</NAME>.<CALL><GETPROP><STRING>pluck</STRING></GETPROP>(<STRING>"handler"</STRING></CALL>).<GETPROP><STRING>include</STRING></GETPROP>(<NAME>handler</NAME>)</CALL></IFNE>) <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>wrapper = <FUNCTION>function(<PARAMETER>event</PARAMETER>) <BLOCK>{
      <BLOCK>if (<IFNE><OR>!<NOT><NAME>Event</NAME></NOT> || !<OR><NOT><GETPROP><NAME>Event</NAME>.<STRING>extend</STRING></GETPROP></NOT> ||
        (<AND><GETPROP><NAME>event</NAME>.<STRING>eventName</STRING></GETPROP> &amp;&amp; <NE><GETPROP><NAME>event</NAME>.<STRING>eventName</STRING></GETPROP> != <NAME>eventName</NAME></NE>)</AND></OR></OR></IFNE>)
          <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>

      <EXPR_VOID><CALL><NAME>Event</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME>)</CALL></EXPR_VOID>;
      <EXPR_VOID><CALL><NAME>handler</NAME>.<GETPROP><STRING>call</STRING></GETPROP>(<NAME>element</NAME>, <NAME>event</NAME>)</CALL></EXPR_VOID>
    </BLOCK><RETURN/>}</FUNCTION></NAME></VAR>;

    <EXPR_VOID><SETPROP><NAME>wrapper</NAME>.<STRING>handler</STRING> = <NAME>handler</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><CALL><NAME>c</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<NAME>wrapper</NAME>)</CALL></EXPR_VOID>;
    <RETURN>return <NAME>wrapper</NAME></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>findWrapper</FUNCNAME>(<PARAMETER>id</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>handler</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>c = <CALL><NAME>getWrappersForEventName</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME>)</CALL></NAME></VAR>;
    <RETURN>return <CALL><NAME>c</NAME>.<GETPROP><STRING>find</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>wrapper</PARAMETER>) <BLOCK>{ <RETURN>return <EQ><GETPROP><NAME>wrapper</NAME>.<STRING>handler</STRING></GETPROP> == <NAME>handler</NAME></EQ></RETURN></BLOCK> }</FUNCTION>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>

  <FUNCTION>function <FUNCNAME>destroyWrapper</FUNCNAME>(<PARAMETER>id</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>handler</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>c = <CALL><NAME>getCacheForID</NAME>(<NAME>id</NAME>)</CALL></NAME></VAR>;
    <BLOCK>if (<IFNE><NOT>!<GETELEM><NAME>c</NAME>[<NAME>eventName</NAME>]</GETELEM></NOT></IFNE>) <RETURN>return <FALSE>false</FALSE></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETELEM><NAME>c</NAME>[<NAME>eventName</NAME>] = <CALL><GETELEM><NAME>c</NAME>[<NAME>eventName</NAME></GETELEM>].<GETPROP><STRING>without</STRING></GETPROP>(<CALL><NAME>findWrapper</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME>, <NAME>handler</NAME>)</CALL>)</CALL></SETELEM></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>

  <FUNCTION>function <FUNCNAME>destroyCache</FUNCNAME>() <BLOCK>{
    <LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>id</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><NAME>cache</NAME></ENUM_INIT_KEYS>)
      <BLOCK><LOCAL_BLOCK><LOOP><ENUM_NEXT/><IFEQ/><TARGET/><EMPTY/><TARGET/><EMPTY/><TARGET/><IFEQ/><ENUM_NEXT/>for <VAR>(var <NAME><EXPR_VOID><SETNAME><BINDNAME><ENUM_ID>eventName</ENUM_ID></BINDNAME></SETNAME></EXPR_VOID></NAME></VAR> in <ENUM_INIT_KEYS><GETELEM><NAME>cache</NAME>[<NAME>id</NAME>]</GETELEM></ENUM_INIT_KEYS>)
        <BLOCK><EXPR_VOID><SETELEM><GETELEM><NAME><TARGET/>cache</NAME>[<NAME>id</NAME></GETELEM>][<NAME>eventName</NAME>] = <NULL>null</NULL></SETELEM></EXPR_VOID></BLOCK></LOOP><TARGET/><TARGET/><GOTO/><GOTO/><GOTO/><TARGET/><TARGET/>;</LOCAL_BLOCK></BLOCK></LOOP></LOCAL_BLOCK>
  </BLOCK><RETURN/>}</FUNCTION>

  <BLOCK>if (<IFNE><GETPROP><NAME>window</NAME>.<STRING>attachEvent</STRING></GETPROP></IFNE>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>window</NAME>.<GETPROP><STRING>attachEvent</STRING></GETPROP>(<STRING>"onunload"</STRING>, <NAME>destroyCache</NAME>)</CALL></EXPR_VOID>;
  }</BLOCK></BLOCK><TARGET/>

  <RETURN>return <OBJECTLIT>{
    <OBJLITNAME>observe</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>handler</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <VAR>var <NAME>name = <CALL><NAME>getDOMEventName</NAME>(<NAME>eventName</NAME>)</CALL></NAME></VAR>;

      <VAR>var <NAME>wrapper = <CALL><NAME>createWrapper</NAME>(<NAME>element</NAME>, <NAME>eventName</NAME>, <NAME>handler</NAME>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>wrapper</NAME></NOT></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>

      <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>addEventListener</STRING></GETPROP></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>addEventListener</STRING></GETPROP>(<NAME>name</NAME>, <NAME>wrapper</NAME>, <FALSE>false</FALSE>)</CALL></EXPR_VOID>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>attachEvent</STRING></GETPROP>(<ADD><STRING>"on"</STRING> + <NAME>name</NAME></ADD>, <NAME>wrapper</NAME>)</CALL></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>

      <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>stopObserving</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>handler</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <VAR>var <NAME>id = <CALL><NAME>getEventID</NAME>(<NAME>element</NAME>)</CALL></NAME>, <NAME>name = <CALL><NAME>getDOMEventName</NAME>(<NAME>eventName</NAME>)</CALL></NAME></VAR>;

      <BLOCK>if (<IFNE><AND>!<NOT><NAME>handler</NAME></NOT> &amp;&amp; <NAME>eventName</NAME></AND></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><CALL><NAME>getWrappersForEventName</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>wrapper</PARAMETER>) <BLOCK>{
          <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>stopObserving</STRING></GETPROP>(<NAME>eventName</NAME>, <GETPROP><NAME>wrapper</NAME>.<STRING>handler</STRING></GETPROP>)</CALL></EXPR_VOID>;
        </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
        <RETURN>return <NAME>element</NAME></RETURN>;

      }</BLOCK> else <BLOCK><TARGET/>if (<IFNE><NOT>!<NAME>eventName</NAME></NOT></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>Object</NAME>.<CALL><GETPROP><STRING>keys</STRING></GETPROP>(<CALL><NAME>getCacheForID</NAME>(<NAME>id</NAME>)</CALL></CALL>).<GETPROP><STRING>each</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>eventName</PARAMETER>) <BLOCK>{
          <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>stopObserving</STRING></GETPROP>(<NAME>eventName</NAME>)</CALL></EXPR_VOID>;
        </BLOCK><RETURN/>}</FUNCTION>)</CALL></EXPR_VOID>;
        <RETURN>return <NAME>element</NAME></RETURN>;
      <GOTO/>}</BLOCK></BLOCK></BLOCK><TARGET/><TARGET/><TARGET/>

      <VAR>var <NAME>wrapper = <CALL><NAME>findWrapper</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME>, <NAME>handler</NAME>)</CALL></NAME></VAR>;
      <BLOCK>if (<IFNE><NOT>!<NAME>wrapper</NAME></NOT></IFNE>) <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK><TARGET/>

      <BLOCK>if (<IFNE><GETPROP><NAME>element</NAME>.<STRING>removeEventListener</STRING></GETPROP></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>removeEventListener</STRING></GETPROP>(<NAME>name</NAME>, <NAME>wrapper</NAME>, <FALSE>false</FALSE>)</CALL></EXPR_VOID>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>detachEvent</STRING></GETPROP>(<ADD><STRING>"on"</STRING> + <NAME>name</NAME></ADD>, <NAME>wrapper</NAME>)</CALL></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>

      <EXPR_VOID><CALL><NAME>destroyWrapper</NAME>(<NAME>id</NAME>, <NAME>eventName</NAME>, <NAME>handler</NAME>)</CALL></EXPR_VOID>;

      <RETURN>return <NAME>element</NAME></RETURN>;</BLOCK>
    }</FUNCTION>,

    <OBJLITNAME>fire</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>eventName</PARAMETER>, <PARAMETER>memo</PARAMETER>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETNAME></EXPR_VOID>;
      <BLOCK>if (<IFNE><AND><EQ><NAME>element</NAME> == <NAME>document</NAME></EQ> &amp;&amp; <AND><GETPROP><NAME>document</NAME>.<STRING>createEvent</STRING></GETPROP> &amp;&amp; !<NOT><GETPROP><NAME>element</NAME>.<STRING>dispatchEvent</STRING></GETPROP></NOT></AND></AND></IFNE>)
        <EXPR_VOID><SETNAME><BINDNAME>element</BINDNAME> = <GETPROP><NAME>document</NAME>.<STRING>documentElement</STRING></GETPROP></SETNAME></EXPR_VOID>;</BLOCK><TARGET/>

      <BLOCK>if (<IFNE><GETPROP><NAME>document</NAME>.<STRING>createEvent</STRING></GETPROP></IFNE>) <BLOCK>{
        <VAR>var <NAME>event = <CALL><NAME>document</NAME>.<GETPROP><STRING>createEvent</STRING></GETPROP>(<STRING>"HTMLEvents"</STRING>)</CALL></NAME></VAR>;
        <EXPR_VOID><CALL><NAME>event</NAME>.<GETPROP><STRING>initEvent</STRING></GETPROP>(<STRING>"dataavailable"</STRING>, <TRUE>true</TRUE>, <TRUE>true</TRUE>)</CALL></EXPR_VOID>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <VAR>var <NAME>event = <CALL><NAME>document</NAME>.<GETPROP><STRING>createEventObject</STRING></GETPROP>()</CALL></NAME></VAR>;
        <EXPR_VOID><SETPROP><NAME>event</NAME>.<STRING>eventType</STRING> = <STRING>"ondataavailable"</STRING></SETPROP></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>

      <EXPR_VOID><SETPROP><NAME>event</NAME>.<STRING>eventName</STRING> = <NAME>eventName</NAME></SETPROP></EXPR_VOID>;
      <EXPR_VOID><SETPROP><NAME>event</NAME>.<STRING>memo</STRING> = <OR><NAME>memo</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR></SETPROP></EXPR_VOID>;

      <BLOCK>if (<IFNE><GETPROP><NAME>document</NAME>.<STRING>createEvent</STRING></GETPROP></IFNE>) <BLOCK>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>dispatchEvent</STRING></GETPROP>(<NAME>event</NAME>)</CALL></EXPR_VOID>;
      }</BLOCK> else <BLOCK><TARGET/>{
        <EXPR_VOID><CALL><NAME>element</NAME>.<GETPROP><STRING>fireEvent</STRING></GETPROP>(<GETPROP><NAME>event</NAME>.<STRING>eventType</STRING></GETPROP>, <NAME>event</NAME>)</CALL></EXPR_VOID>;
      <GOTO/>}</BLOCK></BLOCK><TARGET/>

      <RETURN>return <CALL><NAME>Event</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>event</NAME>)</CALL></RETURN>;</BLOCK>
    }</FUNCTION>
  }</OBJECTLIT></RETURN>;</BLOCK>
}</FUNCTION>)()</CALL>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>Event</NAME>, <GETPROP><NAME>Event</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Element</NAME>.<GETPROP><STRING>addMethods</STRING></GETPROP>(<OBJECTLIT>{
  <OBJLITNAME>fire</OBJLITNAME>:          <GETPROP><NAME>Event</NAME>.<STRING>fire</STRING></GETPROP>,
  <OBJLITNAME>observe</OBJLITNAME>:       <GETPROP><NAME>Event</NAME>.<STRING>observe</STRING></GETPROP>,
  <OBJLITNAME>stopObserving</OBJLITNAME>: <GETPROP><NAME>Event</NAME>.<STRING>stopObserving</STRING></GETPROP>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>document</NAME>, <OBJECTLIT>{
  <OBJLITNAME>fire</OBJLITNAME>:          <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>fire</STRING></GETPROP>.<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL>,
  <OBJLITNAME>observe</OBJLITNAME>:       <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>observe</STRING></GETPROP>.<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL>,
  <OBJLITNAME>stopObserving</OBJLITNAME>: <CALL><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<GETPROP><STRING>stopObserving</STRING></GETPROP>.<GETPROP><STRING>methodize</STRING></GETPROP>()</CALL>
}</OBJECTLIT>)</CALL></EXPR_RESULT>;

(<EXPR_RESULT><CALL><FUNCTION>function() <BLOCK>{
  /* Support for the DOMContentLoaded event is based on work by Dan Webb,
     Matthias Miller, Dean Edwards and John Resig. */

  <VAR>var <NAME>timer</NAME>, <NAME>fired = <FALSE>false</FALSE></NAME></VAR>;

  <FUNCTION>function <FUNCNAME>fireContentLoadedEvent</FUNCNAME>() <BLOCK>{
    <BLOCK>if (<IFNE><NAME>fired</NAME></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><NAME>timer</NAME></IFNE>) <EXPR_VOID><CALL><NAME>window</NAME>.<GETPROP><STRING>clearInterval</STRING></GETPROP>(<NAME>timer</NAME>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><NAME>document</NAME>.<GETPROP><STRING>fire</STRING></GETPROP>(<STRING>"dom:loaded"</STRING>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETNAME><BINDNAME>fired</BINDNAME> = <TRUE>true</TRUE></SETNAME></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>

  <BLOCK>if (<IFNE><GETPROP><NAME>document</NAME>.<STRING>addEventListener</STRING></GETPROP></IFNE>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>Browser</STRING></GETPROP>.<STRING>WebKit</STRING></GETPROP></IFNE>) <BLOCK>{
      <EXPR_VOID><SETNAME><BINDNAME>timer</BINDNAME> = <CALL><NAME>window</NAME>.<GETPROP><STRING>setInterval</STRING></GETPROP>(<FUNCTION>function() <BLOCK>{
        <BLOCK>if (<IFNE><CALL><REGEXP>/loaded|complete/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<GETPROP><NAME>document</NAME>.<STRING>readyState</STRING></GETPROP>)</CALL></IFNE>)
          <EXPR_VOID><CALL><NAME>fireContentLoadedEvent</NAME>()</CALL></EXPR_VOID>;</BLOCK><TARGET/>
      </BLOCK><RETURN/>}</FUNCTION>, <NUMBER>0</NUMBER>)</CALL></SETNAME></EXPR_VOID>;

      <EXPR_VOID><CALL><NAME>Event</NAME>.<GETPROP><STRING>observe</STRING></GETPROP>(<NAME>window</NAME>, <STRING>"load"</STRING>, <NAME>fireContentLoadedEvent</NAME>)</CALL></EXPR_VOID>;

    }</BLOCK> else <BLOCK><TARGET/>{
      <EXPR_VOID><CALL><NAME>document</NAME>.<GETPROP><STRING>addEventListener</STRING></GETPROP>(<STRING>"DOMContentLoaded"</STRING>,
        <NAME>fireContentLoadedEvent</NAME>, <FALSE>false</FALSE>)</CALL></EXPR_VOID>;
    <GOTO/>}</BLOCK></BLOCK><TARGET/>

  }</BLOCK> else <BLOCK><TARGET/>{
    <EXPR_VOID><CALL><NAME>document</NAME>.<GETPROP><STRING>write</STRING></GETPROP>(<STRING>"&lt;script id=__onDOMContentLoaded defer src=//:&gt;&lt;\/script&gt;"</STRING>)</CALL></EXPR_VOID>;
    <EXPR_VOID><SETPROP><CALL><NAME>$</NAME>(<STRING>"__onDOMContentLoaded"</STRING></CALL>).<STRING>onreadystatechange</STRING> = <FUNCTION>function() <BLOCK>{
      <BLOCK>if (<IFNE><EQ><GETPROP><THIS>this</THIS>.<STRING>readyState</STRING></GETPROP> == <STRING>"complete"</STRING></EQ></IFNE>) <BLOCK>{
        <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>onreadystatechange</STRING> = <NULL>null</NULL></SETPROP></EXPR_VOID>;
        <EXPR_VOID><CALL><NAME>fireContentLoadedEvent</NAME>()</CALL></EXPR_VOID>;
      }</BLOCK></BLOCK><TARGET/>
    </BLOCK><RETURN/>}</FUNCTION></SETPROP></EXPR_VOID>;
  <GOTO/>}</BLOCK></BLOCK><TARGET/>
</BLOCK><RETURN/>}</FUNCTION>)()</CALL></EXPR_RESULT>;
/*------------------------------- DEPRECATED -------------------------------*/

<EXPR_RESULT><SETPROP><NAME>Hash</NAME>.<STRING>toQueryString</STRING> = <GETPROP><NAME>Object</NAME>.<STRING>toQueryString</STRING></GETPROP></SETPROP></EXPR_RESULT>;

<VAR>var <NAME>Toggle = <OBJECTLIT>{ <OBJLITNAME>display</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<STRING>toggle</STRING></GETPROP> }</OBJECTLIT></NAME></VAR>;

<NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>childOf</STRING> = <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>descendantOf</STRING></GETPROP></SETPROP></EXPR_RESULT>;

<VAR>var <NAME>Insertion = <OBJECTLIT>{
  <OBJLITNAME>Before</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <OBJECTLIT>{<OBJLITNAME>before</OBJLITNAME>:<NAME>content</NAME>}</OBJECTLIT>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>Top</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <OBJECTLIT>{<OBJLITNAME>top</OBJLITNAME>:<NAME>content</NAME>}</OBJECTLIT>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>Bottom</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <OBJECTLIT>{<OBJLITNAME>bottom</OBJLITNAME>:<NAME>content</NAME>}</OBJECTLIT>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>After</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>content</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>insert</STRING></GETPROP>(<NAME>element</NAME>, <OBJECTLIT>{<OBJLITNAME>after</OBJLITNAME>:<NAME>content</NAME>}</OBJECTLIT>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

<VAR>var <NAME>$continue = <NEW>new <NAME>Error</NAME>(<STRING>'"throw $continue" is deprecated, use "return" instead'</STRING>)</NEW></NAME></VAR>;

// This should be moved to script.aculo.us; notice the deprecated methods
// further below, that map to the newer Element methods.
<VAR>var <NAME>Position = <OBJECTLIT>{
  // set to true if needed, warning: firefox performance problems
  // NOT neeeded for page scrolling, only if draggable contained in
  // scrollable elements
  <OBJLITNAME>includeScrollOffsets</OBJLITNAME>: <FALSE>false</FALSE>,

  // must be called before calling withinIncludingScrolloffset, every time the
  // page is scrolled
  <OBJLITNAME>prepare</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>deltaX</STRING> =  <OR><GETPROP><NAME>window</NAME>.<STRING>pageXOffset</STRING></GETPROP>
                || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP>
                || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollLeft</STRING></GETPROP>
                || <NUMBER>0</NUMBER></OR></OR></OR></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>deltaY</STRING> =  <OR><GETPROP><NAME>window</NAME>.<STRING>pageYOffset</STRING></GETPROP>
                || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>documentElement</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP>
                || <OR><GETPROP><NAME>document</NAME>.<GETPROP><STRING>body</STRING></GETPROP>.<STRING>scrollTop</STRING></GETPROP>
                || <NUMBER>0</NUMBER></OR></OR></OR></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  // caches x/y coordinate pair to use with overlap
  <OBJLITNAME>within</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>x</PARAMETER>, <PARAMETER>y</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><GETPROP><THIS>this</THIS>.<STRING>includeScrollOffsets</STRING></GETPROP></IFNE>)
      <RETURN>return <CALL><THIS>this</THIS>.<GETPROP><STRING>withinIncludingScrolloffsets</STRING></GETPROP>(<NAME>element</NAME>, <NAME>x</NAME>, <NAME>y</NAME>)</CALL></RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>xcomp</STRING> = <NAME>x</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>ycomp</STRING> = <NAME>y</NAME></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>offset</STRING> = <CALL><NAME>Element</NAME>.<GETPROP><STRING>cumulativeOffset</STRING></GETPROP>(<NAME>element</NAME>)</CALL></SETPROP></EXPR_VOID>;

    <RETURN>return (<AND><GE><NAME>y</NAME> &gt;= <GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>1</NUMBER>]</GETELEM></GE> &amp;&amp;
            <AND><LT><NAME>y</NAME> &lt;  <ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>1</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetHeight</STRING></GETPROP></ADD></LT> &amp;&amp;
            <AND><GE><NAME>x</NAME> &gt;= <GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM></GE> &amp;&amp;
            <LT><NAME>x</NAME> &lt;  <ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetWidth</STRING></GETPROP></ADD></LT></AND></AND>)</AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>withinIncludingScrolloffsets</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>x</PARAMETER>, <PARAMETER>y</PARAMETER>) <BLOCK>{
    <VAR>var <NAME>offsetcache = <CALL><NAME>Element</NAME>.<GETPROP><STRING>cumulativeScrollOffset</STRING></GETPROP>(<NAME>element</NAME>)</CALL></NAME></VAR>;

    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>xcomp</STRING> = <SUB><ADD><NAME>x</NAME> + <GETELEM><NAME>offsetcache</NAME>[<NUMBER>0</NUMBER>]</GETELEM></ADD> - <GETPROP><THIS>this</THIS>.<STRING>deltaX</STRING></GETPROP></SUB></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>ycomp</STRING> = <SUB><ADD><NAME>y</NAME> + <GETELEM><NAME>offsetcache</NAME>[<NUMBER>1</NUMBER>]</GETELEM></ADD> - <GETPROP><THIS>this</THIS>.<STRING>deltaY</STRING></GETPROP></SUB></SETPROP></EXPR_VOID>;
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>offset</STRING> = <CALL><NAME>Element</NAME>.<GETPROP><STRING>cumulativeOffset</STRING></GETPROP>(<NAME>element</NAME>)</CALL></SETPROP></EXPR_VOID>;

    <RETURN>return (<AND><GE><GETPROP><THIS>this</THIS>.<STRING>ycomp</STRING></GETPROP> &gt;= <GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>1</NUMBER>]</GETELEM></GE> &amp;&amp;
            <AND><LT><GETPROP><THIS>this</THIS>.<STRING>ycomp</STRING></GETPROP> &lt;  <ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>1</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetHeight</STRING></GETPROP></ADD></LT> &amp;&amp;
            <AND><GE><GETPROP><THIS>this</THIS>.<STRING>xcomp</STRING></GETPROP> &gt;= <GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM></GE> &amp;&amp;
            <LT><GETPROP><THIS>this</THIS>.<STRING>xcomp</STRING></GETPROP> &lt;  <ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetWidth</STRING></GETPROP></ADD></LT></AND></AND>)</AND></RETURN>;</BLOCK>
  }</FUNCTION>,

  // within must be called directly before
  <OBJLITNAME>overlap</OBJLITNAME>: <FUNCTION>function(<PARAMETER>mode</PARAMETER>, <PARAMETER>element</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<NAME>mode</NAME></NOT></IFNE>) <RETURN>return <NUMBER>0</NUMBER></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><EQ><NAME>mode</NAME> == <STRING>'vertical'</STRING></EQ></IFNE>)
      <RETURN>return ((<DIV><SUB><ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>1</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetHeight</STRING></GETPROP>)</ADD> - <GETPROP><THIS>this</THIS>.<STRING>ycomp</STRING></GETPROP>)</SUB> /
        <GETPROP><NAME>element</NAME>.<STRING>offsetHeight</STRING></GETPROP></DIV></RETURN>;</BLOCK><TARGET/>
    <BLOCK>if (<IFNE><EQ><NAME>mode</NAME> == <STRING>'horizontal'</STRING></EQ></IFNE>)
      <RETURN>return ((<DIV><SUB><ADD><GETELEM><THIS>this</THIS>.<GETPROP><STRING>offset</STRING></GETPROP>[<NUMBER>0</NUMBER>]</GETELEM> + <GETPROP><NAME>element</NAME>.<STRING>offsetWidth</STRING></GETPROP>)</ADD> - <GETPROP><THIS>this</THIS>.<STRING>xcomp</STRING></GETPROP>)</SUB> /
        <GETPROP><NAME>element</NAME>.<STRING>offsetWidth</STRING></GETPROP></DIV></RETURN>;</BLOCK><TARGET/>
  </BLOCK><RETURN/>}</FUNCTION>,

  // Deprecation layer -- use newer Element methods now (1.5.2).

  <OBJLITNAME>cumulativeOffset</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>cumulativeOffset</STRING></GETPROP>,

  <OBJLITNAME>positionedOffset</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>positionedOffset</STRING></GETPROP>,

  <OBJLITNAME>absolutize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>Position</NAME>.<GETPROP><STRING>prepare</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>absolutize</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>relativize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><NAME>Position</NAME>.<GETPROP><STRING>prepare</STRING></GETPROP>()</CALL></EXPR_VOID>;
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>relativize</STRING></GETPROP>(<NAME>element</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>,

  <OBJLITNAME>realOffset</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>cumulativeScrollOffset</STRING></GETPROP>,

  <OBJLITNAME>offsetParent</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>getOffsetParent</STRING></GETPROP>,

  <OBJLITNAME>page</OBJLITNAME>: <GETPROP><NAME>Element</NAME>.<GETPROP><STRING>Methods</STRING></GETPROP>.<STRING>viewportOffset</STRING></GETPROP>,

  <OBJLITNAME>clone</OBJLITNAME>: <FUNCTION>function(<PARAMETER>source</PARAMETER>, <PARAMETER>target</PARAMETER>, <PARAMETER>options</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>options</BINDNAME> = <OR><NAME>options</NAME> || <OBJECTLIT>{ }</OBJECTLIT></OR></SETNAME></EXPR_VOID>;
    <RETURN>return <CALL><NAME>Element</NAME>.<GETPROP><STRING>clonePosition</STRING></GETPROP>(<NAME>target</NAME>, <NAME>source</NAME>, <NAME>options</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></NAME></VAR>;

/*--------------------------------------------------------------------------*/

<BLOCK>if (<IFNE><NOT>!<GETPROP><NAME>document</NAME>.<STRING>getElementsByClassName</STRING></GETPROP></NOT></IFNE>) <EXPR_RESULT><SETPROP><NAME>document</NAME>.<STRING>getElementsByClassName</STRING> = <CALL><FUNCTION>function(<PARAMETER>instanceMethods</PARAMETER>)<BLOCK>{
  <FUNCTION>function <FUNCNAME>iter</FUNCNAME>(<PARAMETER>name</PARAMETER>) <BLOCK>{
    <RETURN>return <HOOK><CALL><NAME>name</NAME>.<GETPROP><STRING>blank</STRING></GETPROP>()</CALL> ? <NULL>null</NULL> : <ADD><ADD><STRING>"[contains(concat(' ', @class, ' '), ' "</STRING> + <NAME>name</NAME></ADD> + <STRING>" ')]"</STRING></ADD></HOOK></RETURN>;</BLOCK>
  }</FUNCTION>

  <EXPR_VOID><SETPROP><NAME>instanceMethods</NAME>.<STRING>getElementsByClassName</STRING> = <HOOK><GETPROP><NAME>Prototype</NAME>.<GETPROP><STRING>BrowserFeatures</STRING></GETPROP>.<STRING>XPath</STRING></GETPROP> ?
  <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>className</BINDNAME> = <CALL><NAME>className</NAME>.<CALL><GETPROP><STRING>toString</STRING></GETPROP></CALL>().<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>cond = <HOOK><CALL><REGEXP>/\s/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<NAME>className</NAME>)</CALL> ? <CALL><CALL><NAME>$w</NAME>(<NAME>className</NAME></CALL>).<CALL><GETPROP><STRING>map</STRING></GETPROP>(<NAME>iter</NAME></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>''</STRING>)</CALL> : <CALL><NAME>iter</NAME>(<NAME>className</NAME>)</CALL></HOOK></NAME></VAR>;
    <RETURN>return <HOOK><NAME>cond</NAME> ? <CALL><NAME>document</NAME>.<GETPROP><STRING>_getElementsByXPath</STRING></GETPROP>(<ADD><STRING>'.//*'</STRING> + <NAME>cond</NAME></ADD>, <NAME>element</NAME>)</CALL> : <ARRAYLIT>[]</ARRAYLIT></HOOK></RETURN>;</BLOCK>
  }</FUNCTION> : <FUNCTION>function(<PARAMETER>element</PARAMETER>, <PARAMETER>className</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETNAME><BINDNAME>className</BINDNAME> = <CALL><NAME>className</NAME>.<CALL><GETPROP><STRING>toString</STRING></GETPROP></CALL>().<GETPROP><STRING>strip</STRING></GETPROP>()</CALL></SETNAME></EXPR_VOID>;
    <VAR>var <NAME>elements = <ARRAYLIT>[]</ARRAYLIT></NAME>, <NAME>classNames = (<HOOK><CALL><REGEXP>/\s/</REGEXP>.<GETPROP><STRING>test</STRING></GETPROP>(<NAME>className</NAME>)</CALL> ? <CALL><NAME>$w</NAME>(<NAME>className</NAME>)</CALL> : <NULL>null</NULL>)</HOOK></NAME></VAR>;
    <BLOCK>if (<IFNE><AND>!<NOT><NAME>classNames</NAME></NOT> &amp;&amp; !<NOT><NAME>className</NAME></NOT></AND></IFNE>) <RETURN>return <NAME>elements</NAME></RETURN>;</BLOCK><TARGET/>

    <VAR>var <NAME>nodes = <CALL><CALL><NAME>$</NAME>(<NAME>element</NAME></CALL>).<GETPROP><STRING>getElementsByTagName</STRING></GETPROP>(<STRING>'*'</STRING>)</CALL></NAME></VAR>;
    <EXPR_VOID><SETNAME><BINDNAME>className</BINDNAME> = <ADD><ADD><STRING>' '</STRING> + <NAME>className</NAME></ADD> + <STRING>' '</STRING></ADD></SETNAME></EXPR_VOID>;

    <LOOP><EMPTY/>for <VAR>(var <NAME>i = <NUMBER>0</NUMBER></NAME>, <NAME>child</NAME>, <NAME>cn</NAME></VAR>; <IFEQ><SETNAME><BINDNAME><TARGET/>child</BINDNAME> = <GETELEM><NAME>nodes</NAME>[<NAME>i</NAME>]</GETELEM></SETNAME></IFEQ>; <EXPR_VOID><INC><NAME>i</NAME></INC></EXPR_VOID>++) <BLOCK><TARGET/>{
      <BLOCK>if (<IFNE><AND><GETPROP><NAME>child</NAME>.<STRING>className</STRING></GETPROP> &amp;&amp; (<AND><SETNAME><BINDNAME>cn</BINDNAME> = <ADD><ADD><STRING>' '</STRING> + <GETPROP><NAME>child</NAME>.<STRING>className</STRING></GETPROP></ADD> + <STRING>' '</STRING></ADD>)</SETNAME> &amp;&amp; (<OR><CALL><NAME>cn</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>className</NAME>)</CALL> ||
          (<AND><NAME>classNames</NAME> &amp;&amp; <CALL><NAME>classNames</NAME>.<GETPROP><STRING>all</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>name</PARAMETER>) <BLOCK>{
            <RETURN>return !<AND><NOT><CALL><NAME>name</NAME>.<CALL><GETPROP><STRING>toString</STRING></GETPROP></CALL>().<GETPROP><STRING>blank</STRING></GETPROP>()</CALL></NOT> &amp;&amp; <CALL><NAME>cn</NAME>.<GETPROP><STRING>include</STRING></GETPROP>(<ADD><ADD><STRING>' '</STRING> + <NAME>name</NAME></ADD> + <STRING>' '</STRING></ADD>)</CALL></AND></RETURN>;</BLOCK>
          }</FUNCTION>)</CALL>)</AND>)</OR></AND></AND></IFNE>)
        <EXPR_VOID><CALL><NAME>elements</NAME>.<GETPROP><STRING>push</STRING></GETPROP>(<CALL><NAME>Element</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<NAME>child</NAME>)</CALL>)</CALL></EXPR_VOID>;</BLOCK><TARGET/>
    <TARGET/><TARGET/><GOTO/><TARGET/><TARGET/>}</BLOCK></LOOP>
    <RETURN>return <NAME>elements</NAME></RETURN>;</BLOCK>
  }</FUNCTION></HOOK></SETPROP></EXPR_VOID>;

  <RETURN>return <FUNCTION>function(<PARAMETER>className</PARAMETER>, <PARAMETER>parentElement</PARAMETER>) <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$</NAME>(<OR><NAME>parentElement</NAME> || <GETPROP><NAME>document</NAME>.<STRING>body</STRING></GETPROP></OR></CALL>).<GETPROP><STRING>getElementsByClassName</STRING></GETPROP>(<NAME>className</NAME>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION></RETURN>;</BLOCK>
}</FUNCTION>(<GETPROP><NAME>Element</NAME>.<STRING>Methods</STRING></GETPROP>)</CALL></SETPROP></EXPR_RESULT>;</BLOCK><TARGET/>

/*--------------------------------------------------------------------------*/

<EXPR_RESULT><SETPROP><NAME>Element</NAME>.<STRING>ClassNames</STRING> = <CALL><NAME>Class</NAME>.<GETPROP><STRING>create</STRING></GETPROP>()</CALL></SETPROP></EXPR_RESULT>;
<NAME>Element</NAME>.<EXPR_RESULT><SETPROP><GETPROP><STRING>ClassNames</STRING></GETPROP>.<STRING>prototype</STRING> = <OBJECTLIT>{
  <OBJLITNAME>initialize</OBJLITNAME>: <FUNCTION>function(<PARAMETER>element</PARAMETER>) <BLOCK>{
    <EXPR_VOID><SETPROP><THIS>this</THIS>.<STRING>element</STRING> = <CALL><NAME>$</NAME>(<NAME>element</NAME>)</CALL></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>_each</OBJLITNAME>: <FUNCTION>function(<PARAMETER>iterator</PARAMETER>) <BLOCK>{
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>element</STRING></GETPROP>.<GETPROP><STRING>className</STRING></GETPROP>.<CALL><GETPROP><STRING>split</STRING></GETPROP>(<REGEXP>/\s+/</REGEXP></CALL>).<CALL><GETPROP><STRING>select</STRING></GETPROP>(<FUNCTION>function(<PARAMETER>name</PARAMETER>) <BLOCK>{
      <RETURN>return <GT><GETPROP><NAME>name</NAME>.<STRING>length</STRING></GETPROP> &gt; <NUMBER>0</NUMBER></GT></RETURN>;</BLOCK>
    }</FUNCTION></CALL>).<GETPROP><STRING>_each</STRING></GETPROP>(<NAME>iterator</NAME>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>set</OBJLITNAME>: <FUNCTION>function(<PARAMETER>className</PARAMETER>) <BLOCK>{
    <THIS>this</THIS>.<EXPR_VOID><SETPROP><GETPROP><STRING>element</STRING></GETPROP>.<STRING>className</STRING> = <NAME>className</NAME></SETPROP></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>add</OBJLITNAME>: <FUNCTION>function(<PARAMETER>classNameToAdd</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><CALL><THIS>this</THIS>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>classNameToAdd</NAME>)</CALL></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>set</STRING></GETPROP>(<CALL><CALL><NAME>$A</NAME>(<THIS>this</THIS></CALL>).<CALL><GETPROP><STRING>concat</STRING></GETPROP>(<NAME>classNameToAdd</NAME></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>' '</STRING>)</CALL>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>remove</OBJLITNAME>: <FUNCTION>function(<PARAMETER>classNameToRemove</PARAMETER>) <BLOCK>{
    <BLOCK>if (<IFNE><NOT>!<CALL><THIS>this</THIS>.<GETPROP><STRING>include</STRING></GETPROP>(<NAME>classNameToRemove</NAME>)</CALL></NOT></IFNE>) <RETURN>return</RETURN>;</BLOCK><TARGET/>
    <EXPR_VOID><CALL><THIS>this</THIS>.<GETPROP><STRING>set</STRING></GETPROP>(<CALL><CALL><NAME>$A</NAME>(<THIS>this</THIS></CALL>).<CALL><GETPROP><STRING>without</STRING></GETPROP>(<NAME>classNameToRemove</NAME></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>' '</STRING>)</CALL>)</CALL></EXPR_VOID>;
  </BLOCK><RETURN/>}</FUNCTION>,

  <OBJLITNAME>toString</OBJLITNAME>: <FUNCTION>function() <BLOCK>{
    <RETURN>return <CALL><CALL><NAME>$A</NAME>(<THIS>this</THIS></CALL>).<GETPROP><STRING>join</STRING></GETPROP>(<STRING>' '</STRING>)</CALL></RETURN>;</BLOCK>
  }</FUNCTION>
}</OBJECTLIT></SETPROP></EXPR_RESULT>;

<EXPR_RESULT><CALL><NAME>Object</NAME>.<GETPROP><STRING>extend</STRING></GETPROP>(<GETPROP><NAME>Element</NAME>.<GETPROP><STRING>ClassNames</STRING></GETPROP>.<STRING>prototype</STRING></GETPROP>, <NAME>Enumerable</NAME>)</CALL></EXPR_RESULT>;

/*--------------------------------------------------------------------------*/

<EXPR_RESULT><CALL><NAME>Element</NAME>.<GETPROP><STRING>addMethods</STRING></GETPROP>()</CALL></EXPR_RESULT>;</SCRIPT>
