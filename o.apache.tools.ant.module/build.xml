<?xml version="1.0" encoding="UTF-8"?>
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2005 Sun
Microsystems, Inc. All Rights Reserved.
-->

<project name="ant" default="netbeans" basedir=".">

    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="build-init" depends="projectized.build-init">
        <ant dir="external" target="unscramble"/>
        <ant dir="../libs/external" target="unscramble"/>
        <property name="src-bridge.cp" value="${module.classpath}:${src-bridge.cp.extra}"/>
    </target>
    
    <target name="files-init" depends="basic-init">
        <patternset id="module.files">
            <include name="${module.jar}"/>
            <include name="${javahelp.jar}" if="has.javahelp"/>
            <include name="${nb.system.dir}/Modules/${code.name.base.dashes}.xml"/>
            <include name="ant/nblib/bridge.jar"/>
            <include name="ant/lib/**"/>
            <include name="ant/bin/**"/>
            <include name="ant/etc/**"/>
            <include name="ant/patches/**"/>
        </patternset>
    </target>

    <target name="compile-bridge" depends="init,compile">
        <mkdir dir="build/bridge-classes"/>
        <javac srcdir="src-bridge" destdir="build/bridge-classes" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}" source="1.4" includeantruntime="false">
            <classpath>
                <path path="${src-bridge.cp}"/>
            </classpath>
        </javac>
        <copy todir="build/bridge-classes">
            <fileset dir="src-bridge" excludesfile="${nb_all}/nbbuild/standard-jar-excludes.txt"/>
        </copy>
    </target>

    <target name="jar-bridge" depends="compile-bridge">
        <mkdir dir="${netbeans.dest.dir}/${cluster.dir}/ant/nblib"/>
        <jar jarfile="${netbeans.dest.dir}/${cluster.dir}/ant/nblib/bridge.jar" compress="false">
            <fileset dir="build/bridge-classes"/>
        </jar>
    </target>

    <target name="release" depends="init">
        <mkdir dir="${netbeans.dest.dir}/${cluster.dir}/ant/lib"/>
        <copy todir="${netbeans.dest.dir}/${cluster.dir}/ant/lib">
            <fileset dir="external/lib"/>
        </copy>
        <unzip dest="${netbeans.dest.dir}/${cluster.dir}/ant">
            <fileset dir="external">
                <include name="ant-misc-*.zip"/>
            </fileset>
        </unzip>
        <chmod perm="ugo+x">
            <fileset dir="${netbeans.dest.dir}/${cluster.dir}/ant/bin">
                <exclude name="*.cmd"/>
                <exclude name="*.bat"/>
            </fileset>
        </chmod>
        <!-- #47708: temporarily patch Ant to accept console input from forked Java processes: -->
        <mkdir dir="${netbeans.dest.dir}/${cluster.dir}/ant/patches"/>
        <copy file="external/24918.jar" tofile="${netbeans.dest.dir}/${cluster.dir}/ant/patches/ant162-24918.jar"/>
        <!-- #52045: patch Ant to stop forked processes when build is stopped: -->
        <copy file="external/31928.jar" tofile="${netbeans.dest.dir}/${cluster.dir}/ant/patches/ant162-31928.jar"/>
    </target>

    <target name="netbeans-extra" depends="jar-bridge,release"/>

    <target name="nbm" depends="init,netbeans" description="Build NBM archive.">
        <mkdir dir="build"/>
        <makenbm file="build/${nbm}"
                 productdir="${netbeans.dest.dir}/${cluster.dir}"
                 module="${module.jar}"
                 homepage="${nbm.homepage}"
                 distribution="http://${dist.base}/${nbm}"
                 needsrestart="${nbm.needs.restart}">
            <license name="ant-license.txt">
                <text>For the Ant module itself:</text>
                <file location="${license.file}"/>
                <text>For the Ant runtime:</text>
                <file location="${nb_all}/nbbuild/external/apache-license-2.0.txt"/>
            </license>
            <signature keystore="${keystore}" storepass="${storepass}" alias="${nbm_alias}"/>
        </makenbm>
    </target>

    <!-- For use when making new releases: -->
    <target name="release-helper" depends="clean" description="Help do some things useful when bundling a new Ant release.">
        <ant dir="external" target="clean"/>
        <condition property="all.defined">
            <and>
            <isset property="release.version"/>
            <isset property="release.path"/>
            <isset property="release.cvs.tag"/>
        </and>
        </condition>
        <fail unless="all.defined">
            You need to set the following properties first:
            release.version: version of Ant being bundled, e.g. "1.6"
            release.path: full path to the Ant binary distribution, e.g. "/tmp/apache-ant-1.6.0"
            release.cvs.tag: CVS tag in Ant of the release, e.g. "ANT_160"
        </fail>
        <property name="release.sources" location="build/release-work/ant-sources"/>
        <property name="release.sourcepath" location="${release.sources}/ant/src/main"/>
        <mkdir dir="${release.sourcepath}"/>
        <echo>1.  Checking out Ant sources into ${release.sources}...</echo>
        <!-- Currently checks out only src/main subdir for speed. -->
        <cvs package="ant/src/main" cvsroot=":pserver:anoncvs@cvs.apache.org:/home/cvspublic" dest="${release.sources}" failonerror="true" tag="${release.cvs.tag}"/>
        <property name="ant-api.zip" location="external/ant-api-${release.version}.zip.master"/>
        <echo>2.  Will store Javadoc to ${ant-api.zip}...</echo>
        <delete file="${ant-api.zip}"/>
        <zip zipfile="${ant-api.zip}">
            <fileset dir="${release.path}/docs/manual/api"/>
        </zip>
        <property name="orig.manual" location="${release.path}/docs/manual"/>
        <echo>3.  Creating the Ant manual from ${orig.manual}...</echo>
        <property name="online.manual" location="build/release-work/online-manual"/>
        <delete dir="${online.manual}"/>
        <mkdir dir="${online.manual}"/>
        <copy todir="${online.manual}">
            <fileset dir="${orig.manual}" excludesfile="../nbbuild/standard-jar-excludes.txt">
                <!-- These are obviated by JavaHelp: -->
                <exclude name="*list.html"/>
                <exclude name="index.html"/>
                <exclude name="toc.html"/>
                <!-- Presumably you do not care about other IDE integrations at this point: -->
                <exclude name="ide.html"/>
                <exclude name="Integration/"/>
                <!-- Does not apply inside NetBeans: -->
                <exclude name="running.html"/>
                <!-- Included as a separate Javadoc mount: -->
                <exclude name="api/"/>
                <!-- Currently done specially: -->
                <exclude name="stylesheets/antmanual.css"/>
                <!-- More or less useless: -->
                <exclude name="cover.html"/>
            </fileset>
        </copy>
        <mkdir dir="${online.manual}/stylesheets"/>
        <tstamp/>
        <echo file="${online.manual}/stylesheets/antmanual.css">
/* This document was modified on ${TODAY} by ant.netbeans.org to meet accessibility guidelines. */
@import "../../../../../../../netbeans/modules/usersguide/ide.css";
        </echo>
        <replaceregexp flags="s" match='(&lt;body&gt;).*(&lt;h2&gt;&lt;a name="librarydependencies"&gt;)' replace="\1&#10;&lt;!-- Modified on ${TODAY} by ant.netbeans.org to exclude irrelevant sections --&gt;&#10;\2" file="${online.manual}/install.html"/>
        <property name="ant-docs.zip" location="external/ant-docs-${release.version}.zip.master"/>
        <zip zipfile="${ant-docs.zip}" compress="true">
            <fileset dir="${online.manual}"/>
        </zip>
        <property name="here" location="."/>
        <property name="ant-libs.zip" location="external/ant-libs-${release.version}.zip.master"/>
        <echo>4.  Creating ${ant-libs.zip}...</echo>
        <zip zipfile="${ant-libs.zip}" compress="true">
            <fileset dir="${release.path}/lib">
                <include name="ant*.jar"/>
            </fileset>
        </zip>
        <property name="ant-misc.zip" location="external/ant-misc-${release.version}.zip.master"/>
        <echo>5.  Creating ${ant-misc.zip}...</echo>
        <zip zipfile="${ant-misc.zip}" compress="true">
            <fileset dir="${release.path}">
                <include name="bin/"/>
                <include name="etc/"/>
            </fileset>
        </zip>
        <echo>Now some (currently) manual steps for you:
6.  Ensure these files in ${here} match the actual contents of ${online.manual}:
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/javahelp/org/apache/tools/ant/module/docs/Map.jhm
7.  Mention that the Ant version is ${release.version} in these files in ${here}:
    - docs/javahelp/org/apache/tools/ant/module/docs/HelpSet.hs
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/src/org/apache/tools/ant/module/docs/Bundle.properties
    - ../usersguide/javahelp/org/netbeans/modules/usersguide/ant/*.html
    - external/build.xml
    - external/.cvsignore
    and cvs rm -f the old .scrambled files and ant scramble to make new ones and cvs add -kb them
8.  Run: ant -f ${here}/docs/build.xml check-javahelp
9.  Increase spec versions in manifest.mf and docs/manifest.mf.
10. Test everything, including at least:
    ant -f ${here}/build.xml clean netbeans
    ant -f ${here}/test/build.xml cleanresults runtests
    ant -f ${here}/../java/project/test/build.xml cleanresults runtests
11. Submit a patch for cvs://cvs.apache.org/ant/xdocs/external.xml
    mentioning that the bundled version in NB is now ${release.version}.

After that you should be done!
        </echo>
    </target>

</project>
