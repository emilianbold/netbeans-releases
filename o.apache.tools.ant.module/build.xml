<?xml version="1.0" encoding="UTF-8"?>
<!--
The contents of this file are subject to the terms of the Common Development
and Distribution License (the License). You may not use this file except in
compliance with the License.

You can obtain a copy of the License at http://www.netbeans.org/cddl.html
or http://www.netbeans.org/cddl.txt.

When distributing Covered Code, include this CDDL Header Notice in each file
and include the License file at http://www.netbeans.org/cddl.txt.
If applicable, add the following below the CDDL Header, with the fields
enclosed by brackets [] replaced by your own identifying information:
"Portions Copyrighted [year] [name of copyright owner]"

The Original Software is NetBeans. The Initial Developer of the Original
Software is Sun Microsystems, Inc. Portions Copyright 1997-2006 Sun
Microsystems, Inc. All Rights Reserved.
-->
<project name="ant" default="netbeans" basedir=".">

    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="build-init" depends="projectized.build-init">
        <ant dir="external" target="unzip"/>
        <property name="src-bridge.cp" value="${module.classpath}:${src-bridge.cp.extra}"/>
    </target>

    <target name="compile-bridge" depends="init,compile">
        <mkdir dir="build/bridge-classes"/>
        <depend srcdir="src-bridge" destdir="build/bridge-classes" cache="build/depcache-bridge">
            <classpath>
                <path path="${src-bridge.cp}"/>
            </classpath>
        </depend>
        <javac srcdir="src-bridge" destdir="build/bridge-classes" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}" source="1.5" includeantruntime="false">
            <classpath>
                <path path="${src-bridge.cp}"/>
            </classpath>
            <compilerarg line="${javac.compilerargs}"/>
        </javac>
        <copy todir="build/bridge-classes">
            <fileset dir="src-bridge" excludes="${jar-excludes}"/>
        </copy>
    </target>

    <target name="jar-bridge" depends="compile-bridge">
        <mkdir dir="${cluster}/ant/nblib"/>
        <jar jarfile="${cluster}/ant/nblib/bridge.jar" compress="false">
            <fileset dir="build/bridge-classes"/>
        </jar>
    </target>

    <target name="release" depends="init">
        <mkdir dir="${cluster}/ant/lib"/>
        <copy todir="${cluster}/ant/lib">
            <fileset dir="external/lib"/>
        </copy>
        <unzip dest="${cluster}/ant">
            <fileset dir="external">
                <include name="ant-misc-*.zip"/>
            </fileset>
        </unzip>
        <chmod perm="ugo+x">
            <fileset dir="${cluster}/ant/bin">
                <exclude name="*.cmd"/>
                <exclude name="*.bat"/>
            </fileset>
        </chmod>
    </target>

    <target name="netbeans-extra" depends="jar-bridge,release"/>

    <target name="nbm" depends="init,netbeans,-nbm-prompt-for-storepass" description="Build NBM archive.">
        <mkdir dir="build"/>
        <property name="nbm.target.cluster" value=""/> <!-- fallback -->
        <makenbm file="build/${nbm}"
                 productdir="${cluster}"
                 module="${module.jar}"
                 homepage="${nbm.homepage}"
                 distribution="http://${dist.base}/${nbm}"
                 needsrestart="${nbm.needs.restart}"
                 releasedate="${nbm.release.date}"
                 moduleauthor="${nbm.module.author}"
                 targetcluster="${nbm.target.cluster}"
                 global="${nbm.is.global}">
            <license>
                <text>For the Ant module itself:</text>
                <file location="${license.file}"/>
                <text>For the Ant runtime:</text>
                <file location="${nb_all}/ant/external/ant-1.6.5-license.txt"/>
            </license>
            <signature keystore="${keystore}" storepass="${storepass}" alias="${nbm_alias}"/>
        </makenbm>
    </target>

    <target name="jnlp" depends="netbeans">
        <mkdir dir="${jnlp.dest.dir}"/>
        <copy todir="${jnlp.dest.dir}" flatten="true">
            <fileset dir="${cluster}">
                <include name="${module.jar}"/>
                <include name="ant/patches/*.jar"/>
            </fileset>
        </copy>
        <copy todir="${jnlp.dest.dir}">
            <fileset dir="${cluster}">
                <include name="ant/lib/*.jar"/>
            </fileset>
            <mapper type="glob" from="ant${file.separator}lib${file.separator}*.jar" to="apache-*-1.6.5.jar"/>
        </copy>
        <copy file="${cluster}/ant/nblib/bridge.jar" tofile="${jnlp.dest.dir}/org-apache-tools-ant-module-bridge.jar"/>
        <signjar alias="${jnlp.signjar.alias}" storepass="${jnlp.signjar.password}" keystore="${jnlp.signjar.keystore}">
            <fileset dir="${jnlp.dest.dir}">
                <include name="org-apache-tools-ant-module.jar"/>
                <include name="org-apache-tools-ant-module-bridge.jar"/>
                <include name="apache-ant*.jar"/>
            </fileset>
        </signjar>
        <pathconvert property="ant-jar-resources" pathsep="'/&gt;&#10;    &lt;jar href='">
            <path>
                <fileset dir="${jnlp.dest.dir}">
                    <include name="apache-ant*.jar"/>
                </fileset>
            </path>
            <mapper type="glob" from="${jnlp.dest.dir}${file.separator}*" to="*"/>
        </pathconvert>
        <echo file="${jnlp.dest.dir}/org-apache-tools-ant-module.jnlp"><![CDATA[<?xml version='1.0' encoding='UTF-8'?>
<jnlp spec='1.0+' codebase='${jnlp.codebase}'>
  <information>
   <title>Apache Ant Integration</title>
   <vendor>NetBeans</vendor>
   <description kind='one-line'>Bundles Apache Ant.</description>
   <description kind='short'>This module bundles the Apache Ant build tool.</description>
  </information>
  <security><all-permissions/></security>
  <resources>
    <jar href='org-apache-tools-ant-module.jar'/>
    <jar href='org-apache-tools-ant-module-bridge.jar'/>
    <jar href='${ant-jar-resources}'/>
  </resources>
  <component-desc/>
</jnlp>
            ]]>
        </echo>
    </target>

    <!-- For use when making new releases: -->
    <target name="release-helper" depends="clean" description="Help do some things useful when bundling a new Ant release.">
        <ant dir="external" target="clean"/>
        <condition property="all.defined">
            <and>
            <isset property="release.version"/>
            <isset property="release.path"/>
        </and>
        </condition>
        <fail unless="all.defined">
            You need to set the following properties first:
            release.version: version of Ant being bundled, e.g. "1.6"
            release.path: full path to the Ant binary distribution, e.g. "/tmp/apache-ant-1.6.0"
        </fail>
        <property name="ant-api.zip" location="external/ant-api-${release.version}.zip.master"/>
        <echo>1.  Will store Javadoc to ${ant-api.zip}...</echo>
        <delete file="${ant-api.zip}"/>
        <zip zipfile="${ant-api.zip}">
            <fileset dir="${release.path}/docs/manual/api"/>
        </zip>
        <property name="orig.manual" location="${release.path}/docs/manual"/>
        <echo>2.  Creating the Ant manual from ${orig.manual}...</echo>
        <property name="online.manual" location="build/release-work/online-manual"/>
        <delete dir="${online.manual}"/>
        <mkdir dir="${online.manual}"/>
        <copy todir="${online.manual}">
            <fileset dir="${orig.manual}">
                <!-- These are obviated by JavaHelp: -->
                <exclude name="*list.html"/>
                <exclude name="index.html"/>
                <exclude name="toc.html"/>
                <!-- Presumably you do not care about other IDE integrations at this point: -->
                <exclude name="ide.html"/>
                <exclude name="Integration/"/>
                <!-- Does not apply inside NetBeans: -->
                <exclude name="running.html"/>
                <!-- Included as a separate Javadoc mount: -->
                <exclude name="api/"/>
                <!-- Currently done specially: -->
                <exclude name="stylesheets/antmanual.css"/>
                <!-- More or less useless: -->
                <exclude name="cover.html"/>
            </fileset>
        </copy>
        <mkdir dir="${online.manual}/stylesheets"/>
        <tstamp/>
        <echo file="${online.manual}/stylesheets/antmanual.css">
/* This document was modified on ${TODAY} by ant.netbeans.org to meet accessibility guidelines. */
@import "../../../../../../../netbeans/modules/usersguide/ide.css";
        </echo>
        <replaceregexp flags="s" match='(&lt;body&gt;).*(&lt;h2&gt;&lt;a name="librarydependencies"&gt;)' replace="\1&#10;&lt;!-- Modified on ${TODAY} by ant.netbeans.org to exclude irrelevant sections --&gt;&#10;\2" file="${online.manual}/install.html"/>
        <property name="ant-docs.zip" location="external/ant-docs-${release.version}.zip.master"/>
        <zip zipfile="${ant-docs.zip}" compress="true">
            <fileset dir="${online.manual}"/>
        </zip>
        <property name="here" location="."/>
        <property name="ant-libs.zip" location="external/ant-libs-${release.version}.zip.master"/>
        <echo>3.  Creating ${ant-libs.zip}...</echo>
        <zip zipfile="${ant-libs.zip}" compress="true">
            <fileset dir="${release.path}/lib">
                <include name="ant*.jar"/>
            </fileset>
        </zip>
        <property name="ant-misc.zip" location="external/ant-misc-${release.version}.zip.master"/>
        <echo>4.  Creating ${ant-misc.zip}...</echo>
        <zip zipfile="${ant-misc.zip}" compress="true">
            <fileset dir="${release.path}">
                <include name="bin/"/>
                <include name="etc/"/>
            </fileset>
        </zip>
        <echo>Now some (currently) manual steps for you:
5.  Ensure these files in ${here} match the actual contents of ${online.manual}:
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/javahelp/org/apache/tools/ant/module/docs/Map.jhm
6.  Mention that the Ant version is ${release.version} in these files in ${here}:
    - docs/javahelp/org/apache/tools/ant/module/docs/HelpSet.hs
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/src/org/apache/tools/ant/module/docs/Bundle.properties
    - ../usersguide/javahelp/org/netbeans/modules/usersguide/ant/*.html
    - external/build.xml
    - external/.cvsignore
    and cvs rm -f the old .zip files and cvs add -kb the new ones
7.  Run: ant -f ${here}/docs/build.xml check-javahelp
    You can ignore links to api/org/apache/... which will be broken, as well as a few other things.
    But for real problems in the HTML, commit fixes to docs/manual/ in the ant.apache.org CVS trunk.
8.  Increase spec versions in manifest.mf and docs/manifest.mf.
9.  Test everything, including at least:
    ant -f ${here}/build.xml clean netbeans
    ant -f ${here}/docs/build.xml clean netbeans
    ant -f ${here}/test/build.xml cleanresults runtests
    ant -f ${here}/../java/project/test/build.xml cleanresults runtests
    ant -f ${here}/../nbbuild/build.xml commit-verification
10. Submit a patch for https://svn.apache.org/repos/asf/ant/core/trunk/xdocs/external.xml
    mentioning that the bundled version in NB is now ${release.version}.

After that you should be done!
        </echo>
    </target>

</project>
