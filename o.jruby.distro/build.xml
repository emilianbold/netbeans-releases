<?xml version="1.0" encoding="UTF-8"?>
<!-- You may freely edit this file. See harness/README in the NetBeans platform -->
<!-- for some information on what you could do (e.g. targets to override). -->
<!-- If you delete this file and reopen the project it will be recreated. -->
<project name="o.jruby.distro" default="netbeans" basedir=".">
    <description>Builds, tests, and runs the project o.jruby.distro</description>
    <import file="../nbbuild/templates/projectized.xml"/>
    <!--
    <propertyfile file="../jruby/nbproject/project.properties"/>
    -->

    <target name="jruby.distro.init">
        <uptodate property="jruby.distro.build.uptodate" targetfile="${cluster}/jruby-${jruby_src_version}">
            <srcfiles dir="${src.dir}" includes="**/*"/>
            <srcfiles dir="external" includes="**/*"/>
            <srcfiles dir="../o.jruby/external">
                <include name="jruby-src-${jruby_src_version}.zip"/>
            </srcfiles>
            <srcfiles dir="unpatched_files" includes="**/*"/>
        </uptodate>
    </target>

    <target name="files-init" depends="projectized-common.files-init">
        <!-- Override module.files definition performed by parent, used for NBMs etc. -->
        <patternset id="module.files" includes="${release.files},${extra.module.files}">
            <!-- Standard includes (from common definition) -->
            <include name="${module.jar}"/>
            <include name="${javahelp.jar}" if="has.javahelp"/>
            <include name="config/Modules/${code.name.base.dashes}.xml"/>
            <include name="config/ModuleAutoDeps/${code.name.base.dashes}.xml" if="has.module.auto.deps"/>
            <include name="ant/nblib/${code.name.base.dashes}.jar"/>
            <!-- JRuby+Rails stuff -->
            <include name="jruby-${jruby_src_version}/**"/>
            <!-- preindexing not supported in Parsing API, so just delete the files
            <exclude name="jruby-${jruby_src_version}/**/netbeans-index-*.zip"/>
            -->
        </patternset>
    </target>    

    <target name="build-jruby-bin">
        <echo>Build JRuby binary distribution from source</echo>
        <delete dir="${unpatched_source}"/>
        <mkdir dir="${unpatched_source}"/>
        <unzip dest="${unpatched_source}">
			<fileset dir="../o.jruby/external/">
				<include name="jruby-src-${jruby_src_version}.zip"/>
			</fileset>
		</unzip>
        <!-- JRuby now seems to ship with ri and rdocs pre-expanded in the lib directory! Nuke these -->
        <delete dir="${unpatched_source}/jruby-${jruby_src_version}/share/ri"/>
        <delete dir="${unpatched_source}/jruby-${jruby_src_version}/lib/ruby/gems/1.8/doc/rake-0.8.7/rdoc"/>
        <delete dir="${unpatched_source}/jruby-${jruby_src_version}/lib/ruby/gems/1.8/doc/rake-0.8.7/ri"/>
        <!-- Patch build.xml to modify gem behavior: install locally -->
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" overwrite="true">
            <fileset dir="unpatched_files" />
        </copy>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/rake-0.8.7.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/ruby-debug-base-0.10.3.1-java.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/ruby-debug-ide-0.4.6.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/activerecord-jdbcpostgresql-adapter-0.9.1.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/jdbc-postgres-8.2.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/activerecord-jdbcmysql-adapter-0.9.1.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/jdbc-mysql-5.0.4.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/activerecord-jdbc-adapter-0.9.1.gem"/>
        <copy todir="${unpatched_source}/jruby-${jruby_src_version}" file="external/rspec-1.2.7.gem"/>
        <unzip dest="${unpatched_source}/jruby-${jruby_src_version}" src="external/rails-gems-2.3.2.zip"/>
        <unzip dest="${unpatched_source}/jruby-${jruby_src_version}" src="external/rcov-0.8.1.5.0-java.zip"/>
        <!-- Run dist-bin target in JRuby's own build.xml file -->
        <ant dir="${unpatched_source}/jruby-${jruby_src_version}" target="dist-bin" inheritall="false" inheritrefs="false"/>
        <!-- Extract the resulting .tar.gz file into our cluster -->
        <untar compression="gzip" dest="${cluster}" src="${unpatched_source}/jruby-${jruby_src_version}/jruby-bin-${jruby_src_version}.tar.gz" />
    </target>

    <target name="release" depends="init,jruby.distro.init" unless="jruby.distro.build.uptodate">
        <property name="jruby_dir" location="${cluster}/jruby-${jruby_src_version}"/>
    
        <!-- Build JRuby from source (using its own build files -->
        <antcall target="build-jruby-bin"/>

        <chmod perm="ugo+x">
          <fileset dir="${jruby_dir}/">
            <include name="bin/*"/>
          </fileset>
        </chmod>
    </target>

    <target name="clean" depends="projectized-common.clean">
        <!-- HACK: For some reason the clean target doesn't get expansions for the logical dirs... -->
        <delete dir="unpatched_source"/>
    </target>

</project>
