<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="netbeans" name="ide.ergonomics">
    <description>Builds, tests, and runs the project org.netbeans.modules.ide.ergonomics</description>
    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="-release.dir" depends="-disable-kits,projectized-common.-release.dir"/>
    <target name="jar-prep" depends="-generate-proxies,projectized-common.jar-prep"/>
    <target name="clean" depends="-clean-release,projectized-common.clean"/>

    <!--
    -
    - Internal implementation
    -
    -->
    <target name="-compile-ant" depends="projectized-common.basic-init">
        <mkdir dir="${src-ant.build}"/>
        <depend srcdir="src-ant" destdir="${src-ant.build}" cache="build/depcache-ant">
            <classpath>
                <path path="${src-ant.cp}"/>
            </classpath>
        </depend>
        <javac srcdir="src-ant" destdir="${src-ant.build}"
            deprecation="${build.compiler.deprecation}"
            debug="true"
            source="1.5" target="1.5" includeantruntime="false">
            <classpath>
                <path path="${src-ant.cp}"/>
            </classpath>
            <compilerarg line="${javac.compilerargs}"/>
        </javac>
        <copy todir="${src-ant.build}">
            <fileset dir="src-ant" excludes="${jar-excludes}"/>
        </copy>
    </target>

    <target name="-init-clusters">
        <taskdef name="resolvelist"
             classname="org.netbeans.nbbuild.ResolveList"
             classpath="${nb_all}/nbbuild/nbantext.jar"/>
        <resolvelist
            name="ergonomic.clusters.includes"
            list="${nb.clusters.list}"
        >
            <mapper type="glob" from="*" to="*.dir"/>
        </resolvelist>
        <dirset 
            id="ergonomic.clusters"
            dir="${netbeans.dest.dir}"
            includes="${ergonomic.clusters.includes}"
        >
            <exclude name="harness*"/>
            <exclude name="ide1*"/>
            <exclude name="platform*"/>
            <exclude name="ergonomics*"/>
            <exclude name="extra*"/>
            <exclude name="nb*.*"/>
        </dirset>
    </target>

    <target name="-clean-release">
        <property name="build.release.dir" location="build/release"/>
        <delete dir="${build.release.dir}"/>
    </target>
    <target name="-init-static-analysis">
        <property name="build.release.dir" location="build/release"/>
        <condition property="skip.static.analysis">
            <and>
                <equals arg1="${static.analysis}" arg2="false"/>
                <available file="${build.release.dir}"/>
            </and>
        </condition>
    </target>


    <target 
        name="-disable-kits"
        depends="-init-clusters,-init-static-analysis"
        unless="skip.static.analysis"
    >
        <mkdir dir="${build.release.dir}/config/Modules"/>
        <subant genericantfile="build.xml" target="-disable-one-cluster">
            <property name="xmldir" value="${build.release.dir}/config/Modules"/>
            <property name="ergonomicsdir" location="${basedir}"/>
            <property name="src-ant.cp" value="${src-ant.cp}"/>
            <dirset refid="ergonomic.clusters"/>
        </subant>
        <pathconvert property="extra.module.files" pathsep=",">
            <path>
                <fileset id="-disable-kits" dir="${build.release.dir}">
                    <include name="**/*"/>
                </fileset>
            </path>
            <chainedmapper>
                <flattenmapper/>
                <globmapper from="*" to="config/Modules/*"/>
            </chainedmapper>
        </pathconvert>
        <copy todir="${cluster}">
            <fileset dir="${build.release.dir}">
                <include name="${extra.module.files}"/>
            </fileset>
        </copy>
    </target>

    <target 
        name="-generate-proxies"
        depends="-init-clusters,-init-static-analysis,-compile-ant"
        unless="skip.static.analysis"
    >
        <subant genericantfile="build.xml" target="-proxy-one-cluster">
            <property name="ergonomicsdir" location="${basedir}"/>
            <property name="src-ant.cp" value="${src-ant.cp}"/>
            <dirset refid="ergonomic.clusters"/>
        </subant>
    </target>

    <target name="-init-one-cluster-propeties">
        <pathconvert property="cluster.name">
            <path location="."/>
            <mapper type="regexp" from=".*[/\\]([a-z]*)[0-9\.]*" to="\1"/>
        </pathconvert>

        <property name="proxytmp" value="${ergonomicsdir}/build/proxies/${cluster.name}"/>
        <property name="proxydir" value="${ergonomicsdir}/build/classes/org/netbeans/modules/ide/ergonomics/${cluster.name}"/>
    </target>
    <target 
        name="-proxy-one-cluster"
        depends="-init-clusters,-init-one-cluster-propeties"
    >
        <taskdef name="layerindex"
             classname="org.netbeans.nbbuild.LayerIndex"
             classpath="${nb_all}/nbbuild/nbantext.jar"/>
        <layerindex resourceid="layers">
            <modules dir=".">
                <include name="modules/*.jar"/>
            </modules>
        </layerindex>
        <taskdef name="extractlayer"
             classname="org.netbeans.modules.ide.ergonomics.ant.ExtractLayer"
             classpath="${ergonomicsdir}/build/antclasses/:${src-ant.cp}"/>
        <taskdef name="l10nreplace"
             classname="org.netbeans.modules.ide.ergonomics.ant.L10NReplace"
             classpath="${ergonomicsdir}/build/antclasses/:${src-ant.cp}"/>

        <mkdir dir="${proxytmp}/layers"/>
        <copy todir="${proxytmp}/layers">
            <resources refid="layers"/>
        </copy>

        <xmlcatalog id="xml.fs.catalog">
            <dtd
                    publicid="-//NetBeans//DTD Filesystem 1.0//EN"
                    location="${ergonomicsdir}/../openide.filesystems/src/org/openide/filesystems/filesystem.dtd"
                />
            <dtd
                    publicid="-//NetBeans//DTD Filesystem 1.1//EN"
                    location="${ergonomicsdir}/../openide.filesystems/src/org/openide/filesystems/filesystem1_1.dtd"
                />
            <dtd
                    publicid="-//NetBeans//DTD Filesystem 1.2//EN"
                    location="${ergonomicsdir}/../openide.filesystems/src/org/openide/filesystems/filesystem1_2.dtd"
                />
        </xmlcatalog>

        <xslt
            basedir="${proxytmp}/layers/"
            destdir="${proxytmp}/extracted/" style="${ergonomicsdir}/project-wizard.xsl"
            useimplicitfileset="true" extension=".fragment"
            filenameparameter="filename"
        >
            <xmlcatalog refid="xml.fs.catalog"/>
            <param name="cluster.name" expression="${cluster.name}"/>
        </xslt>

        <concat destfile="${proxytmp}/${cluster.name}.xml">
            <header>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;filesystem&gt;
            </header>
            <filterchain>
                <ignoreblank byline="true"/>
            </filterchain>
            <fileset dir="${proxytmp}/extracted">
            </fileset>
            <footer>
&lt;/filesystem&gt;
            </footer>
        </concat>

        <available
            file="${ergonomicsdir}/${cluster.name}.properties"
            value="${ergonomicsdir}/${cluster.name}.properties"
            property="proxyprop"
        />
        <property name="proxyprop" location="${ergonomicsdir}/empty.properties"/>
        <mkdir dir="${proxydir}"/>
        <extractlayer
            clusterName="${cluster.name}"
            layer="${proxytmp}/${cluster.name}.xml"
            bundle="${proxydir}/Bundle.properties"
            destdir="${proxydir}"
            badgeicon="${ergonomicsdir}/src/org/netbeans/modules/ide/ergonomics/fod/badge.png"
        >
           <modules dir=".">
                <include name="modules/*.jar"/>
            </modules>
           <entries dir="${netbeans.dest.dir}">
                <include name="**/modules/*.jar"/>
                <exclude name="ergonomics*/**/*"/>
            </entries>
            <bundlefilter>
                <concatfilter prepend="${proxyprop}"/>
            </bundlefilter>
         </extractlayer>
         <l10nreplace
            dir="${proxydir}"
            bundle="${ergonomicsdir}/src/org/netbeans/modules/ide/ergonomics/Bundle.properties"
         >
             <replacefilter
                token="&lt;body&gt;" property="MSG_NotEnabled"
             />
             <replacefilter
                token="&lt;BODY&gt;" property="MSG_NotEnabled"
             />
             <include name="*.html"/>
         </l10nreplace>
    </target>

    
    <target name="-disable-one-cluster" depends="-init-clusters">
        <createmodulexml xmldir="${xmldir}">
            <disabled dir=".">
                <and>
                    <filename name="modules/*.jar"/>
                    <custom 
                        classname="org.netbeans.nbbuild.ModuleStateSelector"
                        classpath="${nb_all}/nbbuild/nbantext.jar"
                    >
                        <param name="acceptEnabled" value="true"/>
                    </custom>
                </and>
            </disabled>
        </createmodulexml>
    </target>
</project>
